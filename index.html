<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volo Discover Build - Baltimore, MD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest" defer></script>
    <style>
        /* Regular weight */
        @font-face {
            font-family: 'VoloSansPro';
            src: url('./VoloSansPro.woff') format('woff'),
                 url('./VoloSansPro.otf') format('opentype');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }
        /* Ultra / ExtraBold weight */
        @font-face {
            font-family: 'VoloSansPro';
            src: url('./VoloSans-ultra.ttf') format('truetype');
            font-weight: 800;
            font-style: normal;
            font-display: swap;
        }
        body {
            font-family: 'VoloSansPro', 'Inter', sans-serif;
            background-color: #ffffff; /* Page background changed to white */
        }
        /* Removed global remap of red to orange to avoid affecting non-Event UI */
        /* .text-red-600 { color: #EA580B !important; }
        .border-red-600 { border-color: #EA580B !important; } */
        .icon-text-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        /* Custom styles for price slider */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        input[type="range"]::-moz-range-thumb {
            width: 1.25rem;
            height: 1.25rem;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
    /* Dual-thumb event time sliders: both thumbs blue for consistency */
    /* Event time slider thumbs: 14px thumb on 6px track -> center with margin-top = -(thumb+2*border - track)/2 = -(14+4-6)/2 = -6px */
    #event-time-start::-webkit-slider-thumb,
    #event-time-end::-webkit-slider-thumb {
        width: 14px;
        height: 14px;
        margin-top: -6px;
        background: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
    }
    #event-time-start::-moz-range-thumb,
    #event-time-end::-moz-range-thumb {
        width: 14px;
        height: 14px;
        margin-top: -6px;
        background: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
    }
        /* Thicker track for visibility */
        #event-time-start::-webkit-slider-runnable-track,
        #event-time-end::-webkit-slider-runnable-track { height: 6px; border-radius: 9999px; background: transparent; }
        #event-time-start::-moz-range-track,
        #event-time-end::-moz-range-track { height: 6px; border-radius: 9999px; background: transparent; }
    /* Remove default focus outline on range inputs to avoid large blue box */
    #event-time-start:focus, #event-time-end:focus { outline: none; }
    #event-time-start, #event-time-end { background: transparent; }
        /* Map container styles */
        #map-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 50;
        }
        #map, #map-preview {
            height: 100%;
            width: 100%;
        }
        /* Overlay title on images: white text with subtle shadow and 2-line clamp */
        .overlay-title {
            color: #fff;
            font-size: 1.2rem !important;
            text-shadow: 0 1px 1px rgba(0,0,0,0.45), 0 0 6px rgba(0,0,0,0.25);
            display: -webkit-box;
            line-clamp: 2;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        /* Emoji used in elevator pills */
    .elev-emoji { font-size: 13px; line-height: 1; display: inline-block; transform: translateY(-0.5px); }
        /* Bottom gradient to improve contrast for pills/title (YouTube-style) */
        .img-bottom-gradient {
            position: absolute;
            left: 0; right: 0; bottom: 0;
            height: 60%;
            background: linear-gradient(to top, rgba(0,0,0,0.75) 0%, rgba(0,0,0,0.35) 45%, rgba(0,0,0,0) 100%);
            pointer-events: none;
        }
        /* Force YouTube (iframe) to cover container (good for portrait videos in landscape frames) */
        .yt-cover {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            height: 100%;
            width: 200%; /* overscan horizontally to ensure cover on portrait videos */
        }
        @media (min-width: 768px) {
            .yt-cover { width: 180%; }
        }
        /* Use Open Sans for elevator pills with semi-bold weight */
    .elev-pill { font-family: 'Open Sans', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif; font-weight: 700; }
        /* Activity type pill shares the font and tight sizing */
        .type-pill { font-family: 'Open Sans', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif; font-weight: 700; }
    /* Meta text (composition/age, skill, format) */
    .meta-text { font-family: 'Open Sans', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif; font-weight: 700; }
    /* Open Sans SemiBold utility for headings/titles in dropdowns */
    .font-open-sans-semibold { font-family: 'Open Sans', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif; font-weight: 600; }
    /* Card title blue link font */
    .card-title-link { font-family: 'Open Sans', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif; }
    /* Map drawer title font matches list filter headers */
    #map-filter-panel-title { font-family: 'Open Sans', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif; }
        /* Hide scrollbars for horizontally-scrollable pills */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* Filters typography: titles (h4) semi-bold, subtitles (h5) medium, using Open Sans */
    #filters-form h4 { font-family: 'Open Sans', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif; }
    #filters-form h5 { font-family: 'Open Sans', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif; }
        /* Visible checkbox styling: 1px border and accent color #818494 */
        input[type="checkbox"]:not(.sr-only) {
            accent-color: #818494;
            width: 16px;
            height: 16px;
            border: 1px solid #818494 !important;
            border-radius: 3px; /* keep square-ish look */
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="bg-[#0034dc] shadow-md">
    <div class="w-full max-w-[1500px] mx-auto px-4 py-3 flex justify-between items-center">
            <!-- Logo -->
            <div class="flex items-center space-x-3">
                <img src="https://rivall-public.s3.us-west-1.amazonaws.com/logos/organization-logos/default.webp" alt="Volo" class="invert brightness-0 h-10 w-auto select-none" />
            </div>
            <!-- Navigation -->
            <nav class="hidden md:flex items-center space-x-8 text-[13px] font-extrabold text-white tracking-wide ml-auto mr-6">
                <a href="#" class="uppercase hover:opacity-80 transition">Volo Kids</a>
                <a href="#" class="uppercase hover:opacity-80 transition">Volo Pass</a>
                <a href="#" class="uppercase hover:opacity-80 transition">Corporate</a>
                <a href="#" class="uppercase hover:opacity-80 transition">Choose City</a>
                <a href="#" class="uppercase hover:opacity-80 transition">About</a>
            </nav>
            <!-- Right Actions -->
            <div class="flex items-center space-x-3">
                <button class="hidden md:inline-flex items-center px-5 py-2.5 rounded-full border border-white text-white text-sm font-normal hover:bg-white/10 transition">Login</button>
                <button class="inline-flex items-center px-5 py-2.5 rounded-full bg-[#c7ff10] text-black text-sm font-normal hover:brightness-95 transition">Sign up</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div id="list-view-container">
    <main class="mx-auto max-w-[1500px] p-4">
            

            <!-- Filters and Results -->
            <!-- Mobile actions row: Filters button -->
            <div class="md:hidden flex items-center justify-end mb-3">
                <button id="mobile-filters-open" type="button" class="inline-flex items-center gap-2 rounded-full border border-gray-300 bg-white px-3 py-2 text-sm font-semibold text-gray-700 shadow-sm">
                    <i data-lucide="sliders-horizontal" class="h-4 w-4 text-[rgb(34,34,34)]"></i>
                    Filters
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

                <!-- Left Column: Filters -->
                <aside class="hidden lg:block lg:col-span-1 space-y-6">
                    <!-- Map Preview -->
                    <div class="bg-white p-0 rounded-2xl border border-gray-200">
                        <div id="map-preview-container" class="h-40 rounded-lg overflow-hidden cursor-pointer" role="button" aria-label="View these results on a map" title="View on map">
                            <div id="map-preview" class="bg-gray-200 flex items-center justify-center h-full w-full">
                                <span class="text-gray-500">Map Preview</span>
                            </div>
                        </div>
                        <button id="view-map-btn" class="mt-3 w-full text-blue-600 rounded-lg bg-transparent mb-3">View in a map</button>
                    </div>

                    

    

                    <!-- Filters -->
                    <!-- Anchor to restore filters-form after mobile overlay closes -->
                    <div id="filters-form-anchor" class="hidden"></div>

                    <div id="filters-form" class="space-y-0 divide-y divide-gray-300 p-0 bg-transparent">


                    
                        <!-- Scope Explainer / Daily Type -->
                        <div id="section-scope-explainer" class="pb-4">
                            <div class="w-full flex items-center justify-between py-2">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="trophy" class="h-5 w-5 text-[rgb(34,34,34)]" id="scope-explainer-icon"></i>
                                    <h4 class="font-semibold text-lg" id="scope-explainer-title">Leagues</h4>
                                </div>
                            </div>
                            <div id="scope-explainer-body" class="text-sm text-gray-700 leading-relaxed">
                                Weekly games and playoffs. Sign up solo, with friends, or a full team — we guarantee a game every week.
                            </div>
                            <div id="daily-type-container" class="mt-3 hidden" aria-hidden="true">
                                <div class="mt-2 flex flex-nowrap gap-2 overflow-x-auto" role="group" aria-label="Daily type">
                                    <label class="cursor-pointer">
                                        <input type="radio" name="daily-type" class="filter-input sr-only peer" id="daily-all" data-name="All" data-type="all">
                                        <span class="inline-block whitespace-nowrap px-3 py-1.5 rounded-full border border-[#818494] text-sm text-black peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">All</span>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="radio" name="daily-type" class="filter-input sr-only peer" id="daily-dropin" data-name="Drop-ins" data-type="drop-in">
                                        <span class="inline-block whitespace-nowrap px-3 py-1.5 rounded-full border border-[#818494] text-sm text-black peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">Drop-ins</span>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="radio" name="daily-type" class="filter-input sr-only peer" id="daily-pickup" data-name="Pickups" data-type="pickup">
                                        <span class="inline-block whitespace-nowrap px-3 py-1.5 rounded-full border border-[#818494] text-sm text-black peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">Pickups</span>
                                    </label>
                                </div>
                                <div id="daily-type-explainer" class="mt-3 space-y-2 text-sm text-gray-700"></div>
                            </div>
                        </div>

                        <!-- Schedule -->
                        <div class="py-6">
                            <div class="w-full flex items-center justify-between py-2">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="clock" class="h-5 w-5 text-[rgb(34,34,34)]"></i>
                                    <h4 class="font-semibold text-lg">Schedule</h4>
                                </div>
                            </div>
                            <div id="section-schedule" class="pb-3 space-y-4">
                                <div>
                                    <h5 class="text-sm font-medium">Day of the Week</h5>
                                    <div class="mt-2 flex flex-nowrap gap-2 overflow-x-auto">
                                        <label class="cursor-pointer">
                                            <input type="checkbox" class="filter-input sr-only peer" id="day-mon" data-name="Mon">
                                            <span class="inline-block px-3 py-1.5 rounded-full border border-[#818494] text-sm text-black peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">M</span>
                                        </label>
                                        <label class="cursor-pointer">
                                            <input type="checkbox" class="filter-input sr-only peer" id="day-tue" data-name="Tue">
                                            <span class="inline-block px-3 py-1.5 rounded-full border border-[#818494] text-sm text-black peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">T</span>
                                        </label>
                                        <label class="cursor-pointer">
                                            <input type="checkbox" class="filter-input sr-only peer" id="day-wed" data-name="Wed">
                                            <span class="inline-block px-3 py-1.5 rounded-full border border-[#818494] text-sm text-black peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">W</span>
                                        </label>
                                        <label class="cursor-pointer">
                                            <input type="checkbox" class="filter-input sr-only peer" id="day-thu" data-name="Thu">
                                            <span class="inline-block px-3 py-1.5 rounded-full border border-[#818494] text-sm text-black peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">T</span>
                                        </label>
                                        <label class="cursor-pointer">
                                            <input type="checkbox" class="filter-input sr-only peer" id="day-fri" data-name="Fri">
                                            <span class="inline-block px-3 py-1.5 rounded-full border border-[#818494] text-sm text-black peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">F</span>
                                        </label>
                                        <label class="cursor-pointer">
                                            <input type="checkbox" class="filter-input sr-only peer" id="day-sat" data-name="Sat">
                                            <span class="inline-block px-3 py-1.5 rounded-full border border-[#818494] text-sm text-black peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">S</span>
                                        </label>
                                        <label class="cursor-pointer">
                                            <input type="checkbox" class="filter-input sr-only peer" id="day-sun" data-name="Sun">
                                            <span class="inline-block px-3 py-1.5 rounded-full border border-[#818494] text-sm text-black peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">S</span>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <!-- Start Month (hidden across all scopes) -->
                                    <div id="start-month-block" class="hidden" aria-hidden="true">
                                        <h5 class="text-sm font-medium">Start Month</h5>
                                        <div class="mt-2 flex flex-wrap gap-2">
                                            <label class="cursor-pointer">
                                                <input type="checkbox" class="filter-input sr-only peer" id="month-september" data-name="September">
                                                <span class="inline-block px-3 py-1.5 rounded-full border border-[#818494] text-sm text-black peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">SEP</span>
                                            </label>
                                            <label class="cursor-pointer">
                                                <input type="checkbox" class="filter-input sr-only peer" id="month-october" data-name="October">
                                                <span class="inline-block px-3 py-1.5 rounded-full border border-[#818494] text-sm text-black peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">OCT</span>
                                            </label>
                                            <label class="cursor-pointer">
                                                <input type="checkbox" class="filter-input sr-only peer" id="month-november" data-name="November">
                                                <span class="inline-block px-3 py-1.5 rounded-full border border-[#818494] text-sm text-black peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">NOV</span>
                                            </label>
                                        </div>
                                    </div>
                                    <!-- Daily Quick Dates (shown in Daily scope only) -->
                                    <div id="daily-quickdate-block" class="hidden" aria-hidden="true">
                                        <div class="mt-2 flex flex-wrap gap-2">
                                            <label class="cursor-pointer">
                                                <input type="checkbox" class="filter-input sr-only peer" id="date-today" data-name="Today">
                                                <span class="inline-block px-3 py-1.5 rounded-full border border-[#818494] text-sm text-black peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">Today</span>
                                            </label>
                                            <label class="cursor-pointer">
                                                <input type="checkbox" class="filter-input sr-only peer" id="date-tomorrow" data-name="Tomorrow">
                                                <span class="inline-block px-3 py-1.5 rounded-full border border-[#818494] text-sm text-black peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">Tomorrow</span>
                                            </label>
                                            <label class="cursor-pointer">
                                                <input type="checkbox" class="filter-input sr-only peer" id="date-weekend" data-name="This Weekend">
                                                <span class="inline-block px-3 py-1.5 rounded-full border border-[#818494] text-sm text-black peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">This Weekend</span>
                                            </label>
                                            <label class="cursor-pointer">
                                                <input type="checkbox" class="filter-input sr-only peer" id="date-nextweek" data-name="Next Week">
                                                <span class="inline-block px-3 py-1.5 rounded-full border border-[#818494] text-sm text-black peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">Next Week</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Events: Start time range filter (shown only in Events scope) -->
                        <div id="events-starttime-block" class="mt-6 mb-8 py-4 hidden" aria-hidden="true">
                            <div class="flex justify-between items-center mb-2">
                                <h5 class="text-sm font-semibold">Start time window</h5>
                                <span id="event-time-range-summary" class="text-sm text-gray-700" aria-live="polite">Any — Any</span>
                            </div>
                            <div class="mt-2 space-y-3">
                                <div id="event-time-track" class="relative h-10 flex items-center select-none" aria-describedby="event-time-help">
                                    <div class="absolute h-1.5 rounded-full bg-gray-200" style="top:50%; transform:translateY(-50%); left:0; right:0;" aria-hidden="true"></div>
                                    <div id="event-time-active-band" class="absolute h-1.5 rounded-full bg-blue-500/40" style="top:50%; transform:translateY(-50%);" aria-hidden="true"></div>
                                    <input id="event-time-start" type="range" min="0" max="1439" step="30" value="0" class="absolute inset-0 w-full appearance-none" aria-label="Start time (left handle)" style="z-index:30;">
                                    <input id="event-time-end" type="range" min="0" max="1439" step="30" value="1439" class="absolute inset-0 w-full appearance-none" aria-label="End time (right handle)" style="z-index:20;">
                                </div>
                            </div>
                        </div>
                         <!-- Price & Deals -->
                         <div class="py-6">
                            <div class="w-full flex items-center justify-between py-2">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="badge-dollar-sign" class="h-5 w-5 text-[rgb(34,34,34)]"></i>
                                    <h4 class="font-semibold text-lg">Price & Deals</h4>
                                </div>
                            </div>
                            <div id="section-price-deals" class="pb-3 space-y-4">
                                <div>
                                    <div id="daily-free-members-note" class="hidden text-sm text-gray-700">Free for members</div>
                                    <h5 class="text-sm font-medium">Show Prices For:</h5>
                                    <div class="mt-2 flex flex-nowrap gap-2 overflow-x-auto">
                                        <label class="cursor-pointer">
                                            <input type="radio" name="price-type" class="filter-input sr-only peer" id="price-member" data-name="Member">
                                            <span class="inline-block whitespace-nowrap px-3 py-1.5 rounded-full border border-[#818494] text-sm text-black peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">Member</span>
                                        </label>
                                        <label class="cursor-pointer">
                                            <input type="radio" name="price-type" class="filter-input sr-only peer" id="price-nonmember" data-name="Non-Member">
                                            <span class="inline-block whitespace-nowrap px-3 py-1.5 rounded-full border border-[#818494] text-sm text-black peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">Non-Member</span>
                                        </label>
                                        <label class="cursor-pointer">
                                            <input type="radio" name="price-type" class="filter-input sr-only peer" id="price-team" data-name="Team">
                                            <span class="inline-block whitespace-nowrap px-3 py-1.5 rounded-full border border-[#818494] text-sm text-black peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">Team</span>
                                        </label>
                                    </div>
                                </div>
                                <div id="price-slider-container" class="hidden">
                                    <input id="price-range" type="range" min="0" max="100" step="25" value="100" class="w-full" aria-labelledby="price-range-label">
                                    <div class="flex justify-between text-sm text-gray-600 mt-2">
                                        <span id="price-range-min">$0</span>
                                        <span id="price-range-display" aria-live="polite">$0 — $100</span>
                                    </div>
                                </div>
                                <div>
                                    <h5 class="text-sm font-medium">Registration Deals</h5>
                                    <div class="mt-2 space-y-2">
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="deal-discounted" data-name="Discounted Events"> <span class="ml-2 text-sm">Discounted Events</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="deal-earlybird" data-name="Early Bird Pricing"> <span class="ml-2 text-sm">Early Bird Pricing</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="deal-volopassfree" data-name="Free for Volo Pass Members"> <span class="ml-2 text-sm">Free for Volo Pass Members</span></label>
                                    </div>
                                    <!-- Volo Pass CTA moved here -->
                                    <div class="mt-4 py-2 rounded-2xl overflow-hidden flex flex-col bg-[#0034DD] text-white border border-[#0034DD] hidden" aria-hidden="true">
                                        <div class="p-4 text-center">
                                            <h3 class="font-extrabold uppercase tracking-tight text-[1.5rem] leading-tight">Play More, Pay Less</h3>
                                            <p class="mt-1 text-xs text-blue-50">Score deals on leagues, pickup games, member exclusive events, and more.</p>
                                        </div>
                                        <div class="text-center px-3 pb-5">
                                            <a href="#" class="inline-flex items-center justify-center rounded-full px-3 py-2 text-xs font-bold border border-[#c7ff10] bg-[#c7ff10] text-black hover:brightness-95 transition">BECOME A VOLO PASS MEMBER</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Location (moved above Program Highlights) -->
                        <div class="py-6">
                            <div class="w-full flex items-center justify-between py-2">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="map-pin" class="h-5 w-5 text-[rgb(34,34,34)]"></i>
                                    <h4 class="font-semibold text-lg">Location</h4>
                                </div>
                            </div>
                            <div id="section-location" class="pb-3 space-y-4">
                                <div>
                                    <h5 class="text-sm font-medium">Venues</h5>
                                    <div class="relative mt-2">
                                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-[rgb(34,34,34)] pointer-events-none"></i>
                                        <input id="venue-search-input" type="text" class="w-full border rounded-xl px-2 py-3 pl-10" placeholder="Search venue name" aria-label="Search venue name">
                                    </div>
                                    <div id="venue-list" class="mt-2 space-y-2"></div>
                                </div>
                                <div>
                                    <h5 class="text-sm font-medium">Neighborhood</h5>
                                    <div class="relative mt-2">
                                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-[rgb(34,34,34)] pointer-events-none"></i>
                                        <input id="neighborhood-search-input" type="text" class="w-full border rounded-xl px-2 py-3 pl-10" placeholder="Search neighborhood" aria-label="Search neighborhood">
                                    </div>
                                    <div id="neighborhood-list" class="mt-2 space-y-2"></div>
                                </div>
                                
                            </div>
                        </div>
                        <!-- Program Highlights -->
                        <div class="py-6">
                            <div class="w-full flex items-center justify-between py-2">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="sparkles" class="h-5 w-5 text-[rgb(34,34,34)]"></i>
                                    <h4 class="font-semibold text-lg">Program Highlights</h4>
                                </div>
                            </div>
                            <div id="section-highlights" class="pb-3 space-y-2">
                                <label class="flex items-center"><input type="checkbox" class="filter-input" id="hl-bar-site" data-name="Bar on Site"> <span class="ml-2 text-sm">Bar on Site</span></label>
                                <label class="flex items-center"><input type="checkbox" class="filter-input" id="hl-bar-tab" data-name="Bar Tab Challenge"> <span class="ml-2 text-sm">Bar Tab Challenge</span></label>
                                <label class="flex items-center"><input type="checkbox" class="filter-input" id="hl-city-champs" data-name="City Championship"> <span class="ml-2 text-sm">City Championship</span></label>
                                <label class="flex items-center"><input type="checkbox" class="filter-input" id="hl-club-volo" data-name="Club Volo Tournament Series"> <span class="ml-2 text-sm">Club Volo Tournament Series</span></label>
                                <label class="flex items-center"><input type="checkbox" class="filter-input" id="hl-concert" data-name="Concert"> <span class="ml-2 text-sm">Concert</span></label>
                                <label class="flex items-center"><input type="checkbox" class="filter-input" id="hl-dj" data-name="DJ at the Bar"> <span class="ml-2 text-sm">DJ at the Bar</span></label>
                                <label class="flex items-center"><input type="checkbox" class="filter-input" id="hl-flipcup" data-name="Flip Cup Counts"> <span class="ml-2 text-sm">Flip Cup Counts</span></label>
                                <label class="flex items-center"><input type="checkbox" class="filter-input" id="hl-free-pickup" data-name="Free Pickup"> <span class="ml-2 text-sm">Free Pickup</span></label>
                                <label class="flex items-center"><input type="checkbox" class="filter-input" id="hl-glow" data-name="GLOW"> <span class="ml-2 text-sm">GLOW</span></label>
                                <label class="flex items-center"><input type="checkbox" class="filter-input" id="hl-happy-hour" data-name="Happy Hour"> <span class="ml-2 text-sm">Happy Hour</span></label>
                                <label class="flex items-center"><input type="checkbox" class="filter-input" id="hl-happy-hour-league" data-name="Happy Hour League"> <span class="ml-2 text-sm">Happy Hour League</span></label>
                                <label class="flex items-center"><input type="checkbox" class="filter-input" id="hl-player-appreciation" data-name="Player Appreciation"> <span class="ml-2 text-sm">Player Appreciation</span></label>
                                <label class="flex items-center"><input type="checkbox" class="filter-input" id="hl-player-party" data-name="Player Party"> <span class="ml-2 text-sm">Player Party</span></label>
                                <label class="flex items-center"><input type="checkbox" class="filter-input" id="hl-pro-sport" data-name="Professional Sporting Event"> <span class="ml-2 text-sm">Professional Sporting Event</span></label>
                                <label class="flex items-center"><input type="checkbox" class="filter-input" id="hl-singles" data-name="Singles Events (Volo Solo)"> <span class="ml-2 text-sm">Singles Events (Volo Solo)</span></label>
                                <label class="flex items-center"><input type="checkbox" class="filter-input" id="hl-tailgates" data-name="Tailgates"> <span class="ml-2 text-sm">Tailgates</span></label>
                                <label class="flex items-center"><input type="checkbox" class="filter-input" id="hl-volekids" data-name="Volo Kids Fundraiser"> <span class="ml-2 text-sm">Volo Kids Fundraiser</span></label>
                                <label class="flex items-center"><input type="checkbox" class="filter-input" id="hl-watch-party" data-name="Watch Party"> <span class="ml-2 text-sm">Watch Party</span></label>
                                <label class="flex items-center"><input type="checkbox" class="filter-input" id="hl-waterfront" data-name="Waterfront View"> <span class="ml-2 text-sm">Waterfront View</span></label>
                            </div>
                        </div>
                        <!-- Player & Team Type -->
                        <div class="py-6">
                            <div class="w-full flex items-center justify-between py-2">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="users" class="h-5 w-5 text-[rgb(34,34,34)]"></i>
                                    <h4 class="font-semibold text-lg">Player & Team Type</h4>
                                </div>
                            </div>
                            <div id="section-player-team" class="pb-3 space-y-4">
                                <div>
                                    <h5 class="text-sm font-semibold">Team Composition</h5>
                                    <div class="mt-2 grid grid-cols-2 gap-3">
                                        <!-- Coed -->
                                        <label class="block cursor-pointer">
                                            <input type="checkbox" class="sr-only peer filter-input" id="comp-coed" data-name="Coed">
                                            <div class="rounded-xl border border-gray-300 p-4 text-center transition peer-checked:border-blue-600 peer-checked:bg-blue-50">
                                                <i data-lucide="users" class="mx-auto h-6 w-6 text-gray-500 peer-checked:text-blue-600"></i>
                                                <div class="mt-2 text-sm font-medium text-gray-800 peer-checked:text-blue-700">Coed</div>
                                            </div>
                                        </label>
                                        <!-- Men's -->
                                        <label class="block cursor-pointer">
                                            <input type="checkbox" class="sr-only peer filter-input" id="comp-mens" data-name="Men's">
                                            <div class="rounded-xl border border-gray-300 p-4 text-center transition peer-checked:border-blue-600 peer-checked:bg-blue-50">
                                                <i data-lucide="mars" class="mx-auto h-6 w-6 text-gray-500 peer-checked:text-blue-600"></i>
                                                <div class="mt-2 text-sm font-medium text-gray-800 peer-checked:text-blue-700">Men's</div>
                                            </div>
                                        </label>
                                        <!-- Open -->
                                        <label class="block cursor-pointer">
                                            <input type="checkbox" class="sr-only peer filter-input" id="comp-open" data-name="Open">
                                            <div class="rounded-xl border border-gray-300 p-4 text-center transition peer-checked:border-blue-600 peer-checked:bg-blue-50">
                                                <i data-lucide="circle" class="mx-auto h-6 w-6 text-gray-500 peer-checked:text-blue-600"></i>
                                                <div class="mt-2 text-sm font-medium text-gray-800 peer-checked:text-blue-700">Open</div>
                                            </div>
                                        </label>
                                        <!-- Women's -->
                                        <label class="block cursor-pointer">
                                            <input type="checkbox" class="sr-only peer filter-input" id="comp-womens" data-name="Women's">
                                            <div class="rounded-xl border border-gray-300 p-4 text-center transition peer-checked:border-blue-600 peer-checked:bg-blue-50">
                                                <i data-lucide="venus" class="mx-auto h-6 w-6 text-gray-500 peer-checked:text-blue-600"></i>
                                                <div class="mt-2 text-sm font-medium text-gray-800 peer-checked:text-blue-700">Women's</div>
                                            </div>
                                        </label>
                                    </div>
                                    <p class="mt-2 text-xs text-gray-500">Coed has gender specific roster requirements Open does not.</p>
                                </div>
                                <!-- Move Skill Level under Team Composition -->
                                <div>
                                    <h5 class="text-sm font-semibold">Skill Level</h5>
                                    <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <div class="space-y-2">
                                            <label class="flex items-center"><input type="checkbox" class="filter-input" id="skill-competitive" data-name="Competitive"> <span class="ml-2 text-sm">Competitive</span></label>
                                            <label class="flex items-center"><input type="checkbox" class="filter-input" id="skill-intermediate" data-name="Intermediate"> <span class="ml-2 text-sm">Intermediate</span></label>
                                        </div>
                                        <div class="space-y-2">
                                            <label class="flex items-center"><input type="checkbox" class="filter-input" id="skill-recreational" data-name="Recreational"> <span class="ml-2 text-sm">Recreational</span></label>
                                            <label class="flex items-center"><input type="checkbox" class="filter-input" id="skill-beginner" data-name="Social/Beginner"> <span class="ml-2 text-sm">Social/Beginner</span></label>
                                        </div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <h5 class="text-sm font-semibold">Age Group</h5>
                                        <div class="mt-2 space-y-2">
                                            <label class="flex items-center opacity-50 cursor-not-allowed" aria-disabled="true"><input type="checkbox" class="filter-input" id="age-35" data-name="35+" disabled> <span class="ml-2 text-sm">35+</span></label>
                                            <label class="flex items-center opacity-50 cursor-not-allowed" aria-disabled="true"><input type="checkbox" class="filter-input" id="age-40" data-name="40+" disabled> <span class="ml-2 text-sm">40+</span></label>
                                            <label class="flex items-center opacity-50 cursor-not-allowed" aria-disabled="true"><input type="checkbox" class="filter-input" id="age-50" data-name="50+" disabled> <span class="ml-2 text-sm">50+</span></label>
                                        </div>
                                    </div>
                                    <div>
                                        <h5 class="text-sm font-semibold">Community</h5>
                                        <div class="mt-2 space-y-2">
                                            <label class="flex items-center"><input type="checkbox" class="filter-input" id="comm-lgbtq" data-name="LGBTQ+"> <span class="ml-2 text-sm">LGBTQ+</span></label>
                                            <label class="flex items-center"><input type="checkbox" class="filter-input" id="comm-singles" data-name="Singles (Volo Solo)"> <span class="ml-2 text-sm">Singles (Volo Solo)</span></label>
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                        <!-- Program Details -->
                        <div class="py-6">
                            <div class="w-full flex items-center justify-between py-2">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="file-text" class="h-5 w-5 text-[rgb(34,34,34)]"></i>
                                    <h4 class="font-semibold text-lg">Program Details</h4>
                                </div>
                                <button type="button" class="group inline-flex items-center justify-center w-8 h-8 rounded-md hover:bg-gray-100" data-collapse-toggle="#section-program-details">
                                    <i data-lucide="chevron-down" class="h-4 w-4 text-gray-600 group-data-[open=true]:rotate-180 transition-transform"></i>
                                </button>
                            </div>
                            <div id="section-program-details" class="pb-3 space-y-4 hidden" data-collapsible>
                                
                                <div>
                                    <h5 class="text-sm font-medium">Style of Play</h5>
                                    <div class="mt-2 space-y-2">
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="style-2games" data-name="2 Games Per Night"> <span class="ml-2 text-sm">2 Games Per Night</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="style-playoffs" data-name="All Teams Make Playoffs"> <span class="ml-2 text-sm">All Teams Make Playoffs</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="style-chicago" data-name="Chicago Style"> <span class="ml-2 text-sm">Chicago Style</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="style-cupinhand" data-name="Cup In Hand"> <span class="ml-2 text-sm">Cup In Hand</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="style-doubleheader" data-name="Doubleheader"> <span class="ml-2 text-sm">Doubleheader</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="style-glow" data-name="Glow"> <span class="ml-2 text-sm">Glow</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="style-glowflip" data-name="Glow + Flip Cup"> <span class="ml-2 text-sm">Glow + Flip Cup</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="style-ladder" data-name="Ladder League"> <span class="ml-2 text-sm">Ladder League</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="style-openplay" data-name="Open Play"> <span class="ml-2 text-sm">Open Play</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="style-partyleague" data-name="Party League"> <span class="ml-2 text-sm">Party League</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="style-partypickleball" data-name="Party Pickleball"> <span class="ml-2 text-sm">Party Pickleball</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="style-traditional" data-name="Traditional"> <span class="ml-2 text-sm">Traditional</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="style-triplethreat" data-name="Triple Threat"> <span class="ml-2 text-sm">Triple Threat</span></label>
                                    </div>
                                </div>
                                <div>
                                    <h5 class="text-sm font-medium">Format</h5>
                                    <div id="format-list" class="mt-2 space-y-2">
                                        <!-- Dynamically populated NvN options (e.g., 7v7, 5v5) -->
                                    </div>
                                </div>
                                <div>
                                    <h5 class="text-sm font-medium">Surface Type</h5>
                                    <div class="mt-2 space-y-2">
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="surface-beach" data-name="Beach/Sand"> <span class="ml-2 text-sm">Beach/Sand</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="surface-grass" data-name="Grass"> <span class="ml-2 text-sm">Grass</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="surface-indoor" data-name="Indoor"> <span class="ml-2 text-sm">Indoor</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="surface-outdoor" data-name="Outdoor"> <span class="ml-2 text-sm">Outdoor</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="surface-turf" data-name="Turf"> <span class="ml-2 text-sm">Turf</span></label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Amenities & Perks -->
                        <div class="py-6">
                            <div class="w-full flex items-center justify-between py-2">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="gift" class="h-5 w-5 text-[rgb(34,34,34)]"></i>
                                    <h4 class="font-semibold text-lg">Amenities & Perks</h4>
                                </div>
                                <button type="button" class="group inline-flex items-center justify-center w-8 h-8 rounded-md hover:bg-gray-100" data-collapse-toggle="#section-amenities">
                                    <i data-lucide="chevron-down" class="h-4 w-4 text-gray-600 group-data-[open=true]:rotate-180 transition-transform"></i>
                                </button>
                            </div>
                            <div id="section-amenities" class="pb-3 space-y-4 hidden" data-collapsible>
                                <div>
                                    <h5 class="text-sm font-medium">Social & Bar Scene</h5>
                                    <div class="mt-2 space-y-2">
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="soc-bar-site" data-name="Bar on Site"> <span class="ml-2 text-sm">Bar on Site</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="soc-bogo" data-name="BOGO Pitchers"> <span class="ml-2 text-sm">BOGO Pitchers</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="soc-byoc" data-name="Bring Your Own Case (no glass)"> <span class="ml-2 text-sm">Bring Your Own Case (no glass)</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="soc-byob" data-name="BYOB (Bring Your Own Beer)"> <span class="ml-2 text-sm">BYOB (Bring Your Own Beer)</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="soc-host" data-name="Dedicated Social Host"> <span class="ml-2 text-sm">Dedicated Social Host</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="soc-dj" data-name="DJ at the Bar"> <span class="ml-2 text-sm">DJ at the Bar</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="soc-deals" data-name="Includes Happy Hour / Bar Deals"> <span class="ml-2 text-sm">Includes Happy Hour / Bar Deals</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="soc-sponsor" data-name="Sponsor Bar"> <span class="ml-2 text-sm">Sponsor Bar</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="soc-events" data-name="Special Events"> <span class="ml-2 text-sm">Special Events</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="soc-exclusive" data-name="Volo Exclusive Bar Deals"> <span class="ml-2 text-sm">Volo Exclusive Bar Deals</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="soc-walkbar" data-name="Walking Distance to Bar"> <span class="ml-2 text-sm">Walking Distance to Bar</span></label>
                                    </div>
                                </div>
                                <div>
                                    <h5 class="text-sm font-medium">Program Perks</h5>
                                    <div class="mt-2 space-y-2">
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="perk-refs" data-name="Includes Referees"> <span class="ml-2 text-sm">Includes Referees</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="perk-tshirt" data-name="T-Shirt Included"> <span class="ml-2 text-sm">T-Shirt Included</span></label>
                                    </div>
                                </div>
                                <div>
                                    <h5 class="text-sm font-medium">Venue Features</h5>
                                    <div class="mt-2 space-y-2">
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="venue-dogs" data-name="Dogs Welcome"> <span class="ml-2 text-sm">Dogs Welcome</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="venue-lights" data-name="Lights"> <span class="ml-2 text-sm">Lights</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="venue-transit" data-name="Near Public Transportation"> <span class="ml-2 text-sm">Near Public Transportation</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="venue-new" data-name="New Facility"> <span class="ml-2 text-sm">New Facility</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="venue-parking" data-name="On-Site Parking"> <span class="ml-2 text-sm">On-Site Parking</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="venue-popular" data-name="Popular Venue"> <span class="ml-2 text-sm">Popular Venue</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="venue-tables" data-name="Reserved Tables"> <span class="ml-2 text-sm">Reserved Tables</span></label>
                                        <label class="flex items-center"><input type="checkbox" class="filter-input" id="venue-streetparking" data-name="Street Parking"> <span class="ml-2 text-sm">Street Parking</span></label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </aside>

                <!-- Right Column: Results -->
                <section class="lg:col-span-3">
                    <!-- Search Bar Section (moved here above results) -->
                    <section id="search-bar-section" class="mb-6">
                        <div class="grid grid-cols-1 gap-2 items-end md:flex md:items-stretch md:gap-2">
                            <!-- Your City -->
                            <div class="md:col-span-3 flex-1">
                                <div class="relative">
                                    <span class="absolute left-12 top-2 text-[11px] font-normal text-gray-600">Your City</span>
                                    <i data-lucide="map-pin" class="absolute left-4 top-1/2 -translate-y-1/2 h-5 w-5 text-[rgb(34,34,34)] pointer-events-none"></i>
                                    <input type="text" id="city" aria-label="Your City" placeholder="Search for a city..." class="w-full pt-5 pb-2 pl-12 pr-5 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base" value="Baltimore" />
                                    <!-- City Dropdown -->
                                    <div id="city-dropdown" class="absolute left-0 top-full mt-2 z-50 w-96 bg-white border border-gray-200 rounded-md shadow-lg hidden">
                                        <div class="flex flex-col">
                                            <div class="border-b border-gray-200 p-2">
                                                <div class="flex items-center gap-2">
                                                    <div class="relative flex-1">
                                                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-[rgb(34,34,34)]" aria-hidden="true"></i>
                                                        <input id="city-search" placeholder="Search for a city..." class="w-full rounded-md border border-gray-300 py-2 pl-9 pr-3 text-sm focus:ring-blue-500 focus:border-blue-500" type="text" value="">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="max-h-64 overflow-y-auto p-1" id="city-list">
                                                <button type="button" data-city="Baltimore" class="flex w-full items-center rounded-md px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100"><img alt="Baltimore icon" class="mr-3 h-6 w-6 object-contain" src="https://volosports.com/img/unsafe/format:webp/plain/https://volosports-public.s3.us-west-1.amazonaws.com/common/city-crests/Volo-Crest-BaltimoreNavy.png">Baltimore</button>
                                                <button type="button" data-city="Boston" class="flex w-full items-center rounded-md px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100"><img alt="Boston icon" class="mr-3 h-6 w-6 object-contain" src="https://volosports.com/img/unsafe/format:webp/plain/https://volosports-public.s3.us-west-1.amazonaws.com/common/city-crests/Volo-Crest-BostonNavy.png">Boston</button>
                                                <button type="button" data-city="Charleston" class="flex w-full items-center rounded-md px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100"><img alt="Charleston icon" class="mr-3 h-6 w-6 object-contain" src="https://volosports.com/img/unsafe/format:webp/plain/https://volosports-public.s3.us-west-1.amazonaws.com/common/city-crests/Volo-Crest-CharlestonNavy.png">Charleston</button>
                                                <button type="button" data-city="Denver" class="flex w-full items-center rounded-md px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100"><img alt="Denver icon" class="mr-3 h-6 w-6 object-contain" src="https://volosports.com/img/unsafe/format:webp/plain/https://volosports-public.s3.us-west-1.amazonaws.com/common/city-crests/Volo-Crest-DenverNavy.png">Denver</button>
                                                <button type="button" data-city="Los Angeles" class="flex w-full items-center rounded-md px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100"><img alt="Los Angeles icon" class="mr-3 h-6 w-6 object-contain" src="https://volosports.com/img/unsafe/format:webp/plain/https://volosports-public.s3.us-west-1.amazonaws.com/common/city-crests/Volo-Crest-LANavy.png">Los Angeles</button>
                                                <button type="button" data-city="Miami" class="flex w-full items-center rounded-md px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100"><img alt="Miami icon" class="mr-3 h-6 w-6 object-contain" src="https://volosports.com/img/unsafe/format:webp/plain/https://volosports-public.s3.us-west-1.amazonaws.com/common/city-crests/Volo-Crest-Miami.png">Miami</button>
                                                <button type="button" data-city="Morristown" class="flex w-full items-center rounded-md px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100"><img alt="Morristown icon" class="mr-3 h-6 w-6 object-contain" src="https://volosports.com/img/unsafe/format:webp/plain/https://volosports-public.s3.us-west-1.amazonaws.com/common/city-crests/Volo-Crest-NJNavy.png">Morristown</button>
                                                <button type="button" data-city="New York Metro Area" class="flex w-full items-center rounded-md px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100"><img alt="New York Metro Area icon" class="mr-3 h-6 w-6 object-contain" src="https://volosports.com/img/unsafe/format:webp/plain/https://volosports-public.s3.us-west-1.amazonaws.com/common/city-crests/Volo-Crest-NYCNavy.png">New York Metro Area</button>
                                                <button type="button" data-city="Philadelphia" class="flex w-full items-center rounded-md px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100"><img alt="Philadelphia icon" class="mr-3 h-6 w-6 object-contain" src="https://volosports.com/img/unsafe/format:webp/plain/https://volosports-public.s3.us-west-1.amazonaws.com/common/city-crests/Volo-Crest-Philadelphia.png">Philadelphia</button>
                                                <button type="button" data-city="San Diego" class="flex w-full items-center rounded-md px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100"><img alt="San Diego icon" class="mr-3 h-6 w-6 object-contain" src="https://volosports.com/img/unsafe/format:webp/plain/https://volosports-public.s3.us-west-1.amazonaws.com/common/city-crests/Volo-Crest-SanDiegoNavy.png">San Diego</button>
                                                <button type="button" data-city="San Francisco" class="flex w-full items-center rounded-md px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100"><img alt="San Francisco icon" class="mr-3 h-6 w-6 object-contain" src="https://volosports.com/img/unsafe/format:webp/plain/https://volosports-public.s3.us-west-1.amazonaws.com/common/city-crests/Volo-Crest-SanFranciscoNavy.png">San Francisco</button>
                                                <button type="button" data-city="San Jose" class="flex w-full items-center rounded-md px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100"><img alt="San Jose icon" class="mr-3 h-6 w-6 object-contain" src="https://volosports.com/img/unsafe/format:webp/plain/https://volosports-public.s3.us-west-1.amazonaws.com/common/city-crests/Volo-Crest-SanJoseNavy.png">San Jose</button>
                                                <button type="button" data-city="Seattle" class="flex w-full items-center rounded-md px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100"><img alt="Seattle icon" class="mr-3 h-6 w-6 object-contain" src="https://volosports.com/img/unsafe/format:webp/plain/https://volosports-public.s3.us-west-1.amazonaws.com/common/city-crests/Volo-Crest-SeattleNavy.png">Seattle</button>
                                                <button type="button" data-city="Virtual" class="flex w-full items-center rounded-md px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100"><img alt="Virtual icon" class="mr-3 h-6 w-6 object-contain" src="https://volosports.com/img/unsafe/format:webp/plain/https://volosports-public.s3.us-west-1.amazonaws.com/common/city-crests/Volo-Crest-VirtualNavy.png">Virtual</button>
                                                <button type="button" data-city="Volo Kids Foundation" class="flex w-full items-center rounded-md px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100"><img alt="Volo Kids Foundation icon" class="mr-3 h-6 w-6 object-contain" src="https://volosports.com/img/unsafe/format:webp/plain/https://volosports-public.s3.us-west-1.amazonaws.com/common/city-crests/Volo-Crest-KidsFoundationNavy.png">Volo Kids Foundation</button>
                                                <button type="button" data-city="Washington DC" class="flex w-full items-center rounded-md px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100"><img alt="Washington DC icon" class="mr-3 h-6 w-6 object-contain" src="https://volosports.com/img/unsafe/format:webp/plain/https://volosports-public.s3.us-west-1.amazonaws.com/common/city-crests/Volo-Crest-WashingtonDCNavy.png">Washington DC</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Types of Activities -->
                            <div class="md:col-span-3 flex-1">
                                <div class="relative">
                                    <span class="absolute left-12 top-2 text-[11px] font-normal text-gray-600">Types of Activities</span>
                                    <i data-lucide="list" class="absolute left-4 top-1/2 -translate-y-1/2 h-5 w-5 text-[rgb(34,34,34)] pointer-events-none"></i>
                                    <input type="text" id="activities" aria-label="Types of Activities" placeholder="Leagues, Tournaments, Daily Sports" class="w-full pt-5 pb-2 pl-12 pr-5 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base" />
                                    <!-- Activities Dropdown -->
                                    <div id="activities-dropdown" class="absolute left-0 top-full mt-2 z-50 w-96 bg-white border border-gray-200 rounded-md shadow-lg hidden">
                                        <div class="flex flex-col">
                                            <div class="space-y-2 p-4" id="activities-list">
                                                <button type="button" data-activity="Leagues" class="block w-full rounded-md p-3 text-left hover:bg-gray-100">
                                                    <div class="flex items-center gap-2">
                                                        <i data-lucide="trophy" class="h-4 w-4"></i>
                                                        <p class="whitespace-normal text-sm font-open-sans-semibold">Leagues</p>
                                                    </div>
                                                    <p class="whitespace-pre-line text-xs text-gray-500 mt-1">Multi-week organized fun, usually with playoffs at the end.</p>
                                                </button>
                                                <button type="button" data-activity="Tournaments" class="block w-full rounded-md p-3 text-left hover:bg-gray-100">
                                                    <div class="flex items-center gap-2">
                                                        <i data-lucide="swords" class="h-4 w-4 text-[rgb(34,34,34)]"></i>
                                                        <p class="whitespace-normal text-sm font-open-sans-semibold">Tournaments</p>
                                                    </div>
                                                    <p class="whitespace-pre-line text-xs text-gray-500 mt-1">Elimination-style competitions, usually a single day or weekend.</p>
                                                </button>
                                                <button type="button" data-activity="Daily Sports" class="block w-full rounded-md p-3 text-left hover:bg-gray-100">
                                                    <div class="flex items-center gap-2">
                                                        <i data-lucide="clock" class="h-4 w-4"></i>
                                                        <p class="whitespace-normal text-sm font-open-sans-semibold">Daily Sports</p>
                                                    </div>
                                                    <p class="whitespace-pre-line text-xs text-gray-500 mt-1">Play pickup sports or drop-in as a sub in a league.</p>
                                                </button>
                                                <button type="button" data-activity="Events" class="block w-full rounded-md p-3 text-left hover:bg-gray-100">
                                                    <div class="flex items-center gap-2">
                                                        <i data-lucide="party-popper" class="h-4 w-4 text-[rgb(34,34,34)]"></i>
                                                        <p class="whitespace-normal text-sm font-open-sans-semibold">Events</p>
                                                    </div>
                                                    <p class="whitespace-pre-line text-xs text-gray-500 mt-1">Happy hours and more.</p>
                                                </button>
                                                <button type="button" data-activity="Private Rentals" class="block w-full rounded-md p-3 text-left hover:bg-gray-100">
                                                    <div class="flex items-center gap-2">
                                                        <i data-lucide="building-2" class="h-4 w-4 text-[rgb(34,34,34)]"></i>
                                                        <p class="whitespace-normal text-sm font-open-sans-semibold">Private Rentals</p>
                                                    </div>
                                                    <p class="whitespace-pre-line text-xs text-gray-500 mt-1">Rent fields or courts for private play.</p>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Your Sports -->
                            <div class="md:col-span-3 flex-1">
                                <div class="relative">
                                    <span class="absolute left-12 top-2 text-[11px] font-normal text-gray-600">Your Sports</span>
                                    <i data-lucide="trophy" class="absolute left-4 top-1/2 -translate-y-1/2 h-5 w-5 text-[rgb(34,34,34)] pointer-events-none"></i>
                                    <input type="text" id="sports" aria-label="Your Sports" placeholder="Search for a sport..." class="w-full pt-5 pb-2 pl-12 pr-5 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base" />
                                    <!-- Sports Dropdown -->
                                    <div id="sports-dropdown" class="absolute right-0 top-full mt-2 z-50 bg-white border border-gray-200 rounded-md shadow-lg hidden max-w-[calc(100vw-2rem)]">
                                        <button id="sports-clear" type="button" class="absolute top-2 right-2 text-sm text-blue-600 hover:underline">Clear</button>
                                        <div class="flex items-start justify-start">
                                            <div class="flex flex-col">
                                                <div class="p-2 pb-0">
                                                    <div class="relative flex items-center justify-center">
                                                        <i data-lucide="search" class="absolute left-3 h-4 w-4 text-[rgb(34,34,34)]" aria-hidden="true"></i>
                                                        <input id="sports-search" placeholder="Search for a sport..." class="w-full rounded-md border border-gray-200 py-2 pl-9 pr-3 text-sm focus:ring-blue-500 focus:border-blue-500" type="text" value="">
                                                    </div>
                                                </div>
                                                <div class="flex max-h-[400px] w-[min(800px,calc(100vw-2rem))] flex-row gap-x-4 overflow-y-auto p-4">
                                                    <div class="flex flex-1 flex-col border-r border-gray-200 pr-4">
                                                        <div class="mb-2 border-b border-gray-200 pb-2">
                                                            <div class="-ml-2 flex cursor-pointer items-center space-x-3 rounded-md p-2 hover:bg-gray-100">
                                                                <input class="h-4 w-4 cursor-pointer rounded border-gray-200 text-blue-600 focus:ring-blue-500" type="checkbox">
                                                                <strong class="text-left text-xs font-bold uppercase text-gray-500">Super Social Sports</strong>
                                                            </div>
                                                        </div>
                                                        <div class="grid gap-y-1" id="sports-list-left">
                                                            <div class="flex cursor-pointer items-center space-x-3 rounded-md p-2 hover:bg-gray-100"><input data-sport="Bowling" class="h-4 w-4 cursor-pointer rounded border-gray-200 text-blue-600 focus:ring-blue-500" type="checkbox"><span class="text-sm font-medium text-gray-800">Bowling</span></div>
                                                            <div class="flex cursor-pointer items-center space-x-3 rounded-md p-2 hover:bg-gray-100"><input data-sport="Axe Throwing" class="h-4 w-4 cursor-pointer rounded border-gray-200 text-blue-600 focus:ring-blue-500" type="checkbox"><span class="text-sm font-medium text-gray-800">Axe Throwing</span></div>
                                                            <div class="flex cursor-pointer items-center space-x-3 rounded-md p-2 hover:bg-gray-100"><input data-sport="Cornhole" class="h-4 w-4 cursor-pointer rounded border-gray-200 text-blue-600 focus:ring-blue-500" type="checkbox"><span class="text-sm font-medium text-gray-800">Cornhole</span></div>
                                                            <div class="flex cursor-pointer items-center space-x-3 rounded-md p-2 hover:bg-gray-100"><input data-sport="Kickball" class="h-4 w-4 cursor-pointer rounded border-gray-200 text-blue-600 focus:ring-blue-500" type="checkbox"><span class="text-sm font-medium text-gray-800">Kickball</span></div>
                                                            <div class="flex cursor-pointer items-center space-x-3 rounded-md p-2 hover:bg-gray-100"><input data-sport="Dodgeball" class="h-4 w-4 cursor-pointer rounded border-gray-200 text-blue-600 focus:ring-blue-500" type="checkbox"><span class="text-sm font-medium text-gray-800">Dodgeball</span></div>
                                                            <div class="flex cursor-pointer items-center space-x-3 rounded-md p-2 hover:bg-gray-100"><input data-sport="Bar Games" class="h-4 w-4 cursor-pointer rounded border-gray-200 text-blue-600 focus:ring-blue-500" type="checkbox"><span class="text-sm font-medium text-gray-800">Bar Games</span></div>
                                                            <div class="flex cursor-pointer items-center space-x-3 rounded-md p-2 hover:bg-gray-100"><input data-sport="Skeeball" class="h-4 w-4 cursor-pointer rounded border-gray-200 text-blue-600 focus:ring-blue-500" type="checkbox"><span class="text-sm font-medium text-gray-800">Skeeball</span></div>
                                                        </div>
                                                    </div>
                                                    <div class="h-full w-px bg-gray-200"></div>
                                                    <div class="flex flex-1 flex-col border-r-0 border-gray-200 pr-4">
                                                        <div class="mb-2 border-b border-gray-200 pb-2">
                                                            <div class="-ml-2 flex cursor-pointer items-center space-x-3 rounded-md p-2 hover:bg-gray-100">
                                                                <input class="h-4 w-4 cursor-pointer rounded border-gray-200 text-blue-600 focus:ring-blue-500" type="checkbox">
                                                                <strong class="text-left text-xs font-bold uppercase text-gray-500">Social &amp; Competitive Sports</strong>
                                                            </div>
                                                        </div>
                                                        <div class="grid gap-y-1" id="sports-list-right">
                                                            <div class="flex cursor-pointer items-center space-x-3 rounded-md p-2 hover:bg-gray-100"><input data-sport="Ultimate Frisbee" class="h-4 w-4 cursor-pointer rounded border-gray-200 text-blue-600 focus:ring-blue-500" type="checkbox"><span class="text-sm font-medium text-gray-800">Ultimate Frisbee</span></div>
                                                            <div class="flex cursor-pointer items-center space-x-3 rounded-md p-2 hover:bg-gray-100"><input data-sport="Soccer" class="h-4 w-4 cursor-pointer rounded border-gray-200 text-blue-600 focus:ring-blue-500" type="checkbox"><span class="text-sm font-medium text-gray-800">Soccer</span></div>
                                                            <div class="flex cursor-pointer items-center space-x-3 rounded-md p-2 hover:bg-gray-100"><input data-sport="Softball" class="h-4 w-4 cursor-pointer rounded border-gray-200 text-blue-600 focus:ring-blue-500" type="checkbox"><span class="text-sm font-medium text-gray-800">Softball</span></div>
                                                            <div class="flex cursor-pointer items-center space-x-3 rounded-md p-2 hover:bg-gray-100"><input data-sport="Basketball" class="h-4 w-4 cursor-pointer rounded border-gray-200 text-blue-600 focus:ring-blue-500" type="checkbox"><span class="text-sm font-medium text-gray-800">Basketball</span></div>
                                                            <div class="flex cursor-pointer items-center space-x-3 rounded-md p-2 hover:bg-gray-100"><input data-sport="Flag Football" class="h-4 w-4 cursor-pointer rounded border-gray-200 text-blue-600 focus:ring-blue-500" type="checkbox"><span class="text-sm font-medium text-gray-800">Flag Football</span></div>
                                                            <div class="flex cursor-pointer items-center space-x-3 rounded-md p-2 hover:bg-gray-100"><input data-sport="Volleyball" class="h-4 w-4 cursor-pointer rounded border-gray-200 text-blue-600 focus:ring-blue-500" type="checkbox"><span class="text-sm font-medium text-gray-800">Volleyball</span></div>
                                                            <div class="flex cursor-pointer items-center space-x-3 rounded-md p-2 hover:bg-gray-100"><input data-sport="Pickleball" class="h-4 w-4 cursor-pointer rounded border-gray-200 text-blue-600 focus:ring-blue-500" type="checkbox"><span class="text-sm font-medium text-gray-800">Pickleball</span></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="border-t border-gray-200 p-2 text-right">
                                            <button id="sports-done" type="button" class="inline-flex items-center px-3 py-1.5 rounded-md bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700">Done</button>
                                        </div>
                                    </div>
                                    <!-- Hidden container to hold applied sports inputs (drives pills) -->
                                    <div id="applied-sports-inputs" class="hidden"></div>
                                </div>
                            </div>
                            <!-- Search Button -->
                            <div class="md:col-span-1 flex items-stretch gap-2">
                                <!-- Mobile: full-width CTA -->
                                <button id="mobile-search-btn" aria-label="Search" title="Search" class="md:hidden h-[52px] w-full flex items-center justify-center rounded-xl bg-[#0034DD] text-white font-bold hover:bg-[#002ACC] transition border border-[#0034DD]">
                                    Search
                                </button>
                                <!-- Desktop/Tablet: circular icon -->
                                <button id="desktop-search-btn" aria-label="Search" title="Search" class="hidden md:flex h-[52px] w-[52px] items-center justify-center rounded-full bg-[#c7ff10] text-black font-bold hover:brightness-95 transition border border-[#c7ff10]">
                                    <i data-lucide="search" class="h-5 w-5"></i>
                                </button>
                            </div>
                        </div>
                    </section>
                    <!-- Results heading + filter pills in one row -->
                    <div class="flex flex-wrap items-center gap-2 mb-6">
                        <h2 id="results-heading" class="text-sm font-medium">0 ways to play</h2>
                        <div id="filter-pills-container-list" class="flex flex-wrap gap-2 items-center"></div>
                    </div>

                    <!-- Dynamic Activity Cards -->
                    <div id="activity-cards-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                    <!-- Pagination -->
                    <div id="pagination-container" class="mt-4 flex flex-wrap items-center gap-2"></div>
                    <!-- Non-matching guidance and results -->
                    <section id="nonmatching-section" class="mt-8 space-y-4 hidden">
                        <!-- Cross-sell banner (moved above guidance) -->
                        <div id="cross-sell-banner" class="hidden mb-4"></div>
                        <div class="text-center">
                            <h3 class="text-base font-semibold text-gray-800">Try removing filters to see more activities</h3>
                            <div id="centered-applied-pills" class="mt-3 flex flex-wrap justify-center gap-2"></div>
                            <div class="mt-2">
                                <button type="button" class="text-sm text-blue-600 hover:underline font-normal" data-action="remove-all">Remove all filters</button>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-base font-semibold text-gray-800 mb-2">Activities that don't match all your filters</h4>
                            <div id="nonmatching-cards-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                        </div>
                    </section>
                    <!-- Local file loader (fallback for file:// protocol when auto-fetch fails) -->
                    <div id="local-file-loader" class="hidden">
                        <div class="rounded-lg border border-yellow-300 bg-yellow-50 p-3 text-yellow-900">
                            <p class="text-sm mb-2">Running without a server detected. Select your leagues.json, tournaments.json, and (optional) daily-sports.json to load data locally:</p>
                            <input id="local-file-input" type="file" accept="application/json,.json,.ndjson,.jsonl" multiple class="text-sm" />
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Full Screen Map View -->
    <div id="map-view-container" class="hidden">
        <div id="map-container">
            <div id="map"></div>
        </div>

        <!-- Map UI Elements Overlay: allow map interactions except on actual UI -->
        <div id="map-overlay" class="absolute inset-0 z-[60] pointer-events-none">
            <!-- Top bar -->
            <div class="absolute top-0 left-0 right-0 pointer-events-auto">
                <!-- Search summary bar as secondary nav -->
                <div class="w-full bg-white border-b border-gray-200 shadow-sm">
                    <div class="px-4 py-2 flex items-center gap-2">
                        <button id="back-to-list-btn" aria-label="Back to list" class="inline-flex items-center gap-2 shrink-0 rounded-full border border-[#0034DD] bg-[#0034DD] text-white text-sm font-semibold px-2 md:px-3 py-1 md:py-1.5 shadow-md hover:bg-[#002ACC] focus:outline-none focus:ring-2 focus:ring-white/70">
                            <i data-lucide="arrow-left" class="w-5 h-5"></i>
                            <span class="hidden md:inline">Back to list</span>
                        </button>
                        <div id="map-search-summary" class="flex-1 min-w-0 text-[16px] text-blue font-medium truncate ml-2">
                            <!-- Filled dynamically: City · Activity · Sports -->
                        </div>
                    </div>
                </div>
                <div class="w-full mx-auto relative">
                    <div id="map-topbar" class="relative flex items-center gap-2 p-4">
                        <!-- Filter Pills for map view -->
                        <div id="filter-pills-container-map" class="flex-1 flex flex-nowrap overflow-x-auto no-scrollbar gap-2 items-center w-full md:w-auto pr-1 whitespace-nowrap"></div>
                    </div>
                    <!-- Map filter dropdown panel (shows a filter group's content) -->
                    <div id="map-filter-backdrop" class="hidden fixed inset-0 z-[95] pointer-events-auto"></div>
                    <div id="map-filter-panel" class="hidden fixed md:absolute inset-x-0 bottom-0 md:inset-auto z-[100] pointer-events-auto">
                        <div class="relative bg-white md:inline-block md:w-96 w-full max-h-[75vh] md:max-h-none md:rounded-lg md:border md:border-gray-200 md:shadow-md rounded-t-2xl overflow-hidden">
                            <!-- Mobile drawer handle -->
                            <div class="md:hidden absolute top-2 left-1/2 -translate-x-1/2 w-10 h-1 rounded bg-[rgba(32,32,32,0.2)]"></div>
                            <div class="px-3 py-6 md:py-2 border-b border-gray-200 flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <span id="map-filter-panel-icon-wrap" class="inline-flex items-center justify-center">
                                        <!-- icon injected dynamically -->
                                    </span>
                                    <h4 id="map-filter-panel-title" class="font-semibold text-lg"></h4>
                                </div>
                                <button id="map-filter-panel-clear" type="button" class="text-sm text-blue-600 hover:underline">Clear</button>
                            </div>
                            <div id="map-filter-panel-body" class="p-3 md:max-h-[60vh] max-h-[55vh] overflow-auto"></div>
                            <div class="px-3 py-2 border-t border-gray-200 text-right">
                                <button id="map-filter-panel-done" type="button" class="inline-flex items-center px-3 py-1.5 rounded-md bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700">Done</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Card on Map -->
            <div id="map-activity-card-container" class="absolute bottom-0 left-0 right-0 p-4 hidden pointer-events-auto z-30">
                <div class="w-full max-w-[1600px] mx-auto">
                    <!-- Card content will be injected here by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile floating View in Map button -->
    <button id="mobile-view-map" class="fixed md:hidden bottom-4 left-1/2 -translate-x-1/2 z-40 rounded-full bg-[#0034DD] text-white px-5 py-3 text-sm font-bold shadow-xl border border-[#0034DD]">
        View in Map
    </button>

    <!-- Mobile Filters Overlay -->
    <div id="mobile-filters-overlay" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0" data-overlay-close></div>
        <div class="absolute inset-0 bg-white flex flex-col">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-base font-semibold">Filters</h3>
                <button id="mobile-filters-close" class="text-sm text-gray-600">Close</button>
            </div>
            <div id="mobile-filters-body" class="flex-1 overflow-y-auto p-0">
                <!-- filters-form will be moved in here on open -->
            </div>
            <div class="border-t border-gray-200 p-3 bg-white">
                <button id="mobile-filters-done" class="w-full inline-flex items-center justify-center rounded-full px-4 py-3 text-sm font-bold border border-[#0034DD] bg-[#0034DD] text-white hover:bg-[#002ACC]">Done</button>
            </div>
        </div>
    </div>
    
    <script src="./venue-locations.js"></script>
        <script src="./experience-elevators.js"></script>

        <!-- Inline template for the multi-step Wizard (used when fetch is unavailable, e.g., file://) -->
        <template id="wizard-template">
            <div id="wizard-modal" class="fixed inset-0 z-[120] hidden" role="dialog" aria-modal="true" aria-labelledby="wizard-title" data-wizard-mode="multi">
                <div class="absolute inset-0 bg-black/50" data-wizard-close></div>
                <div class="relative mx-auto my-6 w-[92%] max-w-2xl rounded-2xl bg-white shadow-xl border border-gray-200 overflow-hidden">
                    <div class="px-5 py-4 border-b border-gray-200 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <i data-lucide="sparkles" class="h-5 w-5 text-blue-600"></i>
                            <h3 id="wizard-title" class="text-lg font-semibold">Find your fun</h3>
                        </div>
                        <button type="button" class="text-gray-500 hover:text-gray-700" data-wizard-close aria-label="Close">
                            <i data-lucide="x" class="h-5 w-5"></i>
                        </button>
                    </div>
                    <div class="p-5">
                        <div id="wizard-steps" class="space-y-6">
                            <section id="wizard-step-1" class="space-y-4" data-step>
                                <div>
                                    <p class="text-sm text-gray-600">Not sure what you’re looking for?</p>
                                    <p class="text-base font-semibold text-gray-900">Hey Baltimore! 🦀 I’m your Volo City Guide. Let’s find your next game.</p>
                                    <p class="text-sm text-gray-700">What’s the main vibe you’re looking for?</p>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                    <button type="button" class="rounded-2xl border border-gray-300 p-4 text-left hover:border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-600" data-choice="goal" data-value="league">
                                        <div class="flex items-center gap-2"><i data-lucide="trophy" class="h-5 w-5 text-yellow-600"></i><span class="font-semibold">Join a team for a full season</span></div>
                                        <p class="mt-1 text-xs text-gray-600">Multi-week League. Play weekly and chase the trophy. 🏆</p>
                                    </button>
                                    <button type="button" class="rounded-2xl border border-gray-300 p-4 text-left hover:border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-600" data-choice="goal" data-value="daily">
                                        <div class="flex items-center gap-2"><i data-lucide="zap" class="h-5 w-5 text-orange-600"></i><span class="font-semibold">Just want a one-time game</span></div>
                                        <p class="mt-1 text-xs text-gray-600">Daily Sports. Drop-in or Pickup on your schedule. ⚡</p>
                                    </button>
                                    <button type="button" class="rounded-2xl border border-gray-300 p-4 text-left hover:border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-600" data-choice="goal" data-value="tournament">
                                        <div class="flex items-center gap-2"><i data-lucide="flag" class="h-5 w-5 text-blue-700"></i><span class="font-semibold">A single-day competition</span></div>
                                        <p class="mt-1 text-xs text-gray-600">Tournaments. High energy, winner takes bragging rights. 🥇</p>
                                    </button>
                                    <button type="button" class="rounded-2xl border border-gray-300 p-4 text-left hover:border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-600" data-choice="goal" data-value="browse">
                                        <div class="flex items-center gap-2"><i data-lucide="compass" class="h-5 w-5 text-gray-700"></i><span class="font-semibold">I’m just browsing</span></div>
                                        <p class="mt-1 text-xs text-gray-600">We’ll still help you narrow it down. 👟</p>
                                    </button>
                                </div>
                            </section>
                            <section id="wizard-step-2a" class="space-y-3 hidden" data-step>
                                <p class="text-base font-semibold">Awesome! You’re talking about a League 🏆</p>
                                <p class="text-sm text-gray-700">Our most popular option. Sign up solo, with friends, or a full team for a multi-week season. One game a week and playoffs at the end. Sound right?</p>
                                <div class="flex flex-wrap gap-2">
                                    <button type="button" class="px-3 py-1.5 rounded-full bg-blue-600 text-white text-sm font-semibold" data-confirm="league">Yep, let’s find a league!</button>
                                    <button type="button" class="px-3 py-1.5 rounded-full border border-gray-300 text-sm" data-goback>Tell me the other options</button>
                                </div>
                            </section>
                            <section id="wizard-step-2b" class="space-y-3 hidden" data-step>
                                <p class="text-base font-semibold">Got it! Daily Sports ⚡</p>
                                <p class="text-sm text-gray-700">Perfect for a flexible schedule: one-time pickup games, drop-ins, and single events. No season commitment. Is that the one?</p>
                                <div class="flex flex-wrap gap-2">
                                    <button type="button" class="px-3 py-1.5 rounded-full bg-blue-600 text-white text-sm font-semibold" data-confirm="daily">That’s me! Let’s play!</button>
                                    <button type="button" class="px-3 py-1.5 rounded-full border border-gray-300 text-sm" data-goback>What else is there?</button>
                                </div>
                            </section>
                            <section id="wizard-step-2c" class="space-y-3 hidden" data-step>
                                <p class="text-base font-semibold">LFG! Tournament time 🥇</p>
                                <p class="text-sm text-gray-700">Single-day competition with multiple games and high energy. Ready?</p>
                                <div class="flex flex-wrap gap-2">
                                    <button type="button" class="px-3 py-1.5 rounded-full bg-blue-600 text-white text-sm font-semibold" data-confirm="tournament">I’m in! Show me tourneys!</button>
                                    <button type="button" class="px-3 py-1.5 rounded-full border border-gray-300 text-sm" data-goback>Go back</button>
                                </div>
                            </section>
                            <section id="wizard-step-3" class="space-y-3 hidden" data-step>
                                <p class="text-base font-semibold">What do you want to play? 👟</p>
                                <div id="wizard-sports-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
                                <p class="text-xs text-gray-500">Tip: You can change this later.</p>
                            </section>
                            <section id="wizard-step-4" class="space-y-4 hidden" data-step>
                                <p class="text-base font-semibold">Dial in the perfect game</p>
                                <p class="text-sm text-gray-700">Tap all the must-haves. You can skip this if you want.</p>
                                <div class="space-y-3" id="wizard-pill-pool">
                                    <div>
                                        <p class="text-sm font-semibold mb-1">Skill Level</p>
                                        <div class="flex flex-wrap gap-2" data-pill-group="skill">
                                            <button type="button" class="pill" data-pill="skill" data-value="Social/Beginner">Super Social</button>
                                            <button type="button" class="pill" data-pill="skill" data-value="Recreational">Recreational</button>
                                            <button type="button" class="pill" data-pill="skill" data-value="Intermediate">Intermediate</button>
                                            <button type="button" class="pill" data-pill="skill" data-value="Competitive">Competitive</button>
                                        </div>
                                    </div>
                                    <div>
                                        <p class="text-sm font-semibold mb-1">Format</p>
                                        <div class="flex flex-wrap gap-2" data-pill-group="composition">
                                            <button type="button" class="pill" data-pill="composition" data-value="Coed">Coed</button>
                                            <button type="button" class="pill" data-pill="composition" data-value="Men's">Men's</button>
                                            <button type="button" class="pill" data-pill="composition" data-value="Women's">Women's</button>
                                        </div>
                                    </div>
                                    <div>
                                        <p class="text-sm font-semibold mb-1">Day of Week</p>
                                        <div class="flex flex-wrap gap-2" data-pill-group="dow">
                                            <button type="button" class="pill" data-pill="dow" data-value="weekdays">Weekdays</button>
                                            <button type="button" class="pill" data-pill="dow" data-value="weekends">Weekends</button>
                                        </div>
                                    </div>
                                    <div>
                                        <p class="text-sm font-semibold mb-1">Vibe</p>
                                        <div class="flex flex-wrap gap-2" data-pill-group="vibe">
                                            <button type="button" class="pill" data-pill="vibe" data-value="Bar on Site">Bar on Site 🍻</button>
                                            <button type="button" class="pill" data-pill="vibe" data-value="Kid-Friendly">Kid-Friendly</button>
                                            <button type="button" class="pill" data-pill="vibe" data-value="Indoor">Indoors</button>
                                        </div>
                                    </div>
                                </div>
                                <style>
                                    .pill { padding: 0.375rem 0.75rem; border-radius: 9999px; border: 1px solid #d1d5db; font-size: 0.875rem; line-height: 1.25rem; color: #374151; background: #ffffff; }
                                    .pill[data-selected="true"] { background: #2563eb; color: #ffffff; border-color: #2563eb; }
                                </style>
                            </section>
                            <section id="wizard-step-5" class="space-y-4 hidden" data-step>
                                <div class="space-y-1">
                                    <p class="text-base font-semibold">All set!</p>
                                    <p id="wizard-summary" class="text-sm text-gray-700"></p>
                                </div>
                                <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                                    <a id="wizard-results-link" href="#" class="inline-flex items-center justify-center px-4 py-2 rounded-full bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700" target="_self">See your custom results</a>
                                    <button type="button" class="text-sm text-blue-700 underline" data-wizard-restart>Want to start over?</button>
                                </div>
                            </section>
                        </div>
                    </div>
                    <div class="px-5 py-3 border-t border-gray-200 flex items-center justify-between bg-white">
                        <button type="button" class="px-3 py-1.5 rounded-md text-sm text-gray-700 hover:bg-gray-50" data-wizard-back disabled>Back</button>
                        <div class="flex items-center gap-2">
                            <button type="button" class="px-3 py-1.5 rounded-md border border-gray-300 text-sm text-gray-700 hover:bg-gray-50" data-wizard-close>Cancel</button>
                            <button type="button" class="px-3 py-1.5 rounded-md bg-blue-600 text-white text-sm font-semibold" data-wizard-next>Next</button>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    <script>
    // --- DATA --- (prepared for upcoming dataset schema)
    let activities = [];
    const pagination = { page: 1, perPage: 18 };

        // --- ELEMENTS ---
        const listView = document.getElementById('list-view-container');
        const mapView = document.getElementById('map-view-container');
        const viewMapBtn = document.getElementById('view-map-btn');
        const backToListBtn = document.getElementById('back-to-list-btn');
        const filtersForm = document.getElementById('filters-form');
    // Note: filter inputs can live inside or outside filtersForm.
    // We'll query them dynamically when needed.
        const listPillsContainer = document.getElementById('filter-pills-container-list');
        const mapPillsContainer = document.getElementById('filter-pills-container-map');
    const mapActivityCardContainer = document.getElementById('map-activity-card-container');
    const mapFilterPanel = document.getElementById('map-filter-panel');
    const mapFilterBackdrop = document.getElementById('map-filter-backdrop');
    const mapFilterPanelBody = document.getElementById('map-filter-panel-body');
    const mapFilterPanelTitle = document.getElementById('map-filter-panel-title');
    const mapFilterPanelClear = document.getElementById('map-filter-panel-clear');
    const mapFilterPanelDone = document.getElementById('map-filter-panel-done');
        
        let map; // Google Map instance for full screen
    let previewMap; // Google Map instance for preview
    let markers = []; // To hold map markers
    // Track last selected Activities scope so we only run scope-entry side effects once
    window.__lastActivitiesScope = window.__lastActivitiesScope || '';
    const activityCardsContainer = document.getElementById('activity-cards-container');
        const resultsHeading = document.getElementById('results-heading');

        function updateResultsHeading() {
            if(!resultsHeading) return;
            const count = (typeof getFilteredActivities === 'function') ? getFilteredActivities().length : activities.length;
            resultsHeading.textContent = `${count} ways to play`;
        }

        // --- MEDIA (Carousel & Video) ---
        function hasGlowKickballVideo(activity) {
            const t = String(activity.program_name || activity.title || '').toLowerCase();
            return t.includes('glow') && t.includes('kickball') && t.includes('flip cup') && t.includes('columbia');
        }
        function buildVideoSlide(videoId) {
            // Build a robust YouTube embed URL with safe defaults and origin when available (prevents config errors)
            const isHttpOrigin = typeof window !== 'undefined' && window.location && /^https?:/.test(window.location.origin || '');
            const originParam = isHttpOrigin ? `&origin=${encodeURIComponent(window.location.origin)}` : '';
            const base = 'https://www.youtube.com/embed/';
            const params = `autoplay=1&mute=1&loop=1&playlist=${videoId}&controls=0&modestbranding=1&playsinline=1&rel=0${originParam}`;
            const src = `${base}${videoId}?${params}`;
            // Center-crop trick for portrait content: oversize width and center
            return `
                <div class="media-slide absolute inset-0 opacity-0 pointer-events-none transition-opacity duration-300">
                    <div class="absolute inset-0 overflow-hidden bg-black">
                        <iframe class="yt-cover" src="${src}" title="Video" frameborder="0" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen playsinline referrerpolicy="origin-when-cross-origin"></iframe>
                    </div>
                </div>`;
        }
        function buildImageSlide(url, alt) {
            return `
                <div class="media-slide absolute inset-0 opacity-0 pointer-events-none transition-opacity duration-300">
                    <img src="${url}" alt="${alt}" class="w-full h-full object-cover" onerror="handleImgError(event)" />
                </div>`;
        }

                // --- WIZARD LOADER & HANDLERS ---
        let __wizardModalEl = null;
        let __wizardLoadPromise = null;
            // Helper to coerce currency strings like "$20.00" to numbers
            const toNum = (v) => {
                if (v == null || v === '') return null;
                if (typeof v === 'number') return Number.isFinite(v) ? v : null;
                const n = Number(String(v).replace(/[^0-9.]/g, ''));
                return Number.isFinite(n) ? n : null;
            };
        // Receive selections from the standalone wizard (iframe)
        if (!window.__wizardMessageHandlerInstalled) {
            window.addEventListener('message', (evt) => {
                try {
                    const data = evt && evt.data ? evt.data : {};
                    if (!data || data.source !== 'volo-wizard') return;
                    if (data.type === 'apply') {
                        if (!data.payload) return;
                        applyWizardPayloadFromIframe(data.payload);
                    } else if (data.type === 'close') {
                        if (__wizardModalEl) __wizardModalEl.classList.add('hidden');
                    }
                } catch(_) {}
            });
            window.__wizardMessageHandlerInstalled = true;
        }
        function applyWizardPayloadFromIframe(payload) {
            if (!payload || !payload.filters) return;
            // Activity selection
            const actInput = document.getElementById('activities');
            const mapAct = (t) => {
                const s = String(t||'').toLowerCase();
                if (s.startsWith('league')) return 'Leagues';
                if (s.startsWith('daily')) return 'Daily Sports';
                if (s.startsWith('tournament')) return 'Tournaments';
                return '';
            };
            const target = mapAct(payload.activity_type);
            if (actInput && target) actInput.value = target;
            // Clear daily radios if not daily
            if (!/^daily/i.test(target)) {
                document.querySelectorAll('input[type="radio"][name="daily-type"]').forEach(r => { r.checked = false; });
            }
            // Sports
            try {
                (payload.sports || []).forEach(name => {
                    const sel = `#sports-dropdown input[type="checkbox"][data-sport="${String(name).replace(/"/g, '\\"')}"]`;
                    const cb = document.querySelector(sel);
                    if (cb) cb.checked = true;
                });
                if (typeof renderAppliedSportsInputs === 'function') renderAppliedSportsInputs();
                if (typeof updateSportsFieldValue === 'function') updateSportsFieldValue();
            } catch(_) {}
            // Formats (composition)
            const compIds = { coed: 'comp-coed', mens: 'comp-mens', womens: 'comp-womens', open: 'comp-open' };
            (payload.filters.format || []).forEach(v => { const id = compIds[v]; const el = id && document.getElementById(id); if (el) el.checked = true; });
            // Skill
            const skillIds = { comp: 'skill-competitive', int: 'skill-intermediate', rec: 'skill-recreational', social: 'skill-beginner' };
            (payload.filters.skill || []).forEach(v => { const id = skillIds[v]; const el = id && document.getElementById(id); if (el) el.checked = true; });
            // Days
            const days = payload.filters.day || [];
            if (days.includes('weekdays')) {
                ['day-mon','day-tue','day-wed','day-thu','day-fri'].forEach(id => { const el = document.getElementById(id); if (el) el.checked = true; });
            }
            if (days.includes('weekends')) {
                ['day-sat','day-sun'].forEach(id => { const el = document.getElementById(id); if (el) el.checked = true; });
            }
            // Vibes / features
            (payload.filters.vibe || []).forEach(v => {
                if (v === 'bar') {
                    ['hl-bar-site','soc-bar-site'].forEach(id => { const el = document.getElementById(id); if (el) el.checked = true; });
                } else if (v === 'indoors') {
                    const el = document.getElementById('surface-indoor'); if (el) el.checked = true;
                } else if (v === 'kids') {
                    // no-op: not directly mapped
                }
            });
            if (typeof applyActivityTypeFilterVisibility === 'function') applyActivityTypeFilterVisibility();
            if (typeof applyFiltersAndRerender === 'function') applyFiltersAndRerender();
            // Hide modal if present
            if (__wizardModalEl) __wizardModalEl.classList.add('hidden');
            // Scroll to results
            if (typeof scrollToTopOfResults === 'function') scrollToTopOfResults();
        }
        async function loadWizardModal() {
            try {
                if (__wizardModalEl) return __wizardModalEl;
                // Prefer external wizard in an iframe for easy testing/tweaking; fallback to inline template
                let modal = null;
                // Build iframe modal wrapper
                modal = document.createElement('div');
                modal.id = 'wizard-iframe-modal';
                modal.className = 'fixed inset-0 z-[120] hidden';
                modal.setAttribute('role','dialog');
                modal.setAttribute('aria-modal','true');
                modal.dataset.wizardMode = 'iframe';
                const cacheBust = Date.now();
                modal.innerHTML = `
                    <div class="absolute inset-0 bg-black/50" data-wizard-close></div>
                    <div class="absolute inset-0">
                        <div class="absolute inset-0 flex items-center justify-center text-sm text-gray-200" data-wizard-loading>Loading wizard…</div>
                        <iframe src="./wizard.html?t=${cacheBust}" title="Wizard" class="w-full h-full" style="border:0; background: transparent;" referrerpolicy="no-referrer"></iframe>
                    </div>`;
                document.body.appendChild(modal);
                // Close events
                const closeButtonsLegacy = modal.querySelectorAll('[data-wizard-close]');
                closeButtonsLegacy.forEach(btn => btn.addEventListener('click', () => { modal.classList.add('hidden'); }));
                // no external open link; iframe is full content
                __wizardModalEl = modal;
                return __wizardModalEl;
                if (!modal) return null;
                // Wire events
                const closeButtonsLegacy2 = modal.querySelectorAll('[data-wizard-close]');
                closeButtonsLegacy2.forEach(btn => btn.addEventListener('click', () => { modal.classList.add('hidden'); }));
                // Backdrop click closes
                const backdrop = modal.firstElementChild;
                if (backdrop && backdrop.classList && backdrop.classList.contains('absolute')) {
                    backdrop.addEventListener('click', () => { modal.classList.add('hidden'); });
                }
                // If multi-step wizard, initialize enhanced flow and short-circuit legacy wiring
                if (modal.dataset && modal.dataset.wizardMode === 'multi') {
                    initializeMultiWizard(modal);
                    __wizardModalEl = modal;
                    return __wizardModalEl;
                }
                function setSelection(val) {
                    modal.querySelectorAll('[data-wizard-select]').forEach(b => {
                        const selected = (b.getAttribute('data-wizard-select') === val);
                        if (selected) b.setAttribute('data-selected', 'true'); else b.removeAttribute('data-selected');
                        b.classList.toggle('ring-2', selected);
                        b.classList.toggle('ring-blue-600', selected);
                        b.classList.toggle('border-blue-600', selected);
                    });
                    const edu = modal.querySelector('#wizard-edu');
                    if (edu) {
                        let msg = '';
                        if (val === 'leagues') msg = 'Weekly games and playoffs. Sign up solo, with friends, or a full team — we guarantee a game every week.';
                        if (val === 'dropin') msg = 'Jump in for a single game. Try a new sport or join friends without the season-long commitment.';
                        if (val === 'pickup') msg = 'Just show up. We handle the teams and gear. Perfect for spontaneous play and packed schedules.';
                        edu.textContent = msg;
                        edu.classList.toggle('hidden', !msg);
                    }
                    const applyBtn = modal.querySelector('[data-wizard-apply]');
                    if (applyBtn) applyBtn.disabled = !val;
                    modal.dataset.selection = val || '';
                }
                // Expose setter for opener to preselect current scope
                modal.__setSelection = setSelection;
                modal.addEventListener('click', (e) => {
                    const selBtn = e.target.closest('[data-wizard-select]');
                    if (selBtn) {
                        setSelection(selBtn.getAttribute('data-wizard-select'));
                    }
                });
                const applyBtn = modal.querySelector('[data-wizard-apply]');
                if (applyBtn) {
                    applyBtn.addEventListener('click', () => {
                        const sel = modal.dataset.selection || '';
                        // Apply filters based on selection
                        const activitiesInput = document.getElementById('activities');
                        if (sel === 'leagues') {
                            if (activitiesInput) activitiesInput.value = 'Leagues';
                            // Clear daily radios
                            document.querySelectorAll('input[type="radio"][name="daily-type"]').forEach(r => { r.checked = false; });
                        } else if (sel === 'dropin') {
                            if (activitiesInput) activitiesInput.value = 'Daily Sports';
                            const r = document.getElementById('daily-dropin'); if (r) r.checked = true;
                        } else if (sel === 'pickup') {
                            if (activitiesInput) activitiesInput.value = 'Daily Sports';
                            const r = document.getElementById('daily-pickup'); if (r) r.checked = true;
                        }
                        // Apply and close
                        if (typeof applyActivityTypeFilterVisibility === 'function') applyActivityTypeFilterVisibility();
                        if (typeof applyFiltersAndRerender === 'function') applyFiltersAndRerender();
                        modal.classList.add('hidden');
                        // Scroll to results area
                        scrollToTopOfResults();
                    });
                }
                // Save reference
                __wizardModalEl = modal;
                return __wizardModalEl;
            } catch (e) {
                console.warn('Wizard modal failed to load:', e);
                // Minimal inline fallback so clicks still open something
                if (!__wizardModalEl) {
                    const fallback = document.createElement('div');
                    fallback.id = 'wizard-fallback';
                    fallback.className = 'fixed inset-0 z-[120] hidden';
                    fallback.innerHTML = `
                        <div class="absolute inset-0 bg-black/50" data-fallback-close></div>
                        <div class="relative mx-auto my-10 w-[92%] max-w-xl rounded-2xl bg-white shadow-xl border border-gray-200 overflow-hidden">
                            <div class="px-5 py-4 border-b border-gray-200 flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="sparkles" class="h-5 w-5 text-blue-600"></i>
                                    <h3 class="text-lg font-semibold">Find your fun</h3>
                                </div>
                                <button type="button" class="text-gray-500 hover:text-gray-700" data-fallback-close aria-label="Close">&times;</button>
                            </div>
                            <div class="p-5 space-y-4">
                                <div>
                                    <p class="text-sm text-gray-600">Not sure what you’re looking for?</p>
                                    <p class="text-base font-medium text-gray-900">Let us help you find your fun.</p>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3" role="group" aria-label="Choose an activity type">
                                    <button type="button" class="group rounded-2xl border border-gray-300 p-4 text-left hover:border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-600" data-wizard-select="leagues">
                                      <i data-lucide="trophy" class="h-6 w-6 text-gray-600 group-data-[selected=true]:text-blue-600"></i>
                                      <div class="mt-2 font-semibold text-gray-900">Leagues</div>
                                      <p class="mt-1 text-xs text-gray-600">Weekly games and playoffs. Sign up solo, with friends, or a full team.</p>
                                    </button>
                                    <button type="button" class="group rounded-2xl border border-gray-300 p-4 text-left hover:border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-600" data-wizard-select="dropin">
                                      <i data-lucide="clock" class="h-6 w-6 text-gray-600 group-data-[selected=true]:text-blue-600"></i>
                                      <div class="mt-2 font-semibold text-gray-900">Drop-ins</div>
                                      <p class="mt-1 text-xs text-gray-600">Jump in for a single game—no season commitment.</p>
                                    </button>
                                    <button type="button" class="group rounded-2xl border border-gray-300 p-4 text-left hover:border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-600" data-wizard-select="pickup">
                                      <i data-lucide="users" class="h-6 w-6 text-gray-600 group-data-[selected=true]:text-blue-600"></i>
                                      <div class="mt-2 font-semibold text-gray-900">Pickups</div>
                                      <p class="mt-1 text-xs text-gray-600">Just show up—we handle teams and gear.</p>
                                    </button>
                                </div>
                                <div id="wizard-edu" class="rounded-xl bg-gray-50 border border-gray-200 p-3 text-sm text-gray-700 hidden"></div>
                            </div>
                            <div class="px-5 py-3 border-t border-gray-200 flex items-center justify-end gap-2 bg-white">
                                <button type="button" class="px-3 py-1.5 rounded-md border border-gray-300 text-sm text-gray-700 hover:bg-gray-50" data-fallback-close>Cancel</button>
                                <button type="button" class="px-3 py-1.5 rounded-md bg-blue-600 text-white text-sm font-semibold disabled:opacity-50 disabled:cursor-not-allowed" data-wizard-apply disabled>Continue</button>
                            </div>
                        </div>`;
                    document.body.appendChild(fallback);
                    // Close events
                    fallback.querySelectorAll('[data-fallback-close]').forEach(el => el.addEventListener('click', ()=> fallback.classList.add('hidden')));
                    // Selection & education
                    function fallbackSetSelection(val){
                        fallback.querySelectorAll('[data-wizard-select]').forEach(b => {
                            const selected = (b.getAttribute('data-wizard-select') === val);
                            if (selected) b.setAttribute('data-selected','true'); else b.removeAttribute('data-selected');
                            b.classList.toggle('ring-2', selected);
                            b.classList.toggle('ring-blue-600', selected);
                            b.classList.toggle('border-blue-600', selected);
                        });
                        const edu = fallback.querySelector('#wizard-edu');
                        if (edu) {
                            let msg = '';
                            if (val === 'leagues') msg = 'Weekly games and playoffs. Sign up solo, with friends, or a full team — we guarantee a game every week.';
                            if (val === 'dropin') msg = 'Jump in for a single game. Try a new sport or join friends without the season-long commitment.';
                            if (val === 'pickup') msg = 'Just show up. We handle the teams and gear. Perfect for spontaneous play and packed schedules.';
                            edu.textContent = msg;
                            edu.classList.toggle('hidden', !msg);
                        }
                        const applyBtn = fallback.querySelector('[data-wizard-apply]');
                        if (applyBtn) applyBtn.disabled = !val;
                        fallback.dataset.selection = val || '';
                    }
                    fallback.addEventListener('click', (e)=>{
                        const selBtn = e.target.closest('[data-wizard-select]');
                        if (selBtn) fallbackSetSelection(selBtn.getAttribute('data-wizard-select'));
                    });
                    const applyBtn = fallback.querySelector('[data-wizard-apply]');
                    if (applyBtn) {
                        applyBtn.addEventListener('click', ()=>{
                            const sel = fallback.dataset.selection || '';
                            const activitiesInput = document.getElementById('activities');
                            if (sel === 'leagues') {
                                if (activitiesInput) activitiesInput.value = 'Leagues';
                                document.querySelectorAll('input[type="radio"][name="daily-type"]').forEach(r => { r.checked = false; });
                            } else if (sel === 'dropin') {
                                if (activitiesInput) activitiesInput.value = 'Daily Sports';
                                const r = document.getElementById('daily-dropin'); if (r) r.checked = true;
                            } else if (sel === 'pickup') {
                                if (activitiesInput) activitiesInput.value = 'Daily Sports';
                                const r = document.getElementById('daily-pickup'); if (r) r.checked = true;
                            }
                            if (typeof applyActivityTypeFilterVisibility === 'function') applyActivityTypeFilterVisibility();
                            if (typeof applyFiltersAndRerender === 'function') applyFiltersAndRerender();
                            fallback.classList.add('hidden');
                            scrollToTopOfResults();
                        });
                    }
                    // Expose setter for opener
                    fallback.__setSelection = fallbackSetSelection;
                    __wizardModalEl = fallback;
                }
                return __wizardModalEl;
            }
        }
        async function ensureWizardLoaded() {
            if (__wizardModalEl) return __wizardModalEl;
            if (!__wizardLoadPromise) __wizardLoadPromise = loadWizardModal();
            return __wizardLoadPromise;
        }
        // Global opener delegation: ensure modal is loaded on demand, even if initial fetch failed
        document.addEventListener('click', async (e) => {
            const openBtn = e.target.closest('[data-action="open-wizard"]');
            if (!openBtn) return;
            e.preventDefault();
            const modal = await ensureWizardLoaded();
            if (!modal) return;
            // Always refresh the iframe to pick up latest wizard.html edits
            const frame = modal.querySelector('iframe');
            if (frame) {
                try {
                    const base = './wizard.html';
                    const sep = base.includes('?') ? '&' : '?';
                    frame.src = `${base}${sep}t=${Date.now()}`;
                    // Hide loader when iframe finishes loading
                    const loader = modal.querySelector('[data-wizard-loading]');
                    frame.addEventListener('load', () => { if (loader) loader.classList.add('hidden'); }, { once: true });
                } catch(_) {}
            }
            // Preselect current scope when opening
            const activitiesInput = document.getElementById('activities');
            const currentVal = (activitiesInput && activitiesInput.value) ? activitiesInput.value.trim().toLowerCase() : '';
            let preSel = '';
            if (currentVal.startsWith('league')) preSel = 'leagues';
            else if (currentVal.startsWith('daily')) {
                const isDropin = document.getElementById('daily-dropin');
                const isPickup = document.getElementById('daily-pickup');
                if (isDropin && isDropin.checked) preSel = 'dropin';
                else if (isPickup && isPickup.checked) preSel = 'pickup';
            }
            // For multi-step, set goal on step 1; for legacy, preselect
            if (modal.dataset && modal.dataset.wizardMode === 'multi') {
                if (preSel) {
                    // Map to goal
                    const goal = preSel === 'leagues' ? 'league' : 'daily';
                    const btn = modal.querySelector(`[data-choice="goal"][data-value="${goal}"]`);
                    if (btn) btn.click();
                }
            } else if (typeof modal.__setSelection === 'function') modal.__setSelection(preSel);
            else if (preSel && modal.querySelector) {
                const btn = modal.querySelector(`[data-wizard-select="${preSel}"]`);
                if (btn) btn.click();
            }
            modal.classList.remove('hidden');
            // Escape closes
            const onKey = (evt) => { if (evt.key === 'Escape') { modal.classList.add('hidden'); document.removeEventListener('keydown', onKey); } };
            document.addEventListener('keydown', onKey);
            // Refresh icons
            if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
        });
        // Enhanced Wizard: Multi-step flow wiring
        function initializeMultiWizard(modal) {
            const state = { goal: '', activity: '', dailyType: 'dropin', sport: '', skill: [], composition: [], dow: '', vibe: [] };
            const steps = Array.from(modal.querySelectorAll('[data-step]'));
            const backBtn = modal.querySelector('[data-wizard-back]');
            const nextBtn = modal.querySelector('[data-wizard-next]');
            const summaryEl = modal.querySelector('#wizard-summary');
            const resultsLink = modal.querySelector('#wizard-results-link');

            function showStep(id) {
                steps.forEach(s => s.classList.toggle('hidden', s.id !== id));
                // Enable/disable Back
                if (backBtn) backBtn.disabled = (id === 'wizard-step-1');
                // Update next text
                if (nextBtn) {
                    nextBtn.textContent = (id === 'wizard-step-5') ? 'Apply' : 'Next';
                }
                // Refresh icons
                if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
            }
            function slugify(str) { return String(str || '').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, ''); }
            function buildSportsGrid() {
                const grid = modal.querySelector('#wizard-sports-grid');
                if (!grid) return;
                const popular = ['Soccer','Basketball','Flag Football','Volleyball','Pickleball','Kickball'];
                // Unique sports from dataset, as backup
                const set = new Set(popular);
                try {
                    (activities || []).forEach(a => { const s = normalizeSportLabel(a.sport || a.program_name || a.title || ''); if (s) set.add(s); });
                } catch(_) {}
                const items = Array.from(set).slice(0, 9);
                grid.innerHTML = '';
                items.forEach(name => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'rounded-xl border border-gray-300 px-3 py-2 text-left hover:border-blue-600';
                    btn.dataset.sport = name;
                    btn.innerHTML = `<span class="font-medium">${name}</span>`;
                    btn.addEventListener('click', () => { state.sport = name; showStep('wizard-step-4'); });
                    grid.appendChild(btn);
                });
                const all = document.createElement('button');
                all.type = 'button';
                all.className = 'rounded-xl border border-gray-300 px-3 py-2 text-left hover:border-blue-600';
                all.dataset.sport = 'all';
                all.innerHTML = `<span class="font-medium">All Sports / Not sure yet</span>`;
                all.addEventListener('click', () => { state.sport = 'all'; showStep('wizard-step-4'); });
                grid.appendChild(all);
            }
            function togglePill(el) {
                const group = el.dataset.pill;
                const val = el.dataset.value;
                const sel = el.getAttribute('data-selected') === 'true';
                if (sel) el.removeAttribute('data-selected'); else el.setAttribute('data-selected', 'true');
                const arr = state[group];
                if (Array.isArray(arr)) {
                    if (sel) state[group] = arr.filter(v => v !== val); else state[group] = arr.concat(val);
                } else {
                    // singular like dow
                    state[group] = sel ? '' : val;
                    // ensure only one selected in UI for singular
                    if (group === 'dow') {
                        const peers = modal.querySelectorAll(`[data-pill="${group}"]`);
                        peers.forEach(p => { if (p !== el) p.removeAttribute('data-selected'); });
                    }
                }
            }
            function mapGoalToActivity(goal) {
                if (goal === 'league') return 'Leagues';
                if (goal === 'daily') return 'Daily Sports';
                if (goal === 'tournament') return 'Tournaments';
                return '';
            }
            function applyStateToFilters() {
                const actInput = document.getElementById('activities');
                const targetActivity = state.activity || mapGoalToActivity(state.goal) || '';
                if (actInput && targetActivity) { actInput.value = targetActivity; }
                // Daily type default
                if (targetActivity.toLowerCase().startsWith('daily')) {
                    const dailyId = state.dailyType === 'pickup' ? 'daily-pickup' : 'daily-dropin';
                    const r = document.getElementById(dailyId); if (r) r.checked = true;
                } else {
                    document.querySelectorAll('input[type="radio"][name="daily-type"]').forEach(r => { r.checked = false; });
                }
                // Sports
                if (state.sport && state.sport !== 'all') {
                    const sel = `#sports-dropdown input[type="checkbox"][data-sport="${String(state.sport).replace(/"/g, '\\"')}"]`;
                    const cb = document.querySelector(sel);
                    if (cb) cb.checked = true;
                    if (typeof renderAppliedSportsInputs === 'function') renderAppliedSportsInputs();
                    if (typeof updateSportsFieldValue === 'function') updateSportsFieldValue();
                }
                // Composition
                const compMap = { "Coed": 'comp-coed', "Men's": 'comp-mens', "Women's": 'comp-womens', 'Open': 'comp-open' };
                (state.composition || []).forEach(name => { const id = compMap[name]; const el = id && document.getElementById(id); if (el) el.checked = true; });
                // Skill
                const skillMap = { 'Competitive':'skill-competitive','Intermediate':'skill-intermediate','Recreational':'skill-recreational','Social/Beginner':'skill-beginner' };
                (state.skill || []).forEach(name => { const id = skillMap[name]; const el = id && document.getElementById(id); if (el) el.checked = true; });
                // Days
                if (state.dow === 'weekdays') {
                    ['day-mon','day-tue','day-wed','day-thu','day-fri'].forEach(id => { const el = document.getElementById(id); if (el) el.checked = true; });
                } else if (state.dow === 'weekends') {
                    ['day-sat','day-sun'].forEach(id => { const el = document.getElementById(id); if (el) el.checked = true; });
                }
                // Vibe
                (state.vibe || []).forEach(v => {
                    if (v === 'Bar on Site') {
                        ['hl-bar-site','soc-bar-site'].forEach(id => { const el = document.getElementById(id); if (el) el.checked = true; });
                    } else if (v === 'Indoor') {
                        const el = document.getElementById('surface-indoor'); if (el) el.checked = true;
                    } else if (v === 'Kid-Friendly') {
                        // No direct filter currently; keep for future mapping
                    }
                });
                if (typeof applyActivityTypeFilterVisibility === 'function') applyActivityTypeFilterVisibility();
                if (typeof applyFiltersAndRerender === 'function') applyFiltersAndRerender();
                scrollToTopOfResults();
            }
            function buildSummary() {
                const parts = [];
                const act = state.activity || mapGoalToActivity(state.goal);
                if (act) parts.push(act);
                if (state.sport && state.sport !== 'all') parts.push(state.sport);
                if (state.skill.length) parts.push(state.skill.join(', '));
                if (state.composition.length) parts.push(state.composition.join(', '));
                if (state.dow) parts.push(state.dow === 'weekdays' ? 'Weekdays' : 'Weekends');
                if (state.vibe.length) parts.push(state.vibe.join(', '));
                return parts.join(' · ');
            }
            function buildShareUrl() {
                const url = new URL(window.location.href.split('#')[0]);
                const params = new URLSearchParams();
                const act = state.activity || mapGoalToActivity(state.goal);
                if (act) params.set('activity', act);
                if ((act || '').toLowerCase().startsWith('daily')) params.set('dailyType', state.dailyType || 'dropin');
                if (state.sport && state.sport !== 'all') params.set('sports', state.sport);
                if (state.skill.length) params.set('skill', state.skill.join(','));
                if (state.composition.length) params.set('composition', state.composition.join(','));
                if (state.dow) params.set('days', state.dow);
                if (state.vibe.length) params.set('features', state.vibe.join(','));
                url.search = params.toString();
                return url.toString();
            }
            function onNext() {
                const visible = steps.find(s => !s.classList.contains('hidden'));
                const id = visible ? visible.id : 'wizard-step-1';
                if (id === 'wizard-step-1') {
                    // If no goal chosen, default to browse
                    if (!state.goal) { state.goal = 'browse'; }
                    if (state.goal === 'league') showStep('wizard-step-2a');
                    else if (state.goal === 'daily') showStep('wizard-step-2b');
                    else if (state.goal === 'tournament') showStep('wizard-step-2c');
                    else showStep('wizard-step-3');
                } else if (id === 'wizard-step-2a' || id === 'wizard-step-2b' || id === 'wizard-step-2c') {
                    showStep('wizard-step-3');
                } else if (id === 'wizard-step-3') {
                    showStep('wizard-step-4');
                } else if (id === 'wizard-step-4') {
                    // Prepare summary and link
                    if (summaryEl) summaryEl.textContent = buildSummary();
                    if (resultsLink) {
                        const href = buildShareUrl();
                        resultsLink.setAttribute('href', href);
                        resultsLink.onclick = (e) => { e.preventDefault(); applyStateToFilters(); modal.classList.add('hidden'); };
                    }
                    showStep('wizard-step-5');
                } else if (id === 'wizard-step-5') {
                    applyStateToFilters();
                    modal.classList.add('hidden');
                }
            }
            function onBack() {
                const visible = steps.find(s => !s.classList.contains('hidden'));
                const id = visible ? visible.id : 'wizard-step-1';
                if (id === 'wizard-step-2a' || id === 'wizard-step-2b' || id === 'wizard-step-2c') showStep('wizard-step-1');
                else if (id === 'wizard-step-3') showStep(state.goal && state.goal !== 'browse' ? (state.goal === 'league' ? 'wizard-step-2a' : state.goal === 'daily' ? 'wizard-step-2b' : 'wizard-step-2c') : 'wizard-step-1');
                else if (id === 'wizard-step-4') showStep('wizard-step-3');
                else if (id === 'wizard-step-5') showStep('wizard-step-4');
            }
            // Event wiring
            modal.addEventListener('click', (e) => {
                const goalBtn = e.target.closest('[data-choice="goal"]');
                if (goalBtn) {
                    state.goal = goalBtn.getAttribute('data-value') || '';
                    if (state.goal === 'league') showStep('wizard-step-2a');
                    else if (state.goal === 'daily') showStep('wizard-step-2b');
                    else if (state.goal === 'tournament') showStep('wizard-step-2c');
                    else showStep('wizard-step-3');
                    return;
                }
                const goback = e.target.closest('[data-goback]');
                if (goback) { showStep('wizard-step-1'); return; }
                const confirmBtn = e.target.closest('[data-confirm]');
                if (confirmBtn) {
                    const kind = confirmBtn.getAttribute('data-confirm');
                    if (kind === 'league') state.activity = 'Leagues';
                    else if (kind === 'daily') state.activity = 'Daily Sports';
                    else if (kind === 'tournament') state.activity = 'Tournaments';
                    showStep('wizard-step-3');
                    return;
                }
                const pill = e.target.closest('.pill');
                if (pill && pill.dataset && pill.dataset.pill) { togglePill(pill); return; }
                const restart = e.target.closest('[data-wizard-restart]');
                if (restart) { state.goal=''; state.activity=''; state.sport=''; state.skill=[]; state.composition=[]; state.dow=''; state.vibe=[]; buildSportsGrid(); showStep('wizard-step-1'); return; }
            });
            if (nextBtn) nextBtn.addEventListener('click', onNext);
            if (backBtn) backBtn.addEventListener('click', onBack);
            buildSportsGrid();
            showStep('wizard-step-1');
        }
        function buildPlaceholderSlide(text) {
            return `
                <div class="media-slide absolute inset-0 opacity-0 pointer-events-none transition-opacity duration-300">
                    <div class="w-full h-full flex items-center justify-center bg-gray-200 text-gray-700 text-sm font-semibold">${text}</div>
                </div>`;
        }
        function buildCarouselHtml(slides, withArrows = false) {
            const count = slides.length;
            if (count === 0) return '';
            const slidesHtml = slides.join('');
            const arrows = '';
            // No on-screen arrow UI; index is advanced programmatically (hover on desktop). `withArrows` is reserved for a future enhancement and currently ignored.
            return `
                <div class="media-carousel absolute inset-0" data-media-index="0" data-media-count="${count}">
                    ${slidesHtml}
                </div>
                ${arrows}`;
        }
        function activateCarousel(container) {
            if (!container) return;
            const idx = Math.max(0, Math.min(Number(container.dataset.mediaIndex || 0), Number(container.dataset.mediaCount || 1) - 1));
            const slides = container.querySelectorAll('.media-slide');
            slides.forEach((s, i) => {
                if (i === idx) {
                    s.classList.add('opacity-100');
                    s.classList.remove('opacity-0', 'pointer-events-none');
                } else {
                    s.classList.remove('opacity-100');
                    s.classList.add('opacity-0', 'pointer-events-none');
                }
            });
        }
        function stepCarousel(container, dir) {
            if (!container) return;
            const count = Number(container.dataset.mediaCount || 1);
            let idx = Number(container.dataset.mediaIndex || 0);
            idx = (idx + dir + count) % count;
            container.dataset.mediaIndex = String(idx);
            activateCarousel(container);
        }

        function setCarouselIndex(container, idx) {
            if (!container) return;
            const count = Number(container.dataset.mediaCount || 1);
            const clamped = Math.max(0, Math.min(idx, count - 1));
            container.dataset.mediaIndex = String(clamped);
            activateCarousel(container);
        }

        // Provide a distinct icon per skill level for cards
        function getSkillIconSvg(skill) {
            const s = String(skill || '').toLowerCase();
            const cls = 'h-4 w-4 text-gray-600';
            // Competitive: star
            if (s.startsWith('comp')) {
                return `<i data-lucide="star" class="${cls}"></i>`;
            }
            // Intermediate: diamond
            if (s.startsWith('inter')) {
                return `<i data-lucide="diamond" class="${cls}"></i>`;
            }
            // Recreational: smiley
            if (s.startsWith('recr')) {
                return `<i data-lucide="smile" class="${cls}"></i>`;
            }
            // Social/Beginner: heart
            if (s.includes('beginner') || s.includes('social')) {
                return `<i data-lucide="heart" class="${cls}"></i>`;
            }
            // Default fallback: star
            return `<i data-lucide="star" class="${cls}"></i>`;
        }

        // Surface badge for Daily items: show one of Indoor/Outdoor/Grass/Beach/Sand/Turf
        function getSurfaceBadgeHtml(activity) {
            if (!activity) return '';
            const feats = Array.isArray(activity.features) ? activity.features.map(f => String(f)) : [];
            const candidates = ['Indoor','Outdoor','Grass','Beach/Sand','Turf'];
            let found = '';
            for (const name of candidates) {
                if (feats.some(f => f.toLowerCase() === name.toLowerCase())) { found = name; break; }
            }
            if (!found) return '';
            const iconName = (n => {
                const low = n.toLowerCase();
                if (low.includes('indoor')) return 'building-2';
                if (low.includes('outdoor')) return 'sun';
                if (low.includes('grass')) return 'leaf';
                if (low.includes('beach') || low.includes('sand')) return 'waves';
                if (low.includes('turf')) return 'sprout';
                return 'map-pin';
            })(found);
            return `<div class="flex items-center gap-2 min-w-0"><i data-lucide="${iconName}" class="h-4 w-4 text-gray-600"></i><span class="meta-text text-xs md:text-sm text-gray-800 truncate" title="${found}">${found}</span></div>`;
        }

        // Determine neighborhood for an activity using attached data or venue-locations mapping
        function getNeighborhoodForActivity(activity) {
            if (!activity) return '';
            if (activity.neighborhood) return String(activity.neighborhood);
            const venueName = activity.venue_name || activity.venueName || '';
            if (venueName && typeof venues !== 'undefined' && Array.isArray(venues)) {
                const norm = (s) => String(s || '').toLowerCase().replace(/[^a-z0-9]+/g, ' ').replace(/\s+/g, ' ').trim();
                const nv = norm(venueName);
                const v = venues.find(v => norm(v.venueName) === nv);
                if (v && v.neighborhood) return String(v.neighborhood);
            }
            return '';
        }

        // Build a concise sport phrase: include an allowed descriptor if it precedes the sport name in the raw title
        function getSportPhrase(activity) {
            const rawTitle = String(activity.program_name || activity.title || '').trim();
            const sport = normalizeSportLabel(activity.sport || deriveSportFromText(rawTitle));
            if (!sport) return '';
            // Find the sport in the raw title and see if a descriptor directly precedes it (e.g., "Recreational Pickleball")
            const allowedDescriptors = ['recreational','beginner','intermediate','competitive','social','social/beginner'];
            const segs = formatTitleInterpunct(rawTitle).split('·').map(s => s.trim());
            let phrase = sport;
            for (const seg of segs) {
                const words = seg.split(/\s+/);
                for (let i = 0; i < words.length; i++) {
                    const w = words[i];
                    const trailing = words.slice(i).join(' ');
                    if (trailing.toLowerCase().startsWith(sport.toLowerCase())) {
                        const prev = (i > 0) ? words[i-1].toLowerCase() : '';
                        // Normalize variant tokens
                        const prevNorm = prev.replace(/[^a-z/]+/g, '');
                        if (allowedDescriptors.includes(prevNorm)) {
                            // Capitalize first letter of descriptor
                            const descCap = words[i-1].charAt(0).toUpperCase() + words[i-1].slice(1);
                            phrase = `${descCap} ${sport}`;
                        }
                        return phrase;
                    }
                }
            }
            return phrase;
        }

        // Clean up event titles like "Friday - Title - NeighborhoodVenue" -> "Title"
        function cleanEventProgramTitle(raw) {
            const s = String(raw || '').trim();
            if (!s) return s;
            // Split on spaced dashes only (avoid breaking hyphenated words like "Baltimore-Chicago")
            const parts = s.split(/\s+[-–—]\s+/).map(p => p.trim()).filter(Boolean);
            if (parts.length === 0) return s;
            const isDay = (seg) => /^(mon|tue|wed|thu|thur|thurs|fri|sat|sun|monday|tuesday|wednesday|thursday|friday|saturday|sunday)$/i.test(String(seg || '').trim());
            // Drop leading day segment if present
            let arr = parts.slice();
            if (arr.length >= 2 && isDay(arr[0])) arr = arr.slice(1);
            if (arr.length === 0) return s;
            // If 3+ parts, the last is typically location; drop it and keep the middle joined
            if (arr.length >= 3) {
                let core = arr.slice(0, arr.length - 1).join(' - ').trim();
                // Brand cleanup: prefer concise phrasing
                core = core.replace(/\bVolo\s+Solo\b/i, 'Solo');
                core = core.replace(/^Volo\s+/i, '');
                // Heuristic: unify BigTV Watch Party naming
                if (/\b(big\s*tv|bigtv)\b/i.test(core) || /watch\s*part(y|ies)/i.test(core)) {
                    core = 'BigTV Watch Party';
                }
                return core || s;
            }
            // If 2 parts remain, keep the first as core and drop trailing location
            if (arr.length === 2) {
                let core = arr[0] || s;
                core = core.replace(/\bVolo\s+Solo\b/i, 'Solo');
                core = core.replace(/^Volo\s+/i, '');
                if (/\b(big\s*tv|bigtv)\b/i.test(core) || /watch\s*part(y|ies)/i.test(core)) {
                    core = 'BigTV Watch Party';
                }
                return core || s;
            }
            // Single remaining part is the title
            {
                let core = arr[0] || s;
                core = core.replace(/\bVolo\s+Solo\b/i, 'Solo');
                core = core.replace(/^Volo\s+/i, '');
                if (/\b(big\s*tv|bigtv)\b/i.test(core) || /watch\s*part(y|ies)/i.test(core)) {
                    core = 'BigTV Watch Party';
                }
                return core || s;
            }
        }

        // Compose standardized title.
        // - Tournaments: use dataset-provided name directly.
        // - Events: show a cleaned title stripped of day/location noise.
        // - Others: "Sport · Neighborhood" (no skill descriptor in the title).
        function buildStandardTitle(activity) {
            const type = (typeof getActivityType === 'function') ? getActivityType(activity) : '';
            if (type === 'Tournament') {
                return activity && (activity.name || activity.program_name || activity.title || '');
            }
            if (type === 'Event') {
                const raw = activity && (activity.program_name || activity.title || activity.name);
                const cleaned = cleanEventProgramTitle(raw);
                // Final strip of venue/neighborhood duplicates if interpuncts were introduced elsewhere
                return stripVenueAndNeighborhoodFromTitle(cleaned, activity);
            }
            // Use bare sport label without descriptors like Recreational/Competitive in the title
            const rawTitle = activity && (activity.program_name || activity.title || '');
            const sportOnly = normalizeSportLabel(activity?.sport || deriveSportFromText(rawTitle));
            const hood = getNeighborhoodForActivity(activity);
            if (sportOnly && hood) return `${sportOnly} · ${hood}`;
            return sportOnly || hood || (activity.program_name || '');
        }

        // Compute day pill text using resolved fields first, fallback to parsing the raw title
        function computeDayPillText(activity) {
            if (!activity) return '';
            if (activity.day_label) return String(activity.day_label);
            const unified = formatTitleInterpunct(activity.program_name || activity.title || '');
            const parts = unified.split('·').map(p => p.trim()).filter(Boolean);
            // Reuse logic from extractDayPill but without mutating title
            const DAY_FULL = ['monday','tuesday','wednesday','thursday','friday','saturday','sunday'];
            const DAY_ABBR = { mon:'monday', tue:'tuesday', wed:'wednesday', thu:'thursday', thur:'thursday', thurs:'thursday', fri:'friday', sat:'saturday', sun:'sunday' };
            const TOD_FULL = ['morning','afternoon','evening'];
            const cap = (w) => w ? (w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()) : '';
            const normalizeDay = (s) => {
                if (!s) return '';
                const t = s.toLowerCase().replace(/\./g, '').trim();
                if (DAY_FULL.includes(t)) return cap(t);
                if (DAY_ABBR[t]) return cap(DAY_ABBR[t]);
                return '';
            };
            const normalizeTod = (s) => {
                if (!s) return '';
                const t = s.toLowerCase().replace(/\./g, '').replace(/\s+/g, '').trim();
                if (t === 'am') return 'Morning';
                if (t === 'pm') return 'Evening';
                if (TOD_FULL.includes(s.toLowerCase())) return cap(s);
                return '';
            };
            for (const seg of parts) {
                const m = seg.match(/^(monday|tuesday|wednesday|thursday|friday|saturday|sunday|mon|tue|wed|thu|thur|thurs|fri|sat|sun)(?:\s+(morning|afternoon|evening|a\.?m\.?|p\.?m\.?))?$/i);
                if (m) {
                    const day = normalizeDay(m[1]);
                    const tod = normalizeTod(m[2] || '');
                    if (day) return day + (tod ? (' ' + tod) : '');
                }
            }
            return '';
        }

        // Determine if the activity date is today or tomorrow (ET) using date_mmdd if present; fallback to day_label
        function getActivityDayBadge(activity) {
            if (!activity) return null;
            const mmddRaw = String(activity.date_mmdd || '').trim();
            const m = mmddRaw.match(/^(\d{1,2})\/(\d{1,2})$/);
            try {
                const nowET = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/New_York' }));
                const y = nowET.getFullYear();
                const dayMs = 24*60*60*1000;
                const todayUtc = Date.UTC(y, nowET.getMonth(), nowET.getDate());
                if (m) {
                    const mm = Math.min(12, Math.max(1, parseInt(m[1], 10)));
                    const dd = Math.min(31, Math.max(1, parseInt(m[2], 10)));
                    let targetUtc = Date.UTC(y, mm - 1, dd);
                    // If clearly past by 60+ days, assume next year
                    if (targetUtc - todayUtc < -60 * dayMs) {
                        targetUtc = Date.UTC(y + 1, mm - 1, dd);
                    }
                    const diffDays = Math.round((targetUtc - todayUtc) / dayMs);
                    if (diffDays === 0) return 'today';
                    if (diffDays === 1) return 'tomorrow';
                }
            } catch (_) { /* ignore */ }
            const dl = String(activity.day_label || '').toLowerCase();
            if (dl === 'today') return 'today';
            if (dl === 'tomorrow') return 'tomorrow';
            return null;
        }

        // Extract separate Day and Time-of-day (AM/PM) from activity title when present
        function computeDayAndTod(activity) {
            const out = { day: '', tod: '' };
            if (!activity) return out;
            // Prefer explicit fields first
            if (activity.day_label && String(activity.day_label).trim()) {
                const dl = String(activity.day_label).trim();
                if (!/^today|tomorrow$/i.test(dl)) out.day = dl; // Today/Tomorrow handled separately as badges
            }
            // Parse from title segments: "Saturday Morning - ..." etc.
            const unified = formatTitleInterpunct(activity.program_name || activity.title || '');
            const parts = unified.split('·').map(p => p.trim()).filter(Boolean);
            const DAY_FULL = ['monday','tuesday','wednesday','thursday','friday','saturday','sunday'];
            const DAY_ABBR = { mon:'monday', tue:'tuesday', wed:'wednesday', thu:'thursday', thur:'thursday', thurs:'thursday', fri:'friday', sat:'saturday', sun:'sunday' };
            const cap = (w) => w ? (w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()) : '';
            for (const seg of parts) {
                const m = seg.match(/^(monday|tuesday|wednesday|thursday|friday|saturday|sunday|mon|tue|wed|thu|thur|thurs|fri|sat|sun)(?:\s+(morning|afternoon|evening|a\.?m\.?|p\.?m\.?))?$/i);
                if (m) {
                    // Day
                    const rawDay = m[1].toLowerCase();
                    const full = DAY_FULL.includes(rawDay) ? rawDay : (DAY_ABBR[rawDay] || '');
                    if (full) out.day = cap(full);
                    // Time-of-day -> map to AM/PM
                    const rawTod = (m[2] || '').toLowerCase().replace(/\./g, '');
                    if (rawTod) {
                        if (rawTod === 'am' || rawTod === 'morning') out.tod = 'AM';
                        else if (rawTod === 'pm' || rawTod === 'evening' || rawTod === 'afternoon') out.tod = 'PM';
                    }
                    break;
                }
            }
            return out;
        }

        // Build day pill(s): Today/Tomorrow badges for Daily items; for others, separate Day and AM/PM pill (with clock icon)
        function buildDayPillHtml(activity) {
            const badge = getActivityDayBadge(activity);
            if (isDailyActivity(activity)) {
                if (badge === 'today') {
                    return `<span class="elev-pill inline-flex items-center gap-1 rounded-full bg-orange-500 text-white text-[12.5px] px-2.5 py-1">Today</span>`;
                }
                if (badge === 'tomorrow') {
                    return `<span class="elev-pill inline-flex items-center gap-1 rounded-full bg-[rgba(83,83,83,0.90)] text-white text-[12.5px] px-2.5 py-1">Tomorrow</span>`;
                }
            }
            const info = computeDayAndTod(activity);
            const pills = [];
            if (info.day) {
                pills.push(`<span class="type-pill inline-flex items-center gap-1 rounded-full bg-white text-black text-[13px] px-2.5 py-1 shadow-sm">${info.day}</span>`);
            }
            if (info.tod) {
                pills.push(`<span class="type-pill inline-flex items-center gap-1 rounded-full bg-white text-black text-[13px] px-2.5 py-1 shadow-sm"><i data-lucide="clock" class="w-3.5 h-3.5"></i><span>${info.tod}</span></span>`);
            }
            // Fallback for Tournaments/Leagues: if title has no day, derive from start_date_text (MM/DD)
            if (pills.length === 0 && activity) {
                const isTournament = (/tournament/i.test(String(activity.activity_type)) || activity.source === 'tournaments');
                const isLeague = (/league/i.test(String(activity.activity_type)) || activity.source === 'leagues');
                if (isTournament || isLeague) {
                    const dt = String(activity.start_date_text || '').trim();
                    const m = dt.match(/^(\d{1,2})\/(\d{1,2})$/);
                    if (m && typeof resolveDayFromMMDD === 'function') {
                        const mm = Math.min(12, Math.max(1, parseInt(m[1], 10)));
                        const dd = Math.min(31, Math.max(1, parseInt(m[2], 10)));
                        const d = resolveDayFromMMDD(mm, dd);
                        if (d && d.label) {
                            pills.push(`<span class="type-pill inline-flex items-center gap-1 rounded-full bg-white text-black text-[13px] px-2.5 py-1 shadow-sm">${d.label}</span>`);
                        }
                    }
                }
            }
            return pills.join('');
        }

        // Format times to compact form:
        // - Remove space before AM/PM (e.g., "09:30 PM" -> "09:30PM")
        // - Remove leading zero from hour (e.g., "09:30AM" -> "9:30AM")
        // - Drop ":00" minutes (e.g., "09:00AM" -> "9AM")
        function formatTimeCompact(t) {
            if (t == null) return t;
            let s = String(t).trim();
            if (!s) return s;
            // Normalize AM/PM casing and remove any space before it
            s = s.replace(/\s*([AaPp][Mm])\b/, (_, meridiem) => meridiem.toUpperCase());
            // Match H:MMAM | HH:MMAM | H AM | HHAM (optionally with a space)
            const m = s.match(/^(\d{1,2})(?::(\d{2}))?\s*([AP]M)$/i);
            if (!m) return s; // leave unchanged if it doesn't look like a time we expect
            let hour = parseInt(m[1], 10); // removes any leading zero
            const mins = m[2];
            const ampm = m[3].toUpperCase();
            // Guard against 0-hour edge case in malformed data (treat as 12)
            if (!Number.isFinite(hour) || hour === 0) hour = 12;
            if (!mins || mins === '00') {
                return `${hour}${ampm}`; // e.g., 9AM
            }
            return `${hour}:${mins}${ampm}`; // e.g., 9:30AM
        }

        // Replace spaced dashes used as separators with an interpunct
        // Examples:
        //   "Thursday - Glow Kickball - Columbia" -> "Thursday · Glow Kickball · Columbia"
        // Only transforms dashes that have whitespace on both sides to avoid hyphenated words.
        function formatTitleInterpunct(s) {
            if (s == null) return s;
            const str = String(s);
            // Replace space-enclosed hyphen, en dash, or em dash with interpunct
            return str.replace(/(\s)[\-–—](\s)/g, '$1·$2');
        }

        // Convert a time string like "9AM", "9:30PM", "09:30 PM" into minutes after midnight; NaN if not parseable
        function parseTimeToMinutesSimple(t) {
            if (!t) return NaN;
            const m = String(t).trim().toUpperCase().match(/^(\d{1,2})(?::(\d{2}))?\s*([AP]M)$/);
            if (!m) return NaN;
            let h = parseInt(m[1], 10);
            const min = m[2] ? parseInt(m[2], 10) : 0;
            const ap = m[3];
            if (ap === 'PM' && h !== 12) h += 12;
            if (ap === 'AM' && h === 12) h = 0;
            return h * 60 + min;
        }
        // Format minutes to a compact 12h label used by the Events start-time slider
        function minutesToTimeLabel(mins) {
            const n = Number(mins);
            if (!Number.isFinite(n) || n <= 0) return 'Any time';
            let h24 = Math.floor(n / 60);
            const m = n % 60;
            const ap = h24 >= 12 ? 'PM' : 'AM';
            let h = h24 % 12; if (h === 0) h = 12;
            const mm = m === 0 ? '' : `:${String(m).padStart(2,'0')}`;
            return `${h}${mm}${ap}`;
        }

        // Remove parentheses from titles and normalize spacing around interpuncts
        function sanitizeTitle(s) {
            let t = formatTitleInterpunct(s || '');
            t = t.replace(/[()]/g, ''); // remove literal parentheses
            // Normalize spaces around the interpunct and collapse multiple spaces
            t = t.replace(/\s*·\s*/g, ' · ');
            t = t.replace(/\s{2,}/g, ' ').trim();
            return t;
        }

        // Remove time, price, format, and duplicate location fragments from a composite title.
        // Keeps concise descriptors like "Beginner Indoor Pickleball" and strips tokens such as:
        // - times: 5:30pm, 6PM
        // - prices: $20, $12.5, "Standard", "Member"
        // - format-only: "Open", "Open Play"
        // - neighborhood (e.g., Canton) and venue (handled elsewhere but we defensively strip here too)
        function cleanTitleForDisplay(title, activity) {
            if (!title) return title;
            const n = (s) => String(s || '').toLowerCase().replace(/[^a-z0-9]+/g, ' ').replace(/\s+/g, ' ').trim();
            const neigh = activity && (activity.neighborhood || '');
            const venue = activity && (activity.venue_name || activity.venueName || '');
            // Break into interpunct-separated segments for precise removal
            const unified = formatTitleInterpunct(title);
            let parts = unified.split('·').map(p => p.trim()).filter(Boolean);
            const timeRx = /\b\d{1,2}(?::\d{2})?\s*[AP]M\b/i;
            const priceRx = /\$\s*\d+(?:\.\d+)?/;
            const nvnRx = /\b\d+\s*[vx]\s*\d+\b/i;
            // Common skill-level tokens that are shown elsewhere
            const skillTokenRx = /\b(competitive|intermediate|recreational|rec|beginner|social|social\s*\/\s*beginner|advanced|advanced\s*\/\s*competitive)\b/i;
            // Composition tokens shown elsewhere
            const compositionTokenRx = /\b(coed|men's|womens|women's|open)\b/i;
            // Daily-type tokens shown elsewhere
            const dailyTokenRx = /\b(drop\s*-?in|pick\s*-?up)\b/i;
            parts = parts.filter(seg => {
                const s = seg.trim();
                if (!s) return false;
                // Remove times and price fragments
                if (timeRx.test(s)) return false;
                if (priceRx.test(s)) return false;
                // Any segment containing a dollar sign is considered a price segment; drop it entirely
                if (/\$/i.test(s)) return false;
                if (/\bstandard\b/i.test(s)) return false;
                if (/\bmember\b/i.test(s)) return false;
                if (/\bnon[-\s]?member\b/i.test(s)) return false;
                if (/\bper\s*person\b/i.test(s)) return false;
                if (/\bfree\b/i.test(s)) return false;
                // Remove pure format/composition/skill tokens shown elsewhere
                if (/^open(\s*play)?$/i.test(s)) return false; // Open / Open Play
                if (nvnRx.test(s)) return false; // 7v7, 5v5, etc
                if (skillTokenRx.test(s)) return false; // skill labels
                if (compositionTokenRx.test(s)) return false; // Coed/Men's/Women's/Open
                if (dailyTokenRx.test(s)) return false; // Drop-in / Pickup
                // Remove neighborhood duplicates
                if (neigh && n(s) === n(neigh)) return false;
                // Remove venue duplicates or when segment starts with venue name
                if (venue) {
                    const ns = n(s);
                    const nv = n(venue);
                    if (ns === nv || ns.startsWith(nv + ' ')) return false;
                }
                return true;
            });
            const joined = parts.join(' · ').trim();
            if (joined) return joined;
            // Fallback: inline cleanup on the unified string instead of segment-based, so we don't return a noisy title
            let inline = unified;
            const removalPatterns = [timeRx, priceRx, /\bstandard\b/i, /\bmember\b/i, /\bnon[-\s]?member\b/i, /\bper\s*person\b/i, /\bfree\b/i, nvnRx, skillTokenRx, compositionTokenRx, dailyTokenRx];
            removalPatterns.forEach(rx => { inline = inline.replace(rx, ' '); });
            // Remove explicit currency ranges and single amounts that may remain (e.g., "$10-$15", "$10 – $15", "$10+", "USD 10")
            inline = inline.replace(/\$\s*\d+(?:\.\d+)?(?:\s*[-–—]\s*\$\s*\d+(?:\.\d+)?)*\+?/gi, ' ');
            inline = inline.replace(/\bUSD\s*\$?\s*\d+(?:\.\d+)?\b/gi, ' ');
            // If any lone dollar signs sneak through, drop the token and adjacent digits
            inline = inline.replace(/\$\s*\d+(?:\.\d+)?/gi, ' ');
            // Also remove duplicate neighborhood/venue words if they exist inline
            if (neigh) {
                const rn = n(neigh);
                if (rn) inline = inline.replace(new RegExp(`\\b${rn.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&')}\\b`, 'ig'), ' ');
            }
            if (venue) {
                const rv = n(venue);
                if (rv) inline = inline.replace(new RegExp(`\\b${rv.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&')}\\b`, 'ig'), ' ');
            }
            inline = inline.replace(/\s*·\s*/g, ' ').replace(/\s{2,}/g, ' ').trim();
            if (inline) return inline;
            // Fallbacks when everything was stripped
            if (activity && activity.program_name) return String(activity.program_name);
            if (activity && activity.sport) return String(activity.sport);
            return title;
        }

        // Strip trailing venue name (and optional neighborhood) from a title to avoid duplicates with the venue line below
        function stripVenueAndNeighborhoodFromTitle(title, activity) {
            if (!title) return title;
            const norm = (s) => String(s || '').toLowerCase().replace(/[^a-z0-9]+/g, ' ').replace(/\s+/g, ' ').trim();
            const unified = formatTitleInterpunct(title);
            let parts = unified.split('·').map(p => p.trim()).filter(Boolean);
            if (parts.length === 0) return title;
            const venueName = (activity && (activity.venue_name || activity.venueName)) ? String(activity.venue_name || activity.venueName) : '';
            let neighborhood = '';
            try {
                if (venueName && typeof venues !== 'undefined' && Array.isArray(venues)) {
                    const v = venues.find(v => norm(v.venueName) === norm(venueName));
                    neighborhood = v && v.neighborhood ? String(v.neighborhood) : '';
                }
            } catch (_) { /* no-op if venues not available */ }
            const last = parts[parts.length - 1];
            const secondLast = parts.length >= 2 ? parts[parts.length - 2] : '';
            const nVenue = norm(venueName);
            const nLast = norm(last);
            const nSecondLast = norm(secondLast);
            const nHood = norm(neighborhood);
            let removed = false;
            // Case 1: last segment is exactly the venue name, or starts with it (e.g., "Venue Name Federal Hill")
            if (nVenue && (nLast === nVenue || (nLast.startsWith(nVenue + ' ')))) {
                parts.pop();
                removed = true;
            }
            // Case 2: last two segments are [venue, neighborhood]
            else if (nVenue && nHood && nSecondLast === nVenue && nLast === nHood) {
                parts.pop(); // remove hood
                parts.pop(); // remove venue
                removed = true;
            }
            // Case 3: trailing neighborhood alone (when venue appears elsewhere or is displayed separately)
            else if (nHood && nLast === nHood) {
                parts.pop();
                removed = true;
            }
            // Avoid emptying the title entirely; if nothing remains, revert to original
            if (removed && parts.length === 0) return title;
            const joined = parts.join(' · ').trim();
            return joined || title;
        }

        // Extract a day of week (and optional time-of-day) from a title and return a pill text plus the stripped title
        // e.g., "Men's Competitive Basketball · Monday · Venue" -> { pillText: 'Monday', title: "Men's Competitive Basketball · Venue" }
        // e.g., "Saturday Morning · Party Pickleball · Canton" -> { pillText: 'Saturday Morning', title: 'Party Pickleball · Canton' }
        function extractDayPill(title) {
            if (!title) return { pillText: '', title: '' };
            const cap = (w) => w ? (w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()) : '';
            const DAY_FULL = ['monday','tuesday','wednesday','thursday','friday','saturday','sunday'];
            const DAY_ABBR = { mon:'monday', tue:'tuesday', wed:'wednesday', thu:'thursday', thur:'thursday', thurs:'thursday', fri:'friday', sat:'saturday', sun:'sunday' };
            const TOD_FULL = ['morning','afternoon','evening'];
            const normalizeDay = (s) => {
                if (!s) return '';
                const t = s.toLowerCase().replace(/\./g, '').trim();
                if (DAY_FULL.includes(t)) return cap(t);
                if (DAY_ABBR[t]) return cap(DAY_ABBR[t]);
                return '';
            };
            const normalizeTod = (s) => {
                if (!s) return '';
                const t = s.toLowerCase().replace(/\./g, '').replace(/\s+/g, '').trim();
                if (t === 'am') return 'Morning';
                if (t === 'pm') return 'Evening';
                if (TOD_FULL.includes(s.toLowerCase())) return cap(s);
                return '';
            };
            const raw = String(title);
            const unified = formatTitleInterpunct(raw);
            const parts = unified.split('·').map(p => p.trim()).filter(Boolean);
            let pillText = '';
            // Combined segment check: "Day [Time]" where Time can be morning/afternoon/evening or AM/PM
            let combinedIdx = -1;
            for (let i = 0; i < parts.length; i++) {
                const seg = parts[i];
                const m = seg.match(/^(monday|tuesday|wednesday|thursday|friday|saturday|sunday|mon|tue|wed|thu|thur|thurs|fri|sat|sun)(?:\s+(morning|afternoon|evening|a\.?m\.?|p\.?m\.?))?$/i);
                if (m) {
                    const day = normalizeDay(m[1]);
                    const tod = normalizeTod(m[2] || '');
                    if (day) {
                        pillText = day + (tod ? (' ' + tod) : '');
                        combinedIdx = i;
                        break;
                    }
                }
            }
            if (combinedIdx >= 0) {
                parts.splice(combinedIdx, 1);
                return { pillText, title: parts.join(' · ').trim() };
            }
            // Separate parts: find a day segment and a time-of-day segment separately
            let dayIdx = -1, dayVal = '';
            for (let i = 0; i < parts.length; i++) {
                const d = normalizeDay(parts[i]);
                if (d) { dayIdx = i; dayVal = d; break; }
            }
            let todIdx = -1, todVal = '';
            for (let i = 0; i < parts.length; i++) {
                const t = normalizeTod(parts[i]);
                if (t) { todIdx = i; todVal = t; break; }
            }
            if (dayIdx >= 0 && todIdx >= 0) {
                pillText = dayVal + ' ' + todVal;
                const a = Math.max(dayIdx, todIdx);
                const b = Math.min(dayIdx, todIdx);
                parts.splice(a, 1);
                parts.splice(b, 1);
                return { pillText, title: parts.join(' · ').trim() };
            }
            if (dayIdx >= 0) {
                pillText = dayVal;
                parts.splice(dayIdx, 1);
                return { pillText, title: parts.join(' · ').trim() };
            }
            if (todIdx >= 0) {
                pillText = todVal;
                parts.splice(todIdx, 1);
                return { pillText, title: parts.join(' · ').trim() };
            }
            return { pillText: '', title: unified };
        }

        // Format a money value into { dollars: '63', cents: '20' }
        function formatMoneyParts(val) {
            const n = Number(val);
            if (!Number.isFinite(n)) return { dollars: '0', cents: '00' };
            const [dollars, cents] = n.toFixed(2).split('.');
            return { dollars, cents };
        }

        // --- TEXT PARSING HELPERS (Daily cleanup) ---
        function tokenize(str) {
            return String(str || '')
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, ' ')
                .trim()
                .split(/\s+/)
                .filter(Boolean);
        }
        function extractTimeAndStrip(text) {
            let s = String(text || '');
            // Match 1-2 digit hour with optional :MM and optional space before AM/PM
            const m = s.match(/\b(\d{1,2})(?::(\d{2}))?\s*([AaPp][Mm])\b/);
            if (!m) return { time: '', text: s };
            // Normalize to H:MMAM style
            const hour = String(parseInt(m[1], 10));
            const mins = m[2] ? `:${m[2]}` : '';
            const ampm = m[3].toUpperCase();
            const time = `${hour}${mins}${ampm}`;
            s = s.replace(m[0], '').replace(/\s{2,}/g, ' ').trim();
            return { time, text: s };
        }
        function extractMMDDAndStrip(text) {
            let s = String(text || '');
            const m = s.match(/\b(\d{1,2})\/(\d{1,2})\b/);
            if (!m) return { mmdd: null, text: s };
            const mm = Math.min(12, Math.max(1, parseInt(m[1], 10)));
            const dd = Math.min(31, Math.max(1, parseInt(m[2], 10)));
            s = s.replace(m[0], '').replace(/\s{2,}/g, ' ').trim();
            return { mmdd: { mm, dd }, text: s };
        }
        function resolveDayFromMMDD(mm, dd) {
            if (!Number.isFinite(mm) || !Number.isFinite(dd)) return { label: '', abbrev: '' };
            const now = new Date();
            // Use current year; if date already passed significantly (60+ days), consider next year
            let y = now.getFullYear();
            const d = new Date(y, mm - 1, dd);
            if ((d.getTime() - now.getTime()) < -60 * 24 * 60 * 60 * 1000) {
                y = y + 1;
            }
            const day = new Date(y, mm - 1, dd);
            const names = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            const abbrs = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
            const dow = day.getDay();
            return { label: names[dow], abbrev: abbrs[dow] };
        }
        // Find day-of-week mentioned in free text (full or common abbreviations)
        function findDayOfWeekInText(text) {
            const s = String(text || '').toLowerCase();
            const map = {
                sunday:0, monday:1, tuesday:2, wednesday:3, thursday:4, friday:5, saturday:6,
                sun:0, mon:1, tue:2, tues:2, wed:3, thu:4, thur:4, thurs:4, fri:5, sat:6
            };
            const m = s.match(/\b(sunday|monday|tuesday|wednesday|thursday|friday|saturday|sun|mon|tue|tues|wed|thu|thur|thurs|fri|sat)\b/);
            if (!m) return null;
            return map[m[1]];
        }
        // Compute next (including today) date for a given day-of-week index 0-6; returns {mm,dd,label,abbrev}
        function computeNextDateForDOW(targetDow) {
            const now = new Date();
            const todayDow = now.getDay();
            const delta = (targetDow - todayDow + 7) % 7; // 0=today, else days ahead
            const d = new Date(now.getFullYear(), now.getMonth(), now.getDate() + delta);
            const mm = d.getMonth() + 1;
            const dd = d.getDate();
            const names = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            const abbrs = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
            return { mm, dd, label: names[d.getDay()], abbrev: abbrs[d.getDay()] };
        }
        function findCanonicalVenue(raw) {
            try {
                if (typeof venues === 'undefined' || !Array.isArray(venues)) return null;
                const rawTokens = new Set(tokenize(raw));
                let best = null;
                let bestScore = 0;
                let bestNameMatches = 0;
                venues.forEach(v => {
                    const nameTokens = tokenize(v.venueName);
                    let score = 0;
                    let nameMatches = 0;
                    nameTokens.forEach(t => {
                        if (rawTokens.has(t)) { score += 1; nameMatches += 1; }
                    });
                    // Boost if neighborhood matches
                    const neigh = (v.neighborhood || '').toLowerCase();
                    if (neigh && rawTokens.has(neigh)) score += 1.5;
                    // Boost for 'volo' present for Club Volo venues
                    if (/club\s*volo/i.test(v.venueName) && rawTokens.has('volo')) score += 0.5;
                    if (score > bestScore) { bestScore = score; best = v; bestNameMatches = nameMatches; }
                });
                // Reject matches that only hit neighborhood (no name token overlap)
                if (!best || bestScore <= 0) return null;
                if (bestNameMatches === 0) return null;
                return best;
            } catch (_) { return null; }
        }

        // Determine if an activity is a Daily Sports item (Drop-in or PickUp)
        function isDailyActivity(a) {
            const t = getActivityType(a);
            return t === 'Drop-in' || t === 'PickUp' || a?.source === 'daily';
        }

        // Compute the primary price to display on a card and its suffix label.
        // For leagues: prefer member_price_current; suffix '/member'. If absent, omit.
        // For daily: prefer member_price_current if present (suffix '/member'), else price_person_current (suffix '/person').
        function getPrimaryPriceInfo(a) {
            if (!a) return null;
            const daily = isDailyActivity(a);
            const m = Number(a.member_price_current);
            const n = Number(a.price_person_current);
            if (daily) {
                if (Number.isFinite(m)) {
                    if (m === 0) return { amount: m, suffix: '/member', displayText: '$FREE' };
                    return { amount: m, suffix: '/member' };
                }
                if (Number.isFinite(n)) return { amount: n, suffix: '/person' };
                return null;
            } else {
                if (Number.isFinite(m)) return { amount: m, suffix: '/member' };
                return null;
            }
        }

        // Compute the small secondary price line shown to the right of the schedule line.
        // For leagues: show any available of non-member and team prices.
        // For daily: show per-person price if present (labelled 'Per person'),
        //            or a non-member price if member price used as primary.
        function getSecondaryPriceLine(a) {
            if (!a) return '';
            const daily = isDailyActivity(a);
            const m = Number(a.member_price_current);
            const n = Number(a.price_person_current);
            const t = Number(a.price_team);
            const parts = [];
            // Rentals: omit per-hour text here; pricing is shown as a right-aligned pill in the bottom row
            if (a && a.source === 'rentals') {
                return '';
            }
            if (daily) {
                if (Number.isFinite(n)) {
                    parts.push(`Per person: $${n.toLocaleString()}`);
                } else if (Number.isFinite(m)) {
                    parts.push(`Member: $${m.toLocaleString()}`);
                }
            } else {
                if (Number.isFinite(n)) parts.push(`Non-member: $${n.toLocaleString()}`);
                if (Number.isFinite(t)) parts.push(`Team $${t.toLocaleString()}`);
            }
            return parts.join(' | ');
        }

        // --- DAILY SCHEDULE RESOLUTION ---
        function resolveRelativeDay(offset) {
            const n = Number(offset);
            if (!Number.isFinite(n)) return { label: '', abbrev: '' };
            const now = new Date();
            const d = new Date(now.getFullYear(), now.getMonth(), now.getDate() + n);
            const dow = d.getDay(); // 0=Sun..6=Sat
            const names = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            const abbrs = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
            let label = names[dow];
            if (n === 0) label = 'Today';
            else if (n === 1) label = 'Tomorrow';
            return { label, abbrev: abbrs[dow] };
        }
        function getScheduleLine(a) {
            // For tournaments: show Day Abbrev + date + time range, no weeks label
            if (a && (/tournament/i.test(String(a.activity_type)) || a.source === 'tournaments')) {
                const t1 = formatTimeCompact(a.time_start || '');
                const t2 = formatTimeCompact(a.time_end || '');
                const times = (t1 && t2) ? `${t1} - ${t2}` : (t1 || t2 || '');
                const date = String(a.start_date_text || '').trim();
                let dayAbbrev = '';
                const m = date.match(/^(\d{1,2})\/(\d{1,2})$/);
                if (m && typeof resolveDayFromMMDD === 'function') {
                    const mm = Math.min(12, Math.max(1, parseInt(m[1], 10)));
                    const dd = Math.min(31, Math.max(1, parseInt(m[2], 10)));
                    const d = resolveDayFromMMDD(mm, dd);
                    if (d && d.abbrev) dayAbbrev = d.abbrev;
                }
                const dateLabel = date ? (dayAbbrev ? `${dayAbbrev} ${date}` : `${date}`) : '';
                return `${dateLabel}${dateLabel && times ? ' · ' : ''}${times}`.trim();
            }
            // For Events: prefer day label (Today/Tomorrow/Fri) + times; fallback to start_date_text
            if (a && (/event/i.test(String(a.activity_type)) || a.source === 'events')) {
                const dayLabel = a.day_label || a.start_date_text || '';
                const t1 = formatTimeCompact(a.time_start || '');
                const t2 = formatTimeCompact(a.time_end || '');
                const times = (t1 && t2) ? `${t1} - ${t2}` : (t1 || t2 || '');
                return `${dayLabel}${dayLabel && times ? ' · ' : ''}${times}`.trim();
            }
            // For leagues, keep existing copy when weeks/start_date_text present
            const hasLeagueSchedule = (a && (a.weeks || a.start_date_text));
            if (hasLeagueSchedule) {
                const t1 = formatTimeCompact(a.time_start || '');
                const t2 = formatTimeCompact(a.time_end || '');
                const times = (t1 && t2) ? `${t1} - ${t2}` : (t1 || t2 || '');
                const weeks = a.weeks ? `${a.weeks} weeks` : '';
                const pieces = [];
                if (a.start_date_text) pieces.push(`Starts ${a.start_date_text}`);
                if (weeks) pieces.push(weeks);
                if (times) pieces.push(times);
                return pieces.join(' · ');
            }
            // For Daily Sports / Drop-ins, show day label + times
            if (a && (a.activity_type && /drop[- ]?in|pickup|pick[- ]?up/i.test(String(a.activity_type)))) {
                const dayLabel = a.day_label || '';
                const t1 = formatTimeCompact(a.time_start || '');
                const t2 = formatTimeCompact(a.time_end || '');
                const times = (t1 && t2) ? `${t1} - ${t2}` : (t1 || t2 || '');
                return `${dayLabel}${dayLabel && times ? ' · ' : ''}${times}`;
            }
            // Fallback to times only
            const t1 = formatTimeCompact(a && a.time_start || '');
            const t2 = formatTimeCompact(a && a.time_end || '');
            return (t1 && t2) ? `${t1} - ${t2}` : (t1 || t2 || '');
        }

        // Normalize and render Age badge safely
        function normalizeAge(val) {
            if (val == null) return null;
            if (typeof val === 'number') return Number.isFinite(val) && val > 0 ? val : null;
            const s = String(val).trim().toLowerCase();
            if (!s || s === 'null' || s === 'undefined' || s === 'n/a' || s === 'na') return null;
            const mPlus = s.match(/^(\d+)\s*\+$/);
            if (mPlus) return `${Number(mPlus[1])}+`;
            const mNum = s.match(/^(\d+)$/);
            if (mNum) return Number(mNum[1]);
            return null;
        }
        function getAgeBadgeHtml(obj) {
            const raw = obj && (obj.age != null ? obj.age : null);
            const age = normalizeAge(raw);
            if (age == null) return '';
            let display = '';
            if (typeof age === 'number') display = `${age}+`;
            else if (typeof age === 'string' && /^\d+\+$/.test(age)) display = age;
            else return '';
            return `<div class="flex items-center gap-2 min-w-0"><i data-lucide="hash" class="h-4 w-4 text-gray-600"></i><span class="meta-text text-xs md:text-sm text-gray-800 truncate" title="${display}">${display}</span></div>`;
        }

        // --- SOCIAL PROOF (Events) ---
        function getAttendeeCount(a) {
            if (!a) return null;
            const candidates = [a.attendee_count, a.attendees_count, a.rsvp_count, a.going_count];
            for (const v of candidates) { const n = Number(v); if (Number.isFinite(n) && n > 0) return n; }
            if (Array.isArray(a.attendees) && a.attendees.length > 0) return a.attendees.length;
            return null;
        }
        // New: broader social proof count for "Join N attending or interested"
        function getJoinCount(a) {
            if (!a) return null;
            const candidates = [a.attending_or_interested_count, a.attending_interested_count, a.social_count, a.interest_count, a.attendee_count, a.attendees_count, a.rsvp_count, a.going_count];
            for (const v of candidates) { const n = Number(v); if (Number.isFinite(n) && n > 0) return n; }
            if (Array.isArray(a.attendees) && a.attendees.length > 0) return a.attendees.length;
            return null;
        }
        function isEventInterested(id) {
            try { return localStorage.getItem(`interestedEvent:${id}`) === '1'; } catch(_) { return false; }
        }
        function setEventInterested(id, val) {
            try {
                if (val) localStorage.setItem(`interestedEvent:${id}`, '1');
                else localStorage.removeItem(`interestedEvent:${id}`);
            } catch(_) {}
        }

        function renderActivities() {
            if(!activityCardsContainer) return;
            activityCardsContainer.innerHTML = '';
            let allItems = (typeof getFilteredActivities === 'function') ? getFilteredActivities() : activities;
            // Determine current Activities scope for potential scope-specific sorting
            const actElForSort = document.getElementById('activities');
            const actValForSort = actElForSort ? String(actElForSort.value || '').toLowerCase().trim() : '';
            const isLeaguesScope = (actValForSort === 'leagues' || actValForSort === 'league');
            const isTournamentsScope = (actValForSort === 'tournaments' || actValForSort === 'tournament');
            // Email capture insertion control (show once on first page at position #5 unless user already submitted)
            const emailCaptured = (() => { try { return localStorage.getItem('voloEmailCaptured') === '1'; } catch(_) { return false; } })();
            let emailCtaInserted = false;
            // Daily scope: sort by day — Today, Tomorrow, then upcoming day-of-week — tie-break by start time
            if (typeof isDailyScope === 'function' && isDailyScope() && Array.isArray(allItems)) {
                const todayDowET = (() => {
                    try { return new Date(new Date().toLocaleString('en-US', { timeZone: 'America/New_York' })).getDay(); } catch(_) { return new Date().getDay(); }
                })();
                const abbrToDow = { Sun:0, Mon:1, Tue:2, Wed:3, Thu:4, Fri:5, Sat:6 };
                const parseTimeToMinutes = (t) => {
                    if (!t) return 24*60 + 1; // push unknown times to bottom of same day
                    const m = String(t).trim().match(/^(\d{1,2})(?::(\d{2}))?\s*([AP]M)$/i);
                    if (!m) return 24*60 + 1;
                    let h = parseInt(m[1], 10);
                    const min = m[2] ? parseInt(m[2], 10) : 0;
                    const ap = m[3].toUpperCase();
                    if (ap === 'PM' && h !== 12) h += 12;
                    if (ap === 'AM' && h === 12) h = 0;
                    return h * 60 + min;
                };
                const getRank = (a) => {
                    // Today/Tomorrow badges have top priority
                    const badge = (typeof getActivityDayBadge === 'function') ? getActivityDayBadge(a) : null;
                    if (badge === 'today') return { rank: 0, dayDelta: 0 };
                    if (badge === 'tomorrow') return { rank: 1, dayDelta: 1 };
                    // Otherwise, compute days ahead based on derived day-of-week
                    const abbr = (typeof deriveDayAbbrev === 'function') ? deriveDayAbbrev(a) : '';
                    const dow = abbrToDow[abbr] ?? null;
                    if (dow == null) return { rank: 999, dayDelta: 999 };
                    const delta = (dow - todayDowET + 7) % 7;
                    // After Today/Tomorrow, remaining days start from 2..6, ordered ascending by delta
                    return { rank: 2 + delta, dayDelta: delta };
                };
                allItems = allItems.slice().sort((a, b) => {
                    const ra = getRank(a); const rb = getRank(b);
                    if (ra.rank !== rb.rank) return ra.rank - rb.rank;
                    // Tie-break within the same day by start time
                    const ta = parseTimeToMinutes(a.time_start || a.timeStart || '');
                    const tb = parseTimeToMinutes(b.time_start || b.timeStart || '');
                    if (ta !== tb) return ta - tb;
                    // Stable-ish: final tiebreak by venue or title
                    return String(a.venue_name || a.program_name || '').localeCompare(String(b.venue_name || b.program_name || ''));
                });
            } else if ((isLeaguesScope || isTournamentsScope) && Array.isArray(allItems)) {
                // Leagues/Tournaments scope: prioritize active results that are closing soon
                // Rank order:
                //   1) Status: Open (0) < Waitlist (1) < Sold Out/Closed (2)
                //   2) Registration deadline nearness (minutes to ET 6pm of deadline) ascending
                //   3) Start date nearness (days until start) ascending
                //   4) Sport/venue/name tiebreak alphabetical
                const statusRank = (a) => {
                    const text = (String(a.registration_phase_text || '') + ' ' + String(a.banner_message || '')).toLowerCase();
                    if (/sold\s*out|full|closed|ended|complete/.test(text)) return 2; // bottom
                    if (/wait\s*-?\s*list|waitlist|wait\s*listed/.test(text)) return 1;
                    return 0; // open/default
                };
                const minsToDeadline = (a) => {
                    if (typeof computeMinutesToDeadlineET === 'function') {
                        const m = computeMinutesToDeadlineET(a);
                        if (typeof m === 'number' && m > 0) return m;
                    }
                    return Number.POSITIVE_INFINITY;
                };
                const daysUntilStart = (a) => {
                    // Parse start_date_text; fallback to registration_ends_mmdd if present
                    let mmdd = null;
                    if (a && a.start_date_text) {
                        if (typeof parseMMDDFromText === 'function') mmdd = parseMMDDFromText(a.start_date_text);
                    }
                    if (!mmdd && a && a.registration_ends_mmdd) {
                        if (typeof parseMMDDFromText === 'function') mmdd = parseMMDDFromText(a.registration_ends_mmdd);
                    }
                    if (!mmdd && a && a.registration_phase_text) {
                        if (typeof parseMMDDFromText === 'function') mmdd = parseMMDDFromText(a.registration_phase_text);
                    }
                    if (!mmdd) return Number.POSITIVE_INFINITY;
                    try {
                        const nowET = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/New_York' }));
                        const y = nowET.getFullYear();
                        const start = Date.UTC(y, mmdd.mm - 1, mmdd.dd);
                        const today = Date.UTC(y, nowET.getMonth(), nowET.getDate());
                        let diffDays = Math.round((start - today) / (24*60*60*1000));
                        // If negative, assume next year
                        if (diffDays < 0) {
                            const startNext = Date.UTC(y + 1, mmdd.mm - 1, mmdd.dd);
                            diffDays = Math.round((startNext - today) / (24*60*60*1000));
                        }
                        return diffDays;
                    } catch(_) { return Number.POSITIVE_INFINITY; }
                };
                allItems = allItems.slice().sort((a, b) => {
                    const sa = statusRank(a), sb = statusRank(b);
                    if (sa !== sb) return sa - sb;
                    const da = minsToDeadline(a), db = minsToDeadline(b);
                    if (da !== db) return da - db;
                    const ta = daysUntilStart(a), tb = daysUntilStart(b);
                    if (ta !== tb) return ta - tb;
                    // Stable-ish alphabetical tiebreaks
                    const sportA = String(a.sport || '').toLowerCase();
                    const sportB = String(b.sport || '').toLowerCase();
                    if (sportA !== sportB) return sportA.localeCompare(sportB);
                    const venueA = String(a.venue_name || '').toLowerCase();
                    const venueB = String(b.venue_name || '').toLowerCase();
                    if (venueA !== venueB) return venueA.localeCompare(venueB);
                    return String(a.program_name || a.name || '').localeCompare(String(b.program_name || b.name || ''));
                });
            }
            // Ensure current page is valid
            const total = allItems.length;
            const totalPages = Math.max(1, Math.ceil(total / pagination.perPage));
            if (pagination.page > totalPages) pagination.page = totalPages;
            if (pagination.page < 1) pagination.page = 1;
            const start = (pagination.page - 1) * pagination.perPage;
            const paged = allItems.slice(start, start + pagination.perPage);
            // Render cards for current page
            let ctaInserted = false;
            let renderedCount = 0;
            let wizardCardInserted = false;
            paged.forEach((activity, idx) => {
                // Insert Email Capture card at #5 on first page (index 4) if enabled and not already captured
                if (!emailCtaInserted && !emailCaptured && pagination.page === 1 && idx === 4) {
                    const card = document.createElement('article');
                    card.className = 'bg-white rounded-2xl border border-gray-200 overflow-hidden flex flex-col';
                    card.innerHTML = `
                        <div class="flex-1 p-6 md:p-8 bg-white text-center">
                            <img src="https://rivall-public.s3.us-west-1.amazonaws.com/logos/organization-logos/default-primary.png" alt="Volo logo" class="mx-auto h-10 md:h-12" loading="lazy" />
                            <h3 class="mt-5 text-xl md:text-2xl font-extrabold text-gray-900 tracking-tight">Never Miss a Game (or a Party)</h3>
                            <p class="mt-3 text-sm text-gray-800">Learn more about Volo Sports, plus <em class="italic">receive 15% off your first registration.</em></p>
                            <form id="email-capture-form" class="mt-5 flex items-stretch gap-2" novalidate>
                                <label class="sr-only" for="email-capture-input">Email</label>
                                <input id="email-capture-input" type="email" required placeholder="email@example.com" class="flex-1 rounded-xl border border-gray-300 bg-white text-gray-900 placeholder-gray-400 px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-blue-600" />
                                <button type="submit" class="shrink-0 inline-flex items-center justify-center rounded-xl px-5 py-2.5 text-sm font-bold bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-600">Sign Up</button>
                            </form>
                            <p class="mt-3 text-sm text-red-600">Promo code is for new members only.</p>
                            <p class="mt-2 text-[11px] text-gray-500">*Cannot apply discount to Volo Pass membership.</p>
                        </div>
                    `;
                    activityCardsContainer.appendChild(card);
                    // Wire submit handler
                    const form = card.querySelector('#email-capture-form');
                    const input = card.querySelector('#email-capture-input');
                    if (form && input) {
                        form.addEventListener('submit', (e) => {
                            e.preventDefault();
                            const email = String(input.value || '').trim();
                            const ok = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
                            if (!ok) {
                                input.classList.add('ring-2','ring-red-500','border-red-500');
                                input.focus();
                                return;
                            }
                            try { localStorage.setItem('voloEmailCaptured','1'); localStorage.setItem('voloEmailAddress', email); } catch(_) {}
                            // Success state
                            card.innerHTML = `
                                <div class="flex-1 p-6 md:p-8 bg-white text-center">
                                    <img src="https://rivall-public.s3.us-west-1.amazonaws.com/logos/organization-logos/default-primary.png" alt="Volo logo" class="mx-auto h-10 md:h-12" loading="lazy" />
                                    <div class="mt-4 inline-flex items-center rounded-full bg-emerald-100 text-emerald-700 text-xs font-bold px-2.5 py-1">You're in</div>
                                    <h3 class="mt-3 text-xl md:text-2xl font-extrabold text-gray-900 tracking-tight">Thanks! We’ll keep you in the loop.</h3>
                                    <p class="mt-1 text-sm text-gray-700">Watch your inbox for local games, leagues, and parties. See you out there.</p>
                                </div>`;
                        });
                        input.addEventListener('input', () => {
                            input.classList.remove('ring-2','ring-red-500','border-red-500');
                        });
                    }
                    emailCtaInserted = true;
                    renderedCount++;
                }
                // Build experience elevator pills (top row over image)
                const elevatorPillsHtml = buildElevatorPillsHtml(activity);
                // Note: ratingColor previously used for badges; currently unused and removed for clarity
                const activityTypePill = buildActivityTypePill(activity);
                const statusPillsHtml = buildStatusPillsHtml(activity, { includeClosing: false });
                // Derive fields for new bottom row; use sensible defaults if not provided
                const composition = (activity.format ? (activity.format.toLowerCase().startsWith('coed') ? 'Coed' : activity.format.toLowerCase().startsWith('women') ? "Women's" : activity.format.toLowerCase().startsWith('men') ? "Men's" : activity.format.toLowerCase().startsWith('open') ? 'Open' : 'Coed') : 'Coed');
                const skill = (Array.isArray(activity.skill_levels) && activity.skill_levels.length > 0) ? activity.skill_levels[0] : (activity.skill || 'Recreational');
                const format = (() => { const m = (activity.format || '').match(/\b(\d+v\d+)\b/i); return m ? m[1] : (activity.format || '7v7'); })();
                // Pricing fields and rendering helpers
                const daily = isDailyActivity(activity);
                const primaryPrice = getPrimaryPriceInfo(activity);
                const secondaryLine = getSecondaryPriceLine(activity);
                // Schedule fields for display under location
                const beginsOn = activity.beginsOn || '9/25';
                const weeks = activity.weeks || 7;
                const startTime = activity.startTime || '6:30 PM';
                const endTime = activity.endTime || '9:00 PM';
                // Audience icon based on composition
                const compLower = (composition || '').toLowerCase();
                const iconCoed = '<i data-lucide="users" class="h-4 w-4 text-gray-600"></i>'; 
                const iconMens = '<i data-lucide="mars" class="h-4 w-4 text-gray-600"></i>'; 
                const iconWomens = '<i data-lucide="venus" class="h-4 w-4 text-gray-600"></i>'; 
                const iconOpen = '<i data-lucide="circle" class="h-4 w-4 text-gray-600"></i>'; 
                const compIcon = compLower.includes('women') ? iconWomens : compLower.includes('men') ? iconMens : compLower.includes('coed') ? iconCoed : iconOpen;
                // Skill icon (varies by level)
                // Format icon (three users)
                const formatIcon = '<i data-lucide="users" class="h-4 w-4 text-gray-600"></i>';
                // Prepare price parts for formatted display with small cents
                const memberParts = primaryPrice ? formatMoneyParts(primaryPrice.amount) : null;
                // Derive title with optional day pill
                const dayPillHtml = buildDayPillHtml(activity);
                const pillsRowHtml = (dayPillHtml || elevatorPillsHtml) ? `<div class="flex items-center gap-1 mb-1">${dayPillHtml}${elevatorPillsHtml}</div>` : '';
                const finalTitleText = sanitizeTitle(buildStandardTitle(activity));
                const card = document.createElement('article');
                card.className = 'bg-white rounded-2xl border border-gray-200 overflow-hidden flex flex-col';
                // Attach useful data attributes for analytics or future wiring
                card.dataset.activityId = activity.id || '';
                card.dataset.source = activity.source || '';
                card.dataset.activityType = getActivityType(activity) || '';
                card.dataset.sport = activity.sport || '';
                card.dataset.venue = activity.venue_name || '';
                if (activity.date_mmdd) card.dataset.dateMmdd = activity.date_mmdd;
                if (activity.day_label) card.dataset.day = activity.day_label;
                // Build media slides (video for Glow Kickball + primary image + sporadic placeholder)
                const alt = activity.image_alt || activity.name || activity.program_name || activity.venue_name || 'Activity image';
                const slides = [];
                if (hasGlowKickballVideo(activity)) {
                    slides.push(buildVideoSlide('utMEhvPfU-k'));
                }
                slides.push(buildImageSlide(activity.image_url || activity.img, alt));
                // Always include a second slide so hover can reveal it
                slides.push(buildPlaceholderSlide('2nd image'));
                const carouselHtml = buildCarouselHtml(slides, true);
                // Build optional format block (hide if no NvN derived)
                const nvnForBottom = (() => { const m = (activity.format || '').match(/\b(\d+v\d+)\b/i); return m ? m[1] : ''; })();
                const formatBlockHtml = nvnForBottom ? `
                                <div class="flex items-center gap-2 min-w-0">
                                    ${formatIcon}
                                    <span class="meta-text text-xs md:text-sm text-gray-800 truncate" title="${nvnForBottom}">${nvnForBottom}</span>
                                </div>` : '';

                // Event social proof values used by the bottom row template
                const type = (typeof getActivityType === 'function') ? getActivityType(activity) : '';
                const isEvent = (type === 'Event' || (activity && activity.source === 'events'));
                const isRental = (activity && activity.source === 'rentals');
                const attendeeCount = isEvent ? getAttendeeCount(activity) : null;
                const eventId = String(activity.id || activity.program_id || activity.name || '');
                const interestedActive = (isEvent && eventId) ? isEventInterested(eventId) : false;

                card.innerHTML = `
                    <!-- Top half: Image -->
                    <div class="h-56 relative">
                        ${carouselHtml}
                        ${activityTypePill}
                        ${statusPillsHtml}
                        <div class="img-bottom-gradient"></div>
                        <div class="absolute left-0 right-0 bottom-0 py-3 px-4 z-10">
                            ${pillsRowHtml}
                            <div class="overlay-title font-bold leading-snug mb-2 mt-3">${finalTitleText}</div>
                        </div>
                    </div>
                    <!-- Bottom half: Content split horizontally (2/3 height then 1/3 height) -->
                    <div class="border-t border-gray-200 flex flex-col min-h-0">
                        <!-- Top content (flex-1, allows shrinking) -->
                        <div class="flex-1 px-4 pt-4 pb-4 flex flex-col min-h-0 overflow-hidden">
                            <div class="flex items-start justify-between min-w-0">
                                <h3 class="text-base md:text-lg font-bold text-gray-800 truncate flex items-center gap-2">
                                    <button type="button" class="shrink-0 text-gray-600 hover:text-blue-600" data-action="view-map-location" data-lat="${Number(activity.lat)}" data-lng="${Number(activity.lng)}" title="View on map">
                                        <i data-lucide="map-pin" class="h-4 w-4"></i>
                                    </button>
                                    <span class="card-title-link text-gray-900 truncate">${sanitizeTitle(activity.venue_name || activity.program_name || activity.name)}</span>
                                </h3>
                                <div class="text-right ml-3">
                                    ${primaryPrice ? `
                                    <div class="flex items-baseline justify-end gap-1">
                                        ${primaryPrice.displayText ? `<p class=\"text-lg md:text-xl font-bold text-gray-800\">${primaryPrice.displayText}</p>` : (() => { const p = formatMoneyParts(primaryPrice.amount); return `<p class=\"text-lg md:text-xl font-bold text-gray-800\">$${p.dollars}${p.cents !== '00' ? `<span class="align-text-top text-xs">.${p.cents}</span>` : ''}</p>`; })()}
                                        <span class="text-xs text-gray-500">${primaryPrice.suffix}</span>
                                        <button type="button" class="align-middle text-gray-500 hover:text-blue-600" aria-label="Learn about Volo Pass" data-action="open-volo-pass-modal">
                                            <i data-lucide="info" class="w-4 h-4"></i>
                                        </button>
                                    </div>` : ''}
                                </div>
                            </div>
                            <div class="mt-1 flex items-center justify-between gap-3 text-xs md:text-sm">
                                <div class="text-xs md:text-sm text-gray-700 truncate min-w-0" title="${getScheduleLine(activity)}">${getScheduleLine(activity)}</div>
                                <div class="text-xs md:text-sm text-gray-500 whitespace-nowrap shrink-0">${secondaryLine}</div>
                            </div>
                        </div>
                        <!-- Bottom row (fixed, stays visible) -->
                        <div class="shrink-0 border-t border-gray-200 px-3 pt-4 pb-4">
                            <div class="flex items-center justify-start gap-5 h-full">
                                ${isEvent ? `
                                    ${(() => { const total = getJoinCount(activity); return total ? `<div class=\"flex items-center gap-1 min-w-0\"><span class=\"text-xs md:text-sm text-gray-800 truncate\" title=\"Join ${total.toLocaleString()} attending or interested\">Join <strong>${total.toLocaleString()}</strong> attending or interested</span></div>` : ''; })()}
                                    ${getAgeBadgeHtml(activity)}
                                    <div class=\"ml-auto flex items-center gap-2\">
                                        <button type=\"button\" class=\"inline-flex items-center gap-1 text-xs md:text-sm font-semibold rounded-full px-3 py-1.5 border ${interestedActive ? 'border-yellow-600 text-yellow-600' : 'border-gray-300 text-gray-700'} hover:bg-gray-50\" data-action=\"toggle-interested\" data-activity-id=\"${String(activity.id || activity.program_id || activity.name || '')}\">
                                            <i data-lucide=\"heart\" class=\"h-4 w-4\"></i>
                                            <span>${interestedActive ? 'Interested' : 'Mark Interested'}</span>
                                        </button>
                                        ${buildClosingInlineHtml(activity)}
                                    </div>
                                ` : isRental ? `
                                    <div class=\"flex items-center gap-2 min-w-0\">
                                        <i data-lucide=\"layers\" class=\"h-4 w-4 text-gray-600\"></i>
                                        <span class=\"meta-text text-xs md:text-sm text-gray-800 truncate\" title=\"${activity.units_count || 0} ${activity.units_label}\">${activity.units_count || 0} ${activity.units_label}</span>
                                    </div>
                                    <div class=\"flex items-center gap-2 min-w-0\">
                                        <i data-lucide=\"users\" class=\"h-4 w-4 text-gray-600\"></i>
                                        <span class=\"meta-text text-xs md:text-sm text-gray-800 truncate\" title=\"Max ${activity.max_guests_per_unit || ''} per ${activity.units_label || 'unit'}\">Max ${activity.max_guests_per_unit || ''} / ${activity.units_label || 'unit'}</span>
                                    </div>
                                    ${(() => {
                                        const min = Number(activity.price_hr_min);
                                        const max = Number(activity.price_hr_max);
                                        if (Number.isFinite(min)) {
                                            const priceLabel = (Number.isFinite(max) && max !== min)
                                                ? `$${min.toLocaleString()}–$${max.toLocaleString()}/hr`
                                                : `$${min.toLocaleString()}/hr`;
                                            return `<div class=\"ml-auto flex items-center\"><span class=\"elev-pill inline-flex items-center gap-1 rounded-full bg-gray-100 text-gray-800 text-[12.5px] px-2.5 py-1 border border-gray-300\"><i data-lucide=\"clock\" class=\"w-3.5 h-3.5\"></i><span>${priceLabel}</span></span></div>`;
                                        }
                                        return '';
                                    })()}
                                ` : `
                                    ${daily ? `${getSurfaceBadgeHtml(activity)}` : ''}
                                    <div class=\"flex items-center gap-2 min-w-0\">
                                        ${compIcon}
                                        <span class=\"meta-text text-xs md:text-sm text-gray-800 truncate\" title=\"${composition}\">${composition}</span>
                                    </div>
                                    <div class=\"flex items-center gap-2 min-w-0\">
                                        ${getSkillIconSvg(skill)}
                                        <span class=\"meta-text text-xs md:text-sm text-gray-800 truncate\" title=\"${skill}\">${skill}</span>
                                    </div>
                                    ${!daily ? `${formatBlockHtml}` : ''}
                                    ${getAgeBadgeHtml(activity)}
                                    <div class=\"ml-auto flex items-center gap-2\">${buildClosingInlineHtml(activity)}</div>
                                `}
                            </div>
                        </div>
                    </div>`;
                activityCardsContainer.appendChild(card);
                const carEl = card.querySelector('.media-carousel');
                if (carEl) { activateCarousel(carEl); attachHoverToMedia(carEl); }
                renderedCount++;

                // Insert Wizard CTA at the 15th position on page 1 (after the 14th activity card)
                if (!wizardCardInserted && pagination.page === 1 && idx === 13) {
                    const wizardCard = document.createElement('article');
                    wizardCard.className = 'rounded-2xl overflow-hidden flex flex-col bg-white border border-gray-200';
                    wizardCard.innerHTML = `
                        <div class="flex-1 relative flex flex-col items-center justify-center text-center p-6 md:p-8 gap-3 overflow-hidden">
                            <div class="absolute inset-0 opacity-10 bg-cover bg-center pointer-events-none z-0" style="background-image:url('./overlay-image.jpg')"></div>
                            <div class="relative z-10 flex flex-col items-center gap-2">
                                <h3 class="text-lg md:text-xl font-bold text-gray-900">Not sure what you’re looking for?</h3>
                                <p class="text-sm md:text-base text-gray-600">Let us help you find your fun.</p>
                                <button type="button" class="mt-2 inline-flex items-center justify-center rounded-full px-4 py-2 text-sm font-bold border border-blue-600 bg-blue-600 text-white hover:bg-blue-700" data-action="open-wizard">
                                    Answer a few quesitons
                                </button>
                            </div>
                        </div>`;
                    activityCardsContainer.appendChild(wizardCard);
                    wizardCardInserted = true;
                    renderedCount++;
                }

                // Insert CTA card after the 7th item (8th position) only on first page, and only if total results >= 8
                if (!ctaInserted && pagination.page === 1 && total >= 8 && idx === 6) {
                    const cta = document.createElement('article');
                    cta.className = 'rounded-2xl overflow-hidden flex flex-col bg-[#0034DD] text-white border border-gray-200';
                    cta.innerHTML = `
                        <div class="flex-1 relative flex flex-col items-center justify-center text-center p-6 md:p-8 gap-3 overflow-hidden">
                            <div class="absolute inset-0 opacity-20 bg-cover bg-center pointer-events-none z-0" style="background-image:url('./overlay-image.jpg')"></div>
                            <div class="relative z-10 flex flex-col items-center gap-3">
                                <h3 class="font-extrabold uppercase tracking-tight text-[30px] leading-tight">Play More, Pay Less</h3>
                                <p class="text-sm md:text-base text-blue-50 max-w-md">Play unlimited pickups, drop-ins, clinics, and tournaments. Get discounts on leagues and access to exclusive member events.</p>
                            </div>
                        </div>
                        <div class="shrink-0 border-t border-[#0034DD] bg-white px-3 pt-4 pb-4">
                            <div class="flex items-center justify-center h-full">
                                <a href="#" class="inline-flex items-center justify-center rounded-full px-4 py-2 text-sm font-bold border border-[#c7ff10] bg-[#c7ff10] text-black hover:brightness-95 transition">BECOME A VOLO PASS MEMBER</a>
                            </div>
                        </div>`;
                    activityCardsContainer.appendChild(cta);
                    ctaInserted = true;
                    renderedCount++;
                }
            });
            // Wizard CTA filler: previously added a second Wizard card to fill md 2-col grid.
            // Per request, only keep the Wizard at position #15; do not add any additional Wizard tiles.
            // If we ever want a generic visual spacer on odd counts, we can add a non-interactive placeholder here.
            if (false && renderedCount % 2 === 1) {
                const wizardCta = document.createElement('article');
                wizardCta.className = 'hidden md:flex rounded-2xl overflow-hidden flex-col bg-white border border-gray-200';
                wizardCta.innerHTML = `
                    <div class="flex-1 relative flex flex-col items-center justify-center text-center p-6 md:p-8 gap-3 overflow-hidden">
                        <div class="absolute inset-0 opacity-10 bg-cover bg-center pointer-events-none z-0" style="background-image:url('./overlay-image.jpg')"></div>
                        <div class="relative z-10 flex flex-col items-center gap-2">
                            <h3 class="text-lg md:text-xl font-bold text-gray-900">Not sure what you’re looking for?</h3>
                            <p class="text-sm md:text-base text-gray-600">Let us help you find your fun.</p>
                            <button type="button" class="mt-2 inline-flex items-center justify-center rounded-full px-4 py-2 text-sm font-bold border border-blue-600 bg-blue-600 text-white hover:bg-blue-700" data-action="open-wizard">
                                Answer a few quesitons
                            </button>
                        </div>
                    </div>`;
                activityCardsContainer.appendChild(wizardCta);
            }
            // If nothing rendered (no results), show a clear wizard CTA to help the user
            if (renderedCount === 0) {
                const noResults = document.createElement('article');
                noResults.className = 'rounded-2xl overflow-hidden flex flex-col bg-white border border-gray-200';
                noResults.innerHTML = `
                    <div class="flex-1 relative flex flex-col items-center justify-center text-center p-8 gap-3 overflow-hidden">
                        <div class="relative z-10 flex flex-col items-center gap-2">
                            <h3 class="text-xl font-bold text-gray-900">We couldn’t find a match</h3>
                            <p class="text-sm md:text-base text-gray-600">Try the Wizard to discover activities that fit your schedule and vibe.</p>
                            <button type="button" class="mt-2 inline-flex items-center justify-center rounded-full px-4 py-2 text-sm font-bold border border-blue-600 bg-blue-600 text-white hover:bg-blue-700" data-action="open-wizard">Answer a few quesitons</button>
                        </div>
                    </div>`;
                activityCardsContainer.appendChild(noResults);
            }
            renderPagination(total);
                // Render Lucide icons for any placeholders in newly injected DOM
                if (window.lucide && typeof window.lucide.createIcons === 'function') {
                    window.lucide.createIcons();
                }
    
            // Global Interested toggle handler (Events)
            if (!window.__interestedToggleHandlerInstalled) {
                document.addEventListener('click', (e) => {
                    const btn = e.target && e.target.closest && e.target.closest('[data-action="toggle-interested"]');
                    if (!btn) return;
                    e.preventDefault();
                    const id = btn.getAttribute('data-activity-id') || '';
                    if (!id) return;
                    const nowActive = !isEventInterested(id);
                    setEventInterested(id, nowActive);
                    // Update button styles/text
                    btn.classList.toggle('border-orange-600', nowActive);
                    btn.classList.toggle('text-orange-600', nowActive);
                    btn.classList.toggle('border-gray-300', !nowActive);
                    btn.classList.toggle('text-gray-700', !nowActive);
                    const label = btn.querySelector('span');
                    if (label) label.textContent = nowActive ? 'Interested' : 'Mark Interested';
                });
                window.__interestedToggleHandlerInstalled = true;
            }
            // Start/upkeep countdown timers for same-day closings
            if (typeof startCountdownTicker === 'function') startCountdownTicker();
            // Render non-matching section beneath
            renderNonMatchingSection();
        }

        function renderPagination(totalItems) {
            const container = document.getElementById('pagination-container');
            if (!container) return;
            container.innerHTML = '';
            const per = pagination.perPage;
            const totalPages = Math.max(1, Math.ceil((totalItems || 0) / per));
            if (totalPages <= 1) return; // nothing to render
            const btnBase = 'px-3 py-1 rounded border text-sm';
            const mkBtn = (label, page, disabled=false, active=false) => {
                const btn = document.createElement('button');
                btn.className = `${btnBase} ${active ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-700 border-gray-300 hover:border-gray-400'} ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`;
                btn.textContent = label;
                if (!disabled) {
                    btn.addEventListener('click', () => {
                        pagination.page = page;
                        renderActivities();
                        updateResultsHeading();
                        // Keep page top in view on page change
                        scrollToTopOfResults();
                        // Map shows all filtered results; no need to refresh markers on page change
                    });
                }
                return btn;
            };
            // Prev
            container.appendChild(mkBtn('Prev', Math.max(1, pagination.page - 1), pagination.page === 1));
            // Page numbers (show up to 9 with ellipses if needed)
            const pages = [];
            const maxToShow = 9;
            if (totalPages <= maxToShow) {
                for (let i = 1; i <= totalPages; i++) pages.push(i);
            } else {
                const start = Math.max(1, pagination.page - 2);
                const end = Math.min(totalPages, start + 4);
                const set = new Set([1,2, ...Array.from({length: end - start + 1}, (_, idx) => start + idx), totalPages-1, totalPages]);
                const seq = Array.from(set).filter(n => n >= 1 && n <= totalPages).sort((a,b)=>a-b);
                for (let i = 0; i < seq.length; i++) {
                    pages.push(seq[i]);
                    if (i < seq.length - 1 && seq[i+1] - seq[i] > 1) pages.push('…');
                }
            }
            pages.forEach(p => {
                if (p === '…') {
                    const span = document.createElement('span');
                    span.className = 'px-2 text-gray-500';
                    span.textContent = '…';
                    container.appendChild(span);
                } else {
                    container.appendChild(mkBtn(String(p), p, false, p === pagination.page));
                }
            });
            // Next
            container.appendChild(mkBtn('Next', Math.min(totalPages, pagination.page + 1), pagination.page === totalPages));
        }

        // Initialize Wizard after page scripts are ready
        (async function initExtras(){
            // Lazy-load wizard; opener also ensures loading on demand
            try { await loadWizardModal(); } catch(_) {}
        })();

        // Smoothly scroll to top of results (list view only)
        function scrollToTopOfResults() {
            if (mapView && !mapView.classList.contains('hidden')) return; // Only when in list view
            // Scroll to the top of the search bar section so the dropdowns are visible
            const topEl = document.getElementById('search-bar-section') || document.getElementById('results-heading');
            const y = topEl ? topEl.getBoundingClientRect().top + window.pageYOffset - 16 : 0;
            window.scrollTo({ top: Math.max(0, y), behavior: 'smooth' });
        }

        // Media hover UX: switch to the second slide on hover; revert on mouse leave
        function attachHoverToMedia(container) {
            if (!container) return;
            const host = container.closest('.h-56, .h-40');
            const target = host || container;
            target.addEventListener('mouseenter', () => setCarouselIndex(container, 1), { passive: true });
            target.addEventListener('mouseleave', () => setCarouselIndex(container, 0), { passive: true });
            // Touch: intentionally no-op; consider tap-to-toggle if mobile carousel UX is added
        }

        // Build a small card renderer for non-matching items (simplified)
        function renderNonMatchingSection() {
            const section = document.getElementById('nonmatching-section');
            const grid = document.getElementById('nonmatching-cards-container');
            const centerPills = document.getElementById('centered-applied-pills');
            const banner = document.getElementById('cross-sell-banner');
            if (!section || !grid || !centerPills) return;
            const active = getActiveFilters();
            const filtered = getFilteredActivities();
            // Determine if a global search scope is applied (Activities dropdown and/or Your Sports)
            const selectedSports = (typeof getSelectedSports === 'function') ? getSelectedSports() : [];
            const activitiesInput = document.getElementById('activities');
            const hasActivitySearch = !!(activitiesInput && String(activitiesInput.value || '').trim());
            const hasGlobalSearch = (selectedSports.length > 0) || hasActivitySearch;
            // Hide section when no filters and no global search are active, or dataset is empty
            if ((active.length === 0 && !hasGlobalSearch) || activities.length === 0) {
                section.classList.add('hidden');
                grid.innerHTML = '';
                centerPills.innerHTML = '';
                return;
            }
            // Suppress guidance when current filtered result set spans multiple pages (to reduce noise)
            if (Array.isArray(filtered) && filtered.length > (pagination?.perPage || 18)) {
                section.classList.add('hidden');
                grid.innerHTML = '';
                centerPills.innerHTML = '';
                return;
            }
            // Prepare dynamic heading text and pills area depending on whether this is a filter-driven or search-driven empty state
            const headerTitle = section.querySelector('h3');
            const listTitle = section.querySelector('h4');
            const removeAllBtn = section.querySelector('[data-action="remove-all"]');
            const removeAllWrap = removeAllBtn ? removeAllBtn.closest('div') : null;

            if (active.length > 0) {
                // Filters are applied: show filter guidance and show applied pills
                if (headerTitle) headerTitle.textContent = 'Try removing filters to see more activities';
                if (listTitle) listTitle.textContent = "Activities that don't match all your filters";
                if (removeAllWrap) removeAllWrap.classList.remove('hidden');
                // Update centered applied pills
                centerPills.innerHTML = active.map(input => (
                    `<button type="button" class="flex items-center bg-[#f7f7f7] text-black border border-black text-sm font-normal px-3 py-1 rounded-full" data-filter-id="${input.id}">
                        <span>${input.dataset.name}</span>
                        <i data-lucide="x" class="w-4 h-4 ml-2"></i>
                    </button>`
                )).join('');
            } else {
                // No filters, but a global search (e.g., sports) is applied
                if (headerTitle) headerTitle.textContent = 'Try a new search to see more activities';
                if (listTitle) listTitle.textContent = "Activities that don't match your current search";
                if (removeAllWrap) removeAllWrap.classList.add('hidden');
                centerPills.innerHTML = '';
            }
            // Cross-sell banner for few (<=4) or zero results in scoped searches between Daily and Leagues
            (function renderCrossSell(){
                try {
                    if (!banner) return;
                    // Default hide
                    banner.classList.add('hidden');
                    banner.innerHTML = '';
                    const scopeVal = (activitiesInput && activitiesInput.value) ? String(activitiesInput.value).toLowerCase().trim() : '';
                    const isDaily = scopeVal === 'daily sports';
                    const isLeagues = scopeVal === 'leagues' || scopeVal === 'league';
                    if (!(isDaily || isLeagues)) return; // only cross-sell between Daily and Leagues
                    const count = Array.isArray(filtered) ? filtered.length : 0;
                    if (count > 4) return; // only when few or zero
                    // Build content
                    const suggestTo = isDaily ? 'Leagues' : 'Daily Sports';
                    const title = isDaily
                        ? 'Not finding the daily sport you want? Try Leagues'
                        : 'Looking for something a little more casual? Try Daily Sports';
                    const blurb = isDaily
                        ? 'Leagues are weekly games and playoffs. Join solo, with friends, or a full team — guaranteed games each week.'
                        : 'Daily Sports are drop-ins and pickups you can join today — no season commitment needed.';
                    const btnId = 'cross-sell-switch-btn';
                    // Use local images placed at project root for sharper and consistent rendering
                    const imgDaily = './no-dailys.jpg';
                    const imgLeagues = './no-leagues.jpg';
                    // If current scope is Daily, we suggest Leagues -> show no-leagues; if current is Leagues, suggest Daily -> show no-dailys
                    const imageUrl = isDaily ? imgLeagues : imgDaily;
                    const imageAlt = isDaily ? 'Leagues' : 'Daily Sports';
                    const html = `
                        <div class="rounded-2xl overflow-hidden border border-[#0034DD]">
                            <div class="grid grid-cols-1 md:grid-cols-4">
                                <div class="relative md:col-span-1 h-40 md:h-full">
                                    <img src="${imageUrl}" alt="${imageAlt}" loading="lazy" class="absolute inset-0 w-full h-full object-cover" />
                                </div>
                                <div class="md:col-span-3 bg-[#0034DD] text-white p-4 md:p-6 flex items-center">
                                    <div class="flex-1 min-w-0">
                                        <div class="text-base md:text-lg font-bold leading-snug">${title}</div>
                                        <div class="text-sm md:text-base opacity-90 mt-1">${blurb}</div>
                                    </div>
                                    <button id="${btnId}" type="button" class="ml-4 shrink-0 inline-flex items-center px-3 py-2 rounded-full bg-white text-[#0034DD] text-sm font-bold hover:bg-blue-50 border border-white">
                                        View ${suggestTo}
                                    </button>
                                </div>
                            </div>
                        </div>`;
                    banner.innerHTML = html;
                    banner.classList.remove('hidden');
                    // Wire CTA: switch Activities scope and re-apply
                    const btn = document.getElementById(btnId);
                    if (btn && activitiesInput) {
                        btn.addEventListener('click', () => {
                            activitiesInput.value = suggestTo;
                            // Apply scope-specific filter visibility and re-render results immediately
                            if (typeof applyActivityTypeFilterVisibility === 'function') applyActivityTypeFilterVisibility();
                            if (typeof applyFiltersAndRerender === 'function') applyFiltersAndRerender();
                            if (typeof scrollToTopOfResults === 'function') scrollToTopOfResults();
                        }, { once: true });
                    }
                } catch(_) { /* no-op */ }
            })();

            // Compute non-matching items: items not in the filtered set
            const filteredIds = new Set(filtered.map(a => a.id));
            const nonmatching = activities.filter(a => !filteredIds.has(a.id));
            if (nonmatching.length === 0) {
                // Nothing to show; hide section
                section.classList.add('hidden');
                grid.innerHTML = '';
                if (banner) { banner.classList.add('hidden'); banner.innerHTML=''; }
                return;
            }
            // Show section and render a subset (keep it compact; show up to 8)
            section.classList.remove('hidden');
            grid.innerHTML = '';
            nonmatching.slice(0, 8).forEach(activity => {
                const dayPillHtml2 = buildDayPillHtml(activity);
                const elevatorPillsHtml = buildElevatorPillsHtml(activity);
                const pillsRowHtml2 = (dayPillHtml2 || elevatorPillsHtml) ? `<div class=\"flex items-center gap-1 mb-1\">${dayPillHtml2}${elevatorPillsHtml}</div>` : '';
                const finalTitleText2 = sanitizeTitle(buildStandardTitle(activity));
                const card = document.createElement('article');
                card.className = 'bg-white rounded-2xl border border-gray-200 overflow-hidden flex flex-col opacity-90';
                card.dataset.activityId = activity.id || '';
                card.dataset.source = activity.source || '';
                card.dataset.activityType = getActivityType(activity) || '';
                card.dataset.sport = activity.sport || '';
                card.dataset.venue = activity.venue_name || '';
                if (activity.date_mmdd) card.dataset.dateMmdd = activity.date_mmdd;
                if (activity.day_label) card.dataset.day = activity.day_label;
                const activityTypePill = buildActivityTypePill(activity);
                const statusPillsHtml = buildStatusPillsHtml(activity, { includeClosing: false });
                const composition = deriveCompositionFromFormat(activity.format);
                const skill = (Array.isArray(activity.skill_levels) && activity.skill_levels.length > 0) ? activity.skill_levels[0] : (activity.skill || 'Recreational');
                const format = (() => { const m = (activity.format || '').match(/\b(\d+v\d+)\b/i); return m ? m[1] : ''; })();
                // Skill icon varies by level
                const formatIcon = '<i data-lucide="users" class="h-4 w-4 text-gray-600"></i>';
                const iconCoed = '<i data-lucide="users" class="h-4 w-4 text-gray-600"></i>';
                const iconMens = '<i data-lucide="mars" class="h-4 w-4 text-gray-600"></i>';
                const iconWomens = '<i data-lucide="venus" class="h-4 w-4 text-gray-600"></i>';
                const iconOpen = '<i data-lucide="circle" class="h-4 w-4 text-gray-600"></i>';
                const compLower = (composition || '').toLowerCase();
                const compIcon = compLower.includes('women') ? iconWomens : compLower.includes('men') ? iconMens : compLower.includes('coed') ? iconCoed : iconOpen;
                // Build media slides for non-matching card
                const alt3 = activity.image_alt || activity.name || activity.program_name || activity.venue_name || 'Activity image';
                const slides3 = [];
                if (hasGlowKickballVideo(activity)) slides3.push(buildVideoSlide('utMEhvPfU-k'));
                slides3.push(buildImageSlide(activity.image_url || activity.img, alt3));
                slides3.push(buildPlaceholderSlide('2nd image'));
                const carouselHtml3 = buildCarouselHtml(slides3, false);
                const dailyNM = isDailyActivity(activity);
                const secondaryLineNM = getSecondaryPriceLine(activity);
                const formatBlockNM = format ? `<div class=\"flex items-center gap-2 min-w-0\">${formatIcon}<span class=\"meta-text text-xs text-gray-800 truncate\" title=\"${format}\">${format}</span></div>` : '';

                card.innerHTML = `
                    <div class="h-40 relative">
                        ${carouselHtml3}
                        ${activityTypePill}
                        ${statusPillsHtml}
                        <div class="img-bottom-gradient"></div>
                        <div class="absolute left-0 right-0 bottom-0 p-3 z-10">
                            ${pillsRowHtml2}
                            <div class="overlay-title font-bold leading-snug">${finalTitleText2}</div>
                        </div>
                    </div>
                    <div class="border-t border-gray-200 p-3">
                        <div class="flex items-center justify-between gap-3 text-xs md:text-sm">
                            <div class="text-gray-700 truncate min-w-0">${activity.venue_name || ''}</div>
                            <div class="text-xs md:text-sm text-gray-500 whitespace-nowrap shrink-0">${getScheduleLine(activity)}</div>
                        </div>
                        <div class="mt-2 text-[11px] text-gray-500">${secondaryLineNM}</div>
                        <div class="mt-3 grid grid-cols-3 gap-3">
                            ${dailyNM ? `
                            ${getSurfaceBadgeHtml(activity)}
                            <div class=\"flex items-center gap-2 min-w-0\">${compIcon}<span class=\"meta-text text-xs text-gray-800 truncate\" title=\"${composition}\">${composition}</span></div>
                            <div class=\"flex items-center gap-2 min-w-0\">${getSkillIconSvg(skill)}<span class=\"meta-text text-xs text-gray-800 truncate\" title=\"${skill}\">${skill}</span></div>
                            ` : `
                            <div class=\"flex items-center gap-2 min-w-0\">${compIcon}<span class=\"meta-text text-xs text-gray-800 truncate\" title=\"${composition}\">${composition}</span></div>
                            <div class=\"flex items-center gap-2 min-w-0\">${getSkillIconSvg(skill)}<span class=\"meta-text text-xs text-gray-800 truncate\" title=\"${skill}\">${skill}</span></div>
                            ${formatBlockNM}`}
                        </div>
                    </div>`;
                grid.appendChild(card);
                const carEl3 = card.querySelector('.media-carousel');
                if (carEl3) { activateCarousel(carEl3); attachHoverToMedia(carEl3); }
            });
            if (window.lucide && typeof window.lucide.createIcons === 'function') {
                window.lucide.createIcons();
            }
        }

        // Render venue checkboxes under Location using venues from venue-locations.js
        function renderVenueFilters() {
            const list = document.getElementById('venue-list');
            if (!list || typeof venues === 'undefined' || !Array.isArray(venues)) return;
            const frag = document.createDocumentFragment();
            const sorted = [...venues].sort((a, b) => (a.venueName || '').localeCompare(b.venueName || ''));
            sorted.forEach(v => {
                const id = `venue-${(v.venueName || '').toLowerCase().replace(/[^a-z0-9]+/g, '-')}`;
                const label = document.createElement('label');
                label.className = 'flex items-center cursor-pointer';
                label.innerHTML = `<input type="checkbox" class="filter-input" id="${id}" data-name="${v.venueName}"> <span class="ml-2 text-sm">${v.venueName}</span>`;
                frag.appendChild(label);
            });
            list.innerHTML = '';
            list.appendChild(frag);
        }

        // Render dynamic Neighborhood checkboxes under Location using union of venues and current activities
        function renderNeighborhoodFilters() {
            const list = document.getElementById('neighborhood-list');
            if (!list) return;
            const normalize = (s) => String(s || '').trim();
            const idify = (s) => String(s || '').toLowerCase().replace(/[^a-z0-9]+/g, '-');
            // Capture prior show-more toggle state (if any) before we replace content
            const prevWrapper = list.querySelector('.show-more-wrapper') || (list.nextElementSibling && list.nextElementSibling.classList && list.nextElementSibling.classList.contains('show-more-wrapper') ? list.nextElementSibling : null);
            const prevToggle = prevWrapper ? prevWrapper.querySelector('button') : null;
            const prevToggleState = prevToggle ? prevToggle.dataset.state : null; // 'collapsed' | 'expanded' | null
            const set = new Set();
            // From venues mapping (static)
            if (typeof venues !== 'undefined' && Array.isArray(venues)) {
                venues.forEach(v => { if (v && v.neighborhood) set.add(normalize(v.neighborhood)); });
            }
            // From activities (post-transform)
            if (Array.isArray(activities)) {
                activities.forEach(a => {
                    const hood = (typeof getNeighborhoodForActivity === 'function') ? getNeighborhoodForActivity(a) : (a && a.neighborhood);
                    if (hood) set.add(normalize(hood));
                });
            }
            const values = Array.from(set).filter(Boolean).sort((a,b) => a.localeCompare(b));
            // Preserve currently-checked selections if re-rendering
            const prevChecked = new Set(Array.from(list.querySelectorAll('input[type="checkbox"]:checked')).map(i => i.dataset.name));
            const frag = document.createDocumentFragment();
            values.forEach(name => {
                const id = `hood-${idify(name)}`;
                const label = document.createElement('label');
                label.className = 'flex items-center cursor-pointer';
                label.innerHTML = `<input type="checkbox" class="filter-input" id="${id}" data-name="${name}"> <span class="ml-2 text-sm">${name}</span>`;
                frag.appendChild(label);
            });
            list.innerHTML = '';
            list.appendChild(frag);
            // Restore checked state
            list.querySelectorAll('input[type="checkbox"]').forEach(inp => {
                if (prevChecked.has(inp.dataset.name)) inp.checked = true;
            });
            // Re-apply show more/less control on this container
            if (typeof applyShowMore === 'function') {
                // Remove any prior flag so it can be reapplied after re-render
                if (list.dataset) delete list.dataset.showMoreApplied;
                applyShowMore(list);
                // If previously expanded, restore expanded state
                if (prevToggleState === 'expanded') {
                    const wrapperNow = list.querySelector('.show-more-wrapper') || (list.nextElementSibling && list.nextElementSibling.classList && list.nextElementSibling.classList.contains('show-more-wrapper') ? list.nextElementSibling : null);
                    const btnNow = wrapperNow ? wrapperNow.querySelector('button') : null;
                    if (btnNow) {
                        btnNow.dataset.state = 'expanded';
                        btnNow.textContent = 'Show less';
                        Array.from(list.querySelectorAll('label')).forEach(el => el.classList.remove('hidden'));
                    }
                }
            }
        }

        function getSelectedVenues() {
            const list = document.getElementById('venue-list');
            if (!list) return [];
            return Array.from(list.querySelectorAll('input.filter-input[type="checkbox"]:checked')).map(i => i.dataset.name || '');
        }
        function getSelectedNeighborhoods() {
            const list = document.getElementById('neighborhood-list');
            if (!list) return [];
            return Array.from(list.querySelectorAll('input.filter-input[type="checkbox"]:checked')).map(i => i.dataset.name || '');
        }
        function getSelectedCompositions() {
            // Composition checkboxes live under #section-player-team
            const ids = ['comp-coed', 'comp-mens', 'comp-open', 'comp-womens'];
            const selected = ids
                .map(id => document.getElementById(id))
                .filter(el => el && el.checked)
                .map(el => (el.dataset.name || '').trim());
            return selected;
        }
        function getSelectedSports() {
            const applied = document.getElementById('applied-sports-inputs');
            if (!applied) return [];
            return Array.from(applied.querySelectorAll('input[type="checkbox"].filter-input:checked'))
                .map(cb => (cb.dataset.name || '').trim())
                .filter(Boolean);
        }
        function getSelectedSkills() {
            const skillIds = ['skill-competitive', 'skill-intermediate', 'skill-recreational', 'skill-beginner'];
            return skillIds
                .map(id => document.getElementById(id))
                .filter(el => el && el.checked)
                .map(el => (el.dataset.name || '').trim());
        }
        function getSelectedCommunity() {
            // Community checkboxes under #section-player-team (currently: LGBTQ+, Singles)
            const ids = ['comm-lgbtq', 'comm-singles'];
            return ids
                .map(id => document.getElementById(id))
                .filter(el => el && el.checked)
                .map(el => (el.dataset.name || '').trim());
        }
        function getSelectedFeatures() {
            // Feature-style filters: Program Highlights, Amenities & Perks, Surface Type, Style of Play
            const nodes = document.querySelectorAll(
                '#section-highlights .filter-input:checked,\
                 #section-amenities .filter-input:checked,\
                 #section-program-details input[id^="surface-"].filter-input:checked,\
                 #section-program-details input[id^="style-"].filter-input:checked'
            );
            return Array.from(nodes).map(el => (el.dataset.name || '').trim()).filter(Boolean);
        }
        // --- PRICE FILTERING ---
        function getSelectedPriceType() {
            const r = document.querySelector('input[type="radio"][name="price-type"]:checked');
            return r ? (r.dataset.name || '') : '';
        }
        function computePriceMaxima(list) {
            const out = { member: 0, nonMember: 0, team: 0 };
            (list || []).forEach(a => {
                const m = (a.member_price_current != null ? Number(a.member_price_current) : null);
                const n = (a.price_person_current != null ? Number(a.price_person_current) : null);
                const t = (a.price_team != null ? Number(a.price_team) : null);
                if (Number.isFinite(m)) out.member = Math.max(out.member, m);
                if (Number.isFinite(n)) out.nonMember = Math.max(out.nonMember, n);
                if (Number.isFinite(t)) out.team = Math.max(out.team, t);
            });
            // Provide sensible floors if data empty
            if (out.member === 0) out.member = 100; // fallback
            if (out.nonMember === 0) out.nonMember = 100;
            if (out.team === 0) out.team = 100;
            return out;
        }
        function updatePriceSliderVisibilityAndBounds() {
            const container = document.getElementById('price-slider-container');
            const slider = document.getElementById('price-range');
            const disp = document.getElementById('price-range-display');
            if (!container || !slider || !disp) return;
            const type = getSelectedPriceType();
            if (!type) {
                container.classList.add('hidden');
                return;
            }
            // Show slider and set max based on dataset maxima for that type
            const maxima = computePriceMaxima(activities);
            let max = 100;
            if (type === 'Member') max = maxima.member;
            else if (type === 'Non-Member') max = maxima.nonMember;
            else if (type === 'Team') max = maxima.team;
            // Round to nice step increments
            const step = (type === 'Team') ? 50 : 25;
            const niceMax = Math.ceil(max / step) * step;
            slider.max = String(niceMax);
            slider.step = String(step);
            // If current value exceeds new max, clamp
            const cur = Math.min(Number(slider.value || niceMax), niceMax);
            slider.value = String(cur);
            container.classList.remove('hidden');
            disp.textContent = `$0 — $${Number(slider.value).toLocaleString()}`;
        }
        const FEATURE_ALIASES = {
            'dj at the bar': ['dj at the bar', 'dj on site'],
            'on-site parking': ['on-site parking', 'parking on site', 'on site parking'],
            'parking on site': ['on-site parking', 'parking on site', 'on site parking'],
            'bar on site': ['bar on site', 'sponsor bar'],
            'kid-friendly': ['kid-friendly','kid friendly','kids welcome','family friendly'],
            'flip cup counts': ['flip cup counts', 'flip cup', 'flipcup'],
            // Social & Bar Scene (Amenities) cross-maps
            'includes happy hour / bar deals': ['includes happy hour / bar deals', 'happy hour', 'bar deals', 'drink specials', 'drink deals'],
            'special events': ['special events', 'watch party', 'watch parties', 'player party', 'player parties', 'tailgate', 'tailgates', 'crawl', 'bar crawl', 'member night', 'club night'],
            // Style of Play common variants
            'glow': ['glow', 'glow league', 'glow night'],
            'open play': ['open play', 'drop-in', 'drop in', 'pickup', 'pick up'],
            'doubleheader': ['doubleheader', 'double header'],
            'ladder league': ['ladder league', 'ladder'],
            'party league': ['party league'],
            'party pickleball': ['party pickleball'],
            'traditional': ['traditional'],
            '2 games per night': ['2 games per night', 'two games per night'],
            // Surfaces & spaces
            'indoor': ['indoor', 'indoor space'],
            'outdoor': ['outdoor', 'outdoor space'],
            'grass': ['grass', 'grass field'],
            'beach/sand': ['beach/sand', 'sand', 'beach']
        };
        function norm(s) { return String(s || '').toLowerCase().replace(/\s+/g, ' ').trim(); }
        function normalizeVenueName(s) {
            return String(s || '')
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
        }
        function activityHasFeature(activity, name) {
            const feats = Array.isArray(activity.features) ? activity.features.map(f => norm(f)) : [];
            const n = norm(name);
            const aliases = FEATURE_ALIASES[n] ? FEATURE_ALIASES[n].map(norm) : [n];
            return aliases.some(alias => feats.includes(alias));
        }
        function expandSelectedFeatureNames(arr) {
            const out = [];
            arr.forEach(n => {
                const nn = norm(n);
                if (nn === 'glow + flip cup' || nn === 'glow+flip cup' || nn === 'glow + flipcup') {
                    out.push('GLOW', 'Flip Cup Counts');
                } else {
                    out.push(n);
                }
            });
            return out;
        }

        // --- DAY OF WEEK FILTERING ---
        function getSelectedDays() {
            const ids = ['day-mon','day-tue','day-wed','day-thu','day-fri','day-sat','day-sun'];
            const map = { 'Mon':'Mon', 'Tue':'Tue', 'Wed':'Wed', 'Thu':'Thu', 'Fri':'Fri', 'Sat':'Sat', 'Sun':'Sun' };
            return ids
                .map(id => document.getElementById(id))
                .filter(el => el && el.checked)
                .map(el => map[el.dataset.name] || el.dataset.name)
                .filter(Boolean);
        }
        // --- QUICK DATE FILTERING (Daily scope) ---
        function getSelectedQuickDates() {
            const ids = ['date-today','date-tomorrow','date-weekend','date-nextweek'];
            const active = ids
                .map(id => document.getElementById(id))
                .filter(el => el && el.checked)
                .map(el => el.id.replace('date-',''));
            return active; // e.g., ['today','weekend']
        }
        function deriveDayAbbrev(activity) {
            // Prefer resolved day from daily datasets if available
            if (activity && activity.day_abbrev) return activity.day_abbrev;
            const name = (activity.program_name || activity.title || '').toLowerCase();
            const days = [
                { k:'Mon', rx:/\bmonday\b/ },
                { k:'Tue', rx:/\btuesday\b/ },
                { k:'Wed', rx:/\bwednesday\b/ },
                { k:'Thu', rx:/\bthursday\b/ },
                { k:'Fri', rx:/\bfriday\b/ },
                { k:'Sat', rx:/\bsaturday\b/ },
                { k:'Sun', rx:/\bsunday\b/ }
            ];
            for (const d of days) if (d.rx.test(name)) return d.k;
            // Also support "Mon -" abbreviations at start
            const abbr = [
                { k:'Mon', rx:/^\s*mon\b/ },
                { k:'Tue', rx:/^\s*tue\b/ },
                { k:'Wed', rx:/^\s*wed\b/ },
                { k:'Thu', rx:/^\s*thu\b/ },
                { k:'Fri', rx:/^\s*fri\b/ },
                { k:'Sat', rx:/^\s*sat\b/ },
                { k:'Sun', rx:/^\s*sun\b/ }
            ];
            for (const d of abbr) if (d.rx.test(name)) return d.k;
            return '';
        }
        function deriveCompositionFromFormat(format) {
            const f = (format || '').toLowerCase();
            if (f.startsWith('women')) return "Women's";
            if (f.startsWith('men')) return "Men's";
            if (f.startsWith('open')) return 'Open';
            if (f.startsWith('coed')) return 'Coed';
            // Fallback: try keywords
            if (f.includes('women')) return "Women's";
            if (f.includes('men')) return "Men's";
            if (f.includes('open')) return 'Open';
            if (f.includes('coed')) return 'Coed';
            return 'Coed';
        }

        // Extract NvN (e.g., 7v7, 5v5, 2v2, 1v1) from the format string.
        function deriveNvNFromFormat(format) {
            const f = String(format || '').toLowerCase();
            const m = f.match(/\b(\d+)\s*[vx]\s*(\d+)\b/);
            if (m) return `${parseInt(m[1], 10)}v${parseInt(m[2], 10)}`;
            return '';
        }

        function getSelectedFormats() {
            const list = document.getElementById('format-list');
            if (!list) return [];
            return Array.from(list.querySelectorAll('input.filter-input[type="checkbox"]:checked'))
                .map(i => (i.dataset.name || '').trim())
                .filter(Boolean);
        }

        // --- DAILY TYPE FILTER (All / Drop-ins / Pickups) ---
        function getSelectedDailyType() {
            const radios = document.querySelectorAll('input[type="radio"][name="daily-type"]');
            const sel = Array.from(radios).find(r => r.checked);
            if (!sel) return 'all';
            const t = (sel.dataset.type || 'all').toLowerCase();
            return (t === 'drop-in' || t === 'pickup') ? t : 'all';
        }
        function renderDailyTypeExplainer() {
            const wrap = document.getElementById('daily-type-explainer');
            if (!wrap) return;
            const t = getSelectedDailyType();
            const lines = [];
            if (t === 'all' || t === 'drop-in') {
                lines.push('<div class="flex items-start gap-2"><i data-lucide="zap" class="h-5 w-5 text-orange-600 mt-0.5"></i><div><span class="font-semibold">Drop-ins</span> — Jump in for a single game. Try a new sport or join friends without the season-long commitment.</div></div>');
            }
            if (t === 'all' || t === 'pickup') {
                lines.push('<div class="flex items-start gap-2"><i data-lucide="arrow-up-right" class="h-5 w-5 text-green-600 mt-0.5"></i><div><span class="font-semibold">Pickups</span> — Just show up. We handle the teams and gear. Perfect for spontaneous play and packed schedules.</div></div>');
            }
            wrap.innerHTML = lines.join('');
            if (window.lucide && typeof window.lucide.createIcons === 'function') {
                window.lucide.createIcons();
            }
        }

    // --- SKILL NORMALIZATION --- (maps raw labels to canonical labels used in UI/filters)
        const SKILL_NORMALIZATION = {
            'advanced/competitive': 'Competitive',
            'competitive': 'Competitive',
            'advanced competitive': 'Competitive',
            'beginner/social': 'Social/Beginner',
            'social/beginner': 'Social/Beginner',
            'super social': 'Social/Beginner',
            'beginner': 'Social/Beginner',
            'social': 'Social/Beginner',
            'upper intermediate': 'Intermediate',
            'intermediate': 'Intermediate',
            'recreational': 'Recreational',
            'rec': 'Recreational'
        };
        // Back-compat shim: older builds referenced a global SKILL_TOKENS; define it from normalization keys
        // Ensure both a global var and a window property exist to satisfy any legacy references
        try {
            if (typeof window !== 'undefined') {
                window.SKILL_TOKENS = window.SKILL_TOKENS || Object.keys(SKILL_NORMALIZATION);
            }
            if (typeof SKILL_TOKENS === 'undefined') {
                var SKILL_TOKENS = Object.keys(SKILL_NORMALIZATION);
            }
        } catch (_) { /* no-op */ }
        function normalizeSkillLabel(s) {
            if (!s) return '';
            const raw = String(s).trim();
            const n = raw.toLowerCase();
            if (SKILL_NORMALIZATION[n]) return SKILL_NORMALIZATION[n];
            // Heuristics for partial matches
            if (n.includes('competitive') || n.includes('advanced')) return 'Competitive';
            if (n.includes('upper intermediate')) return 'Intermediate';
            if (n.includes('intermediate')) return 'Intermediate';
            if (n.includes('recreat') || /\brec\b/.test(n)) return 'Recreational';
            if (n.includes('beginner') || n.includes('social')) return 'Social/Beginner';
            return raw; // fallback to original label
        }
        function getFilteredActivities() {
            // Map Activities single-select to normalized types
            function getSelectedActivityTypes() {
                const inp = document.getElementById('activities');
                const val = inp ? String(inp.value || '').trim() : '';
                if (!val) return [];
                const key = val.toLowerCase();
                // Group mapping: UI label -> acceptable normalized types from getActivityType()
                const map = {
                    'leagues': ['League'],
                    'league': ['League'],
                    'tournaments': ['Tournament'],
                    'tournament': ['Tournament'],
                    // Daily Sports groups common daily offerings
                    'daily sports': ['Drop-in', 'PickUp'],
                    // Events and Private Rentals included for future data; may yield 0 with current dataset
                    'events': ['Event', 'Watch Party', 'Player Party', 'Happy Hour'],
                    'private rentals': ['Private Rentals', 'Rental']
                };
                return map[key] || [];
            }
            // Normalize venue names for robust matching (case/punctuation-insensitive)
            const normalizeVenueName = (s) => String(s || '')
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
            const selectedVenues = getSelectedVenues();
            const selectedNeighborhoods = getSelectedNeighborhoods ? getSelectedNeighborhoods() : [];
            const selectedComps = getSelectedCompositions();
            const selectedFormats = getSelectedFormats();
            const selectedSkills = getSelectedSkills();
            const selectedCommunity = getSelectedCommunity();
            const selectedSports = getSelectedSports();
            const selectedFeats = getSelectedFeatures();
            const selectedDays = getSelectedDays();
            const selectedQuickDates = getSelectedQuickDates ? getSelectedQuickDates() : [];
            const selectedActivityTypes = getSelectedActivityTypes();
            const priceType = getSelectedPriceType();
            const eventsScope = (typeof isEventsScope === 'function') ? isEventsScope() : false;
            // Early return for Leagues: if no refinements at all, show all leagues unfiltered
            try {
                const inp = document.getElementById('activities');
                const key = inp ? String(inp.value || '').toLowerCase().trim() : '';
                const isLeaguesScope = (key === 'leagues' || key === 'league');
                const hasRefinements = (
                    (selectedVenues.length + selectedNeighborhoods.length + selectedComps.length + selectedFormats.length + selectedSkills.length + selectedCommunity.length + selectedSports.length + selectedFeats.length + selectedDays.length) > 0
                    || !!priceType
                );
                if (isLeaguesScope && !hasRefinements) {
                    if (typeof DATASETS !== 'undefined' && Array.isArray(DATASETS.leagues) && DATASETS.leagues.length > 0) {
                        return DATASETS.leagues.slice();
                    }
                    // Fallback if datasets not populated
                    return activities.filter(a => String(a.source || '').toLowerCase() === 'leagues');
                }
            } catch(_) { /* no-op */ }
            let items = activities.slice();
            // Strong guard: restrict by data source for the selected scope to prevent bleed-through
            (function applyScopeSourceGuard(){
                try {
                    const inp = document.getElementById('activities');
                    const key = inp ? String(inp.value || '').toLowerCase().trim() : '';
                    const srcMap = {
                        'league': 'leagues',
                        'leagues': 'leagues',
                        'tournament': 'tournaments',
                        'tournaments': 'tournaments',
                        'events': 'events',
                        'daily sports': 'daily',
                        'private rentals': 'rentals'
                    };
                    const want = srcMap[key];
                    if (want) items = items.filter(a => String(a.source || '').toLowerCase() === want);
                } catch(_) { /* no-op */ }
            })();
            // Note: filters combine with AND semantics across categories
            if (selectedActivityTypes.length > 0) {
                const allowed = new Set(selectedActivityTypes);
                items = items.filter(a => allowed.has(getActivityType(a)));
            }
            // Apply daily-type sub-filter when in Daily scope
            if (typeof isDailyScope === 'function' && isDailyScope()) {
                const dailyType = getSelectedDailyType();
                if (dailyType === 'drop-in') {
                    items = items.filter(a => getActivityType(a) === 'Drop-in');
                } else if (dailyType === 'pickup') {
                    items = items.filter(a => getActivityType(a) === 'PickUp');
                }
            }
            if (selectedVenues.length > 0) {
                const set = new Set(selectedVenues.map(normalizeVenueName));
                items = items.filter(a => set.has(normalizeVenueName(a.venue_name || a.venueName || a.name || '')));
            }
            if (selectedNeighborhoods.length > 0) {
                const set = new Set(selectedNeighborhoods.map(s => String(s || '').toLowerCase().trim()));
                items = items.filter(a => {
                    const hood = (typeof getNeighborhoodForActivity === 'function') ? getNeighborhoodForActivity(a) : (a && a.neighborhood);
                    return hood ? set.has(String(hood).toLowerCase().trim()) : false;
                });
            }
            // In Events scope, ignore Sports filter (events often don't have a sport)
            if (!eventsScope && selectedSports.length > 0) {
                const set = new Set(selectedSports.map(normalizeSportLabel));
                items = items.filter(a => set.has(normalizeSportLabel(a.sport)));
            }
            // In Events scope, ignore composition/format/skill filters (not applicable)
            if (!eventsScope && selectedComps.length > 0) {
                const compSet = new Set(selectedComps.map(s => s.toLowerCase()));
                items = items.filter(a => compSet.has(deriveCompositionFromFormat(a.format).toLowerCase()));
            }
            if (!eventsScope && selectedFormats.length > 0) {
                const fmtSet = new Set(selectedFormats.map(s => s.toLowerCase()));
                items = items.filter(a => {
                    const nvn = deriveNvNFromFormat(a.format).toLowerCase();
                    return nvn && fmtSet.has(nvn);
                });
            }
            if (!eventsScope && selectedSkills.length > 0) {
                const skillSet = new Set(selectedSkills.map(s => s.toLowerCase()));
                items = items.filter(a => {
                    const skills = Array.isArray(a.skill_levels) ? a.skill_levels : [];
                    return skills.some(sk => skillSet.has(String(sk).toLowerCase()));
                });
            }
            // Events scope: apply start-time threshold here as well for the NoDays variant semantics
            if (eventsScope) {
                // Apply start/end range filters against activity start times
                const startRangeEl = document.getElementById('event-time-start');
                const endRangeEl = document.getElementById('event-time-end');
                const startVal = startRangeEl ? Number(startRangeEl.value || 0) : 0;
                const endVal = endRangeEl ? Number(endRangeEl.value || 0) : 0;
                if (startVal > 0 || endVal > 0) {
                    items = items.filter(a => {
                        const tStart = parseTimeToMinutesSimple(a.time_start || a.timeStart || '');
                        if (!Number.isFinite(tStart)) return false;
                        if (startVal > 0 && tStart < startVal) return false;
                        // If invalid range (start > end), ignore end filter until user corrects
                        if (endVal > 0 && startVal <= endVal && tStart > endVal) return false;
                        return true;
                    });
                }
            }
             if (selectedFeats.length > 0) {
                 const need = expandSelectedFeatureNames(selectedFeats);
                 items = items.filter(a => need.every(name => activityHasFeature(a, name)));
             }
            // Community selections are treated as required features too (e.g., LGBTQ+, Singles (Volo Solo))
            if (selectedCommunity.length > 0) {
                items = items.filter(a => selectedCommunity.every(name => activityHasFeature(a, name)));
            }
            if (selectedDays.length > 0) {
                const set = new Set(selectedDays);
                items = items.filter(a => set.has(deriveDayAbbrev(a)));
            }
            // Events scope: apply start-time threshold if set (keep items with known times at/after threshold)
            if (eventsScope) {
                // Duplicate application for NoDays semantics consolidated above; no-op here
            }
             // Apply Daily quick date chips (Today, Tomorrow, This Weekend, Next Week) only in Daily scope
             if (typeof isDailyScope === 'function' && isDailyScope() && Array.isArray(selectedQuickDates) && selectedQuickDates.length > 0) {
                const nowET = (() => { try { return new Date(new Date().toLocaleString('en-US', { timeZone: 'America/New_York' })); } catch(_) { return new Date(); } })();
                const todayDow = nowET.getDay(); // 0=Sun..6=Sat
                const abbrForDow = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
                const todayAbbr = abbrForDow[todayDow];
                const tomoAbbr = abbrForDow[(todayDow + 1) % 7];
                // Precompute next week window [next Monday .. next Sunday] as deltas from today
                const deltaToNextMonday = ((8 - todayDow) % 7) || 7; // if Monday (1), -> 7; if Sun (0), -> 1
                const nextWeekStart = deltaToNextMonday; // days ahead for next Monday
                const nextWeekEnd = nextWeekStart + 6;    // through next Sunday
                const MONTHS_MAP = { jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,sept:9,oct:10,nov:11,dec:12 };
                const parseMMDDLoose = (s) => {
                    if (!s) return null;
                    const t = String(s).trim();
                    let m = t.match(/^(\d{1,2})\/(\d{1,2})$/);
                    if (m) { return { mm: Math.min(12, Math.max(1, parseInt(m[1],10))), dd: Math.min(31, Math.max(1, parseInt(m[2],10))) }; }
                    m = t.match(/\b(jan|feb|mar|apr|may|jun|jul|aug|sep|sept|oct|nov|dec)[a-z]*\s+(\d{1,2})\b/i);
                    if (m) { const mm = MONTHS_MAP[m[1].toLowerCase()] || null; const dd = Math.min(31, Math.max(1, parseInt(m[2],10))); if (mm) return { mm, dd }; }
                    return null;
                };
                const daysAheadFromMMDD = (mm, dd) => {
                    const y = nowET.getFullYear();
                    const d = new Date(y, mm - 1, dd);
                    // Normalize to ET midnight comparisons
                    const base = new Date(y, nowET.getMonth(), nowET.getDate());
                    let diff = Math.round((d.getTime() - base.getTime()) / (24*60*60*1000));
                    if (diff < 0) {
                        const dNext = new Date(y + 1, mm - 1, dd);
                        diff = Math.round((dNext.getTime() - base.getTime()) / (24*60*60*1000));
                    }
                    return diff;
                };
                items = items.filter(a => {
                    const badge = (typeof getActivityDayBadge === 'function') ? getActivityDayBadge(a) : null;
                    const abbr = (typeof deriveDayAbbrev === 'function') ? deriveDayAbbrev(a) : '';
                    const mmddRaw = a && (a.date_mmdd || a.dateMMDD || '');
                    const parsed = parseMMDDLoose(mmddRaw);
                    const da = parsed ? daysAheadFromMMDD(parsed.mm, parsed.dd) : null;
                    const isToday = (badge === 'today') || (!badge && (abbr === todayAbbr));
                    const isTomorrow = (badge === 'tomorrow') || (!badge && (abbr === tomoAbbr));
                    const isWeekend = (abbr === 'Sat' || abbr === 'Sun');
                    let isNextWeek = false;
                    if (da != null) {
                        isNextWeek = (da >= nextWeekStart && da <= nextWeekEnd);
                    } else {
                        // Fallback by day-of-week: consider next week as Mon..Sun, avoiding Today/Tomorrow-only bias
                        isNextWeek = (abbr === 'Mon' || abbr === 'Tue' || abbr === 'Wed' || abbr === 'Thu' || abbr === 'Fri');
                    }
                    // Match any selected quick chips
                    return selectedQuickDates.some(q => (
                        (q === 'today' && isToday) ||
                        (q === 'tomorrow' && isTomorrow) ||
                        (q === 'weekend' && isWeekend) ||
                        (q === 'nextweek' && isNextWeek)
                    ));
                });
            }
            if (priceType) {
                const slider = document.getElementById('price-range');
                const cap = slider ? Number(slider.value || slider.max || 0) : 0;
                if (cap > 0) {
                    // Apply inclusive upper bound against relevant price field
                    if (priceType === 'Member') {
                        items = items.filter(a => {
                            const val = (a.member_price_current != null ? Number(a.member_price_current) : NaN);
                            return Number.isFinite(val) ? val <= cap : false;
                        });
                    } else if (priceType === 'Non-Member') {
                        items = items.filter(a => {
                            const val = (a.price_person_current != null ? Number(a.price_person_current) : NaN);
                            return Number.isFinite(val) ? val <= cap : false;
                        });
                    } else if (priceType === 'Team') {
                        items = items.filter(a => {
                            const val = (a.price_team != null ? Number(a.price_team) : NaN);
                            return Number.isFinite(val) ? val <= cap : false;
                        });
                    }
                }
            }
            // Safety fallback: if Leagues scope selected and no refinements are applied, but result is empty,
            // return all leagues to avoid accidental zero state due to transient UI timing or mis-applied filters.
            try {
                const inp = document.getElementById('activities');
                const key = inp ? String(inp.value || '').toLowerCase().trim() : '';
                const isLeaguesScope = (key === 'leagues' || key === 'league');
                const hasRefinements = (
                    (selectedVenues.length + selectedNeighborhoods.length + selectedComps.length + selectedFormats.length + selectedSkills.length + selectedCommunity.length + selectedSports.length + selectedFeats.length + selectedDays.length) > 0
                    || !!priceType
                );
                if (isLeaguesScope && !hasRefinements && items.length === 0) {
                    // Prefer the source slice populated by the loader when available
                    if (typeof DATASETS !== 'undefined' && Array.isArray(DATASETS.leagues) && DATASETS.leagues.length > 0) {
                        items = DATASETS.leagues.slice();
                    } else {
                        items = activities.filter(a => String(a.source || '').toLowerCase() === 'leagues');
                    }
                }
                // Extra guard: if no user-applied filters are active but the count is less than the full leagues slice,
                // return the full leagues list to avoid hidden state causing partial results (e.g., 60 vs 117)
                const activeInputs = (typeof getActiveFilters === 'function') ? getActiveFilters() : [];
                const sportsApplied = (typeof getSelectedSports === 'function') ? getSelectedSports() : [];
                const noUserFilters = (activeInputs.length === 0 && sportsApplied.length === 0 && !priceType);
                const fullLeagues = (typeof DATASETS !== 'undefined' && Array.isArray(DATASETS.leagues) && DATASETS.leagues.length > 0)
                    ? DATASETS.leagues
                    : activities.filter(a => String(a.source || '').toLowerCase() === 'leagues');
                if (isLeaguesScope && noUserFilters && Array.isArray(fullLeagues) && fullLeagues.length > 0 && items.length < fullLeagues.length) {
                    return fullLeagues.slice();
                }
            } catch(_) { /* no-op */ }
            return items;
        }

        function getAllFeatureInputs() {
            return document.querySelectorAll(
                '#section-highlights .filter-input,\
                 #section-amenities .filter-input,\
                 #section-program-details input[id^="surface-"].filter-input,\
                 #section-program-details input[id^="style-"].filter-input,\
                 #section-price-deals input[id^="deal-"].filter-input,\
                 #format-list .filter-input,\
                 #venue-list .filter-input,\
                 #neighborhood-list .filter-input,\
                 #section-schedule input[id^="day-"]'
            );
        }

        function renderFormatFilters() {
            const list = document.getElementById('format-list');
            if (!list) return;
            // Collect NvN from current activities
            const set = new Set();
            (activities || []).forEach(a => {
                const nvn = deriveNvNFromFormat(a && a.format);
                if (nvn) set.add(nvn);
            });
            const values = Array.from(set).sort((a,b) => {
                // Sort by total players desc then label asc (e.g., 7v7 above 5v5)
                const [al, ar] = a.split('v').map(Number);
                const [bl, br] = b.split('v').map(Number);
                const at = (al||0)+(ar||0);
                const bt = (bl||0)+(br||0);
                if (bt !== at) return bt - at;
                return a.localeCompare(b);
            });
            const frag = document.createDocumentFragment();
            values.forEach(v => {
                const id = `fmt-${v.replace(/[^a-z0-9]+/gi,'-').toLowerCase()}`;
                const label = document.createElement('label');
                label.className = 'flex items-center cursor-pointer';
                label.innerHTML = `<input type="checkbox" class="filter-input" id="${id}" data-name="${v}"> <span class="ml-2 text-sm">${v}</span>`;
                frag.appendChild(label);
            });
            list.innerHTML = '';
            list.appendChild(frag);
        }

        // Variant of getFilteredActivities that ignores the Day-of-Week selections.
        // Used strictly for computing option availability so days remain multi-select and visible.
        function getFilteredActivitiesNoDays() {
            // Normalize venue names for robust matching (case/punctuation-insensitive)
            const normalizeVenueName = (s) => String(s || '')
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
            const selectedVenues = getSelectedVenues ? getSelectedVenues() : [];
            const selectedNeighborhoods = getSelectedNeighborhoods ? getSelectedNeighborhoods() : [];
            const selectedComps = getSelectedCompositions ? getSelectedCompositions() : [];
            const selectedFormats = getSelectedFormats ? getSelectedFormats() : [];
            const selectedSkills = getSelectedSkills ? getSelectedSkills() : [];
            const selectedCommunity = getSelectedCommunity ? getSelectedCommunity() : [];
            const selectedSports = getSelectedSports ? getSelectedSports() : [];
            const selectedFeats = getSelectedFeatures ? getSelectedFeatures() : [];
            // Intentionally do NOT read selected days
            const priceType = getSelectedPriceType ? getSelectedPriceType() : '';
            const eventsScope = (typeof isEventsScope === 'function') ? isEventsScope() : false;
            let items = activities.slice();
            // Strong guard: restrict by data source for the selected scope to prevent bleed-through
            (function applyScopeSourceGuard(){
                try {
                    const inp = document.getElementById('activities');
                    const key = inp ? String(inp.value || '').toLowerCase().trim() : '';
                    const srcMap = {
                        'league': 'leagues',
                        'leagues': 'leagues',
                        'tournament': 'tournaments',
                        'tournaments': 'tournaments',
                        'events': 'events',
                        'daily sports': 'daily',
                        'private rentals': 'rentals'
                    };
                    const want = srcMap[key];
                    if (want) items = items.filter(a => String(a.source || '').toLowerCase() === want);
                } catch(_) { /* no-op */ }
            })();
            // Apply the same filters as getFilteredActivities, except for days
            // Activity types route
            if (typeof getActivityType === 'function') {
                const inp = document.getElementById('activities');
                const val = inp ? String(inp.value || '').trim().toLowerCase() : '';
                const map = {
                    'leagues': ['League'],
                    'league': ['League'],
                    'tournaments': ['Tournament'],
                    'tournament': ['Tournament'],
                    'daily sports': ['Drop-in', 'PickUp'],
                    'events': ['Event', 'Watch Party', 'Player Party', 'Happy Hour'],
                    'private rentals': ['Private Rentals', 'Rental']
                };
                const allowed = map[val] || [];
                if (allowed.length > 0) {
                    const set = new Set(allowed);
                    items = items.filter(a => set.has(getActivityType(a)));
                }
            }
            // Apply daily-type sub-filter when in Daily scope
            if (typeof isDailyScope === 'function' && isDailyScope()) {
                const dailyType = getSelectedDailyType();
                if (dailyType === 'drop-in') {
                    items = items.filter(a => getActivityType(a) === 'Drop-in');
                } else if (dailyType === 'pickup') {
                    items = items.filter(a => getActivityType(a) === 'PickUp');
                }
            }
            if (selectedVenues.length > 0) {
                const set = new Set(selectedVenues.map(normalizeVenueName));
                items = items.filter(a => set.has(normalizeVenueName(a.venue_name || a.venueName || a.name || '')));
            }
            if (selectedNeighborhoods.length > 0) {
                const set = new Set(selectedNeighborhoods.map(s => String(s || '').toLowerCase().trim()));
                items = items.filter(a => {
                    const hood = (typeof getNeighborhoodForActivity === 'function') ? getNeighborhoodForActivity(a) : (a && a.neighborhood);
                    return hood ? set.has(String(hood).toLowerCase().trim()) : false;
                });
            }
            if (!eventsScope && selectedSports.length > 0) {
                const set = new Set(selectedSports.map(normalizeSportLabel));
                items = items.filter(a => set.has(normalizeSportLabel(a.sport)));
            }
            if (!eventsScope && selectedComps.length > 0) {
                const compSet = new Set(selectedComps.map(s => s.toLowerCase()));
                items = items.filter(a => compSet.has(deriveCompositionFromFormat(a.format).toLowerCase()));
            }
            if (!eventsScope && selectedFormats.length > 0) {
                const fmtSet = new Set(selectedFormats.map(s => s.toLowerCase()));
                items = items.filter(a => {
                    const nvn = deriveNvNFromFormat(a.format).toLowerCase();
                    return nvn && fmtSet.has(nvn);
                });
            }
            if (!eventsScope && selectedSkills.length > 0) {
                const skillSet = new Set(selectedSkills.map(s => s.toLowerCase()));
                items = items.filter(a => {
                    const skills = Array.isArray(a.skill_levels) ? a.skill_levels : [];
                    return skills.some(sk => skillSet.has(String(sk).toLowerCase()));
                });
            }
            if (selectedFeats.length > 0) {
                const need = expandSelectedFeatureNames(selectedFeats);
                items = items.filter(a => need.every(name => activityHasFeature(a, name)));
            }
            if (selectedCommunity.length > 0) {
                items = items.filter(a => selectedCommunity.every(name => activityHasFeature(a, name)));
            }
            // Events scope: apply start/end time range filtering (same semantics as primary filter function)
            if (eventsScope) {
                const startRangeEl = document.getElementById('event-time-start');
                const endRangeEl = document.getElementById('event-time-end');
                const startVal = startRangeEl ? Number(startRangeEl.value || 0) : 0;
                const endVal = endRangeEl ? Number(endRangeEl.value || 0) : 0;
                if (startVal > 0 || endVal > 0) {
                    items = items.filter(a => {
                        const tStart = parseTimeToMinutesSimple(a.time_start || a.timeStart || '');
                        if (!Number.isFinite(tStart)) return false;
                        if (startVal > 0 && tStart < startVal) return false;
                        if (endVal > 0 && startVal <= endVal && tStart > endVal) return false;
                        return true;
                    });
                }
            }
            if (priceType) {
                const slider = document.getElementById('price-range');
                const cap = slider ? Number(slider.value || slider.max || 0) : 0;
                if (cap > 0) {
                    if (priceType === 'Member') {
                        items = items.filter(a => {
                            const val = (a.member_price_current != null ? Number(a.member_price_current) : NaN);
                            return Number.isFinite(val) ? val <= cap : false;
                        });
                    } else if (priceType === 'Non-Member') {
                        items = items.filter(a => {
                            const val = (a.price_person_current != null ? Number(a.price_person_current) : NaN);
                            return Number.isFinite(val) ? val <= cap : false;
                        });
                    } else if (priceType === 'Team') {
                        items = items.filter(a => {
                            const val = (a.price_team != null ? Number(a.price_team) : NaN);
                            return Number.isFinite(val) ? val <= cap : false;
                        });
                    }
                }
            }
            // Mirror leagues fallback to keep option states sane when nothing matches on an empty-filter leagues scope
            try {
                const inp = document.getElementById('activities');
                const key = inp ? String(inp.value || '').toLowerCase().trim() : '';
                const isLeaguesScope = (key === 'leagues' || key === 'league');
                const hasRefinements = (
                    (selectedVenues.length + selectedNeighborhoods.length + selectedComps.length + selectedFormats.length + selectedSkills.length + selectedCommunity.length + selectedSports.length + selectedFeats.length) > 0
                    || !!priceType
                );
                if (isLeaguesScope && !hasRefinements && items.length === 0) {
                    if (typeof DATASETS !== 'undefined' && Array.isArray(DATASETS.leagues) && DATASETS.leagues.length > 0) {
                        items = DATASETS.leagues.slice();
                    } else {
                        items = activities.filter(a => String(a.source || '').toLowerCase() === 'leagues');
                    }
                }
            } catch(_) { /* no-op */ }
            return items;
        }

        function updateFilterOptionStates() {
            const inputs = getAllFeatureInputs();
            if (!inputs || inputs.length === 0) return;
            // If no data yet, keep filters enabled to avoid misleading disabled state
            if (!Array.isArray(activities) || activities.length === 0) {
                inputs.forEach(inp => {
                    inp.disabled = false;
                    const lbl = inp.closest('label');
                    if (lbl) lbl.classList.remove('opacity-50', 'pointer-events-none', 'hidden');
                });
                // Also ensure any prior ordering is reset to natural order by not reordering when no data
                return;
            }
            const currentItems = getFilteredActivities();
            const currentItemsNoDays = (typeof getFilteredActivitiesNoDays === 'function') ? getFilteredActivitiesNoDays() : activities.slice();
            // Determine if we are in Leagues scope; in this scope, keep filter inputs clickable even if no matches yet
            let isLeaguesScope = false;
            try {
                const inpAct = document.getElementById('activities');
                const key = inpAct ? String(inpAct.value || '').toLowerCase().trim() : '';
                isLeaguesScope = (key === 'leagues' || key === 'league');
            } catch(_) { /* no-op */ }
            inputs.forEach(inp => {
                const name = (inp.dataset && inp.dataset.name) ? inp.dataset.name.trim() : '';
                if (!name) return;
                if (inp.checked) {
                    // Never disable a selected option; users must be able to uncheck it
                    inp.disabled = false;
                    const lbl = inp.closest('label');
                    if (lbl) lbl.classList.remove('opacity-50', 'pointer-events-none');
                    if (lbl) lbl.classList.remove('hidden');
                    if (lbl && lbl.dataset) delete lbl.dataset.noMatches; // ensure not treated as disabled-like in reorder
                    return;
                }
                // Determine relevance based on group
                const inVenueList = !!inp.closest('#venue-list');
                const inFormatList = !!inp.closest('#format-list');
                const inHighlights = !!inp.closest('#section-highlights');
                const inPriceDeals = !!inp.closest('#section-price-deals') && (inp.id || '').startsWith('deal-');
                const inNeighborhoodList = !!inp.closest('#neighborhood-list');
                const isDay = /^day-/.test(inp.id || '');
                let hasAny = false;
                if (inVenueList) {
                    const target = normalizeVenueName(name);
                    hasAny = currentItems.some(a => normalizeVenueName(a.venue_name || a.venueName || a.name || '') === target);
                } else if (inNeighborhoodList) {
                    const want = String(name || '').toLowerCase().trim();
                    hasAny = currentItems.some(a => {
                        const hood = (typeof getNeighborhoodForActivity === 'function') ? getNeighborhoodForActivity(a) : (a && a.neighborhood);
                        return hood ? String(hood).toLowerCase().trim() === want : false;
                    });
                } else if (inFormatList) {
                    const want = String(name || '').toLowerCase();
                    hasAny = currentItems.some(a => {
                        const nvn = (deriveNvNFromFormat(a.format) || '').toLowerCase();
                        return nvn && nvn === want;
                    });
                } else if (isDay) {
                    // For days, compute availability against dataset filtered by other criteria only (ignore days)
                    const wantDay = name;
                    hasAny = currentItemsNoDays.some(a => deriveDayAbbrev(a) === wantDay);
                    // Always keep day-of-week chips visible and enabled to allow multi-select
                    inp.disabled = false;
                    const lbl = inp.closest('label');
                    if (lbl) {
                        lbl.classList.remove('opacity-50', 'pointer-events-none', 'hidden');
                        if (lbl.dataset) delete lbl.dataset.noMatches;
                    }
                    return; // skip standard hide/disable handling for day filters
                } else {
                    // Highlights, Amenities, Surfaces, Styles
                    hasAny = currentItems.some(a => activityHasFeature(a, name));
                }
                const lbl = inp.closest('label');
                if (isLeaguesScope) {
                    // In Leagues scope, keep options clickable even when no matches yet.
                    inp.disabled = false;
                    if (lbl) {
                        // Dim visually if no matches, but do not block clicks and do not hide.
                        lbl.classList.toggle('opacity-50', !hasAny);
                        lbl.classList.remove('pointer-events-none');
                        lbl.classList.remove('hidden');
                        // Mark dimmed items so reorder can treat them as disabled-like
                        if (lbl.dataset) lbl.dataset.noMatches = hasAny ? '0' : '1';
                    }
                } else {
                    inp.disabled = !hasAny;
                    if (lbl) lbl.classList.toggle('opacity-50', !hasAny);
                    if (lbl) lbl.classList.toggle('pointer-events-none', !hasAny);
                    // Keep disabled options visible for Venues, Program Highlights, Format, and Registration Deals so they can appear under the divider
                    const shouldHide = !(inVenueList || inFormatList || inHighlights || inPriceDeals);
                    if (lbl) lbl.classList.toggle('hidden', shouldHide && !hasAny);
                    // Clear any noMatches marker outside Leagues scope to avoid mis-ordering
                    if (lbl && lbl.dataset) delete lbl.dataset.noMatches;
                }
            });
            // Update pills after disabling/enabling
            renderListPills();
            renderMapGroupPills();
            // Reorder filter options within each group: enabled options first (alphabetical), then a divider, then disabled options (alphabetical)
            reorderFilterOptionContainers(document);
        }

    // Reorder helpers: group enabled above disabled; keep lists scannable
        function reorderFilterOptionContainers(root) {
            const scope = root || document;
            // Consider primary containers with flat lists of label rows
            const containers = scope.querySelectorAll(
                '#section-highlights,\
                 #section-highlights .space-y-2,\
                 #section-program-details .space-y-2,\
                 #section-program-details .grid.grid-cols-3,\
                 #section-amenities .space-y-2,\
                 #section-location .space-y-2,\
                 #section-price-deals .space-y-2,\
                 #format-list'
            );
            containers.forEach(reorderOneFilterContainer);
        }

        function reorderOneFilterContainer(container) {
            if (!container) return;
            // Identify the Show more wrapper location depending on layout
            const isGrid = container.classList.contains('grid');
            const showMoreWrapper = isGrid
                ? (container.nextElementSibling && container.nextElementSibling.classList && container.nextElementSibling.classList.contains('show-more-wrapper') ? container.nextElementSibling : null)
                : container.querySelector('.show-more-wrapper');
            const toggleBtn = showMoreWrapper ? showMoreWrapper.querySelector('button') : null;
            const isCollapsed = toggleBtn ? (toggleBtn.dataset.state === 'collapsed') : null; // null = no show-more applied

            // Collect label items only (skip wrappers/dividers)
            const children = Array.from(container.children);
            // Remove any prior custom divider to avoid duplicates
            const priorDivider = container.querySelector('.filter-divider');
            if (priorDivider) priorDivider.remove();
            const items = children.filter(el => el.tagName === 'LABEL');
            if (items.length === 0) return;

            // Utility to derive a case-insensitive sort key
            const getName = (el) => {
                const inp = el.querySelector('input');
                const dataName = inp && inp.dataset ? (inp.dataset.name || '').trim() : '';
                if (dataName) return dataName.toLowerCase();
                const span = el.querySelector('span');
                return ((span && span.textContent) ? span.textContent : el.textContent || '').trim().toLowerCase();
            };

            // Split into enabled and disabled groups
            const enabled = [];
            const disabled = [];
            items.forEach(el => {
                const inp = el.querySelector('input');
                const isDisabled = !!(inp && inp.disabled);
                // In Leagues scope we keep inputs enabled but may mark labels as no-matches
                const isDisabledLike = isDisabled || (el.dataset && el.dataset.noMatches === '1');
                // Clear any previous spacing class
                el.classList.remove('mt-2');
                if (isDisabledLike) disabled.push(el); else enabled.push(el);
            });

            // Sort each group alphabetically by label text
            enabled.sort((a, b) => getName(a).localeCompare(getName(b)));
            disabled.sort((a, b) => getName(a).localeCompare(getName(b)));

            // Re-append in new order; divider introduces a visual split before disabled
            const appendItem = (el) => {
                if (!isGrid && showMoreWrapper && showMoreWrapper.parentNode === container) {
                    container.insertBefore(el, showMoreWrapper);
                } else {
                    container.appendChild(el);
                }
            };
            enabled.forEach(appendItem);
            if (disabled.length > 0) {
                // Insert a visible divider between enabled (has results) and disabled (no results)
                const divider = document.createElement('div');
                divider.className = 'filter-divider my-2 border-t border-gray-200';
                if (!isGrid && showMoreWrapper && showMoreWrapper.parentNode === container) {
                    container.insertBefore(divider, showMoreWrapper);
                } else {
                    container.appendChild(divider);
                }
                disabled.forEach(appendItem);
                // If a show-more control exists and is currently collapsed, hide the divider until expanded
                if (isCollapsed === true) {
                    divider.classList.add('hidden');
                }
            }

            // Re-apply Show more/less state if applicable (paginate only LABELs)
            if (isCollapsed !== null) {
                // Only paginate label items; keep divider visible and unpaginated
                const currentItems = Array.from(container.children).filter(el => el.tagName === 'LABEL');
                currentItems.forEach((el, i) => {
                    if (isCollapsed) {
                        el.classList.toggle('hidden', i >= 4);
                    } else {
                        el.classList.remove('hidden');
                    }
                });
                // Also toggle divider visibility based on expanded/collapsed state
                const dividerNow = container.querySelector('.filter-divider');
                if (dividerNow) dividerNow.classList.toggle('hidden', isCollapsed === true);
            }
        }

        // --- FUNCTIONS ---
        function toggleView() {
            listView.classList.toggle('hidden');
            mapView.classList.toggle('hidden');
            const mobileViewMapBtn = document.getElementById('mobile-view-map');
            if (mobileViewMapBtn) {
                const isMapVisible = !mapView.classList.contains('hidden');
                mobileViewMapBtn.classList.toggle('hidden', isMapVisible);
            }
            const isMapVisible = !mapView.classList.contains('hidden');
            // If map just became visible, ensure we fit bounds to current markers
            if (isMapVisible) {
                scheduleMapFitToMarkers();
                renderMapSearchSummary();
            } else {
                // If leaving map view, hide overlay card and remove keyboard handler
                if (mapActivityCardContainer) mapActivityCardContainer.classList.add('hidden');
                if (window.__mapOverlayKeyHandler) {
                    window.removeEventListener('keydown', window.__mapOverlayKeyHandler);
                    window.__mapOverlayKeyHandler = null;
                }
            }
        }

        // Define filter groups and the selectors for inputs they contain
        const filterGroups = [
            { key: 'schedule', label: 'Schedule', sectionSelector: '#section-schedule', inputSelector: '#section-schedule .filter-input' },
            { key: 'price', label: 'Price & Deals', sectionSelector: '#section-price-deals', inputSelector: '#section-price-deals .filter-input, input[name="price-type"]' },
            { key: 'location', label: 'Location', sectionSelector: '#section-location', inputSelector: '#section-location .filter-input' },
            { key: 'highlights', label: 'Program Highlights', sectionSelector: '#section-highlights', inputSelector: '#section-highlights .filter-input' },
            { key: 'playerteam', label: 'Player & Team Type', sectionSelector: '#section-player-team', inputSelector: '#section-player-team .filter-input' },
            { key: 'details', label: 'Program Details', sectionSelector: '#section-program-details', inputSelector: '#section-program-details .filter-input' },
            { key: 'amenities', label: 'Amenities & Perks', sectionSelector: '#section-amenities', inputSelector: '#section-amenities .filter-input' },
        ];

        function getActiveFilters() {
            // Include all checked filters, including Your Sports (applied sports inputs)
            // Exclude Daily-type 'All' (not a real filter)
            return Array.from(document.querySelectorAll('.filter-input')).filter(i => {
                if (!i.checked) return false;
                if (i.type === 'radio' && i.name === 'daily-type' && (i.dataset.type || '').toLowerCase() === 'all') return false;
                return true;
            });
        }

        function getGroupCounts() {
            const counts = {};
            filterGroups.forEach(g => {
                const inputs = document.querySelectorAll(g.inputSelector);
                counts[g.key] = Array.from(inputs).filter(i => i.checked).length;
            });
            return counts;
        }

        // --- FILTER VISIBILITY PER ACTIVITY TYPE ---
        function isDailyScope() {
            const inp = document.getElementById('activities');
            const val = inp ? String(inp.value || '').toLowerCase().trim() : '';
            return val === 'daily sports';
        }
        function isEventsScope() {
            const inp = document.getElementById('activities');
            const val = inp ? String(inp.value || '').toLowerCase().trim() : '';
            return val === 'events';
        }
        // Track last selected Activities scope so we only run one-time resets when the scope changes
        let __lastActivitiesScope = '';
        function applyActivityTypeFilterVisibility() {
            const daily = isDailyScope();
            const actEl = document.getElementById('activities');
            const actVal = actEl ? String(actEl.value || '').toLowerCase().trim() : '';
            const isTournaments = actVal === 'tournaments';
            const isEvents = actVal === 'events';
            const isRentals = actVal === 'private rentals' || actVal === 'rentals' || actVal === 'rental';
            const isLeagues = (actVal === 'leagues' || actVal === 'league');
            const enteringLeagues = isLeagues && (__lastActivitiesScope !== 'leagues');
            // Update explainer header/body and daily-type controls
            const titleEl = document.getElementById('scope-explainer-title');
            const bodyEl = document.getElementById('scope-explainer-body');
            const iconEl = document.getElementById('scope-explainer-icon');
            const dailyTypeWrap = document.getElementById('daily-type-container');
            let filtersChanged = false;
            if (titleEl && bodyEl && iconEl && dailyTypeWrap) {
                if (daily) {
                    titleEl.textContent = 'Daily Sports';
                    bodyEl.textContent = '';
                    iconEl.setAttribute('data-lucide', 'clock');
                    // Color the clock icon orange in Daily scope
                    iconEl.classList.remove('text-[rgb(34,34,34)]', 'text-blue-500', 'text-yellow-600');
                    iconEl.classList.add('text-orange-600');
                    dailyTypeWrap.classList.remove('hidden');
                    dailyTypeWrap.setAttribute('aria-hidden', 'false');
                    // Ensure a default selection
                    const anyChecked = document.querySelector('input[type="radio"][name="daily-type"]:checked');
                    if (!anyChecked) {
                        const all = document.getElementById('daily-all');
                        if (all) { all.checked = true; all.dispatchEvent(new Event('change', { bubbles: true })); filtersChanged = true; }
                    }
                    if (typeof renderDailyTypeExplainer === 'function') renderDailyTypeExplainer();
                    // Toggle Schedule sub-blocks: show quick dates, hide Start Month
                    const startMonthBlock = document.getElementById('start-month-block');
                    const quickBlock = document.getElementById('daily-quickdate-block');
                    if (startMonthBlock) startMonthBlock.classList.add('hidden');
                    if (quickBlock) { quickBlock.classList.remove('hidden'); quickBlock.setAttribute('aria-hidden','false'); }
                    // Price & Deals: hide Member and Team radios; show 'Free for members' note
                    const memberRadio = document.getElementById('price-member');
                    if (memberRadio) {
                        const lbl = memberRadio.closest('label');
                        if (lbl) lbl.classList.add('hidden');
                        if (memberRadio.checked) { memberRadio.checked = false; filtersChanged = true; }
                    }
                    const teamRadio2 = document.getElementById('price-team');
                    if (teamRadio2) {
                        const lbl = teamRadio2.closest('label');
                        if (lbl) lbl.classList.add('hidden');
                        if (teamRadio2.checked) { teamRadio2.checked = false; filtersChanged = true; }
                    }
                    const freeNote = document.getElementById('daily-free-members-note');
                    if (freeNote) freeNote.classList.remove('hidden');
                } else if (isTournaments) {
                    titleEl.textContent = 'Tournaments';
                    bodyEl.textContent = 'One-day or special events. Compete in brackets or round-robin—bring a team or join solo.';
                    iconEl.setAttribute('data-lucide', 'trophy');
                    // Golden trophy for tournaments
                    iconEl.classList.remove('text-orange-600', 'text-[rgb(34,34,34)]');
                    iconEl.classList.add('text-yellow-600');
                    // Hide daily-type radios
                    dailyTypeWrap.classList.add('hidden');
                    dailyTypeWrap.setAttribute('aria-hidden', 'true');
                    // Toggle Schedule sub-blocks: non-Daily -> keep Start Month hidden, hide quick dates
                    const startMonthBlock = document.getElementById('start-month-block');
                    const quickBlock = document.getElementById('daily-quickdate-block');
                    if (startMonthBlock) startMonthBlock.classList.add('hidden');
                    if (quickBlock) {
                        quickBlock.classList.add('hidden');
                        quickBlock.setAttribute('aria-hidden','true');
                        quickBlock.querySelectorAll('input[type="checkbox"]').forEach(i => { if (i.checked) { i.checked = false; filtersChanged = true; } });
                    }
                    // Price & Deals: show Member/Team again; hide free note
                    const memberRadioT = document.getElementById('price-member');
                    if (memberRadioT) { const lbl = memberRadioT.closest('label'); if (lbl) lbl.classList.remove('hidden'); }
                    const teamRadioT = document.getElementById('price-team');
                    if (teamRadioT) { const lbl = teamRadioT.closest('label'); if (lbl) lbl.classList.remove('hidden'); }
                    const freeNoteT = document.getElementById('daily-free-members-note');
                    if (freeNoteT) freeNoteT.classList.add('hidden');
                } else if (isEvents) {
                    titleEl.textContent = 'Events';
                    bodyEl.textContent = 'Watch parties, tailgates, member nights, and more.';
                    iconEl.setAttribute('data-lucide', 'calendar');
                    // Purple calendar for events
                    iconEl.classList.remove('text-orange-600', 'text-yellow-600', 'text-[rgb(34,34,34)]');
                    iconEl.classList.add('text-purple-600');
                    // Hide daily-type radios
                    dailyTypeWrap.classList.add('hidden');
                    dailyTypeWrap.setAttribute('aria-hidden', 'true');
                    // Toggle Schedule sub-blocks for non-Daily (keep Start Month hidden)
                    const startMonthBlock = document.getElementById('start-month-block');
                    const quickBlock = document.getElementById('daily-quickdate-block');
                    if (startMonthBlock) startMonthBlock.classList.add('hidden');
                    if (quickBlock) {
                        quickBlock.classList.add('hidden');
                        quickBlock.setAttribute('aria-hidden','true');
                        quickBlock.querySelectorAll('input[type="checkbox"]').forEach(i => { if (i.checked) { i.checked = false; filtersChanged = true; } });
                    }
                    // Price & Deals: show Member/Team again; hide free note
                    const memberRadioE = document.getElementById('price-member');
                    if (memberRadioE) { const lbl = memberRadioE.closest('label'); if (lbl) lbl.classList.remove('hidden'); }
                    const teamRadioE = document.getElementById('price-team');
                    if (teamRadioE) { const lbl = teamRadioE.closest('label'); if (lbl) lbl.classList.remove('hidden'); }
                    const freeNoteE = document.getElementById('daily-free-members-note');
                    if (freeNoteE) freeNoteE.classList.add('hidden');
                    // Clear any selected price-type radios for Events to avoid filtering out items with no explicit price
                    const priceRadios = document.querySelectorAll('input[type="radio"][name="price-type"]:checked');
                    if (priceRadios && priceRadios.length > 0) {
                        priceRadios.forEach(r => { r.checked = false; });
                        filtersChanged = true;
                    }
                } else if (isRentals) {
                    titleEl.textContent = 'Private Rentals';
                    bodyEl.textContent = 'Rent fields and courts for private play or group events.';
                    iconEl.setAttribute('data-lucide', 'building-2');
                    iconEl.classList.remove('text-orange-600', 'text-yellow-600', 'text-purple-600');
                    iconEl.classList.add('text-[rgb(34,34,34)]');
                    dailyTypeWrap.classList.add('hidden');
                    dailyTypeWrap.setAttribute('aria-hidden', 'true');
                    // Toggle Schedule sub-blocks for non-Daily (keep Start Month hidden)
                    const startMonthBlock = document.getElementById('start-month-block');
                    const quickBlock = document.getElementById('daily-quickdate-block');
                    if (startMonthBlock) startMonthBlock.classList.add('hidden');
                    if (quickBlock) {
                        quickBlock.classList.add('hidden');
                        quickBlock.setAttribute('aria-hidden','true');
                        quickBlock.querySelectorAll('input[type="checkbox"]').forEach(i => { if (i.checked) { i.checked = false; filtersChanged = true; } });
                    }
                    // Price & Deals: show Member/Team again; hide free note
                    const memberRadioR = document.getElementById('price-member');
                    if (memberRadioR) { const lbl = memberRadioR.closest('label'); if (lbl) lbl.classList.remove('hidden'); }
                    const teamRadioR = document.getElementById('price-team');
                    if (teamRadioR) { const lbl = teamRadioR.closest('label'); if (lbl) lbl.classList.remove('hidden'); }
                    const freeNoteR = document.getElementById('daily-free-members-note');
                    if (freeNoteR) freeNoteR.classList.add('hidden');
                    // Clear price-type radios; rentals use per-hour pricing not covered by these
                    const priceRadios3 = document.querySelectorAll('input[type="radio"][name="price-type"]:checked');
                    if (priceRadios3 && priceRadios3.length > 0) {
                        priceRadios3.forEach(r => { r.checked = false; });
                        filtersChanged = true;
                    }
                    // Rentals scope: restrict filters to Day of Week, Times (no custom time range), Neighborhoods, Venues.
                    // Hide other filter groups and clear their selections.
                    const allowSelectors = new Set(['section-schedule','section-location']);
                    const allSections = document.querySelectorAll('#filters-form > div.py-6, #filters-form > div#events-starttime-block');
                    allSections.forEach(sec => {
                        const inner = sec.querySelector('[id^="section-"]');
                        const id = inner ? inner.id : null;
                        const isSchedule = sec.querySelector('#section-schedule');
                        const isLocation = sec.querySelector('#section-location');
                        const keep = (isSchedule || isLocation);
                        if (!keep) {
                            // Hide entire section wrapper
                            sec.classList.add('hidden');
                            // Clear any checked inputs inside
                            sec.querySelectorAll('.filter-input:checked').forEach(inp => { inp.checked = false; filtersChanged = true; });
                        } else {
                            sec.classList.remove('hidden');
                        }
                    });
                    // Explicitly ensure events time range block hidden for rentals
                    const evTimeBlock2 = document.getElementById('events-starttime-block');
                    if (evTimeBlock2) {
                        evTimeBlock2.classList.add('hidden');
                        evTimeBlock2.setAttribute('aria-hidden','true');
                        // Reset its sliders if previously set
                        const s = document.getElementById('event-time-start');
                        const e = document.getElementById('event-time-end');
                        const summary = document.getElementById('event-time-range-summary');
                        if (s && e) {
                            const prevS = Number(s.value||0), prevE = Number(e.value||0);
                            if (prevS !== 0) { s.value='0'; filtersChanged = true; }
                            if (prevE !== 0) { e.value='0'; filtersChanged = true; }
                            if (summary) summary.textContent = 'Any — Any';
                        }
                    }
                } else {
                    titleEl.textContent = 'Leagues';
                    bodyEl.textContent = 'Weekly games and playoffs. Sign up solo, with friends, or a full team — we guarantee a game every week.';
                    iconEl.setAttribute('data-lucide', 'trophy');
                    // Restore neutral gray trophy when not in Daily scope
                    iconEl.classList.remove('text-orange-600', 'text-yellow-600');
                    iconEl.classList.add('text-[rgb(34,34,34)]');
                    // Clear daily-type when leaving daily scope
                    document.querySelectorAll('input[type="radio"][name="daily-type"]').forEach(r => { r.checked = false; });
                    dailyTypeWrap.classList.add('hidden');
                    dailyTypeWrap.setAttribute('aria-hidden', 'true');
                    // Toggle Schedule sub-blocks: keep Start Month hidden; hide quick dates and clear selections
                    const startMonthBlock2 = document.getElementById('start-month-block');
                    const quickBlock2 = document.getElementById('daily-quickdate-block');
                    if (startMonthBlock2) startMonthBlock2.classList.add('hidden');
                    if (quickBlock2) {
                        quickBlock2.classList.add('hidden');
                        quickBlock2.setAttribute('aria-hidden','true');
                        // Clear any quick-date selections when leaving Daily
                        quickBlock2.querySelectorAll('input[type="checkbox"]').forEach(i => { if (i.checked) { i.checked = false; filtersChanged = true; } });
                    }
                    // Price & Deals: show Member/Team; hide free note
                    const memberRadioL = document.getElementById('price-member');
                    if (memberRadioL) { const lbl = memberRadioL.closest('label'); if (lbl) lbl.classList.remove('hidden'); }
                    const teamRadioL = document.getElementById('price-team');
                    if (teamRadioL) { const lbl = teamRadioL.closest('label'); if (lbl) lbl.classList.remove('hidden'); }
                    const freeNoteL = document.getElementById('daily-free-members-note');
                    if (freeNoteL) freeNoteL.classList.add('hidden');
                    // Only when switching INTO Leagues from another scope, clear prior filters to show full dataset
                    if (enteringLeagues) {
                        // Also clear any selected price-type radios to avoid unintended filtering
                        const priceRadios2 = document.querySelectorAll('input[type="radio"][name="price-type"]:checked');
                        if (priceRadios2 && priceRadios2.length > 0) {
                            priceRadios2.forEach(r => { r.checked = false; });
                            filtersChanged = true;
                        }
                        // Clear any applied sports chips to show the full Leagues set by default
                        const appliedSports = document.getElementById('applied-sports-inputs');
                        if (appliedSports && appliedSports.querySelector('input[type="checkbox"].filter-input:checked')) {
                            appliedSports.innerHTML = '';
                            if (typeof updateSportsFieldValue === 'function') updateSportsFieldValue();
                            filtersChanged = true;
                        }
                        // Clear ALL other checked filters (venues, days, highlights, amenities, formats, community, skills, deals)
                        const checkedFilters = Array.from(document.querySelectorAll('.filter-input')).filter(i => i.checked);
                        if (checkedFilters.length > 0) {
                            checkedFilters.forEach(i => { i.checked = false; });
                            filtersChanged = true;
                        }
                    }
                }
                if (window.lucide && typeof window.lucide.createIcons === 'function') {
                    window.lucide.createIcons();
                }
            }
            // Player & Team Type section: keep visible for Daily
            const playerTeamSection = document.querySelector('#section-player-team')?.parentElement;
            if (playerTeamSection) {
                // Hide for Events, show otherwise (Daily/Leagues/Tournaments/Rentals)
                playerTeamSection.classList.toggle('hidden', isEvents);
            }

            // Events-only: show Start time range block; hide/reset otherwise (also used for Rentals minimal filters if needed)
            const evTimeBlock = document.getElementById('events-starttime-block');
            const evStartInput = document.getElementById('event-time-start');
            const evEndInput = document.getElementById('event-time-end');
            const evSummary = document.getElementById('event-time-range-summary');
            if (evTimeBlock && evStartInput && evEndInput && evSummary) {
                const showRange = isEvents; // keep rentals hidden for now per spec
                if (showRange) {
                    evTimeBlock.classList.remove('hidden');
                    evTimeBlock.setAttribute('aria-hidden','false');
                    // Ensure full-day default when showing Events: start=0 (Any), end=1439 (Any)
                    const prevStart = Number(evStartInput.value || 0);
                    const prevEnd = Number(evEndInput.value || 0);
                    if (prevEnd === 0) {
                        evEndInput.value = '1439';
                        // Update active band and summary to reflect full selection
                        const band = document.getElementById('event-time-active-band');
                        if (band) { band.style.left = '0%'; band.style.right = '0%'; }
                        evSummary.textContent = 'Any — Any';
                        filtersChanged = true;
                    }
                    // Set hit zones for independent thumb dragging
                    const toPctLocal = (mins) => Math.max(0, Math.min(100, (Number(mins||0) / 1439) * 100));
                    const sPct = toPctLocal(Number(evStartInput.value||0));
                    const ePct = toPctLocal(Number(evEndInput.value||1439));
                    const mid = Math.min(sPct + (ePct - sPct)/2, ePct);
                    evStartInput.style.clipPath = `inset(0 ${100-mid}% 0 0)`;
                    evEndInput.style.clipPath = `inset(0 0 0 ${mid}%)`;
                } else {
                    const prevStart = Number(evStartInput.value || 0);
                    const prevEnd = Number(evEndInput.value || 0);
                    evTimeBlock.classList.add('hidden');
                    evTimeBlock.setAttribute('aria-hidden','true');
                    if (prevStart !== 0) { evStartInput.value = '0'; filtersChanged = true; }
                    if (prevEnd !== 0) { evEndInput.value = '0'; filtersChanged = true; }
                    if (evSummary) evSummary.textContent = 'Any — Any';
                }
            }

            // Price & Deals: hide Team radio for Daily and Events; keep Registration Deals visible for Daily
            const teamRadio = document.getElementById('price-team');
            if (teamRadio) {
                const lbl = teamRadio.closest('label');
                const hideTeam = daily || isEvents;
                if (lbl) lbl.classList.toggle('hidden', hideTeam);
                if (hideTeam && teamRadio.checked) {
                    teamRadio.checked = false;
                }
            }
            // Ensure Registration Deals block remains visible
            const regDealsBlock = document.querySelector('#section-price-deals > div:nth-of-type(3)');
            if (regDealsBlock) regDealsBlock.classList.remove('hidden');

            // Program Details: keep all blocks visible for Daily
            const progDetails = document.getElementById('section-program-details');
            if (progDetails) {
                const blocks = Array.from(progDetails.querySelectorAll(':scope > div'));
                blocks.forEach(block => {
                    block.classList.remove('hidden');
                });
            }

            // Ensure the following sections remain visible for Daily only: Program Highlights, Program Details, Amenities & Perks
            const isDaily = typeof isDailyScope === 'function' && isDailyScope();
            if (isDaily) {
                ['#section-highlights', '#section-program-details', '#section-amenities'].forEach(sel => {
                    const section = document.querySelector(sel);
                    if (!section) return;
                    const wrapper = section.closest('.py-6');
                    if (wrapper) wrapper.classList.remove('hidden');
                });
            }
            // Update price slider visibility based on possibly changed radios
            updatePriceSliderVisibilityAndBounds();
            // Recompute option states after visibility changes
            updateFilterOptionStates();
            // If we programmatically changed filters (e.g., cleared price-type), re-apply filters once
            if (filtersChanged && typeof applyFiltersAndRerender === 'function') {
                // Prevent tight recursion by deferring
                setTimeout(() => { try { applyFiltersAndRerender(); } catch(_) {} }, 0);
            }
            // Update last scope tracker (normalize 'league'/'leagues' to 'leagues')
            __lastActivitiesScope = isLeagues ? 'leagues' : (isTournaments ? 'tournaments' : (isEvents ? 'events' : (isRentals ? 'rentals' : (daily ? 'daily sports' : (actVal || '')))));
        }

        function renderListPills() {
            const active = getActiveFilters();
            const activeFilterCount = active.length;
            const pillsHtml = active.map(input => {
                const label = input.dataset && input.dataset.name ? input.dataset.name : (input.id || '');
                return `<button type="button" class="flex items-center bg-[#f7f7f7] text-black border border-black text-sm font-normal px-3 py-1 rounded-full" data-filter-id="${input.id}">
                    <span>${label}</span>
                    <i data-lucide="x" class="w-4 h-4 ml-2"></i>
                </button>`;
            }).join('');
            const removeAllHtml = activeFilterCount > 1 ? `<button type="button" class="text-sm text-blue-600 hover:underline font-normal" data-action="remove-all">Remove all</button>` : '';
            listPillsContainer.innerHTML = pillsHtml + removeAllHtml;
            if (window.lucide && typeof window.lucide.createIcons === 'function') {
                window.lucide.createIcons();
            }
        }

        function renderMapGroupPills() {
            if (!mapPillsContainer) return;
            const counts = getGroupCounts();
            // For Daily scope, include all groups (highlights/details/amenities are applicable)
            const groups = filterGroups;
            const pills = groups.map(g => {
                const count = counts[g.key] || 0;
                const active = count > 0;
                const label = count > 0 ? `${g.label} (${count})` : g.label;
                const base = 'text-sm font-medium px-3 py-1 rounded-full border inline-flex items-center gap-1 transition select-none';
                const normal = 'bg-white text-gray-800 border-gray-800 hover:border-gray-900';
                const activeCls = 'bg-blue-50 text-blue-700 border-blue-500';
                return `
                    <button type="button" class="${base} ${active ? activeCls : normal}" data-group="${g.key}">
                        <span>${label}</span>
                        <i data-lucide="chevron-down" class="w-3.5 h-3.5 ml-0.5 text-current transition-transform duration-150"></i>
                    </button>`;
            }).join('');
            const removeAllHtml = getActiveFilters().length > 0 ? `<button type="button" class="ml-2 text-sm text-blue-600 hover:underline font-normal" data-action="remove-all">Remove all</button>` : '';
            mapPillsContainer.innerHTML = pills + removeAllHtml;
            if (window.lucide && typeof window.lucide.createIcons === 'function') {
                window.lucide.createIcons();
            }
        }

        function updatePills() {
            renderListPills();
            renderMapGroupPills();
        }

    function applyShowMoreToContainer(container) {
            // Apply same show-more behavior as filters list to cloned panel content
            const lists = container.querySelectorAll('.space-y-2, .grid.grid-cols-3');
            lists.forEach(list => {
                // Guard to avoid double applying within the panel instance
                if (list.dataset.showMoreApplied === 'true') return;
                const items = Array.from(list.children).filter(el => {
                    if (el.tagName === 'DIV' && el.classList.contains('show-more-wrapper')) return false;
                    if (el.classList && el.classList.contains('filter-divider')) return false;
                    return true;
                });
                if (items.length <= 4) return;
                for (let i = 4; i < items.length; i++) items[i].classList.add('hidden');
                const toggleWrapper = document.createElement('div');
                toggleWrapper.className = 'show-more-wrapper mt-2';
                const toggle = document.createElement('button');
                toggle.type = 'button';
                toggle.className = 'text-blue-600 text-sm hover:underline';
                toggle.textContent = 'Show more';
                toggle.dataset.state = 'collapsed';
                toggle.addEventListener('click', () => {
                    const collapsed = toggle.dataset.state === 'collapsed';
                    for (let i = 4; i < items.length; i++) items[i].classList.toggle('hidden', !collapsed);
                    toggle.dataset.state = collapsed ? 'expanded' : 'collapsed';
                    toggle.textContent = collapsed ? 'Show less' : 'Show more';
                    // Toggle the divider visibility in tandem with the expanded/collapsed state
                    const divider = list.querySelector('.filter-divider');
                    if (divider) divider.classList.toggle('hidden', toggle.dataset.state === 'collapsed');
                });
                toggleWrapper.appendChild(toggle);
                if (list.classList.contains('grid')) list.after(toggleWrapper); else list.appendChild(toggleWrapper);
                list.dataset.showMoreApplied = 'true';
                // Ensure divider hidden by default while collapsed
                const divider = list.querySelector('.filter-divider');
                if (divider) divider.classList.add('hidden');
            });
        }

        // Global Show more/less for filter lists (used by Venues, Neighborhood, etc.)
        // Shows first 4 label rows, hides the rest behind a toggle. Safe to call multiple times per container.
        function applyShowMore(container) {
            if (!container) return;
            // Avoid duplicating if already applied
            if (container.dataset.showMoreApplied === 'true') return;
            // Only paginate flat label lists; ignore existing wrappers/dividers
            const items = Array.from(container.children).filter(el => {
                if (el.tagName === 'DIV' && el.classList.contains('show-more-wrapper')) return false;
                if (el.classList && el.classList.contains('filter-divider')) return false;
                return true;
            });
            if (items.length <= 4) return; // nothing to do

            // Hide items after index 3
            for (let i = 4; i < items.length; i++) {
                items[i].classList.add('hidden');
            }

            // Create toggle link
            const toggleWrapper = document.createElement('div');
            toggleWrapper.className = 'show-more-wrapper mt-2';
            const toggle = document.createElement('button');
            toggle.type = 'button';
            toggle.className = 'text-blue-600 text-sm hover:underline';
            toggle.textContent = 'Show more';
            toggle.dataset.state = 'collapsed';
            toggle.addEventListener('click', () => {
                const collapsed = toggle.dataset.state === 'collapsed';
                for (let i = 4; i < items.length; i++) {
                    items[i].classList.toggle('hidden', !collapsed);
                }
                toggle.dataset.state = collapsed ? 'expanded' : 'collapsed';
                toggle.textContent = collapsed ? 'Show less' : 'Show more';
                // Toggle the divider visibility in tandem with the expanded/collapsed state
                const divider = container.querySelector('.filter-divider');
                if (divider) divider.classList.toggle('hidden', toggle.dataset.state === 'collapsed');
            });
            toggleWrapper.appendChild(toggle);
            // If container is a grid, place toggle after it to span full width; otherwise append inside
            if (container.classList.contains('grid')) {
                container.after(toggleWrapper);
            } else {
                container.appendChild(toggleWrapper);
            }
            container.dataset.showMoreApplied = 'true';
        }

        function positionPanelUnderAnchor(anchor) {
            const topbar = document.getElementById('map-topbar');
            if (!mapFilterPanel || !anchor || !topbar) return;
            const barRect = topbar.getBoundingClientRect();
            const anchorRect = anchor.getBoundingClientRect();
            const left = anchorRect.left - barRect.left; // relative to container
            const top = barRect.bottom - barRect.top + 8; // 8px gap below bar
            mapFilterPanel.style.left = `${Math.max(0, Math.min(left, barRect.width - 384))}px`; // clamp within bar, 384px = w-96
            mapFilterPanel.style.top = `${top}px`;
        }

        function showMapGroupPanel(groupKey, anchorBtn) {
            if (!mapFilterPanel || !mapFilterPanelBody) return;
            const group = filterGroups.find(g => g.key === groupKey);
            if (!group) return;
            // If Daily scope: block opening of hidden groups (highlights/details/amenities)
            if (isDailyScope() && ['highlights','details','amenities'].includes(groupKey)) return;
            const section = document.querySelector(group.sectionSelector);
            if (!section) return;
            // Map group key to lucide icon name used in list headers
            const ICONS = {
                'schedule': 'clock',
                'price': 'badge-dollar-sign',
                'location': 'map-pin',
                'highlights': 'sparkles',
                'playerteam': 'users',
                'details': 'file-text',
                'amenities': 'gift'
            };
            // Clone and sanitize inputs to avoid interfering with live filters
            const cloned = section.cloneNode(true);
            // Ensure any collapsible sections render open inside the panel
            if (cloned.matches && cloned.matches('[data-collapsible]')) cloned.classList.remove('hidden');
            cloned.querySelectorAll('[data-collapsible]').forEach(el => el.classList.remove('hidden'));
            // Remove any show-more wrappers
            cloned.querySelectorAll('.show-more-wrapper').forEach(el => el.remove());
            // Explicitly unhide known sections within the cloned content
            ['#section-program-details', '#section-amenities'].forEach(sel => {
                const sec = cloned.querySelector(sel);
                if (sec) sec.classList.remove('hidden');
            });
            // Reset any persisted show-more applied flags from originals on cloned lists
            cloned.querySelectorAll('.space-y-2, .grid.grid-cols-3').forEach(list => {
                list.removeAttribute('data-show-more-applied');
            });
            // Sanitize all inputs and sync checked state from originals
            const stagedInputs = cloned.querySelectorAll('input');
            stagedInputs.forEach(inp => {
                const originalId = inp.id || inp.getAttribute('id');
                // Capture target id from associated label if no id
                let targetId = originalId;
                // Try to infer from label[for]
                if (!targetId) {
                    const label = inp.closest('label');
                    if (label && label.htmlFor) targetId = label.htmlFor;
                }
                if (targetId) inp.dataset.targetId = targetId;
                // Remove id and filter-input class so clones don't affect pills or document
                inp.removeAttribute('id');
                inp.classList.remove('filter-input');
                // Prevent radio name collision (e.g., price-type)
                if (inp.type === 'radio' && inp.name) inp.name = `${inp.name}-staged`;
                // Sync checked state from original
                if (targetId) {
                    const orig = document.getElementById(targetId);
                    if (orig && (orig.type === 'checkbox' || orig.type === 'radio')) {
                        inp.checked = orig.checked;
                        // Also sync disabled state so enabled-first ordering works in the clone
                        inp.disabled = !!orig.disabled;
                    }
                    // Sync range value from original
                    if (orig && inp.type === 'range') {
                        inp.value = orig.value;
                    }
                }
            });
            // Also remove label for attributes to avoid duplicate id references
            cloned.querySelectorAll('label[for]').forEach(l => l.removeAttribute('for'));

            // Keep range display in sync inside panel if present
            const stagedRange = cloned.querySelector('input[type="range"]');
            const stagedDisplay = cloned.querySelector('#price-range-display');
            if (stagedRange && stagedDisplay) {
                const updateDisp = () => { stagedDisplay.textContent = `$${Number(stagedRange.value).toLocaleString()}`; };
                stagedRange.addEventListener('input', updateDisp);
                updateDisp();
            }

            // Render
            if (mapFilterPanelTitle) mapFilterPanelTitle.textContent = group.label;
            const iconWrap = document.getElementById('map-filter-panel-icon-wrap');
            if (iconWrap) {
                const iconName = ICONS[groupKey] || '';
                iconWrap.innerHTML = iconName ? `<i data-lucide="${iconName}" class="h-5 w-5 text-[rgb(34,34,34)]"></i>` : '';
            }
            mapFilterPanelBody.innerHTML = '';
            mapFilterPanelBody.appendChild(cloned);
            // Render Lucide icons inside the newly injected panel
            if (window.lucide && typeof window.lucide.createIcons === 'function') {
                window.lucide.createIcons();
            }
            // Reorder options in the cloned panel: enabled first (alphabetical), then divider, then disabled (alphabetical)
            if (typeof reorderFilterOptionContainers === 'function') {
                reorderFilterOptionContainers(mapFilterPanelBody);
            }
            // If this is the Price & Deals group, wire staged price-type to staged slider
            if (groupKey === 'price') {
                const stagedSliderContainer = mapFilterPanelBody.querySelector('#price-slider-container');
                // In clones, input IDs are stripped; select the range input by type instead of id
                const stagedSlider = mapFilterPanelBody.querySelector('input[type="range"]');
                const stagedDisp = mapFilterPanelBody.querySelector('#price-range-display');
                let stagedRadios = mapFilterPanelBody.querySelectorAll('input[type="radio"][name="price-type-staged"]');
                // Fallback: if names did not persist, capture all radios within the group
                if (!stagedRadios || stagedRadios.length === 0) {
                    stagedRadios = mapFilterPanelBody.querySelectorAll('input[type="radio"]');
                }
                const maxima = computePriceMaxima((typeof getFilteredActivities === 'function') ? getFilteredActivities() : activities);
                const updatePanelSlider = () => {
                    if (!stagedSliderContainer || !stagedSlider || !stagedDisp) return;
                    const r = Array.from(stagedRadios).find(r => r.checked);
                    if (!r) { stagedSliderContainer.classList.add('hidden'); return; }
                    const type = r.dataset.name || '';
                    let max = 100; let step = 25;
                    if (type === 'Member') { max = maxima.member; step = 25; }
                    else if (type === 'Non-Member') { max = maxima.nonMember; step = 25; }
                    else if (type === 'Team') { max = maxima.team; step = 50; }
                    const niceMax = Math.ceil(max / step) * step;
                    stagedSlider.max = String(niceMax);
                    stagedSlider.step = String(step);
                    const cur = Math.min(Number(stagedSlider.value || niceMax), niceMax);
                    stagedSlider.value = String(cur);
                    stagedSliderContainer.classList.remove('hidden');
                    stagedDisp.textContent = `$0 — $${Number(stagedSlider.value).toLocaleString()}`;
                };
                stagedRadios.forEach(r => r.addEventListener('change', updatePanelSlider));
                // Delegated safety net to catch label clicks toggling radios
                mapFilterPanelBody.addEventListener('change', (e) => {
                    if (e.target && e.target.matches && e.target.matches('input[type="radio"]')) {
                        updatePanelSlider();
                    }
                });
                if (stagedSlider) {
                    stagedSlider.addEventListener('input', () => {
                        if (stagedDisp) stagedDisp.textContent = `$0 — $${Number(stagedSlider.value).toLocaleString()}`;
                    });
                }
                // Initial render
                updatePanelSlider();
            }
            mapFilterPanel.dataset.groupKey = groupKey;
            // Mobile: show backdrop and treat as bottom drawer; Desktop: positioned popover
            if (mapFilterBackdrop) mapFilterBackdrop.classList.remove('hidden');
            mapFilterPanel.classList.remove('hidden');
            // Apply show more/less to cloned content
            applyShowMoreToContainer(mapFilterPanelBody);
            // Position panel under the clicked group pill
            if (anchorBtn && window.matchMedia('(min-width: 768px)').matches) positionPanelUnderAnchor(anchorBtn);
        }

        function hideMapGroupPanel() {
            if (!mapFilterPanel) return;
            mapFilterPanel.classList.add('hidden');
            if (mapFilterBackdrop) mapFilterBackdrop.classList.add('hidden');
            if (mapFilterPanelBody) mapFilterPanelBody.innerHTML = '';
            // Clear open state on any pill
            if (mapPillsContainer) {
                mapPillsContainer.querySelectorAll('button[data-group].is-open').forEach(btn => {
                    btn.classList.remove('is-open');
                    const icon = btn.querySelector('svg');
                    if (icon) icon.classList.remove('rotate-180');
                });
            }
        }
        
        // Group activities by coordinates (lat,lng)
        function groupActivitiesByCoords(items) {
            const map = new Map();
            items.forEach(a => {
                const key = `${a.lat},${a.lng}`;
                if (!map.has(key)) map.set(key, []);
                map.get(key).push(a);
            });
            return map;
        }

        function renderMapActivityCard(group, index) {
            const a = group[index];
            const total = group.length;
            const canPrev = index > 0;
            const canNext = index < total - 1;
            const primaryPriceMap = getPrimaryPriceInfo(a);
            const memberPartsMap = primaryPriceMap ? formatMoneyParts(primaryPriceMap.amount) : null;
            const secondaryLineMap = getSecondaryPriceLine(a);
            const schedule = getScheduleLine(a);
            // Derive composition/skill/format similar to list
            const composition = (a.format ? (a.format.toLowerCase().startsWith('coed') ? 'Coed' : a.format.toLowerCase().startsWith('women') ? "Women's" : a.format.toLowerCase().startsWith('men') ? "Men's" : a.format.toLowerCase().startsWith('open') ? 'Open' : 'Coed') : 'Coed');
            const skill = (Array.isArray(a.skill_levels) && a.skill_levels.length ? a.skill_levels[0] : 'Recreational');
            const teamSize = (() => { const m = (a.format || '').match(/\b(\d+v\d+)\b/i); return m ? m[1] : ''; })();
            const iconCoed = '<i data-lucide="users" class="h-4 w-4 text-gray-600"></i>';
            const iconMens = '<i data-lucide="mars" class="h-4 w-4 text-gray-600"></i>';
            const iconWomens = '<i data-lucide="venus" class="h-4 w-4 text-gray-600"></i>';
            const iconOpen = '<i data-lucide="circle" class="h-4 w-4 text-gray-600"></i>';
            const compLower = composition.toLowerCase();
            const compIcon = compLower.includes('women') ? iconWomens : compLower.includes('men') ? iconMens : compLower.includes('coed') ? iconCoed : iconOpen;
            // Skill icon varies by level
            const formatIcon = '<i data-lucide="users" class="h-4 w-4 text-gray-600"></i>';

            // Build experience elevator pills
            const elevatorPillsHtml = buildElevatorPillsHtml(a);
            const dayPillHtml3 = buildDayPillHtml(a);
            const pillsRowHtml3 = (dayPillHtml3 || elevatorPillsHtml) ? `<div class=\"flex items-center gap-1 mb-1\">${dayPillHtml3}${elevatorPillsHtml}</div>` : '';
            const finalTitleText3 = sanitizeTitle(buildStandardTitle(a));
            const activityTypePill = buildActivityTypePill(a);
            const statusPillsHtml = buildStatusPillsHtml(a);
            // Build media slides for map overlay
            const altMap = a.image_alt || a.program_name || a.venue_name || 'Activity image';
            const slidesMap = [];
            if (hasGlowKickballVideo(a)) slidesMap.push(buildVideoSlide('utMEhvPfU-k'));
            slidesMap.push(buildImageSlide(a.image_url, altMap));
            slidesMap.push(buildPlaceholderSlide('2nd image'));
            const carouselHtmlMap = buildCarouselHtml(slidesMap, false);
            const html = `
                <article class="bg-white rounded-2xl border border-gray-200 overflow-hidden flex flex-col max-w-2xl mx-auto">
                    <div class="h-56 relative">
                        ${carouselHtmlMap}
                        ${activityTypePill}
                        ${statusPillsHtml}
                        <div class="img-bottom-gradient"></div>
                        <div class="absolute left-0 right-0 bottom-0 p-3 z-10">
                            ${pillsRowHtml3}
                            <div class="overlay-title font-bold leading-snug">${finalTitleText3}</div>
                        </div>
                    </div>
                    <div class="border-t border-gray-200 flex flex-col min-h-0 relative">
                        <div class="flex-1 px-4 pt-4 pb-4 flex flex-col min-h-0 overflow-hidden">
                            <div class="flex items-start justify-between min-w-0">
                                <h3 class="text-base md:text-lg font-bold text-gray-800 truncate flex items-center gap-2">
                                    <button type="button" class="shrink-0 text-gray-600 hover:text-blue-600" data-action="view-map-location" data-lat="${Number(a.lat)}" data-lng="${Number(a.lng)}" title="View on map">
                                        <i data-lucide="map-pin" class="h-4 w-4"></i>
                                    </button>
                                    <span class="card-title-link text-gray-900 truncate">${sanitizeTitle(a.venue_name || a.program_name)}</span>
                                </h3>
                                <div class="text-right ml-3">
                                    ${primaryPriceMap ? `
                                    <div class="flex items-baseline justify-end gap-1">
                                        ${primaryPriceMap.displayText ? `<p class=\"text-lg md:text-xl font-bold text-gray-800\">${primaryPriceMap.displayText}</p>` : (() => { const p = formatMoneyParts(primaryPriceMap.amount); return `<p class=\"text-lg md:text-xl font-bold text-gray-800\">$${p.dollars}${p.cents !== '00' ? `<span class="align-text-top text-xs">.${p.cents}</span>` : ''}</p>`; })()}
                                        <span class="text-xs text-gray-500">${primaryPriceMap.suffix}</span>
                                        <button type="button" class="ml-1 align-middle text-gray-500 hover:text-blue-600" aria-label="Learn about Volo Pass" data-action="open-volo-pass-modal">
                                            <i data-lucide="info" class="w-4 h-4"></i>
                                        </button>
                                    </div>` : ''}
                                </div>
                            </div>
                            <div class="mt-1 flex items-center justify-between gap-3 text-xs md:text-sm">
                                <div class="text-xs md:text-sm text-gray-700 truncate min-w-0" title="${schedule}">${schedule}</div>
                                <div class="text-xs md:text-sm text-gray-500 whitespace-nowrap shrink-0">${secondaryLineMap}</div>
                            </div>
                        </div>
                        <div class="shrink-0 border-t border-gray-200 px-3 pt-4 pb-4">
                            <div class="flex items-center justify-start gap-5 h-full">
                                ${isDailyActivity(a) ? `
                                ${getSurfaceBadgeHtml(a)}
                                <div class=\"flex items-center gap-2 min-w-0\">
                                    ${compIcon}
                                    <span class=\"meta-text text-xs md:text-sm text-gray-800 truncate\" title=\"${composition}\">${composition}</span>
                                </div>
                                <div class=\"flex items-center gap-2 min-w-0\">
                                    ${getSkillIconSvg(skill)}
                                    <span class=\"meta-text text-xs md:text-sm text-gray-800 truncate\" title=\"${skill}\">${skill}</span>
                                </div>
                                ` : `
                                <div class=\"flex items-center gap-2 min-w-0\">
                                    ${compIcon}
                                    <span class=\"meta-text text-xs md:text-sm text-gray-800 truncate\" title=\"${composition}\">${composition}</span>
                                </div>
                                <div class=\"flex items-center gap-2 min-w-0\">
                                    ${getSkillIconSvg(skill)}
                                    <span class=\"meta-text text-xs md:text-sm text-gray-800 truncate\" title=\"${skill}\">${skill}</span>
                                </div>
                                ${teamSize ? `<div class="flex items-center gap-2 min-w-0">${formatIcon}<span class="meta-text text-xs md:text-sm text-gray-800 truncate" title="${teamSize}">${teamSize}</span></div>` : ''}`}
                                ${getAgeBadgeHtml(a)}
                                <div class="ml-auto flex items-center gap-2"></div>
                            </div>
                        </div>
                    </div>
                </article>
                <div class="mt-3 flex justify-center">
                    <div class="inline-flex items-center gap-2 rounded-full bg-[#0034DD] text-white border border-[#0034DD] shadow-md px-3 py-1 font-semibold">
                        <button class="inline-flex items-center justify-center h-7 w-7 rounded-full text-white/90 hover:text-white hover:bg-white/15 focus:outline-none focus:ring-2 focus:ring-white/70 ${canPrev ? '' : 'opacity-40 pointer-events-none'}" data-action="map-prev" aria-label="Previous" ${canPrev ? '' : 'disabled aria-disabled="true"'}>
                            <i data-lucide="chevron-left" class="w-4 h-4"></i>
                        </button>
                        <span class="text-xs text-white/95 tabular-nums">${index + 1} / ${total} Activities</span>
                        <button class="inline-flex items-center justify-center h-7 w-7 rounded-full text-white/90 hover:text-white hover:bg-white/15 focus:outline-none focus:ring-2 focus:ring-white/70 ${canNext ? '' : 'opacity-40 pointer-events-none'}" data-action="map-next" aria-label="Next" ${canNext ? '' : 'disabled aria-disabled="true"'}>
                            <i data-lucide="chevron-right" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>`;
            const container = mapActivityCardContainer ? mapActivityCardContainer.firstElementChild : null;
            if (container) {
                container.innerHTML = html;
                const carElMap = container.querySelector('.media-carousel');
                if (carElMap) { activateCarousel(carElMap); attachHoverToMedia(carElMap); }
            }
            if (window.lucide && typeof window.lucide.createIcons === 'function') {
                window.lucide.createIcons();
            }
            if (typeof startCountdownTicker === 'function') startCountdownTicker();
            mapActivityCardContainer.classList.remove('hidden');
        }

        // ---- EXPERIENCE ELEVATORS LOGIC ----
        // Map icon name to emoji for compact, readable pills
        function getElevatorIcon(name) {
            const emoji = (n => {
                switch (n) {
                    case 'sparkles': return '✨';
                    case 'flag': return '🚩';
                    case 'cup': return '🥤';
                    case 'beer': return '🍺';
                    case 'beer-alt': return '🍻';
                    case 'music': return '🎶';
                    case 'ticket': return '🎟️';
                    case 'user': return '👤';
                    case 'badge': return '🏷️';
                    case 'heart': return '❤️';
                    case 'party': return '🎉';
                    case 'trophy': return '🏆';
                    case 'tv': return '📺';
                    case 'ball': return '⚽';
                    case 'heart-star': return '💚';
                    case 'receipt': return '🧾';
                    case 'shield': return '🛡️';
                    case 'water': return '🌊';
                    default: return '⭐';
                }
            })(name || '');
            return `<span class="elev-emoji" role="img" aria-label="${name || 'icon'}">${emoji}</span>`;
        }

        function matchElevatorsForActivity(activity) {
            const features = Array.isArray(activity.features) ? activity.features : [];
            const available = Array.isArray(window.experienceElevators) ? window.experienceElevators : [];
            const matched = [];
            // Normalize features to lowercase for matching
            const lowerFeatures = features.map(f => String(f).toLowerCase());
            available.forEach(cfg => {
                const aliases = (cfg.aliases || []).map(a => String(a).toLowerCase());
                const hit = lowerFeatures.some(f => aliases.includes(f));
                if (hit) matched.push(cfg);
            });
            return matched;
        }

        function buildElevatorPillsHtml(activity) {
            const matched = matchElevatorsForActivity(activity);
            if (matched.length === 0) return '';
            const top3 = matched.slice(0, 3);
            const rest = matched.slice(3);
            const pill = (cfg) => `
                <span class="elev-pill inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[13px] font-bold text-white"
                      style="background-color:${cfg.color}">
                    ${getElevatorIcon(cfg.icon)}
                    <span>${cfg.label}</span>
                </span>`;
            const pillsRow = top3.map(pill).join('\n');
            const more = rest.length > 0
                ? `<div class="relative inline-block group">
                        <span class="elev-pill inline-flex items-center rounded-full px-2 py-0.5 text-[13px] font-bold text-white bg-gray-800">+${rest.length} more</span>
                        <div class="absolute left-0 bottom-full mb-2 hidden group-hover:block inline-block bg-white border border-gray-200 rounded-full shadow-lg p-2 z-10">
                            <div class="inline-flex items-center gap-1 whitespace-nowrap">
                                ${rest.map(pill).join('')}
                            </div>
                        </div>
                   </div>`
                : '';
            return `${pillsRow}${more ? '\n' + more : ''}`;
        }

        // ---- ACTIVITY TYPE PILL ----
        function getActivityType(activity) {
            const raw = activity.activity_type || activity.program_type || activity.type || '';
            const t = String(raw).trim().toLowerCase();
            const canon = t;
            // Strong source-based typing first
            if (activity && activity.source === 'leagues') return 'League';
            if (activity && activity.source === 'rentals') return 'Private Rentals';
            if (canon === 'league' || canon === 'leagues') return 'League';
            if (canon === 'drop-in' || canon === 'dropin' || canon === 'drop in') return 'Drop-in';
            if (canon === 'pickup' || canon === 'pick-up' || canon === 'pick up') return 'PickUp';
            if (canon === 'tournament' || canon === 'tournaments') return 'Tournament';
            if (canon === 'event' || canon === 'events' || canon === 'watch party' || canon === 'player party' || canon === 'happy hour') return 'Event';
            if (canon === 'rental' || canon === 'rentals' || canon === 'private rentals') return 'Private Rentals';
            // Fallbacks by source to ensure robust typing when raw type missing
            if (activity && activity.source === 'events') return 'Event';
            if (activity && activity.source === 'tournaments') return 'Tournament';
            if (activity && activity.source === 'daily') {
                const name = String(activity.program_name || '').toLowerCase();
                if (/pick\s*-?\s*up/.test(name)) return 'PickUp';
                return 'Drop-in';
            }
            return '';
        }
        function getActivityTypeIcon(type) {
            // Blue icon via currentColor; parent sets text-blue-700
            switch (type) {
                case 'League':
                    // Use Lucide trophy to match sidebar icon
                    return '<i data-lucide="trophy" class="w-3.5 h-3.5"></i>';
                case 'Drop-in':
                    return '<i data-lucide="zap" class="w-3.5 h-3.5"></i>';
                case 'PickUp':
                    return '<i data-lucide="arrow-up-right" class="w-3.5 h-3.5"></i>';
                case 'Tournament':
                    return '<i data-lucide="trophy" class="w-3.5 h-3.5"></i>';
                case 'Event':
                    return '<i data-lucide="calendar" class="w-3.5 h-3.5"></i>';
                case 'Private Rentals':
                    return '<i data-lucide="building-2" class="w-3.5 h-3.5"></i>';
                default:
                    return '';
            }
        }
        function buildActivityTypePill(activity) {
            const t = getActivityType(activity);
            const allowed = new Set(['League', 'Drop-in', 'PickUp', 'Tournament', 'Event', 'Private Rentals']);
            if (!t || !allowed.has(t)) return '';
            const icon = getActivityTypeIcon(t);
            const colorClass = (t === 'Drop-in')
                ? 'text-orange-600'
                : (t === 'PickUp')
                    ? 'text-green-600'
                    : (t === 'League')
                        ? 'text-blue-500'
                        : (t === 'Tournament')
                            ? 'text-blue-700'
                            : (t === 'Event')
                                ? 'text-purple-600'
                                : 'text-blue-600';
            return `
                <div class="absolute left-0 top-0 py-3 px-4 z-10">
                    <span class="type-pill inline-flex items-center gap-1 rounded-full bg-white text-black text-[13px] px-2.5 py-1 shadow-sm">
                        <span class="${colorClass}">${icon}</span>
                        <span>${t}</span>
                    </span>
                </div>
            `;
        }

        // ---- STATUS PILLS (top-right) ----
        function sentenceCaseSmart(str) {
            if (!str || typeof str !== 'string') return str;
            const s = str.trim();
            // Only transform if it's shouting (all upper aside from non-letters)
            const letters = s.replace(/[^A-Za-z]+/g, '');
            if (!letters || letters !== letters.toUpperCase()) return s;
            // Split by " - " to keep parts readable
            const parts = s.split(/\s-\s/);
            const result = parts.map((part) => {
                const original = part;
                let lower = part.toLowerCase();
                // Capitalize first alphabetical character
                const idx = lower.search(/[a-z]/);
                if (idx >= 0) lower = lower.slice(0, idx) + lower.charAt(idx).toUpperCase() + lower.slice(idx + 1);
                // Preserve common acronyms found in original (2-4 chars)
                const acronyms = (original.match(/\b[A-Z]{2,4}\b/g) || []);
                acronyms.forEach(acr => {
                    const re = new RegExp(`\\b${acr.toLowerCase()}\\b`, 'g');
                    lower = lower.replace(re, acr);
                });
                // Preserve AM/PM explicitly
                lower = lower.replace(/\b(am|pm)\b/g, m => m.toUpperCase());
                return lower;
            });
            return result.join(' - ');
        }

    function buildStatusPillsHtml(activity, opts = {}) {
            const includeClosing = opts.includeClosing !== false; // default true
            const msgs = [];
            const a = activity || {};
            if (a.banner_message && String(a.banner_message).trim()) msgs.push(sentenceCaseSmart(String(a.banner_message).trim()));
            // Compute "Closing" messaging and prefer live countdown within 24 hours
            if (includeClosing) {
                const closing = computeClosingCountdown(a);
                if (closing) {
                    // If within 24 hours, render a live countdown instead
                    let minsToDeadline = computeMinutesToDeadlineET(a);
                    if (typeof minsToDeadline === 'number' && minsToDeadline > 0 && minsToDeadline <= 1440) {
                        const md = extractRegistrationMMDD(a);
                        if (md) {
                            const icon = '<i data-lucide="clock" class="w-3.5 h-3.5"></i>';
                            const text = formatCountdownHM(minsToDeadline);
                            const content = `${icon}<span class="closing-countdown" data-countdown-mmdd="${md.mm}/${md.dd}">${text}</span>`;
                            return `
                                <div class="absolute right-0 top-0 p-3 z-10 flex flex-col items-end gap-1">
                                    <span class="elev-pill inline-flex items-center gap-1 rounded-full bg-orange-500 text-white text-[12.5px] px-2.5 py-1">${content}</span>
                                </div>
                            `;
                        }
                    }
                    msgs.push(closing);
                } else if (a.registration_phase_text && String(a.registration_phase_text).trim()) {
                    // Fallback to provided text when we cannot compute countdown
                    const raw = String(a.registration_phase_text).trim();
                    // Replace literal phrase if present
                    let replaced = raw.replace(/\bregistration\s+ends\b/i, 'Closing in');
                    // Normalize singular day phrasing
                    replaced = replaced.replace(/\bClosing in\s+1\s+day\b/i, 'Closing tomorrow');
                    msgs.push(replaced);
                }
            }
            // Deduplicate while preserving order
            const seen = new Set();
            const unique = msgs.filter(m => { if (seen.has(m)) return false; seen.add(m); return true; });
            if (unique.length === 0) return '';
            const render = (m) => {
                const isClosing = /^(Closing in\b|Closing tomorrow\b)/i.test(String(m));
                const icon = isClosing ? '<i data-lucide="clock" class="w-3.5 h-3.5"></i>' : '';
                // If this activity closes today before 6pm ET, render a live countdown (Nh Nm)
                const minsToday = computeMinutesToClosingTodayET(a);
                if (isClosing && typeof minsToday === 'number' && minsToday > 0) {
                    const text = formatCountdownHM(minsToday);
                    const md = extractRegistrationMMDD(a);
                    const dataAttr = md ? `data-countdown-mmdd="${md.mm}/${md.dd}"` : 'data-countdown-today-et="1"';
                    const content = `${icon}<span class="closing-countdown" ${dataAttr}>${text}</span>`;
                    return `<span class="elev-pill inline-flex items-center gap-1 rounded-full bg-orange-500 text-white text-[12.5px] px-2.5 py-1">${content}</span>`;
                }
                // If "Closing tomorrow", render as a countdown target node (static text until <24h) so it can flip to live automatically after midnight
                if (/^Closing tomorrow\b/i.test(String(m))) {
                    const md = extractRegistrationMMDD(a);
                    if (md) {
                        const content = `${icon}<span class="closing-countdown" data-countdown-mmdd="${md.mm}/${md.dd}">Closing tomorrow</span>`;
                        return `<span class="elev-pill inline-flex items-center gap-1 rounded-full bg-[rgba(83,83,83,0.90)] text-white text-[12.5px] px-2.5 py-1">${content}</span>`;
                    }
                }
                const content = isClosing ? `${icon}<span>${m}</span>` : m;
                return `<span class="elev-pill inline-flex items-center gap-1 rounded-full ${isClosing ? 'bg-[rgba(83,83,83,0.90)] text-white' : 'bg-[rgba(83,83,83,0.90)] text-white'} text-[12.5px] px-2.5 py-1">${content}</span>`;
            };
            return `
                <div class="absolute right-0 top-0 p-3 z-10 flex flex-col items-end gap-1">
                    ${unique.map(render).join('')}
                </div>
            `;
        }

        // Inline closing pill for list-card bottom row. Orange within 24 hours, grey otherwise. Mirrors countdown behavior for same-day closings.
        function buildClosingInlineHtml(activity) {
            const a = activity || {};
            const msg = computeClosingCountdown(a);
            if (!msg) return '';
            const isSoon = /^(Closing in\b|Closing tomorrow\b)/i.test(String(msg));
            const icon = '<i data-lucide="clock" class="w-3.5 h-3.5"></i>';
            // Compute whether within 24 hours for live countdown
            let within24 = false;
            const minsToDeadline = computeMinutesToDeadlineET(a);
            if (typeof minsToDeadline === 'number' && minsToDeadline > 0 && minsToDeadline <= 1440) within24 = true;
            const pillClass = within24 ? 'bg-orange-500 text-white' : 'bg-[rgba(83,83,83,0.90)] text-white';
            if (within24) {
                const md = extractRegistrationMMDD(a);
                const mins = typeof minsToDeadline === 'number' ? minsToDeadline : getMinutesUntil6pmET();
                if (typeof mins === 'number' && mins > 0) {
                    const dataAttr = md ? `data-countdown-mmdd="${md.mm}/${md.dd}"` : 'data-countdown-today-et="1"';
                    const text = formatCountdownHM(mins);
                    return `<span class="elev-pill inline-flex items-center gap-1 rounded-full ${pillClass} text-[12.5px] px-2.5 py-1"><span class="shrink-0">${icon}</span><span class="closing-countdown" ${dataAttr}>${text}</span></span>`;
                }
            }
            // If within 24–48 hours, show static "Closing tomorrow" but include countdown target so it flips after midnight
            if (typeof minsToDeadline === 'number' && minsToDeadline > 1440 && minsToDeadline <= 2880) {
                const md = extractRegistrationMMDD(a);
                if (md) {
                    return `<span class="elev-pill inline-flex items-center gap-1 rounded-full ${pillClass} text-[12.5px] px-2.5 py-1"><span class="shrink-0">${icon}</span><span class="closing-countdown" data-countdown-mmdd="${md.mm}/${md.dd}">Closing tomorrow</span></span>`;
                }
            }
            return `<span class="elev-pill inline-flex items-center gap-1 rounded-full ${pillClass} text-[12.5px] px-2.5 py-1"><span class="shrink-0">${icon}</span><span>${msg}</span></span>`;
        }

    // Compute a user-friendly "Closing in" message based on registration end date (MM/DD) with a 6pm ET cutoff.
    function computeClosingCountdown(a) {
            if (!a) return '';
            let mmdd = String(a.registration_ends_mmdd || '').trim();
            if (!mmdd) {
                const t = String(a.registration_phase_text || '');
                const m = t.match(/(\d{1,2})\/(\d{1,2})/);
                if (m) mmdd = `${m[1]}/${m[2]}`;
            }
            const m2 = mmdd.match(/^\s*(\d{1,2})\/(\d{1,2})\s*$/);
            if (!m2) return '';
            const mm = Math.min(12, Math.max(1, parseInt(m2[1], 10)));
            const dd = Math.min(31, Math.max(1, parseInt(m2[2], 10)));
            const nowET = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/New_York' }));
            const y = nowET.getFullYear();
            const dayMs = 24*60*60*1000;
            // Compute day difference using UTC-midnight values to avoid local TZ skew
            const todayUtc = Date.UTC(y, nowET.getMonth(), nowET.getDate());
            const deadlineUtc = Date.UTC(y, mm - 1, dd);
            let dayDiff = Math.round((deadlineUtc - todayUtc) / dayMs);
            if (dayDiff < 0) {
                // Assume the intended deadline is next year
                const deadlineNextUtc = Date.UTC(y + 1, mm - 1, dd);
                dayDiff = Math.round((deadlineNextUtc - todayUtc) / dayMs);
            }
            // Same ET day: show hours until 6pm ET based on ET clock
            if (dayDiff === 0) {
                const minutesNow = nowET.getHours() * 60 + nowET.getMinutes();
                const minutesUntil = 18 * 60 - minutesNow; // 6pm ET
                if (minutesUntil <= 0) return '';
                const hours = Math.ceil(minutesUntil / 60);
                return `Closing in ${hours} hour${hours === 1 ? '' : 's'}`;
            }
            if (dayDiff === 1) return 'Closing tomorrow';
            // All other cases show the date
            return `Closing on ${mm}/${dd}`;
        }

    // --- Countdown helpers for same-day closings (to 6pm ET) ---
        function extractRegistrationMMDD(activity) {
            if (!activity) return null;
            let mmdd = String(activity.registration_ends_mmdd || '').trim();
            if (!mmdd) {
                const t = String(activity.registration_phase_text || '');
                const m = t.match(/(\d{1,2})\/(\d{1,2})/);
                if (m) mmdd = `${m[1]}/${m[2]}`;
            }
            const m2 = mmdd.match(/^\s*(\d{1,2})\/(\d{1,2})\s*$/);
            if (!m2) return null;
            const mm = Math.min(12, Math.max(1, parseInt(m2[1], 10)));
            const dd = Math.min(31, Math.max(1, parseInt(m2[2], 10)));
            return { mm, dd };
        }
        function getMinutesUntil6pmET() {
            const nowET = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/New_York' }));
            const minutesNow = nowET.getHours() * 60 + nowET.getMinutes();
            return 18 * 60 - minutesNow; // 6pm ET
        }
        function computeMinutesToClosingTodayET(activity) {
            const md = extractRegistrationMMDD(activity);
            if (!md) return null;
            const nowET = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/New_York' }));
            const todayMM = nowET.getMonth() + 1;
            const todayDD = nowET.getDate();
            if (md.mm === todayMM && md.dd === todayDD) {
                const mins = getMinutesUntil6pmET();
                return mins > 0 ? mins : null;
            }
            return null;
        }
        function formatCountdownHM(totalMins) {
            const mins = Math.max(0, Math.floor(totalMins));
            const h = Math.floor(mins / 60);
            const m = mins % 60;
            if (h > 0 && m > 0) return `Closing in ${h}h ${m}m`;
            if (h > 0) return `Closing in ${h}h`;
            if (m > 0) return `Closing in ${m}m`;
            return 'Closing now';
        }
        function computeMinutesToTarget6pmET(mm, dd) {
            const nowET = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/New_York' }));
            const y = nowET.getFullYear();
            const dayMs = 24*60*60*1000;
            const todayUtc = Date.UTC(y, nowET.getMonth(), nowET.getDate());
            let deadlineUtc = Date.UTC(y, mm - 1, dd);
            if (deadlineUtc < todayUtc - 0.5*dayMs) {
                // If clearly past, assume next year
                deadlineUtc = Date.UTC(y + 1, mm - 1, dd);
            }
            let dayDiff = Math.round((deadlineUtc - todayUtc) / dayMs);
            const minutesNow = nowET.getHours() * 60 + nowET.getMinutes();
            // Minutes until 6pm of target ET date
            const mins = dayDiff * 24 * 60 + (18 * 60 - minutesNow);
            return mins > 0 ? mins : 0;
        }
        function computeMinutesToDeadlineET(activity) {
            const md = extractRegistrationMMDD(activity);
            if (!md) return null;
            const mins = computeMinutesToTarget6pmET(md.mm, md.dd);
            return mins > 0 ? mins : null;
        }
        function updateCountdownPills() {
            // New: nodes with explicit target MM/DD (works for today and tomorrow within 48h)
            const nodesWithTarget = document.querySelectorAll('.closing-countdown[data-countdown-mmdd]');
            nodesWithTarget.forEach(node => {
                const mmdd = node.getAttribute('data-countdown-mmdd') || '';
                const m = mmdd.match(/^(\d{1,2})\/(\d{1,2})$/);
                if (!m) return;
                const mm = parseInt(m[1], 10); const dd = parseInt(m[2], 10);
                const mins = computeMinutesToTarget6pmET(mm, dd);
                if (mins <= 0) {
                    const pill = node.closest('.elev-pill');
                    if (pill && pill.parentElement) pill.parentElement.removeChild(pill);
                } else if (mins <= 1440) {
                    node.textContent = formatCountdownHM(mins);
                } else if (mins <= 2880) {
                    node.textContent = 'Closing tomorrow';
                }
            });
            // Back-compat: legacy same-day countdown nodes
            const legacyNodes = document.querySelectorAll('.closing-countdown[data-countdown-today-et="1"]');
            if (legacyNodes.length) {
                const mins = getMinutesUntil6pmET();
                legacyNodes.forEach(node => {
                    if (!(node && node.closest)) return;
                    if (mins <= 0) {
                        const pill = node.closest('.elev-pill');
                        if (pill && pill.parentElement) pill.parentElement.removeChild(pill);
                    } else {
                        node.textContent = formatCountdownHM(mins);
                    }
                });
            }
        }
        function startCountdownTicker() {
            // Start once
            if (!window.__closingCountdownInterval) {
                window.__closingCountdownInterval = setInterval(updateCountdownPills, 30000); // 30s
            }
            // Immediate update so UI reflects current minute
            updateCountdownPills();
        }

        function showActivityCardOnMapForGroup(group) {
            let currentIndex = 0;
            function mount() {
                renderMapActivityCard(group, currentIndex);
                const container = mapActivityCardContainer ? mapActivityCardContainer.firstElementChild : null;
                if (!container) return;
                const prevBtn = container.querySelector('[data-action="map-prev"]');
                const nextBtn = container.querySelector('[data-action="map-next"]');
                if (prevBtn) prevBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (currentIndex > 0) { currentIndex -= 1; mount(); }
                });
                if (nextBtn) nextBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (currentIndex < group.length - 1) { currentIndex += 1; mount(); }
                });
                // Keyboard navigation while overlay is visible
                const onKey = (e) => {
                    if (!mapActivityCardContainer || mapActivityCardContainer.classList.contains('hidden')) return;
                    if (e.key === 'ArrowLeft') {
                        if (currentIndex > 0) { e.preventDefault(); currentIndex -= 1; mount(); }
                    } else if (e.key === 'ArrowRight') {
                        if (currentIndex < group.length - 1) { e.preventDefault(); currentIndex += 1; mount(); }
                    }
                };
                // Remove any prior handler first to avoid stacking
                if (window.__mapOverlayKeyHandler) {
                    window.removeEventListener('keydown', window.__mapOverlayKeyHandler);
                }
                window.__mapOverlayKeyHandler = onKey;
                window.addEventListener('keydown', onKey);
            }
            mount();
        }

        // --- GOOGLE MAPS ---
        function initMap() {
            const auburnCoords = { lat: 39.2904, lng: -76.6122 }; // Baltimore center
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 13,
                center: auburnCoords,
                disableDefaultUI: true,
                zoomControl: true,
            });

            const bounds = new google.maps.LatLngBounds();
            // Group filtered activities by coordinates so each marker can represent multiple programs
            const items = (typeof getFilteredActivities === 'function') ? getFilteredActivities() : activities;
            const grouped = groupActivitiesByCoords(items);
            grouped.forEach((group, key) => {
                const [latStr, lngStr] = key.split(',');
                const lat = parseFloat(latStr), lng = parseFloat(lngStr);
                const marker = new google.maps.Marker({ position: { lat, lng }, map, title: group[0].venue_name || group[0].program_name });
                marker.addListener('click', () => showActivityCardOnMapForGroup(group));
                markers.push(marker);
                bounds.extend({ lat, lng });
            });
            if(!bounds.isEmpty()) {
                map.fitBounds(bounds, 60); // padding
            }
            
            // Close card and any open filter panel when map is clicked
            map.addListener('click', () => {
                mapActivityCardContainer.classList.add('hidden');
                // Remove keyboard handler when overlay is closed
                if (window.__mapOverlayKeyHandler) {
                    window.removeEventListener('keydown', window.__mapOverlayKeyHandler);
                    window.__mapOverlayKeyHandler = null;
                }
                hideMapGroupPanel();
            });
        }

        function initPreviewMap() {
            const auburnCoords = { lat: 39.2904, lng: -76.6122 }; // Baltimore center
            const previewMapDiv = document.getElementById('map-preview');
            if (!previewMapDiv) return;
            // Ensure Google Maps is available
            if (typeof window === 'undefined' || typeof window.google === 'undefined' || !google.maps) return;
            // Clear any placeholder content before mounting the map
            try { previewMapDiv.innerHTML = ''; } catch(_) {}

            previewMap = new google.maps.Map(previewMapDiv, {
                zoom: 11,
                center: auburnCoords,
                gestureHandling: 'none', // Make the map non-interactive
                zoomControl: false,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false,
            });

            const bounds = new google.maps.LatLngBounds();
            const items = (typeof getFilteredActivities === 'function') ? getFilteredActivities() : activities;
            items.forEach(activity => {
                if (typeof activity.lat === 'number' && typeof activity.lng === 'number') {
                    new google.maps.Marker({ position: { lat: activity.lat, lng: activity.lng }, map: previewMap });
                    bounds.extend({ lat: activity.lat, lng: activity.lng });
                }
            });
            if(!bounds.isEmpty()) {
                previewMap.fitBounds(bounds, 40);
            }
        }

        function refreshMapMarkers() {
            if (!map) return;
            // Clear existing markers
            markers.forEach(m => m.setMap(null));
            markers = [];
            const bounds = new google.maps.LatLngBounds();
            const items = (typeof getFilteredActivities === 'function') ? getFilteredActivities() : activities;
            const grouped = groupActivitiesByCoords(items);
            grouped.forEach((group, key) => {
                const [latStr, lngStr] = key.split(',');
                const lat = parseFloat(latStr), lng = parseFloat(lngStr);
                const marker = new google.maps.Marker({ position: { lat, lng }, map, title: group[0].venue_name || group[0].program_name });
                marker.addListener('click', () => showActivityCardOnMapForGroup(group));
                markers.push(marker);
                bounds.extend({ lat, lng });
            });
            if(!bounds.isEmpty()) {
                map.fitBounds(bounds, 60);
            }
        }

        // Fit the map to currently visible markers (safe when map just became visible)
        function fitMapToMarkers(padding = 60) {
            if (!map || !markers || markers.length === 0 || typeof google === 'undefined' || !google.maps) return;
            const bounds = new google.maps.LatLngBounds();
            let count = 0;
            markers.forEach(m => {
                const pos = m.getPosition && m.getPosition();
                if (pos) { bounds.extend(pos); count++; }
            });
            if (count === 1) {
                const pos = markers[0].getPosition();
                if (pos) {
                    map.setCenter(pos);
                    map.setZoom(14);
                }
                return;
            }
            if (!bounds.isEmpty()) {
                map.fitBounds(bounds, padding);
            }
        }

        // When showing the map after being hidden, schedule a resize + fit to ensure proper bounds
        function scheduleMapFitToMarkers() {
            if (!map) return;
            // Trigger resize so Google Maps recomputes layout after container becomes visible
            try { if (google && google.maps && google.maps.event) google.maps.event.trigger(map, 'resize'); } catch(_) {}
            // Use RAF and a short timeout to wait for layout
            requestAnimationFrame(() => {
                setTimeout(() => fitMapToMarkers(60), 50);
            });
        }

        // Build and update the map search summary bar (City · Activity · Sports)
        function computeMapSearchSummary() {
            const cityInput = document.getElementById('city');
            const activitiesInput = document.getElementById('activities');
            const appliedSportsContainer = document.getElementById('applied-sports-inputs');
            const city = (cityInput && cityInput.value) ? cityInput.value.trim() : '';
            const activity = (activitiesInput && activitiesInput.value) ? activitiesInput.value.trim() : '';
            const sports = Array.from(appliedSportsContainer ? appliedSportsContainer.querySelectorAll('input[type="checkbox"].filter-input:checked') : [])
                .map(cb => cb.dataset.name).filter(Boolean);
            const sportsLabel = sports.length === 0 ? 'All Sports'
                : sports.length <= 2 ? sports.join(', ')
                : `${sports.length} selected`;
            const parts = [];
            if (city) parts.push(city);
            if (activity) parts.push(activity);
            parts.push(sportsLabel);
            return parts.join(' · ');
        }
        function renderMapSearchSummary() {
            const el = document.getElementById('map-search-summary');
            if (!el) return;
            el.textContent = computeMapSearchSummary();
            el.title = el.textContent;
        }

        // Switch to map view and open the map card for the group that matches a lat/lng
        function focusMapOnLatLng(lat, lng) {
            if (typeof lat !== 'number' || typeof lng !== 'number' || !isFinite(lat) || !isFinite(lng)) return;
            // Ensure map view is visible
            if (listView && mapView && mapView.classList.contains('hidden')) {
                listView.classList.add('hidden');
                mapView.classList.remove('hidden');
                scheduleMapFitToMarkers();
            }
            // Initialize map if needed
            if (!map || typeof google === 'undefined' || !google.maps) return;
            const items = (typeof getFilteredActivities === 'function') ? getFilteredActivities() : activities;
            const grouped = groupActivitiesByCoords(items);
            const key = `${lat},${lng}`;
            const group = grouped.get(key);
            if (group && Array.isArray(group) && group.length) {
                map.setCenter({ lat, lng });
                map.setZoom(14);
                showActivityCardOnMapForGroup(group);
            }
        }

        // Delegated handler for the small map icon next to titles
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('[data-action="view-map-location"]');
            if (!btn) return;
            e.preventDefault();
            const lat = parseFloat(btn.getAttribute('data-lat'));
            const lng = parseFloat(btn.getAttribute('data-lng'));
            focusMapOnLatLng(lat, lng);
        });
        
        // --- GOOGLE MAPS ERROR HANDLING ---
        // This is a global function that the Google Maps script can call on authentication failure.
        function gm_authFailure() {
            const mapDiv = document.getElementById('map');
            const mapPreviewDiv = document.getElementById('map-preview');
            const errorMessageHTML = `
                <div class="h-full w-full bg-red-100 text-red-800 flex flex-col items-center justify-center p-4 text-center">
                    <i data-lucide="alert-circle" class="w-10 h-10 mb-2"></i>
                    <h3 class="font-bold text-lg">Map Loading Error</h3>
                    <p class="text-sm mt-1">A valid Google Maps API key is required. Please replace <strong>YOUR_API_KEY</strong> in the code.</p>
                </div>
            `;
            if (mapDiv) mapDiv.innerHTML = errorMessageHTML;
            if (mapPreviewDiv) mapPreviewDiv.innerHTML = errorMessageHTML;
        }

        // Callback function to initialize both maps
        window.initializeAllMaps = function() {
            initMap();
            // After init, ensure markers reflect current filters
            refreshMapMarkers();
            initPreviewMap();
        }

        // --- SCRIPT INITIALIZATION ---
        function loadGoogleMapsScript() {
            const apiKey = "AIzaSyD0cogMvTi4JMSi_Ze_XjFtaoCY0CdZPVw";

            if (apiKey === "YOUR_API_KEY" || !apiKey) {
                console.error("Google Maps API key is missing or is still the placeholder. Please open this file and replace 'YOUR_API_KEY' with a valid key.");
                gm_authFailure();
                return;
            }

            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initializeAllMaps&v=weekly`;
            script.async = true;
            document.head.appendChild(script);
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Initialize Lucide icons for any static placeholders
            if (window.lucide && typeof window.lucide.createIcons === 'function') {
                window.lucide.createIcons();
            }
            if (typeof startCountdownTicker === 'function') startCountdownTicker();
            // Collapse/expand for select filter sections
            document.querySelectorAll('[data-collapse-toggle]').forEach(btn => {
                const targetSel = btn.getAttribute('data-collapse-toggle');
                const target = targetSel ? document.querySelector(targetSel) : null;
                if (!target) return;
                // Ensure collapsed on load
                target.classList.add('hidden');
                btn.dataset.open = 'false';
                btn.addEventListener('click', () => {
                    const isHidden = target.classList.contains('hidden');
                    target.classList.toggle('hidden');
                    btn.dataset.open = isHidden ? 'true' : 'false';
                });
            });
            // Build venue filters and search wiring
            renderVenueFilters();
            // Build neighborhood filters and search wiring
            renderNeighborhoodFilters();
            const venueSearch = document.getElementById('venue-search-input');
            if (venueSearch) {
                venueSearch.addEventListener('input', () => {
                    const q = (venueSearch.value || '').toLowerCase();
                    const list = document.getElementById('venue-list');
                    if (!list) return;
                    Array.from(list.querySelectorAll('label')).forEach(l => {
                        const name = (l.textContent || '').toLowerCase();
                        l.classList.toggle('hidden', q && !name.includes(q));
                    });
                });
            }
            const neighborhoodSearch = document.getElementById('neighborhood-search-input');
            if (neighborhoodSearch) {
                neighborhoodSearch.addEventListener('input', () => {
                    const q = (neighborhoodSearch.value || '').toLowerCase();
                    const list = document.getElementById('neighborhood-list');
                    if (!list) return;
                    Array.from(list.querySelectorAll('label')).forEach(l => {
                        const name = (l.textContent || '').toLowerCase();
                        l.classList.toggle('hidden', q && !name.includes(q));
                    });
                    // When clearing the search, restore the show-more collapsed state if present
                    if (!q) {
                        const wrapper = list.querySelector('.show-more-wrapper') || (list.nextElementSibling && list.nextElementSibling.classList && list.nextElementSibling.classList.contains('show-more-wrapper') ? list.nextElementSibling : null);
                        const btn = wrapper ? wrapper.querySelector('button') : null;
                        const collapsed = btn ? (btn.dataset.state === 'collapsed') : null;
                        if (collapsed !== null) {
                            const items = Array.from(list.querySelectorAll('label'));
                            items.forEach((el, i) => {
                                el.classList.toggle('hidden', collapsed && i >= 4);
                            });
                        }
                    }
                });
            }
            viewMapBtn.addEventListener('click', toggleView);
            backToListBtn.addEventListener('click', toggleView);
            function applyFiltersAndRerender() {
                pagination.page = 1; // reset page when filters change
                updatePills();
                renderActivities();
                updateResultsHeading();
                refreshMapMarkers();
                // Refresh mini preview map to reflect current filtered results
                try { if (window.google && google.maps) initPreviewMap(); } catch(_) {}
                scheduleMapFitToMarkers();
                updateFilterOptionStates();
                updatePriceSliderVisibilityAndBounds();
                renderMapSearchSummary();
                // Scroll to top so user sees updated results
                scrollToTopOfResults();
                // Adjust filter visibility based on Activities scope (Daily vs Leagues)
                if (typeof applyActivityTypeFilterVisibility === 'function') applyActivityTypeFilterVisibility();
            }
            filtersForm.addEventListener('change', applyFiltersAndRerender);
            // Price range slider display updater
            const priceRange = document.getElementById('price-range');
            const priceDisplay = document.getElementById('price-range-display');
            if (priceRange && priceDisplay) {
                const syncPrice = () => {
                    const val = Number(priceRange.value);
                    priceDisplay.textContent = `$0 — $${val.toLocaleString()}`;
                };
                priceRange.addEventListener('input', () => { syncPrice(); applyFiltersAndRerender(); });
                priceRange.addEventListener('change', () => { syncPrice(); applyFiltersAndRerender(); });
                // Initial hidden; bounds set when a price type is chosen
            }
            // Events dual-thumb slider: combined summary + active band
            const eventStartRange = document.getElementById('event-time-start');
            const eventEndRange = document.getElementById('event-time-end');
            const eventRangeSummary = document.getElementById('event-time-range-summary');
            const eventActiveBand = document.getElementById('event-time-active-band');
            if (eventStartRange && eventEndRange && eventRangeSummary) {
                const toPct = (mins) => Math.max(0, Math.min(100, (Number(mins||0) / 1439) * 100));
                const toLabel = (mins) => Number(mins||0) > 0 ? minutesToTimeLabel(Number(mins)) : 'Any';
                const updateHitZones = () => {
                    const sPct = toPct(Number(eventStartRange.value||0));
                    const ePct = toPct(Number(eventEndRange.value||1439));
                    const mid = Math.min(sPct + (ePct - sPct)/2, ePct);
                    eventStartRange.style.clipPath = `inset(0 ${100-mid}% 0 0)`;
                    eventEndRange.style.clipPath = `inset(0 0 0 ${mid}%)`;
                };
                const syncBand = () => {
                    const s = Number(eventStartRange.value || 0);
                    const e = Number(eventEndRange.value || 1439);
                    const left = `${toPct(Math.max(0, Math.min(1439, s)))}%`;
                    const rightPct = toPct(Math.max(0, Math.min(1439, e)));
                    const right = `${100 - rightPct}%`;
                    if (eventActiveBand) {
                        eventActiveBand.style.left = left;
                        eventActiveBand.style.right = right;
                    }
                };
                const syncSummary = () => {
                    const s = Number(eventStartRange.value || 0);
                    const e = Number(eventEndRange.value || 1439);
                    const sTxt = toLabel(s);
                    const eTxt = e < 1439 ? toLabel(e) : 'Any';
                    eventRangeSummary.textContent = `${sTxt} — ${eTxt}`;
                };
                const clamp = () => {
                    let s = Number(eventStartRange.value || 0);
                    let e = Number(eventEndRange.value || 1439);
                    if (s > e) {
                        if (clamp.lastChanged === 'start') eventStartRange.value = String(e);
                        else if (clamp.lastChanged === 'end') eventEndRange.value = String(s);
                        else eventStartRange.value = String(e);
                    }
                };
                const elevate = (which) => {
                    if (which === 'start') {
                        eventStartRange.style.zIndex = '30';
                        eventEndRange.style.zIndex = '20';
                    } else {
                        eventEndRange.style.zIndex = '30';
                        eventStartRange.style.zIndex = '20';
                    }
                };
                const onStartInput = () => { clamp.lastChanged = 'start'; elevate('start'); clamp(); syncBand(); syncSummary(); updateHitZones(); applyFiltersAndRerender(); };
                const onEndInput = () => { clamp.lastChanged = 'end'; elevate('end'); clamp(); syncBand(); syncSummary(); updateHitZones(); applyFiltersAndRerender(); };
                const track = document.getElementById('event-time-track');
                if (track) {
                    const onPointDown = (e) => {
                        if (e.target === eventStartRange || e.target === eventEndRange) return; // native drag handles
                        const rect = track.getBoundingClientRect();
                        const clientX = (e.touches && e.touches[0]) ? e.touches[0].clientX : e.clientX;
                        const x = clientX - rect.left;
                        const pct = Math.max(0, Math.min(1, x / rect.width));
                        const raw = pct * 1439;
                        const snapped = Math.round(raw / 30) * 30;
                        const sVal = Number(eventStartRange.value||0);
                        const eVal = Number(eventEndRange.value||1439);
                        const distToStart = Math.abs(snapped - sVal);
                        const distToEnd = Math.abs(snapped - eVal);
                        if (distToStart <= distToEnd) {
                            eventStartRange.value = String(Math.min(snapped, eVal));
                            clamp.lastChanged = 'start';
                            onStartInput();
                        } else {
                            eventEndRange.value = String(Math.max(snapped, sVal));
                            clamp.lastChanged = 'end';
                            onEndInput();
                        }
                    };
                    track.addEventListener('pointerdown', onPointDown);
                    track.addEventListener('touchstart', onPointDown, { passive: true });
                }
                eventStartRange.addEventListener('input', onStartInput);
                eventStartRange.addEventListener('change', onStartInput);
                eventEndRange.addEventListener('input', onEndInput);
                eventEndRange.addEventListener('change', onEndInput);
                if (Number(eventEndRange.value || 0) === 0) eventEndRange.value = '1439';
                syncBand();
                syncSummary();
                updateHitZones();
                elevate('start');
            }
            // Allow selecting and deselecting price-type via label clicks (Member / Non-Member / Team)
            const priceTypeContainer = document.querySelector('#section-price-deals .flex.flex-nowrap');
            if (priceTypeContainer) {
                priceTypeContainer.addEventListener('click', (e) => {
                    const label = e.target.closest('label');
                    if (!label || !priceTypeContainer.contains(label)) return;
                    const input = label.querySelector('input[type="radio"][name="price-type"]');
                    if (!input) return;
                    // Toggle manually to support deselect behavior
                    e.preventDefault();
                    const wasChecked = input.checked;
                    // Uncheck all in group first
                    document.querySelectorAll('input[type="radio"][name="price-type"]').forEach(r => { r.checked = false; });
                    // Recheck only if it was previously unchecked
                    input.checked = !wasChecked;
                    // Dispatch change so pills sync
                    input.dispatchEvent(new Event('change', { bubbles: true }));
                    // Show/hide slider and set bounds based on selection and current dataset
                    updatePriceSliderVisibilityAndBounds();
                    applyFiltersAndRerender();
                });
            }
            // Clear-all button removed with Filters header; pills still reflect selections live.
            // Show more / Show less toggle for lists is defined globally as applyShowMore()

            // Find all filter lists and apply show more behavior
            // Patterns: grids or vertical space-y containers directly containing label rows
            document.querySelectorAll('#filters-form .space-y-2, #filters-form .grid.grid-cols-3').forEach(applyShowMore);
            updatePills(); // Initial call
            renderActivities();
            updateResultsHeading();
            loadGoogleMapsScript(); // Load the Google Maps script after the DOM is ready
            if (typeof applyActivityTypeFilterVisibility === 'function') applyActivityTypeFilterVisibility();

            // --- Mobile UX wiring ---
            // Hide the inline map callout on small screens (already handled via aside hidden), wire floating View in Map
            const mobileViewMap = document.getElementById('mobile-view-map');
            if (mobileViewMap) mobileViewMap.addEventListener('click', toggleView);

            // Make the map preview clickable to open the map view
            const previewContainer = document.getElementById('map-preview-container');
            if (previewContainer) {
                previewContainer.addEventListener('click', () => {
                    // If currently in list view (map hidden), switch to map view
                    if (mapView && mapView.classList.contains('hidden')) {
                        toggleView();
                    }
                    scheduleMapFitToMarkers();
                });
            }

            // Mobile search CTA should perform same action as desktop search
            const mobileSearchBtn = document.getElementById('mobile-search-btn');
            const desktopSearchBtn = document.getElementById('desktop-search-btn');
            const triggerSearch = () => {
                // Commit staged sports selections and apply filters
                if (typeof renderAppliedSportsInputs === 'function') renderAppliedSportsInputs();
                if (typeof updateSportsFieldValue === 'function') updateSportsFieldValue();
                if (typeof applyFiltersAndRerender === 'function') {
                    applyFiltersAndRerender();
                } else {
                    // Fallback
                    pagination.page = 1;
                    renderActivities();
                    updateResultsHeading();
                    refreshMapMarkers();
                    scrollToTopOfResults();
                }
            };
            if (mobileSearchBtn) mobileSearchBtn.addEventListener('click', triggerSearch);
            if (desktopSearchBtn) desktopSearchBtn.addEventListener('click', triggerSearch);

            // Mobile Filters overlay logic
            const mobileFiltersOpen = document.getElementById('mobile-filters-open');
            const mobileFiltersOverlay = document.getElementById('mobile-filters-overlay');
            const mobileFiltersBody = document.getElementById('mobile-filters-body');
            const mobileFiltersClose = document.getElementById('mobile-filters-close');
            const mobileFiltersDone = document.getElementById('mobile-filters-done');
            const filtersFormEl = document.getElementById('filters-form');
            const filtersFormAnchor = document.getElementById('filters-form-anchor');

            function openMobileFilters() {
                if (!mobileFiltersOverlay || !mobileFiltersBody || !filtersFormEl) return;
                // Create a padded wrapper to provide left padding inside overlay
                let paddedWrapper = document.createElement('div');
                paddedWrapper.id = 'mobile-filters-padding-wrapper';
                paddedWrapper.className = 'px-4';
                paddedWrapper.appendChild(filtersFormEl);
                mobileFiltersBody.innerHTML = '';
                mobileFiltersBody.appendChild(paddedWrapper);
                mobileFiltersOverlay.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            }
            function closeMobileFilters(applyChanges = false) {
                if (!mobileFiltersOverlay || !filtersFormEl || !filtersFormAnchor) return;
                // Move filters form back to the anchor position in sidebar
                const wrapper = document.getElementById('mobile-filters-padding-wrapper');
                if (wrapper && wrapper.contains(filtersFormEl)) {
                    wrapper.removeChild(filtersFormEl);
                }
                filtersFormAnchor.after(filtersFormEl);
                // Clear overlay body content
                if (mobileFiltersBody) mobileFiltersBody.innerHTML = '';
                mobileFiltersOverlay.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
                if (applyChanges) {
                    // Apply filters
                    if (typeof applyFiltersAndRerender === 'function') applyFiltersAndRerender();
                }
            }

            if (mobileFiltersOpen) mobileFiltersOpen.addEventListener('click', openMobileFilters);
            if (mobileFiltersClose) mobileFiltersClose.addEventListener('click', () => closeMobileFilters(false));
            if (mobileFiltersDone) mobileFiltersDone.addEventListener('click', () => closeMobileFilters(true));
            if (mobileFiltersOverlay) mobileFiltersOverlay.addEventListener('click', (e) => {
                if (e.target && e.target.hasAttribute('data-overlay-close')) closeMobileFilters(false);
            });

            // No sort dropdown: results render in data order after filters

            // Parse filters from URL query and apply
            function parseAndApplyQueryFilters() {
                try {
                    const url = new URL(window.location.href);
                    const qs = url.searchParams;
                    if (!qs || Array.from(qs.keys()).length === 0) return; // nothing to do
                    const activity = qs.get('activity');
                    const dailyType = qs.get('dailyType');
                    const sports = (qs.get('sports') || '').split(',').map(s => s.trim()).filter(Boolean);
                    const skills = (qs.get('skill') || '').split(',').map(s => s.trim()).filter(Boolean);
                    const compositions = (qs.get('composition') || '').split(',').map(s => s.trim()).filter(Boolean);
                    const days = qs.get('days');
                    const features = (qs.get('features') || '').split(',').map(s => s.trim()).filter(Boolean);
                    // Activity
                    if (activity) {
                        const actInput = document.getElementById('activities');
                        if (actInput) actInput.value = activity;
                    }
                    // Daily type
                    if (dailyType) {
                        const id = dailyType.toLowerCase() === 'pickup' ? 'daily-pickup' : 'daily-dropin';
                        const r = document.getElementById(id); if (r) r.checked = true;
                    }
                    // Sports
                    if (sports && sports.length) {
                        sports.forEach(name => {
                            const sel = `#sports-dropdown input[type="checkbox"][data-sport="${String(name).replace(/"/g, '\\"')}"]`;
                            const cb = document.querySelector(sel);
                            if (cb) cb.checked = true;
                        });
                        if (typeof renderAppliedSportsInputs === 'function') renderAppliedSportsInputs();
                        if (typeof updateSportsFieldValue === 'function') updateSportsFieldValue();
                    }
                    // Skills
                    const skillMap = { 'Competitive':'skill-competitive','Intermediate':'skill-intermediate','Recreational':'skill-recreational','Social/Beginner':'skill-beginner' };
                    skills.forEach(name => { const id = skillMap[name]; const el = id && document.getElementById(id); if (el) el.checked = true; });
                    // Composition
                    const compMap = { 'Coed':'comp-coed', "Men's":'comp-mens', "Women's":'comp-womens', 'Open':'comp-open' };
                    compositions.forEach(name => { const id = compMap[name]; const el = id && document.getElementById(id); if (el) el.checked = true; });
                    // Days
                    if (days === 'weekdays') ['day-mon','day-tue','day-wed','day-thu','day-fri'].forEach(id => { const el = document.getElementById(id); if (el) el.checked = true; });
                    else if (days === 'weekends') ['day-sat','day-sun'].forEach(id => { const el = document.getElementById(id); if (el) el.checked = true; });
                    // Features (Bar on Site, Indoor)
                    features.forEach(v => {
                        if (v.toLowerCase() === 'bar on site') ['hl-bar-site','soc-bar-site'].forEach(id => { const el = document.getElementById(id); if (el) el.checked = true; });
                        else if (v.toLowerCase() === 'indoor') { const el = document.getElementById('surface-indoor'); if (el) el.checked = true; }
                    });
                    if (typeof applyActivityTypeFilterVisibility === 'function') applyActivityTypeFilterVisibility();
                    if (typeof applyFiltersAndRerender === 'function') applyFiltersAndRerender();
                } catch (e) {
                    console.warn('Failed to parse URL filters:', e);
                }
            }

            // Always attempt to load both datasets; on file:// also show local file uploader as a fallback
            const isFileProto = window.location.protocol === 'file:';
            if (isFileProto) {
                const box = document.getElementById('local-file-loader');
                const input = document.getElementById('local-file-input');
                if (box && input) {
                    box.classList.remove('hidden');
                    input.addEventListener('change', async (e) => {
                        const files = Array.from(input.files || []);
                        if (!files.length) return;
                        try {
                            let leagues = [];
                            let daily = [];
                            let tournaments = [];
                            let events = [];
                            let rentals = [];
                            for (const file of files) {
                                try {
                                    const text = await file.text();
                                    const data = JSON.parse(text);
                                    const list = Array.isArray(data)
                                        ? data
                                        : (Array.isArray(data.records) ? data.records : (Array.isArray(data.items) ? data.items : []));
                                    const name = (file.name || '').toLowerCase();
                                    // Strong filename-first routing
                                    const nameIsLeagues = /league/.test(name);
                                    const nameIsDaily = /daily/.test(name);
                                    const nameIsTournaments = /tournament/.test(name);
                                    const nameIsEvents = /event/.test(name);
                                    const nameIsRentals = /rental/.test(name);
                                    // Content heuristics as a secondary signal
                                    const hasDailyTraits = list.some(it => (it && (it.relative_day_offset != null)));
                                    const hasEventTraits = list.some(it => (it && (it.day_label || it.date_mmdd)));
                                    const hasLeagueTraits = list.some(it => (it && (it.weeks != null || it.start_date_text || it.format)));
                                    const hasRentalTraits = list.some(it => (it && (it.rental_name || it.price_hr_min != null || it.price_hr_max != null)));
                                    // Final classification priority:
                                    // 1) Explicit filename match
                                    // 2) Content traits, preferring leagues if league traits present
                                    let bucket = 'leagues';
                                    if (nameIsLeagues) bucket = 'leagues';
                                    else if (nameIsTournaments) bucket = 'tournaments';
                                    else if (nameIsEvents) bucket = 'events';
                                    else if (nameIsDaily) bucket = 'daily';
                                    else if (nameIsRentals) bucket = 'rentals';
                                    else if (hasLeagueTraits) bucket = 'leagues';
                                    else if (hasEventTraits) bucket = 'events';
                                    else if (hasDailyTraits) bucket = 'daily';
                                    else if (hasRentalTraits) bucket = 'rentals';
                                    // Map to transformers
                                    if (bucket === 'daily') {
                                        daily = daily.concat(list.map(transformDailyToActivity).filter(Boolean));
                                    } else if (bucket === 'tournaments') {
                                        tournaments = tournaments.concat(list.map(transformTournamentToActivity).filter(Boolean));
                                    } else if (bucket === 'events') {
                                        events = events.concat(list.map(transformEventToActivity).filter(Boolean));
                                    } else if (bucket === 'rentals') {
                                        rentals = rentals.concat(list.map(transformRentalToActivity).filter(Boolean));
                                    } else {
                                        leagues = leagues.concat(list.map(transformLeagueToActivity).filter(Boolean));
                                    }
                                } catch (err) {
                                    console.error('Failed to parse selected file:', file && file.name, err);
                                }
                            }
                            activities = [];
                            if (leagues.length > 0) {
                                shiftActivitiesDates(leagues, 4);
                                activities = activities.concat(leagues);
                                if (typeof DATASETS !== 'undefined') DATASETS.leagues = leagues.slice();
                            }
                            if (daily.length > 0) { activities = activities.concat(daily); if (typeof DATASETS !== 'undefined') DATASETS.daily = daily.slice(); }
                            if (tournaments.length > 0) { activities = activities.concat(tournaments); if (typeof DATASETS !== 'undefined') DATASETS.tournaments = tournaments.slice(); }
                            if (events.length > 0) { activities = activities.concat(events); if (typeof DATASETS !== 'undefined') DATASETS.events = events.slice(); }
                            if (rentals.length > 0) { activities = activities.concat(rentals); if (typeof DATASETS !== 'undefined') DATASETS.rentals = rentals.slice(); }
                            renderFormatFilters();
                            pagination.page = 1;
                            const actEl = document.getElementById('activities');
                            if (actEl && !actEl.value) actEl.value = 'Leagues';
                            // Use unified pipeline so source guards and visibility apply consistently
                            if (typeof applyActivityTypeFilterVisibility === 'function') applyActivityTypeFilterVisibility();
                            if (typeof applyFiltersAndRerender === 'function') {
                                applyFiltersAndRerender();
                            } else {
                                updateResultsHeading();
                                renderActivities();
                                if (typeof renderNeighborhoodFilters === 'function') renderNeighborhoodFilters();
                                refreshMapMarkers();
                                if (typeof previewMap !== 'undefined') initPreviewMap();
                                updateFilterOptionStates();
                                updatePriceSliderVisibilityAndBounds();
                            }
                            // Hide local file loader once data is successfully loaded
                            box.classList.add('hidden');
                        } catch (err) {
                            console.error('Failed to load selected files:', err);
                            alert('Could not parse JSON files. Please select valid leagues.json, tournaments.json, daily-sports.json, events.json, and/or rentals.json.');
                        }
                    });
                }
                // Try to fetch both JSON files even on file:// (may fail due to CORS in some browsers)
                loadAllData().then(() => {
                    if (Array.isArray(activities) && activities.length > 0) {
                        box.classList.add('hidden');
                    }
                    parseAndApplyQueryFilters();
                });
            } else {
                // Load data from same folder (both datasets)
                loadAllData().then(() => { parseAndApplyQueryFilters(); });
            }
            // Initialize filter states for the current (possibly empty) dataset
            updateFilterOptionStates();
            // Ensure default activity type is applied at startup
            (function ensureDefaultActivity() {
                const actEl = document.getElementById('activities');
                if (actEl && !actEl.value) {
                    actEl.value = 'Leagues';
                    // Apply scope-specific visibility and render so initial view reflects default scope
                    if (typeof applyActivityTypeFilterVisibility === 'function') applyActivityTypeFilterVisibility();
                    if (typeof applyFiltersAndRerender === 'function') applyFiltersAndRerender();
                }
            })();

            // --- DROPDOWNS: City, Activities, Sports ---
            const cityInput = document.getElementById('city');
            const cityDropdown = document.getElementById('city-dropdown');
            const citySearch = document.getElementById('city-search');
            const cityList = document.getElementById('city-list');
            // Removed city-done button (single-select)

            const activitiesInput = document.getElementById('activities');
            const activitiesDropdown = document.getElementById('activities-dropdown');
            // Removed activities-done button (single-select)
            const activitiesList = document.getElementById('activities-list');

            const sportsInput = document.getElementById('sports');
            const sportsDropdown = document.getElementById('sports-dropdown');
            const sportsSearch = document.getElementById('sports-search');
            const sportsClearBtn = document.getElementById('sports-clear');
            const sportsDoneBtn = document.getElementById('sports-done');
            const appliedSportsContainer = document.getElementById('applied-sports-inputs');

            function show(dd) { if (dd) dd.classList.remove('hidden'); }
            function hide(dd) { if (dd) dd.classList.add('hidden'); }
            function hideAllDropdowns() { hide(cityDropdown); hide(activitiesDropdown); hide(sportsDropdown); }

            // Helper: check if click target is inside a container
            function isInside(target, container) { return container && (target === container || container.contains(target)); }

            // City dropdown behavior (staged apply)
            let stagedCityValue = cityInput ? cityInput.value : '';
            function filterCityList(query) {
                if (!cityList) return;
                const q = query.trim().toLowerCase();
                const buttons = cityList.querySelectorAll('button[data-city]');
                buttons.forEach(btn => {
                    const name = btn.dataset.city.toLowerCase();
                    btn.classList.toggle('hidden', q && !name.includes(q));
                });
            }
            function highlightCity(selected) {
                if (!cityList) return;
                cityList.querySelectorAll('button[data-city]').forEach(btn => {
                    btn.classList.toggle('bg-gray-100', btn.dataset.city === selected);
                });
            }
            if (cityInput) {
                cityInput.addEventListener('focus', () => {
                    hideAllDropdowns();
                    stagedCityValue = cityInput.value || '';
                    if (citySearch) citySearch.value = stagedCityValue;
                    filterCityList(stagedCityValue);
                    highlightCity(stagedCityValue);
                    show(cityDropdown);
                });
                cityInput.addEventListener('click', () => {
                    hideAllDropdowns();
                    stagedCityValue = cityInput.value || '';
                    if (citySearch) citySearch.value = stagedCityValue;
                    filterCityList(stagedCityValue);
                    highlightCity(stagedCityValue);
                    show(cityDropdown);
                });
                cityInput.addEventListener('input', () => {
                    if (citySearch) citySearch.value = cityInput.value;
                    filterCityList(cityInput.value || '');
                    highlightCity('');
                    show(cityDropdown);
                });
            }
            if (citySearch) {
                citySearch.addEventListener('input', () => filterCityList(citySearch.value || ''));
            }
            if (cityList) {
                cityList.addEventListener('click', (e) => {
                    const btn = e.target.closest('button[data-city]');
                    if (!btn) return;
                    const selected = btn.dataset.city;
                    // Commit immediately for single-select
                    if (cityInput) cityInput.value = selected;
                    stagedCityValue = selected;
                    if (citySearch) citySearch.value = selected;
                    highlightCity(selected);
                    updateResultsHeading();
                    hide(cityDropdown);
                });
            }

            // Activities dropdown behavior (staged apply)
            // Default to 'Leagues' so users see league results by default
            let stagedActivityValue = activitiesInput ? (activitiesInput.value || 'Leagues') : 'Leagues';
            if (activitiesInput && !activitiesInput.value) activitiesInput.value = 'Leagues';
            if (activitiesInput) {
                activitiesInput.addEventListener('focus', () => {
                    hideAllDropdowns();
                    stagedActivityValue = activitiesInput.value || stagedActivityValue || '';
                    // highlight selected
                    if (activitiesList) {
                        activitiesList.querySelectorAll('[data-activity]').forEach(b => b.classList.toggle('bg-gray-100', (b.dataset.activity || '') === stagedActivityValue));
                    }
                    show(activitiesDropdown);
                });
                activitiesInput.addEventListener('click', () => {
                    hideAllDropdowns();
                    stagedActivityValue = activitiesInput.value || stagedActivityValue || '';
                    if (activitiesList) {
                        activitiesList.querySelectorAll('[data-activity]').forEach(b => b.classList.toggle('bg-gray-100', (b.dataset.activity || '') === stagedActivityValue));
                    }
                    show(activitiesDropdown);
                });
            }
            if (activitiesDropdown) {
                activitiesDropdown.addEventListener('click', (e) => {
                    const btn = e.target.closest('button[data-activity]');
                    if (!btn) return;
                    const activity = btn.dataset.activity || '';
                    // Commit immediately for single-select
                    stagedActivityValue = activity;
                    const finalValue = stagedActivityValue || 'Leagues';
                    if (activitiesInput) activitiesInput.value = finalValue;
                    if (activitiesList) {
                        activitiesList.querySelectorAll('[data-activity]').forEach(b => b.classList.toggle('bg-gray-100', (b.dataset.activity || '') === activity));
                    }
                    hide(activitiesDropdown);
                    // First adjust filter visibility (may clear radios), then apply filters
                    if (typeof applyActivityTypeFilterVisibility === 'function') applyActivityTypeFilterVisibility();
                    applyFiltersAndRerender();
                });
            }

            // Sports dropdown behavior (staged apply)
            function slugify(str) {
                return str.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
            }
            // Helper to compute field value from applied selections (not staged)
            function updateSportsFieldValue() {
                if (!sportsInput) return;
                const selected = Array.from(appliedSportsContainer ? appliedSportsContainer.querySelectorAll('input[type="checkbox"].filter-input') : [])
                    .filter(cb => cb.checked)
                    .map(cb => cb.dataset.name);
                if (selected.length === 0) {
                    sportsInput.value = '';
                    sportsInput.placeholder = 'Search for a sport...';
                } else if (selected.length <= 2) {
                    sportsInput.value = selected.join(', ');
                } else {
                    sportsInput.value = `${selected.length} selected`;
                }
            }
            function getSportsDropdownCheckboxes() {
                return sportsDropdown ? sportsDropdown.querySelectorAll('input[type="checkbox"][data-sport]') : [];
            }
            function syncSportsDropdownFromApplied() {
                const applied = new Set(Array.from(appliedSportsContainer ? appliedSportsContainer.querySelectorAll('input[type="checkbox"].filter-input') : [])
                    .filter(cb => cb.checked)
                    .map(cb => cb.dataset.name));
                getSportsDropdownCheckboxes().forEach(cb => {
                    const name = cb.getAttribute('data-sport') || '';
                    cb.checked = applied.has(name);
                });
            }
            function renderAppliedSportsInputs() {
                if (!appliedSportsContainer) return;
                appliedSportsContainer.innerHTML = '';
                const selected = Array.from(getSportsDropdownCheckboxes())
                    .filter(cb => cb.checked)
                    .map(cb => cb.getAttribute('data-sport') || '')
                    .filter(Boolean);
                selected.forEach(name => {
                    const id = `sport-${slugify(name)}`;
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.id = id;
                    input.className = 'filter-input';
                    input.dataset.name = name;
                    input.checked = true;
                    appliedSportsContainer.appendChild(input);
                });
            }

            if (sportsInput) {
                sportsInput.addEventListener('focus', () => { hideAllDropdowns(); syncSportsDropdownFromApplied(); show(sportsDropdown); });
                sportsInput.addEventListener('click', () => { hideAllDropdowns(); syncSportsDropdownFromApplied(); show(sportsDropdown); });
            }
            if (sportsSearch) {
                const filterSports = () => {
                    const q = (sportsSearch.value || '').toLowerCase();
                    const items = sportsDropdown.querySelectorAll('#sports-list-left > div, #sports-list-right > div');
                    items.forEach(item => {
                        const name = item.textContent.toLowerCase();
                        item.classList.toggle('hidden', q && !name.includes(q));
                    });
                };
                sportsSearch.addEventListener('input', filterSports);
            }
            if (sportsClearBtn) {
                sportsClearBtn.addEventListener('click', () => {
                    getSportsDropdownCheckboxes().forEach(cb => { cb.checked = false; });
                });
            }
            if (sportsDoneBtn) {
                sportsDoneBtn.addEventListener('click', () => {
                    renderAppliedSportsInputs();
                    updateSportsFieldValue();
                    applyFiltersAndRerender();
                    updateResultsHeading();
                    hide(sportsDropdown);
                });
            }

            // Hook the hero Search button to apply staged sports selections as well
            const heroSearchBtn = document.querySelector('button[aria-label="Search"]');
            if (heroSearchBtn) {
                heroSearchBtn.addEventListener('click', () => {
                    // Always commit staged sports selections into applied inputs
                    renderAppliedSportsInputs();
                    updateSportsFieldValue();
                    if (sportsDropdown) hide(sportsDropdown);
                    // Apply filters regardless
                    applyFiltersAndRerender();
                    updateResultsHeading();
                });
            }

            // Volo Pass modal wiring
            const voloPassModal = document.getElementById('volo-pass-modal');
            const voloPassBackdrop = document.getElementById('volo-pass-backdrop');
            function openVoloPassModal() {
                if (!voloPassModal || !voloPassBackdrop) return;
                voloPassModal.classList.remove('hidden');
                voloPassBackdrop.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
                if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
            }
            function closeVoloPassModal() {
                if (!voloPassModal || !voloPassBackdrop) return;
                voloPassModal.classList.add('hidden');
                voloPassBackdrop.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }
            document.addEventListener('click', (e) => {
                const openBtn = e.target.closest('[data-action="open-volo-pass-modal"]');
                const closeBtn = e.target.closest('[data-action="close-volo-pass-modal"]');
                if (openBtn) { e.preventDefault(); openVoloPassModal(); }
                if (closeBtn) { e.preventDefault(); closeVoloPassModal(); }
            });
            // Close on backdrop click or Escape
            if (voloPassBackdrop) voloPassBackdrop.addEventListener('click', closeVoloPassModal);
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeVoloPassModal(); });

            // Global handlers for closing dropdowns
            document.addEventListener('click', (e) => {
                const cityWrap = cityInput ? cityInput.parentElement : null;
                const actWrap = activitiesInput ? activitiesInput.parentElement : null;
                const sportWrap = sportsInput ? sportsInput.parentElement : null;
                const target = e.target;
                const clickedInsideCity = cityWrap && isInside(target, cityWrap) || isInside(target, cityDropdown);
                const clickedInsideAct = actWrap && isInside(target, actWrap) || isInside(target, activitiesDropdown);
                const clickedInsideSport = sportWrap && isInside(target, sportWrap) || isInside(target, sportsDropdown);
                if (!clickedInsideCity) hide(cityDropdown);
                if (!clickedInsideAct) hide(activitiesDropdown);
                if (!clickedInsideSport) hide(sportsDropdown);
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') hideAllDropdowns();
            });

            // Delegated handlers for pill clicks and remove-all in both list and map containers
            function onPillsClick(e) {
                const removeAll = e.target.closest('[data-action="remove-all"]');
                if (removeAll) {
                    const inputs = document.querySelectorAll('.filter-input');
                    inputs.forEach(input => {
                        if (input.type === 'checkbox' || input.type === 'radio') {
                            input.checked = false;
                            input.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    });
                    // Update sports field display since applied sports changed
                    if (typeof updateSportsFieldValue === 'function') updateSportsFieldValue();
                    applyFiltersAndRerender();
                    if (e.currentTarget === mapPillsContainer) hideMapGroupPanel();
                    return;
                }
                const pill = e.target.closest('[data-filter-id]');
                if (pill) {
                    const id = pill.getAttribute('data-filter-id');
                    const el = document.getElementById(id);
                    if (el) {
                        el.checked = false;
                        el.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                    if (typeof updateSportsFieldValue === 'function') updateSportsFieldValue();
                    applyFiltersAndRerender();
                }
            }
            listPillsContainer.addEventListener('click', onPillsClick);
            mapPillsContainer.addEventListener('click', onPillsClick);
            const centerPills = document.getElementById('centered-applied-pills');
            if (centerPills) centerPills.addEventListener('click', onPillsClick);
            const nonmatchSection = document.getElementById('nonmatching-section');
            if (nonmatchSection) {
                nonmatchSection.addEventListener('click', (e) => {
                    const btn = e.target.closest('[data-action="remove-all"]');
                    if (btn) {
                        const inputs = document.querySelectorAll('.filter-input');
                        inputs.forEach(input => {
                            if (input.type === 'checkbox' || input.type === 'radio') {
                                input.checked = false;
                                input.dispatchEvent(new Event('change', { bubbles: true }));
                            }
                        });
                        if (typeof updateSportsFieldValue === 'function') updateSportsFieldValue();
                        applyFiltersAndRerender();
                    }
                });
            }

            // No separate venue change listener needed; filtersForm change covers it.

            // Map group pills: open corresponding group panel on click
            if (mapPillsContainer) {
                mapPillsContainer.addEventListener('click', (e) => {
                    const btn = e.target.closest('button[data-group]');
                    if (!btn) return;
                    const key = btn.getAttribute('data-group');
                    const alreadyOpen = btn.classList.contains('is-open');
                    hideMapGroupPanel();
                    if (!alreadyOpen) {
                        btn.classList.add('is-open');
                        const icon = btn.querySelector('svg');
                        if (icon) icon.classList.add('rotate-180');
                        showMapGroupPanel(key, btn);
                    }
                });
            }

            // Close action for map filter panel and click-outside handler
            if (mapFilterPanel) {
                // Clear: uncheck all staged inputs in the panel
                if (mapFilterPanelClear) {
                    mapFilterPanelClear.addEventListener('click', () => {
                        if (!mapFilterPanelBody) return;
                        mapFilterPanelBody.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(i => { i.checked = false; });
                    });
                }
                // Done: apply staged values back to originals
                if (mapFilterPanelDone) {
                    mapFilterPanelDone.addEventListener('click', () => {
                        const groupKey = mapFilterPanel.dataset.groupKey || '';
                        // Special handling for price-type radios: clear originals first
                        const stagedRadios = mapFilterPanelBody.querySelectorAll('input[type="radio"]');
                        if (stagedRadios.length) {
                            // Gather original radio names from data-targetId
                            const toCheckIds = new Set();
                            stagedRadios.forEach(r => {
                                const targetId = r.dataset.targetId;
                                if (r.checked && targetId) toCheckIds.add(targetId);
                            });
                            // For known group price-type
                            document.querySelectorAll('input[type="radio"][name="price-type"]').forEach(r => { r.checked = false; });
                            toCheckIds.forEach(id => {
                                const orig = document.getElementById(id);
                                if (orig) orig.checked = true;
                            });
                        }
                        // Apply checkboxes
                        mapFilterPanelBody.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                            const targetId = cb.dataset.targetId;
                            if (!targetId) return;
                            const orig = document.getElementById(targetId);
                            if (orig && orig.type === 'checkbox') {
                                orig.checked = cb.checked;
                                // Fire change so pills/logic update for checkboxes not tied to form
                                orig.dispatchEvent(new Event('change', { bubbles: true }));
                            }
                        });
                        // For radios, dispatch one change event to update pills
                        document.querySelectorAll('input[type="radio"][name="price-type"]').forEach(r => {
                            r.dispatchEvent(new Event('change', { bubbles: true }));
                        });
                        // Apply any staged range inputs (e.g., Events start-time)
                        mapFilterPanelBody.querySelectorAll('input[type="range"]').forEach(r => {
                            const targetId = r.dataset.targetId;
                            if (!targetId) return;
                            const orig = document.getElementById(targetId);
                            if (orig && orig.type === 'range') {
                                orig.value = r.value;
                                orig.dispatchEvent(new Event('change', { bubbles: true }));
                            }
                        });
                         applyFiltersAndRerender();
                         hideMapGroupPanel();
                     });
                 }
                // Hide when pressing Escape
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') hideMapGroupPanel();
                });
            }

            // Close bottom drawer when tapping backdrop
            if (mapFilterBackdrop) {
                mapFilterBackdrop.addEventListener('click', hideMapGroupPanel);
            }

            // Hide on Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') hideMapGroupPanel();
            });
        });

        // --- DATA LOADING ---
        async function loadLeaguesData() {
            const url = './leagues.json';
            try {
                const res = await fetch(url, { cache: 'no-store' });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const list = Array.isArray(data)
                    ? data
                    : (Array.isArray(data.records) ? data.records : (Array.isArray(data.items) ? data.items : []));
                activities = list.map(transformLeagueToActivity).filter(Boolean);
                // Load Daily Sports and merge
                await loadDailySportsData();
                renderFormatFilters();
                // Shift dataset dates so the earliest becomes ~4 days from today; preserve relative spacing (applies to leagues only)
                shiftActivitiesDates(activities, 4);
                // After loading, rerender and refresh maps
                updateResultsHeading();
                renderActivities();
                if (typeof renderNeighborhoodFilters === 'function') renderNeighborhoodFilters();
                refreshMapMarkers();
                if (typeof previewMap !== 'undefined') initPreviewMap();
                updateFilterOptionStates();
                updatePriceSliderVisibilityAndBounds();
            } catch (err) {
                console.error('Failed to load leagues.json:', err);
                const container = document.getElementById('activity-cards-container');
                if (container && container.children.length === 0) {
                    const div = document.createElement('div');
                    div.className = 'p-4 rounded-md bg-yellow-50 text-yellow-800 border border-yellow-200';
                    div.textContent = 'Unable to load leagues.json. If you are opening this file directly in a browser, please use a local server to enable fetch of local files.';
                    container.appendChild(div);
                }
            }
        }

        async function loadDailySportsData() {
            try {
                const res = await fetch('./daily-sports.json', { cache: 'no-store' });
                if (!res.ok) return; // optional dataset
                const data = await res.json();
                const list = Array.isArray(data)
                    ? data
                    : (Array.isArray(data.records) ? data.records : (Array.isArray(data.items) ? data.items : []));
                const daily = list.map(transformDailyToActivity).filter(Boolean);
                activities = activities.concat(daily);
            } catch (e) {
                console.warn('Daily Sports dataset not loaded:', e);
            }
        }

        // Unified loader: always attempt to load both datasets on page load
        // Keep source-specific slices available for robust fallbacks and UI logic
    const DATASETS = { leagues: [], daily: [], tournaments: [], events: [], rentals: [] };

        // Robust JSON parser used for server-side loads as well
        function __robustParseJSON(text) {
            if (text == null) return null;
            let t = String(text).replace(/^\uFEFF/, '').replace(/\r\n?/g, '\n');
            try { return JSON.parse(t); } catch (e1) {
                try { return JSON.parse(t.replace(/,(\s*[\}\]])/g, '$1')); } catch (e2) {
                    const lines = t.split(/\n/).map(l => l.trim()).filter(l => l && !/^\s*(\/\/|#)/.test(l));
                    const nd = [];
                    for (const ln of lines) { try { nd.push(JSON.parse(ln)); } catch(_) {} }
                    if (nd.length > 0) return nd;
                    throw e2;
                }
            }
        }
        function __findFirstArrayDeep(obj, depth=0) {
            if (!obj || typeof obj !== 'object' || depth > 3) return null;
            if (Array.isArray(obj)) return obj;
            for (const k in obj) {
                const v = obj[k];
                if (Array.isArray(v)) return v;
                if (v && typeof v === 'object') {
                    const r = __findFirstArrayDeep(v, depth+1);
                    if (r) return r;
                }
            }
            return null;
        }
        function __extractList(data) {
            if (Array.isArray(data)) return data;
            if (data && typeof data === 'object') {
                const keys = ['records','items','leagues','league','events','event','tournaments','tournament','daily','daily_sports','daily-sports','rentals','rental','data','results'];
                for (const k of keys) { if (Array.isArray(data[k])) return data[k]; }
                const deep = __findFirstArrayDeep(data);
                if (Array.isArray(deep)) return deep;
            }
            return [];
        }

        async function loadAllData() {
            let leagues = [];
            let daily = [];
            let tournaments = [];
            let events = [];
            let rentals = [];
            // Fetch in parallel; tolerate one failing
            const [leaguesRes, dailyRes, tournamentsRes, eventsRes, rentalsRes] = await Promise.allSettled([
                fetch('./leagues.json', { cache: 'no-store' }),
                fetch('./daily-sports.json', { cache: 'no-store' }),
                fetch('./tournaments.json', { cache: 'no-store' }),
                fetch('./events.json', { cache: 'no-store' }),
                fetch('./rentals.json', { cache: 'no-store' })
            ]);
            try {
                if (leaguesRes.status === 'fulfilled' && leaguesRes.value.ok) {
                    const text = await leaguesRes.value.text();
                    const data = __robustParseJSON(text);
                    const list = __extractList(data);
                    leagues = list.map(transformLeagueToActivity).filter(Boolean);
                    DATASETS.leagues = leagues.slice();
                } else {
                    console.warn('leagues.json fetch failed or not ok:', leaguesRes.status === 'rejected' ? leaguesRes.reason : leaguesRes.value && leaguesRes.value.status);
                }
            } catch (e) {
                console.warn('leagues.json parse failed:', e);
            }
            try {
                if (dailyRes.status === 'fulfilled' && dailyRes.value.ok) {
                    const text = await dailyRes.value.text();
                    const data = __robustParseJSON(text);
                    const list = __extractList(data);
                    daily = list.map(transformDailyToActivity).filter(Boolean);
                    DATASETS.daily = daily.slice();
                } else {
                    console.warn('daily-sports.json fetch failed or not ok:', dailyRes.status === 'rejected' ? dailyRes.reason : dailyRes.value && dailyRes.value.status);
                }
            } catch (e) {
                console.warn('daily-sports.json parse failed:', e);
            }
            // Tournaments: try JSON first; fall back to parsing the raw HTML snapshot if available
            let needRawTournamentsFallback = false;
            try {
                if (tournamentsRes.status === 'fulfilled' && tournamentsRes.value.ok) {
                    const text = await tournamentsRes.value.text();
                    const data = __robustParseJSON(text);
                    const list = __extractList(data);
                    // If list empty, consider fallback
                    if (Array.isArray(list) && list.length) {
                        tournaments = list.map(transformTournamentToActivity).filter(Boolean);
                        DATASETS.tournaments = tournaments.slice();
                    } else {
                        needRawTournamentsFallback = true;
                    }
                } else {
                    console.warn('tournaments.json fetch failed or not ok:', tournamentsRes.status === 'rejected' ? tournamentsRes.reason : tournamentsRes.value && tournamentsRes.value.status);
                    needRawTournamentsFallback = true;
                }
            } catch (e) {
                console.warn('tournaments.json parse failed:', e);
                needRawTournamentsFallback = true;
            }
            if (needRawTournamentsFallback) {
                try {
                    const rawRes = await fetch('./raw-tournaments-data.html', { cache: 'no-store' });
                    if (rawRes.ok) {
                        const html = await rawRes.text();
                        const rawList = parseRawTournaments(html);
                        tournaments = rawList.map(transformTournamentToActivity).filter(Boolean);
                        DATASETS.tournaments = tournaments.slice();
                    }
                } catch (e) {
                    console.warn('raw-tournaments-data.html parse failed:', e);
                }
            }
            // Events: try JSON first; fall back to parsing the raw HTML snapshot if available
            let needRawEventsFallback = false;
            try {
                if (eventsRes.status === 'fulfilled' && eventsRes.value.ok) {
                    const text = await eventsRes.value.text();
                    const data = __robustParseJSON(text);
                    const list = __extractList(data);
                    if (Array.isArray(list) && list.length) {
                        events = list.map(transformEventToActivity).filter(Boolean);
                        DATASETS.events = events.slice();
                    } else {
                        needRawEventsFallback = true;
                    }
                } else {
                    console.warn('events.json fetch failed or not ok:', eventsRes.status === 'rejected' ? eventsRes.reason : eventsRes.value && eventsRes.value.status);
                    needRawEventsFallback = true;
                }
            } catch (e) {
                console.warn('events.json parse failed:', e);
                needRawEventsFallback = true;
            }
            if (needRawEventsFallback) {
                try {
                    const rawRes = await fetch('./events-raw-data.html', { cache: 'no-store' });
                    if (rawRes.ok) {
                        const html = await rawRes.text();
                        const rawList = parseRawEvents(html);
                        events = rawList.map(transformEventToActivity).filter(Boolean);
                        DATASETS.events = events.slice();
                    }
                } catch (e) {
                    console.warn('events-raw-data.html parse failed:', e);
                }
            }
            // Rentals (JSON only; optional dataset)
            try {
                if (rentalsRes.status === 'fulfilled' && rentalsRes.value.ok) {
                    const text = await rentalsRes.value.text();
                    const data = __robustParseJSON(text);
                    const list = __extractList(data);
                    if (Array.isArray(list) && list.length) {
                        rentals = list.map(transformRentalToActivity).filter(Boolean);
                        DATASETS.rentals = rentals.slice();
                    }
                } else {
                    console.warn('rentals.json fetch failed or not ok:', rentalsRes.status === 'rejected' ? rentalsRes.reason : rentalsRes.value && rentalsRes.value.status);
                }
            } catch (e) {
                console.warn('rentals.json parse failed:', e);
            }
            activities = [].concat(leagues, daily, tournaments, events, rentals);
            // Shift only league dates forward (leagues are first segment)
            if (leagues.length > 0) {
                shiftActivitiesDates(leagues, 4);
                // Rebuild activities with shifted leagues
                activities = [].concat(leagues, daily, tournaments, events, rentals);
                // Keep datasets.leagues in sync after date shift
                DATASETS.leagues = leagues.slice();
            }
            renderFormatFilters();
            // Default Activities scope to first non-empty dataset if empty
            const actEl = document.getElementById('activities');
            if (actEl && !actEl.value) {
                const scope = leagues.length ? 'Leagues' : (tournaments.length ? 'Tournaments' : (daily.length ? 'Daily Sports' : (events.length ? 'Events' : (rentals.length ? 'Private Rentals' : ''))));
                if (scope) actEl.value = scope;
            }
            console.log('Datasets loaded (server):', { leagues: leagues.length, tournaments: tournaments.length, daily: daily.length, events: events.length, rentals: rentals.length });
            // Use unified apply to ensure scope guards and UI visibility are honored
            if (typeof applyActivityTypeFilterVisibility === 'function') applyActivityTypeFilterVisibility();
            if (typeof applyFiltersAndRerender === 'function') {
                if (typeof renderNeighborhoodFilters === 'function') renderNeighborhoodFilters();
                applyFiltersAndRerender();
            } else {
                updateResultsHeading();
                renderActivities();
                if (typeof renderNeighborhoodFilters === 'function') renderNeighborhoodFilters();
                refreshMapMarkers();
                if (typeof previewMap !== 'undefined') initPreviewMap();
                updateFilterOptionStates();
                updatePriceSliderVisibilityAndBounds();
            }
        }

        // --- SPORTS NORMALIZATION & DERIVATION ---
        const CANONICAL_SPORTS = [
            'Bowling','Axe Throwing','Cornhole','Kickball','Dodgeball','Bar Games','Skeeball',
            'Ultimate Frisbee','Soccer','Softball','Basketball','Flag Football','Volleyball','Pickleball'
        ];
        const SPORT_ALIASES = {
            'flag football': ['flag football','football (flag)','flag-football','flag'],
            'ultimate frisbee': ['ultimate frisbee','ultimate','frisbee'],
            'bar games': ['bar games','bar-games'],
            'skeeball': ['skeeball','skee-ball','skee ball'],
            'axe throwing': ['axe throwing','axe-throwing','axes'],
            // common forms map to themselves implicitly; list above captures typical variants
        };
        function normalizeSportLabel(name) {
            if (!name) return '';
            const s = String(name).trim();
            const low = s.toLowerCase();
            // Exact canonical match
            for (const canon of CANONICAL_SPORTS) {
                if (low === canon.toLowerCase()) return canon;
            }
            // Aliases
            for (const canon in SPORT_ALIASES) {
                const variants = SPORT_ALIASES[canon];
                if (variants.some(v => v === low)) {
                    // return canonical with proper casing if exists in list
                    const canonProper = CANONICAL_SPORTS.find(c => c.toLowerCase() === canon);
                    return canonProper || canon;
                }
            }
            // Heuristics: contains checks
            for (const canon of CANONICAL_SPORTS) {
                if (low.includes(canon.toLowerCase())) return canon;
            }
            // Nothing matched; return original
            return s;
        }
        function deriveSportFromText(text) {
            const t = String(text || '').toLowerCase();
            for (const canon of CANONICAL_SPORTS) {
                const lc = canon.toLowerCase();
                if (t.includes(lc)) return canon;
            }
            // A few additional heuristics
            if (/\bultimate\b/.test(t)) return 'Ultimate Frisbee';
            if (/\bfrisbee\b/.test(t)) return 'Ultimate Frisbee';
            if (/\bflag\b/.test(t) && /\bfootball\b/.test(t)) return 'Flag Football';
            if (/\bsoccer\b/.test(t)) return 'Soccer';
            return '';
        }

        function parseLatLngFromMapUrl(url) {
            if (!url || typeof url !== 'string') return { lat: null, lng: null };
            // Try /place/lat,lng
            let m = url.match(/\/place\/(-?\d+\.?\d*),(-?\d+\.?\d*)/);
            if (m) {
                const lat = parseFloat(m[1]);
                const lng = parseFloat(m[2]);
                if (!Number.isNaN(lat) && !Number.isNaN(lng)) return { lat, lng };
            }
            // Try @lat,lng,zoom
            m = url.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*)/);
            if (m) {
                const lat = parseFloat(m[1]);
                const lng = parseFloat(m[2]);
                if (!Number.isNaN(lat) && !Number.isNaN(lng)) return { lat, lng };
            }
            // Try q=lat,lng
            m = url.match(/[?&]q=([^&]+)/);
            if (m) {
                const q = decodeURIComponent(m[1]);
                const mm = q.match(/(-?\d+\.?\d*),(-?\d+\.?\d*)/);
                if (mm) {
                    const lat = parseFloat(mm[1]);
                    const lng = parseFloat(mm[2]);
                    if (!Number.isNaN(lat) && !Number.isNaN(lng)) return { lat, lng };
                }
            }
            return { lat: null, lng: null };
        }

        function fixImageUrl(url) {
            if (!url || typeof url !== 'string') return url;
            const u = url.trim();
            // If this is a local/relative asset (e.g., missingimage.avif), do not rewrite
            // We only normalize extensions for remote URLs.
            const isRemote = /^(https?:)?\/\//i.test(u);
            if (!isRemote) return u;
            let out = u;
            // Collapse duplicate .avif extensions like .avif.avif -> .avif
            out = out.replace(/\.avif(\.avif)+/gi, '.avif');
            // Prefer plain .webp over .avif.webp for broader compatibility
            if (out.includes('.avif.webp')) out = out.replace('.avif.webp', '.webp');
            // If plain avif remains, switch to png for remote resources (broader support)
            if (/\.avif(\?|#|$)/i.test(out)) out = out.replace(/\.avif(\?|#|$)/i, '.png$1');
            return out;
        }

        function isInvalidImageUrl(u) {
            const s = String(u == null ? '' : u).trim().toLowerCase();
            return !s || s === '#' || s === 'null' || s === 'undefined';
        }

        function getSportPlaceholder(sportLike) {
            const labelRaw = String(sportLike || 'Sport').trim();
            const label = labelRaw ? labelRaw.charAt(0).toUpperCase() + labelRaw.slice(1) : 'Sport';
            // Brand-aligned placeholder with sport label
            return `https://placehold.co/800x450/0034DD/ffffff?text=${encodeURIComponent(label)}`;
        }
        // --- DATASET DATE SHIFTING ---
        // Parse a MM/DD from a string (supports "M/D" and month names like "Sep 5" or "September 5")
        function parseMMDDFromText(text) {
            const s = String(text || '').trim();
            if (!s) return null;
            // 1) Try M/D
            let m = s.match(/\b(\d{1,2})\/(\d{1,2})\b/);
            if (m) {
                const mm = Math.min(12, Math.max(1, parseInt(m[1], 10)));
                const dd = Math.min(31, Math.max(1, parseInt(m[2], 10)));
                return { mm, dd };
            }
            // 2) Try month name + day
            const months = {
                jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,sept:9,oct:10,nov:11,dec:12
            };
            m = s.match(/\b(jan|feb|mar|apr|may|jun|jul|aug|sep|sept|oct|nov|dec)[a-z]*\s+(\d{1,2})\b/i);
            if (m) {
                const mm = months[m[1].toLowerCase()] || null;
                const dd = Math.min(31, Math.max(1, parseInt(m[2], 10)));
                if (mm) return { mm, dd };
            }
            return null;
        }
        // Format a Date to M/D
        function formatMMDD(dateObj) {
            const mm = dateObj.getMonth() + 1;
            const dd = dateObj.getDate();
            return `${mm}/${dd}`;
        }
        function replaceDateInText(text, mm, dd) {
            const s = String(text || '');
            const mmdd = `${mm}/${dd}`;
            // Replace first MM/DD if present
            if (/\b\d{1,2}\/\d{1,2}\b/.test(s)) {
                return s.replace(/\b\d{1,2}\/\d{1,2}\b/, mmdd);
            }
            // Replace first MonthName DD if present
            const monthNameRegex = /\b(jan|feb|mar|apr|may|jun|jul|aug|sep|sept|oct|nov|dec)[a-z]*\s+(\d{1,2})\b/i;
            if (monthNameRegex.test(s)) {
                return s.replace(monthNameRegex, mmdd);
            }
            // Fallback to mm/dd alone
            return mmdd;
        }
        // Compute a delta so the earliest parsed date becomes today + targetDays
        // Returns { delta, baseYear } where baseYear is the year of the target base date (handles year crossings)
        function computeDatasetShiftDeltaDays(list, targetDaysAhead = 4) {
            const ordinals = [];
            list.forEach(a => {
                const startPick = parseMMDDFromText(a.start_date_text);
                let mmdd = startPick;
                if (!mmdd) {
                    mmdd = parseMMDDFromText(a.registration_ends_mmdd);
                }
                if (!mmdd && a.registration_phase_text) {
                    mmdd = parseMMDDFromText(a.registration_phase_text);
                }
                if (mmdd) {
                    const d = new Date(Date.UTC(2000, mmdd.mm - 1, mmdd.dd));
                    const ordinal = Math.floor(d.getTime() / (24*60*60*1000));
                    ordinals.push(ordinal);
                }
            });
            if (ordinals.length === 0) return { delta: 0, baseYear: (new Date()).getFullYear() };
            const minOrdinal = Math.min(...ordinals);
            // Base target is today + targetDaysAhead
            const today = new Date();
            const base = new Date(today.getFullYear(), today.getMonth(), today.getDate() + targetDaysAhead);
            const baseOrdinal = Math.floor(Date.UTC(2000, base.getMonth(), base.getDate()) / (24*60*60*1000));
            return { delta: (baseOrdinal - minOrdinal), baseYear: base.getFullYear() };
        }
        function shiftMMDD({ mm, dd }, deltaDays, year) {
            const y = year || (new Date()).getFullYear();
            const d = new Date(y, mm - 1, dd);
            d.setDate(d.getDate() + deltaDays);
            return { mm: d.getMonth() + 1, dd: d.getDate(), y: d.getFullYear() };
        }
        function shiftActivitiesDates(list, targetDaysAhead = 4) {
            if (!Array.isArray(list) || list.length === 0) return list;
            const { delta, baseYear } = computeDatasetShiftDeltaDays(list, targetDaysAhead);
            if (delta === 0) return list;
            const y = baseYear;
            list.forEach(a => {
                // Shift start_date_text if present
                const startParsed = parseMMDDFromText(a.start_date_text);
                if (startParsed) {
                    const shifted = shiftMMDD(startParsed, delta, y);
                    a.start_date_text = replaceDateInText(a.start_date_text, shifted.mm, shifted.dd);
                }
                // Shift registration_ends_mmdd or derive from phase text
                let regParsed = parseMMDDFromText(a.registration_ends_mmdd);
                if (!regParsed && a.registration_phase_text) {
                    regParsed = parseMMDDFromText(a.registration_phase_text);
                }
                if (regParsed) {
                    const shiftedReg = shiftMMDD(regParsed, delta, y);
                    a.registration_ends_mmdd = `${shiftedReg.mm}/${shiftedReg.dd}`;
                }
            });
            return list;
        }


        function handleImgError(e) {
            const img = e && e.target ? e.target : e;
            if (!img || !img.src) return;
            const tries = parseInt(img.dataset.fallbackAttempt || '0', 10);
            const src = img.src;
            // Fallback chain to try compatible formats, then a pure black image (no text)
            if (tries === 0) {
                // Normalize double .avif and .avif.webp cases
                if (/\.avif(\.avif)+/i.test(src)) {
                    img.dataset.fallbackAttempt = '1';
                    img.src = src.replace(/\.avif(\.avif)+/i, '.avif');
                    return;
                }
                if (src.includes('.avif.webp')) {
                    img.dataset.fallbackAttempt = '1';
                    img.src = src.replace('.avif.webp', '.webp');
                    return;
                }
                if (/\.avif(\?|#|$)/i.test(src)) {
                    // Try WEBP first
                    img.dataset.fallbackAttempt = '1';
                    img.src = src.replace(/\.avif(\?|#|$)/i, '.webp$1');
                    return;
                }
                if (/\.webp(\?|#|$)/i.test(src)) {
                    img.dataset.fallbackAttempt = '1';
                    img.src = src.replace(/\.webp(\?|#|$)/i, '.png$1');
                    return;
                }
                if (/\.png(\?|#|$)/i.test(src)) {
                    img.dataset.fallbackAttempt = '1';
                    img.src = src.replace(/\.png(\?|#|$)/i, '.jpg$1');
                    return;
                }
            } else if (tries === 1) {
                if (/\.avif(\?|#|$)/i.test(src)) {
                    img.dataset.fallbackAttempt = '2';
                    img.src = src.replace(/\.avif(\?|#|$)/i, '.png$1');
                    return;
                }
                if (/\.webp(\?|#|$)/i.test(src)) {
                    img.dataset.fallbackAttempt = '2';
                    img.src = src.replace(/\.webp(\?|#|$)/i, '.jpg$1');
                    return;
                }
                if (/\.png(\?|#|$)/i.test(src)) {
                    img.dataset.fallbackAttempt = '2';
                    img.src = src.replace(/\.png(\?|#|$)/i, '.jpg$1');
                    return;
                }
                if (/\.jpg(\?|#|$)/i.test(src)) {
                    img.dataset.fallbackAttempt = '2';
                    img.src = src.replace(/\.jpg(\?|#|$)/i, '.jpeg$1');
                    return;
                }
            }
            // Final fallback: a pure black 1x1 PNG (no text overlay).
            img.dataset.fallbackAttempt = String(tries + 1);
            img.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==';
        }

        function transformLeagueToActivity(l) {
            if (!l) return null;
            const programName = l.program_name || l.programName || l.title || l.name || '';
            const venueName = l.venue_name || l.venueName || '';
            // Force league type; avoid trusting upstream misc types
            const typeRaw = 'League';
            const startText = l.start_date_text || l.startDateText || l.start_date || '';
            const timeStart = l.time_start || l.timeStart || l.start_time || '';
            const timeEnd = l.time_end || l.timeEnd || l.end_time || '';
            const weeks = l.weeks != null ? l.weeks : (l.duration_weeks || '');
            const format = l.format || l.team_format || l.teamFormat || '';
            let skills = l.skill_levels || l.skills || (l.skill_level ? [l.skill_level] : []);
            let features = l.features || l.highlights || [];
            if (Array.isArray(features)) {
                features = features.filter(f => String(f).toLowerCase().trim() !== 'view all perks');
            }
            // Enrich features from program_name/title content (e.g., Glow, Flip Cup, Style of Play cues)
            const titleStr = String(l.program_name || l.title || '').toLowerCase();
            if (titleStr.includes('glow')) features = [...features, 'GLOW'];
            if (titleStr.includes('flip cup')) features = [...features, 'Flip Cup Counts'];
            if (titleStr.includes('open play') || titleStr.includes('drop-in') || titleStr.includes('pickup') || titleStr.includes('pick up')) features = [...features, 'Open Play'];
            if (titleStr.includes('doubleheader') || titleStr.includes('double header')) features = [...features, 'Doubleheader'];
            if (titleStr.includes('ladder')) features = [...features, 'Ladder League'];
            if (titleStr.includes('party league')) features = [...features, 'Party League'];
            if (titleStr.includes('party pickleball')) features = [...features, 'Party Pickleball'];
            if (titleStr.includes('traditional')) features = [...features, 'Traditional'];
            if (titleStr.includes('2 games per night') || /\b(two\s+games\s+per\s+night)\b/.test(titleStr)) features = [...features, '2 Games Per Night'];
            const banner = l.banner_message || l.bannerMessage || '';
            const regPhase = l.registration_phase_text || l.registrationPhaseText || '';
            const memberPrice = l.member_price_current ?? l.memberPrice ?? l.member_price ?? null;
            const nonMember = l.price_person_current ?? l.price ?? l.nonMemberPrice ?? null;
            const teamPrice = l.price_team ?? l.teamPrice ?? null;
            // Extract sport and normalize to canonical label (do early so we can build placeholders)
            const sportRaw = l.sport || l.sport_name || l.sportName || l.program_sport || l.programSport || '';
            let sport = normalizeSportLabel(sportRaw || deriveSportFromText(programName));
            const imageUrlRaw = l.image_url || l.imageUrl || l.image || 'https://placehold.co/400x400/1d4ed8/ffffff?text=Sport+Image';
            let imageUrl = isInvalidImageUrl(imageUrlRaw) ? getSportPlaceholder(sport) : fixImageUrl(imageUrlRaw);
            // Hardcode image for known missing asset case
            if (String(programName).trim().toLowerCase() === 'thursday - glow kickball + flip cup - columbia') {
                imageUrl = getSportPlaceholder(sport);
            }
            const imageAlt = l.image_alt || l.imageAlt || programName || 'Sport Image';
            const venueMapUrl = l.venue_map_url || (venueName ? `https://www.google.com/maps?q=${encodeURIComponent(venueName)}` : '#');
            let lat = (typeof l.lat === 'number') ? l.lat : (l.latitude ?? null);
            let lng = (typeof l.lng === 'number') ? l.lng : (l.longitude ?? null);
            if (lat == null || lng == null) {
                const found = parseLatLngFromMapUrl(venueMapUrl);
                lat = lat ?? found.lat;
                lng = lng ?? found.lng;
            }
            // Normalize skills to canonical filter values and dedupe
            const normSkills = (Array.isArray(skills) ? skills : [skills]).map(normalizeSkillLabel).filter(Boolean);
            const uniqueSkills = Array.from(new Set(normSkills));
            // Normalize explicit day field (if provided) to day_label/day_abbrev
            const dayRaw = l.day || l.day_label || l.dayLabel || '';
            const normDay = (() => {
                if (!dayRaw) return null;
                const s = String(dayRaw).trim().toLowerCase();
                const map = [
                    { test: /^(monday|mon|^m$)/, label:'Monday', abbrev:'Mon' },
                    { test: /^(tuesday|tue|tues|^tu$|^t$)/, label:'Tuesday', abbrev:'Tue' },
                    { test: /^(wednesday|wed|^w$)/, label:'Wednesday', abbrev:'Wed' },
                    { test: /^(thursday|thu|thur|thurs|^th$)/, label:'Thursday', abbrev:'Thu' },
                    { test: /^(friday|fri|^f$)/, label:'Friday', abbrev:'Fri' },
                    { test: /^(saturday|sat|^sa$)/, label:'Saturday', abbrev:'Sat' },
                    { test: /^(sunday|sun|^su$)/, label:'Sunday', abbrev:'Sun' }
                ];
                for (const m of map) { if (m.test.test(s)) return { label: m.label, abbrev: m.abbrev }; }
                return null;
            })();
            return {
                id: String(l.id || l.slug || `${programName}-${venueName}`).replace(/\s+/g,'-').toLowerCase(),
                source: 'leagues',
                program_name: programName,
                activity_type: typeRaw,
                sport,
                venue_name: venueName,
                venue_map_url: venueMapUrl,
                timing_raw: l.timing_raw || '',
                start_date_text: startText,
                weeks: weeks || '',
                time_start: timeStart,
                time_end: timeEnd,
                format,
                skill_levels: uniqueSkills,
                features: Array.isArray(features) ? features : [],
                banner_message: banner,
                registration_phase_text: regPhase,
                registration_ends_mmdd: l.registration_ends_mmdd || '',
                price_person_current: nonMember,
                price_person_base: l.price_person_base ?? null,
                price_person_units: l.price_person_units || 'per_person',
                price_team: teamPrice,
                price_team_units: l.price_team_units || 'per_team',
                member_price_original: l.member_price_original ?? null,
                member_price_current: memberPrice,
                image_url: imageUrl,
                // Legacy alias to keep older templates safe
                img: imageUrl,
                image_alt: imageAlt,
                perks_more_url: l.perks_more_url || '#',
                lat: (typeof lat === 'number' ? lat : null),
                lng: (typeof lng === 'number' ? lng : null),
                // Optional minimum age display (e.g., 50 for 50+). Normalize null-like strings to null.
                age: (() => {
                    const raw = l.age;
                    if (raw == null) return null;
                    const s = (typeof raw === 'string') ? raw.trim().toLowerCase() : raw;
                    if (s === '' || s === 'null' || s === 'undefined' || s === 'n/a' || s === 'na') return null;
                    return raw;
                })(),
                // Inject normalized day fields if present
                ...(normDay ? { day_label: normDay.label, day_abbrev: normDay.abbrev } : {})
            };
        }

        function transformTournamentToActivity(t) {
            if (!t) return null;
            // Accept objects from tournaments.json (league-like fields) and raw parsed entries
            const programName = t.program_name || t.title || t.name || '';
            const venueName = t.venue_name || t.venue || '';
            const startText = t.start_date_text || t.date || '';
            let timeStart = t.time_start || '';
            let timeEnd = t.time_end || '';
            if ((!timeStart || !timeEnd) && t.time) {
                const m = String(t.time).match(/\b(\d{1,2}(?::\d{2})?\s*[AP]M)\s*[-–—]\s*(\d{1,2}(?::\d{2})?\s*[AP]M)\b/i);
                if (m) { timeStart = timeStart || m[1]; timeEnd = timeEnd || m[2]; }
            }
            const format = t.format || '';
            let skills = t.skill_levels || (t.skill_level ? [t.skill_level] : []);
            let features = t.features || [];
            if (Array.isArray(features)) {
                features = features.filter(f => String(f).toLowerCase().trim() !== 'view all perks');
            }
            const sportRaw = t.sport || t.sport_name || t.program_sport || '';
            const sport = normalizeSportLabel(sportRaw || deriveSportFromText(programName));
            const imageUrlRaw = t.image_url || t.image || '';
            const imageUrl = isInvalidImageUrl(imageUrlRaw) ? getSportPlaceholder(sport) : fixImageUrl(imageUrlRaw);
            const imageAlt = t.image_alt || programName || 'Sport Image';
            const venueMapUrl = t.venue_map_url || t.map_url || (venueName ? `https://www.google.com/maps?q=${encodeURIComponent(venueName)}` : '#');
            let lat = (typeof t.lat === 'number') ? t.lat : (t.latitude ?? null);
            let lng = (typeof t.lng === 'number') ? t.lng : (t.longitude ?? null);
            if (lat == null || lng == null) {
                const found = parseLatLngFromMapUrl(venueMapUrl);
                lat = lat ?? found.lat;
                lng = lng ?? found.lng;
            }
            const normSkills = (Array.isArray(skills) ? skills : [skills]).map(normalizeSkillLabel).filter(Boolean);
            const uniqueSkills = Array.from(new Set(normSkills));
            const toNum = (v) => {
                if (v == null || v === '') return null;
                if (typeof v === 'number') return Number.isFinite(v) ? v : null;
                const n = Number(String(v).replace(/[^0-9.]/g, ''));
                return Number.isFinite(n) ? n : null;
            };
            // Normalize explicit day field (if provided) to day_label/day_abbrev
            const dayRaw = t.day || t.day_label || t.dayLabel || '';
            const normDay = (() => {
                if (!dayRaw) return null;
                const s = String(dayRaw).trim().toLowerCase();
                const map = [
                    { test: /^(monday|mon|^m$)/, label:'Monday', abbrev:'Mon' },
                    { test: /^(tuesday|tue|tues|^tu$|^t$)/, label:'Tuesday', abbrev:'Tue' },
                    { test: /^(wednesday|wed|^w$)/, label:'Wednesday', abbrev:'Wed' },
                    { test: /^(thursday|thu|thur|thurs|^th$)/, label:'Thursday', abbrev:'Thu' },
                    { test: /^(friday|fri|^f$)/, label:'Friday', abbrev:'Fri' },
                    { test: /^(saturday|sat|^sa$)/, label:'Saturday', abbrev:'Sat' },
                    { test: /^(sunday|sun|^su$)/, label:'Sunday', abbrev:'Sun' }
                ];
                for (const m of map) { if (m.test.test(s)) return { label: m.label, abbrev: m.abbrev }; }
                return null;
            })();
            // Normalize registration deadline fields: accept several aliases and map to registration_ends_mmdd
            const regEnds = (t.registration_ends_mmdd || t.registration_ends || t.registrationEnds || t.registration_deadline || '').toString().trim();
            return {
                id: String(t.id || t.slug || `${programName}-${venueName}`).replace(/\s+/g,'-').toLowerCase(),
                source: 'tournaments',
                activity_type: 'Tournament',
                name: t.name || programName,
                program_name: programName,
                sport,
                venue_name: venueName,
                venue_map_url: venueMapUrl,
                timing_raw: t.timing_raw || '',
                start_date_text: startText,
                weeks: t.weeks || '',
                time_start: timeStart,
                time_end: timeEnd,
                format,
                skill_levels: uniqueSkills,
                features: Array.isArray(features) ? features : [],
                banner_message: t.banner_message || '',
                registration_phase_text: t.registration_phase_text || t.registrationPhaseText || '',
                registration_ends_mmdd: regEnds,
                price_person_current: (t.price_person_current ?? toNum(t.price_person)) ?? null,
                price_person_base: (t.price_person_base ?? toNum(t.price_person_base)) ?? null,
                price_person_units: t.price_person_units || 'per_person',
                price_team: (t.price_team ?? toNum(t.price_team)) ?? null,
                price_team_units: t.price_team_units || 'per_team',
                member_price_original: t.member_price_original ?? null,
                member_price_current: (t.member_price_current ?? toNum(t.member_price)) ?? null,
                image_url: imageUrl,
                img: imageUrl,
                image_alt: imageAlt,
                perks_more_url: t.perks_more_url || '#',
                lat: (typeof lat === 'number' ? lat : null),
                lng: (typeof lng === 'number' ? lng : null),
                ...(normDay ? { day_label: normDay.label, day_abbrev: normDay.abbrev } : {})
            };
        }

        function transformEventToActivity(e) {
            if (!e) return null;
            const programName = e.program_name || e.title || e.name || '';
            let venueName = e.venue_name || '';
            const startText = e.start_date_text || '';
            let timeStart = e.time_start || '';
            let timeEnd = e.time_end || '';
            const imageUrlRaw = e.image_url || e.image || '';
            const sport = normalizeSportLabel(e.sport || deriveSportFromText(programName));
            const imageUrl = isInvalidImageUrl(imageUrlRaw) ? getSportPlaceholder(sport) : fixImageUrl(imageUrlRaw);
            // Try to resolve canonical venue
            const isGenericArea = /^(canton|fells\s*point|federal\s*hill|brewers\s*hill)$/i.test(String(venueName || '').trim());
            // Prefer using programName for matching when venue is a generic neighborhood (helps bars like Greene Turtle)
            let canonical = null;
            if (isGenericArea) {
                canonical = findCanonicalVenue(programName) || findCanonicalVenue(venueName);
            } else {
                canonical = findCanonicalVenue(venueName || programName);
            }
            let lat = null, lng = null, mapUrl = e.venue_map_url || '';
            if (canonical && canonical.position) {
                lat = canonical.position.lat; lng = canonical.position.lng;
                venueName = canonical.venueName || venueName;
                mapUrl = `https://www.google.com/maps?q=${lat},${lng}`;
            } else if (mapUrl) {
                const found = parseLatLngFromMapUrl(mapUrl);
                lat = found.lat; lng = found.lng;
            } else if (venueName) {
                mapUrl = `https://www.google.com/maps?q=${encodeURIComponent(venueName)}`;
            }
            // Normalize time casing
            timeStart = timeStart ? String(timeStart).replace(/\s*([AaPp][Mm])\b/, (_, ap) => ap.toUpperCase()) : '';
            timeEnd = timeEnd ? String(timeEnd).replace(/\s*([AaPp][Mm])\b/, (_, ap) => ap.toUpperCase()) : '';
            // Derive day_label/abbr and date_mmdd if provided by parser
            const dayLabel = e.day_label || '';
            const dayAbbrev = e.day_abbrev || '';
            const dateMMDD = e.date_mmdd || '';
            // Prices: events often free; carry through parsed values if any
            const memberPrice = e.member_price_current ?? null;
            const nonMember = e.price_person_current ?? null;
            const features = Array.isArray(e.features) ? e.features.slice() : [];
            // Derive "Big TV" feature for watch parties so we can render a dedicated pill
            const isBigTv = /\b(big\s*tv|bigtv)\b/i.test(programName) || /watch\s*part(y|ies)/i.test(programName);
            if (isBigTv && !features.some(f => String(f).toLowerCase() === 'big tv')) {
                features.push('Big TV');
            }
            return {
                id: String(e.id || e.slug || `${programName}-${venueName}-${startText}-${timeStart}`).replace(/\s+/g,'-').toLowerCase(),
                source: 'events',
                activity_type: 'Event',
                program_name: programName,
                sport,
                venue_name: venueName,
                venue_map_url: mapUrl,
                start_date_text: startText,
                time_start: timeStart,
                time_end: timeEnd,
                format: e.format || 'Open',
                skill_levels: [],
                features,
                member_price_current: memberPrice,
                price_person_current: nonMember,
                image_url: imageUrl,
                img: imageUrl,
                image_alt: e.image_alt || programName || 'Event Image',
                day_label: dayLabel,
                day_abbrev: dayAbbrev,
                date_mmdd: dateMMDD,
                neighborhood: canonical ? (canonical.neighborhood || '') : (e.neighborhood || ''),
                lat: (typeof lat === 'number' ? lat : null),
                lng: (typeof lng === 'number' ? lng : null),
                // Social proof counts (carry through so card can show "Join N attending or interested")
                attending_or_interested_count: (e.attending_or_interested_count ?? e.attending_interested_count ?? null),
                attendee_count: (e.attendee_count ?? e.attendees_count ?? null),
                rsvp_count: (e.rsvp_count ?? null),
                going_count: (e.going_count ?? null),
                interest_count: (e.interest_count ?? null),
                social_count: (e.social_count ?? null),
                attendees: Array.isArray(e.attendees) ? e.attendees.slice() : (Array.isArray(e.attendee_list) ? e.attendee_list.slice() : []),
            };
        }

        function transformRentalToActivity(r) {
            if (!r) return null;
            const programName = r.rental_name || r.title || r.name || '';
            let venueName = r.venue_name || '';
            const sport = normalizeSportLabel(r.sport || deriveSportFromText(programName));
            // Resolve coordinates from canonical venue when possible
            const canonical = findCanonicalVenue(venueName || programName);
            let lat = null, lng = null, mapUrl = r.venue_map_url || '';
            if (canonical && canonical.position) {
                lat = canonical.position.lat; lng = canonical.position.lng;
                venueName = canonical.venueName || venueName;
                mapUrl = `https://www.google.com/maps?q=${lat},${lng}`;
            } else if (mapUrl) {
                const found = parseLatLngFromMapUrl(mapUrl);
                lat = found.lat; lng = found.lng;
            } else if (venueName) {
                mapUrl = `https://www.google.com/maps?q=${encodeURIComponent(venueName)}`;
            }
            const imageUrlRaw = r.image_url || '';
            const imageUrl = isInvalidImageUrl(imageUrlRaw) ? getSportPlaceholder(sport) : fixImageUrl(imageUrlRaw);
            return {
                id: String(r.id || r.slug || `${programName}-${venueName}`).replace(/\s+/g,'-').toLowerCase(),
                source: 'rentals',
                activity_type: 'Private Rentals',
                program_name: programName,
                sport,
                venue_name: venueName,
                venue_map_url: mapUrl,
                // Rentals pricing (per hour)
                price_hr_min: r.price_hr_min ?? null,
                price_hr_max: r.price_hr_max ?? null,
                price_hr_units: r.price_hr_units || 'per_hour',
                units_label: r.units_label || '',
                units_count: r.units_count ?? null,
                max_guests_per_unit: r.max_guests_per_unit ?? null,
                // Media
                image_url: imageUrl,
                img: imageUrl,
                image_alt: r.image_alt || programName || 'Rental Image',
                // Location hints
                neighborhood: r.neighborhood || (canonical ? (canonical.neighborhood || '') : ''),
                lat: (typeof lat === 'number' ? lat : null),
                lng: (typeof lng === 'number' ? lng : null),
                // Keep optional fields present so UI doesn’t break where it expects strings
                start_date_text: '',
                time_start: '',
                time_end: '',
                format: 'Open',
                skill_levels: [],
                features: [],
            };
        }

        function parseRawTournaments(html) {
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const cards = Array.from(doc.querySelectorAll('[class^="main_discover-card__"], .main_discover-card'));
                const out = [];
                for (const card of cards) {
                    const nameEl = card.querySelector('[class*="main_name__"], .main_name');
                    const program_name = nameEl ? nameEl.textContent.trim() : '';
                    const mapLink = card.querySelector('a.googleMapLink');
                    const venue_name = mapLink ? (mapLink.textContent || '').trim() : '';
                    const venue_map_url = mapLink ? (mapLink.getAttribute('href') || '') : '';
                    const timingEl = card.querySelector('[class*="main_timing__"], .main_timing');
                    const timing_raw = timingEl ? (timingEl.textContent || '').trim() : '';
                    // Extract date and times from timing_raw like: "Oct 25  •  11:00 AM - 4:00 PM"
                    let start_date_text = '';
                    let time_start = '';
                    let time_end = '';
                    if (timing_raw) {
                        const cleaned = timing_raw.replace(/\s*•\s*/g, ' • ').replace(/\s{2,}/g, ' ').trim();
                        // MMMon DD at start
                        const m = cleaned.match(/\b([A-Za-z]{3,9})\s+(\d{1,2})\b/);
                        if (m) start_date_text = `${m[1]} ${m[2]}`;
                        const times = Array.from(cleaned.matchAll(/(\d{1,2}:\d{2}\s*[AP]M)/gi)).map(x => x[1].toUpperCase());
                        if (times.length >= 1) time_start = times[0];
                        if (times.length >= 2) time_end = times[1];
                    }
                    const formatEl = card.querySelector('[class*="main_format__"] p, .main_format p');
                    const format = formatEl ? (formatEl.textContent || '').trim() : '';
                    const skillsEl = card.querySelector('[class*="main_skill-levels__"] p, .main_skill-levels p');
                    let skill_levels = [];
                    if (skillsEl) {
                        const txt = (skillsEl.textContent || '').replace(/^[^:]*:\s*/i, '');
                        skill_levels = txt.split(/,\s*/).map(s => s.trim()).filter(Boolean);
                    }
                    const featuresWrap = card.querySelector('[class*="main_venue-features__"], .main_venue-features');
                    const features = [];
                    if (featuresWrap) {
                        featuresWrap.querySelectorAll('[data-tip]').forEach(el => {
                            const tip = el.getAttribute('data-tip');
                            if (tip) features.push(tip.trim());
                        });
                    }
                    const imgEl = card.querySelector('[class*="main_program-image__"] img, .main_program-image img');
                    const image_url = imgEl ? (imgEl.getAttribute('src') || '') : '';
                    const image_alt = imgEl ? (imgEl.getAttribute('alt') || '') : '';
                    out.push({
                        program_name,
                        venue_name,
                        venue_map_url,
                        timing_raw,
                        start_date_text,
                        time_start,
                        time_end,
                        format,
                        skill_levels,
                        features,
                        image_url,
                        image_alt,
                    });
                }
                return out;
            } catch (e) {
                console.warn('parseRawTournaments failed:', e);
                return [];
            }
        }

        function parseRawEvents(html) {
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const HEADER_RX = /^(Mon|Tue|Wed|Thu|Fri|Sat|Sun)\s+([A-Za-z]{3,9})\s+(\d{1,2})$/;
                const MONTHS = { jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,sept:9,oct:10,nov:11,dec:12 };
                const headers = Array.from(doc.querySelectorAll('div')).filter(el => {
                    const t = (el.textContent || '').trim();
                    return HEADER_RX.test(t);
                });
                function findPrevHeader(el) {
                    let best = null;
                    for (const h of headers) {
                        const pos = h.compareDocumentPosition(el);
                        // h precedes el if DOCUMENT_POSITION_FOLLOWING is set and not preceding
                        const precedes = (pos & Node.DOCUMENT_POSITION_FOLLOWING) !== 0 && (pos & Node.DOCUMENT_POSITION_PRECEDING) === 0;
                        if (precedes) {
                            if (!best) best = h; else {
                                const afterBest = (best.compareDocumentPosition(h) & Node.DOCUMENT_POSITION_FOLLOWING) !== 0;
                                if (afterBest) best = h;
                            }
                        }
                    }
                    if (!best) return null;
                    const m = (best.textContent || '').trim().match(HEADER_RX);
                    if (!m) return null;
                    const dow = m[1];
                    const mon = m[2].toLowerCase();
                    const dd = parseInt(m[3], 10);
                    const mm = MONTHS[mon] || null;
                    const abbrs = { Mon:'Mon', Tue:'Tue', Wed:'Wed', Thu:'Thu', Fri:'Fri', Sat:'Sat', Sun:'Sun' };
                    const names = { Mon:'Monday', Tue:'Tuesday', Wed:'Wednesday', Thu:'Thursday', Fri:'Friday', Sat:'Saturday', Sun:'Sunday' };
                    return {
                        day_abbrev: abbrs[dow] || dow,
                        day_label: names[dow] || dow,
                        start_date_text: mm ? (m[2].charAt(0).toUpperCase() + m[2].slice(1,3)) + ' ' + dd : (m[2] + ' ' + dd),
                        date_mmdd: (mm && dd) ? `${mm}/${dd}` : ''
                    };
                }
                const cards = Array.from(doc.querySelectorAll('[tabindex="0"]')).filter(el => /\bEvent\b/i.test(el.textContent || ''));
                const out = [];
                cards.forEach(card => {
                    const headerInfo = findPrevHeader(card) || {};
                    // Collect all text nodes within card
                    const texts = Array.from(card.querySelectorAll('div')).map(d => (d.textContent || '').trim()).filter(Boolean);
                    // Title heuristic
                    const title = texts.find(t => /( - )|Watch Party|Tailgate|Crawl|Night|Hurling|Ravens|NFL/i.test(t) && t.length > 10 && t.toLowerCase() !== 'event') || '';
                    // Venue heuristic: prefer Club Volo or known area names
                    const venueCand = texts.filter(t => /Club Volo|Tailgate|Fells Point|Canton|Federal Hill|Brewers Hill|Pigtown|Sound Garden/i.test(t));
                    const venue_name = venueCand.length ? venueCand[venueCand.length - 1] : '';
                    // Times: collect times in AM/PM
                    const times = [];
                    texts.forEach(t => {
                        const rx = /(\d{1,2})(?::(\d{2}))?\s*([AaPp][Mm])/g;
                        let m;
                        while ((m = rx.exec(t)) !== null) {
                            const hour = m[1];
                            const mins = m[2] || '00';
                            const ap = m[3].toUpperCase();
                            times.push(`${parseInt(hour,10)}:${mins}${ap}`);
                        }
                    });
                    let time_start = '';
                    let time_end = '';
                    if (times.length === 1) time_start = times[0];
                    else if (times.length > 1) { time_start = times[0]; time_end = times[times.length - 1]; }
                    // Image
                    const imgEl = card.querySelector('img');
                    const image_url = imgEl ? (imgEl.getAttribute('src') || '') : '';
                    const image_alt = imgEl ? (imgEl.getAttribute('alt') || '') : '';
                    // Price chips and flags
                    let price_person_current = null;
                    let member_price_current = null;
                    const hasMemberWord = texts.some(t => /\bMember\b/i.test(t));
                    const hasStandardWord = texts.some(t => /\bStandard\b/i.test(t));
                    // find monetary values
                    const dollars = [];
                    texts.forEach(t => {
                        const m = t.match(/\$(\d+(?:\.\d{1,2})?)/);
                        if (m) dollars.push(parseFloat(m[1]));
                    });
                    if (dollars.length) {
                        const amt = dollars[0];
                        if (hasMemberWord && (amt === 0 || amt === 0.0)) member_price_current = 0;
                        else if (hasStandardWord && (amt === 0 || amt === 0.0)) price_person_current = 0;
                        else price_person_current = amt;
                    }
                    const features = [];
                    if (texts.some(t => /Member Exclusive/i.test(t))) features.push('Member Exclusive');
                    if (texts.some(t => /Free For Volo Pass/i.test(t))) features.push('Free For Volo Pass');
                    // Build raw item
                    out.push({
                        program_name: title,
                        venue_name,
                        start_date_text: headerInfo.start_date_text || '',
                        time_start,
                        time_end,
                        image_url,
                        image_alt,
                        day_label: headerInfo.day_label || '',
                        day_abbrev: headerInfo.day_abbrev || '',
                        date_mmdd: headerInfo.date_mmdd || '',
                        price_person_current,
                        member_price_current,
                        features
                    });
                });
                return out;
            } catch (e) {
                console.warn('parseRawEvents failed:', e);
                return [];
            }
        }

        function transformDailyToActivity(r) {
            if (!r) return null;
            const id = r.id || `${r.program_name}-${r.venue_name}-${r.time_start}`;
            let programNameRaw = r.program_name || '';
            let venueNameRaw = r.venue_name || '';
            // Extract time and date hints from messy fields when missing
            let timeStart = r.time_start || '';
            if (!timeStart) {
                const ex1 = extractTimeAndStrip(programNameRaw); programNameRaw = ex1.text; if (ex1.time) timeStart = ex1.time;
                if (!timeStart) { const ex2 = extractTimeAndStrip(venueNameRaw); venueNameRaw = ex2.text; if (ex2.time) timeStart = ex2.time; }
            } else {
                // Normalize casing
                timeStart = String(timeStart).replace(/\s*([AaPp][Mm])\b/, (_, ap) => ap.toUpperCase());
            }
            let dateMMDD = null;
            {
                const exd1 = extractMMDDAndStrip(programNameRaw); programNameRaw = exd1.text; if (exd1.mmdd) dateMMDD = exd1.mmdd;
                const exd2 = extractMMDDAndStrip(venueNameRaw); venueNameRaw = exd2.text; if (!dateMMDD && exd2.mmdd) dateMMDD = exd2.mmdd;
            }
            // Clean program name focusing on Community/Open + Sport
            const sportGuess = r.sport || deriveSportFromText(programNameRaw) || deriveSportFromText(venueNameRaw);
            const hasCommunity = /\bcommunity\b/i.test(programNameRaw) || /\bcommunity\b/i.test(venueNameRaw);
            let programName = programNameRaw;
            // Remove common noise terms
            programName = programName.replace(/\b(pick\s*up|pickup|free|open\s*play|club\s*volo|volo|brewers|hill)\b/gi, ' ')
                                     .replace(/\s{2,}/g, ' ').trim();
            if (!programName || hasCommunity) {
                programName = `${hasCommunity ? 'Community ' : ''}${normalizeSportLabel(sportGuess || r.sport || '')}`.trim();
            }
            // Venue: prefer canonical from raw strings
            const venueCandidate = venueNameRaw || programNameRaw;
            const canonical = findCanonicalVenue(venueCandidate);
            let venueName = canonical ? canonical.venueName : (venueNameRaw || r.venue_name || '');
            // Derive map/coords
            let lat = null, lng = null, mapUrl = r.venue_map_url || '';
            if (canonical && canonical.position) {
                lat = canonical.position.lat; lng = canonical.position.lng;
                mapUrl = `https://www.google.com/maps?q=${lat},${lng}`;
            } else if (mapUrl) {
                const found = parseLatLngFromMapUrl(mapUrl);
                lat = found.lat; lng = found.lng;
            }
            // Day label from relative offset or explicit/extracted date; if missing, infer from day name in text or default to today
            let dayLabel = '', dayAbbrev = '';
            if (r.relative_day_offset != null) {
                const rel = resolveRelativeDay(r.relative_day_offset);
                dayLabel = rel.label; dayAbbrev = rel.abbrev;
            } else if (dateMMDD) {
                const rel2 = resolveDayFromMMDD(dateMMDD.mm, dateMMDD.dd);
                dayLabel = rel2.label; dayAbbrev = rel2.abbrev;
            } else {
                // Try to infer from any day-of-week text in the raw fields
                const dow = findDayOfWeekInText(`${programNameRaw} ${venueNameRaw}`);
                if (typeof dow === 'number') {
                    const nxt = computeNextDateForDOW(dow);
                    dateMMDD = { mm: nxt.mm, dd: nxt.dd };
                    dayLabel = nxt.label; dayAbbrev = nxt.abbrev;
                }
                // Final fallback: attach today's date if still missing
                if (!dateMMDD) {
                    const now = new Date();
                    dateMMDD = { mm: now.getMonth() + 1, dd: now.getDate() };
                    const names = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
                    const abbrs = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
                    dayLabel = names[now.getDay()];
                    dayAbbrev = abbrs[now.getDay()];
                }
            }
            // Format: default to Open if we see 'open play', otherwise preserve or set 'Open'
            const format = /open\s*play/i.test(`${r.format || ''} ${programNameRaw} ${venueNameRaw}`) ? 'Open' : (r.format || 'Open');
            const sport = normalizeSportLabel(r.sport || deriveSportFromText(programName));
            const imageUrlRaw = r.image_url || '';
            const imageUrl = isInvalidImageUrl(imageUrlRaw) ? getSportPlaceholder(sport) : fixImageUrl(imageUrlRaw);
            if (!mapUrl && venueName) mapUrl = `https://www.google.com/maps?q=${encodeURIComponent(venueName)}`;
            // Composition
            const skills = Array.isArray(r.skill_levels) ? r.skill_levels.map(normalizeSkillLabel) : [];
            const uniqSkills = Array.from(new Set(skills));
            // Feature cleanup
            const features = Array.isArray(r.features) ? r.features : [];
            return {
                id: String(id).toLowerCase().replace(/\s+/g,'-'),
                source: 'daily',
                program_name: programName,
                activity_type: r.activity_type || 'Drop-in',
                sport,
                venue_name: venueName,
                venue_map_url: mapUrl,
                time_start: timeStart || '',
                time_end: r.time_end || '',
                format,
                skill_levels: uniqSkills,
                features,
                // Daily specific resolved fields
                day_label: dayLabel,
                day_abbrev: dayAbbrev,
                date_mmdd: dateMMDD ? `${dateMMDD.mm}/${dateMMDD.dd}` : '',
                venue_id: canonical ? canonical.id : null,
                neighborhood: canonical ? (canonical.neighborhood || '') : (r.neighborhood || ''),
                // Prices may not apply to daily entries; leave null to be ignored by price filter when cap is set
                member_price_current: r.member_price_current ?? null,
                price_person_current: r.price_person_current ?? null,
                price_team: r.price_team ?? null,
                image_url: imageUrl,
                img: imageUrl,
                image_alt: r.image_alt || programName || 'Sport Image',
                lat: (typeof lat === 'number' ? lat : null),
                lng: (typeof lng === 'number' ? lng : null),
            };
        }
    </script>

    <!-- Volo Pass Modal -->
    <div id="volo-pass-backdrop" class="fixed inset-0 bg-black/50 z-50 hidden"></div>
    <div id="volo-pass-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="relative w-full max-w-xl bg-white rounded-2xl shadow-2xl overflow-hidden">
           
            <div class="bg-[#0034DD] text-white p-6">
                <h3 class="text-2xl font-extrabold tracking-tight uppercase">Play More, Pay Less</h3>
                <p class="mt-2 text-blue-50 text-sm">Become a Volo Pass member for insider access to Volo’s nationally recognized programming.</p>
            </div>
            <div class="p-6 space-y-4">
                <p class="text-gray-800 text-sm leading-relaxed">Play unlimited pickups, drop-ins, clinics, and tournaments. Get league discounts and access to exclusive member events—all with one flexible membership.</p>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div class="rounded-xl border border-gray-200 p-3">
                        <div class="font-semibold">Unlimited Drop-ins</div>
                        <p class="text-sm text-gray-600 mt-1">Grab a spot when a team needs a sub—enjoy all the fun, none of the commitment.</p>
                    </div>
                    <div class="rounded-xl border border-gray-200 p-3">
                        <div class="font-semibold">Unlimited Pickups</div>
                        <p class="text-sm text-gray-600 mt-1">Join pickup games on your schedule. Choose your skill level, show up, and play.</p>
                    </div>
                    <div class="rounded-xl border border-gray-200 p-3">
                        <div class="font-semibold">League Discounts</div>
                        <p class="text-sm text-gray-600 mt-1">Save $10–$50 on leagues when you register as a Volo Pass member.</p>
                    </div>
                    <div class="rounded-xl border border-gray-200 p-3">
                        <div class="font-semibold">Member-Only Events</div>
                        <p class="text-sm text-gray-600 mt-1">Exclusive parties, watch events, and more—just for members.</p>
                    </div>
                </div>
                <div class="pt-2 flex items-center justify-between gap-3">
                    <a href="#" class="text-sm text-gray-600 hover:text-gray-900 underline" data-action="close-volo-pass-modal">Maybe later</a>
                    <a href="#" class="inline-flex items-center justify-center rounded-full px-4 py-2 text-sm font-bold border border-[#c7ff10] bg-[#c7ff10] text-black hover:brightness-95 transition">BECOME A VOLO PASS MEMBER</a>
                </div>
            </div>
        </div>
    </div>

</body>
</html>

